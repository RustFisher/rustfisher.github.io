<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>RustFisher的自留地</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="RustFisher的自留地"><meta name="msapplication-TileImage" content="/img/fish.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="RustFisher的自留地"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="技术学习与实践，一些开发记录，读书笔记"><meta property="og:type" content="blog"><meta property="og:title" content="RustFisher的自留地"><meta property="og:url" content="https://blog.rustfisher.com/"><meta property="og:site_name" content="RustFisher的自留地"><meta property="og:description" content="技术学习与实践，一些开发记录，读书笔记"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.rustfisher.com/img/og_image.png"><meta property="article:author" content="Rust Fisher"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.rustfisher.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.rustfisher.com"},"headline":"RustFisher的自留地","image":["https://blog.rustfisher.com/img/og_image.png"],"author":{"@type":"Person","name":"Rust Fisher"},"publisher":{"@type":"Organization","name":"RustFisher的自留地","logo":{"@type":"ImageObject","url":"https://blog.rustfisher.com/img/fish.png"}},"description":"技术学习与实践，一些开发记录，读书笔记"}</script><link rel="icon" href="/img/fish.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-NT4BCBCQTP" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-NT4BCBCQTP');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script data-ad-client="ca-pub-7286632197002340" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/fish.png" alt="RustFisher的自留地" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/RustFisher"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-01-19T12:11:11.000Z" title="2017/1/19 20:11:11">2017-01-19</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:52.929Z" title="2021/6/18 17:38:52">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">10 分钟读完 (大约1472个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/01/19/Android/Gradle_for_android_Basic_Build_Customization/">Gradle 基础自定义构建</a></p><div class="content"><p>win7  Android Studio 2.1.3</p>
<p>基础自定义构建 Basic Build Customization</p>
<p>本章目的</p>
<ul>
<li>理解Gradle文件</li>
<li>build tasks入门</li>
<li>自定义构建</li>
</ul>
<h2 id="理解Gradle文件"><a href="#理解Gradle文件" class="headerlink" title="理解Gradle文件"></a>理解Gradle文件</h2><p>在Android Studio中新建一个项目后，会自动创建3个Gradle文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MyApp</span><br><span class="line">├── build.gradle</span><br><span class="line">├── settings.gradle</span><br><span class="line">└── app</span><br><span class="line">    └── build.gradle</span><br></pre></td></tr></table></figure>
<p>每个文件都有自己的作用</p>
<h3 id="settings-gradle文件"><a href="#settings-gradle文件" class="headerlink" title="settings.gradle文件"></a>settings.gradle文件</h3><p>新建工程的settings文件类似下面这样</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&#x27;:app&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Gradle为每个settings文件创建<code>Settings</code>对象，并调用其中的方法。</p>
<h3 id="The-top-level-build-file-最外层的构建文件"><a href="#The-top-level-build-file-最外层的构建文件" class="headerlink" title="The top-level build file 最外层的构建文件"></a>The top-level build file 最外层的构建文件</h3><p>能对工程中所有模块进行配置。如下</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:2.1.3&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">        maven &#123; url <span class="string">&quot;https://jitpack.io&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(<span class="attr">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>buildscript</code>代码块是具体配置的地方，引用JCenter仓库。<br>本例中，一个仓库代表着依赖库，换句话说是app可以从中下载使用库文件。<br>JCenter是一个有名的 Maven 仓库。</p>
<p><code>dependencies</code>代码块用来配置依赖。上面注释说明了，不要在此添加依赖，而应该到独立的模块<br>中去配置依赖。</p>
<p><code>allprojects</code>能对所有模块进行配置。</p>
<h3 id="模块中的build文件"><a href="#模块中的build文件" class="headerlink" title="模块中的build文件"></a>模块中的build文件</h3><p>模块中的独立配置文件，会覆盖掉top-level的<code>build.gradle</code>文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">25</span></span><br><span class="line">    buildToolsVersion <span class="string">&quot;25.0.2&quot;</span></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.xxx.rust.newproj&quot;</span></span><br><span class="line">        minSdkVersion <span class="number">18</span></span><br><span class="line">        targetSdkVersion <span class="number">25</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(<span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>, <span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">    testCompile <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">    compile <span class="string">&#x27;com.android.support:appcompat-v7:25.1.0&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面来看3个主要的代码块。</p>
<h4 id="plugin"><a href="#plugin" class="headerlink" title="plugin"></a>plugin</h4><p>第一行应用了Android 应用插件。Android插件由Google团队开发维护。该插件提供构建，测试，打包应用和模块需要的所有的task。</p>
<h4 id="android"><a href="#android" class="headerlink" title="android"></a>android</h4><p>最大的一个区域。defaultConfig区域对app核心进行配置，会配置覆盖AndroidManifest.xml中的配置。</p>
<p>applicationId复写掉manifest文件中的包名。但applicationId和包名有区别。<br>manifest中的包名，在源代码和R文件中使用。所以package name在android studio中理解为一个查询类的路径比较合理。<br>applicationId在Android系统中是作为应用的唯一标识，即在一个Android设备中所有的应用程序的applicationId都是唯一的。</p>
<h4 id="dependencies"><a href="#dependencies" class="headerlink" title="dependencies"></a>dependencies</h4><p>是Gradle标准配置的一部分。<br>Android中用来配置使用到的库。</p>
<h2 id="定制化构建-Customizing-the-build"><a href="#定制化构建-Customizing-the-build" class="headerlink" title="定制化构建 Customizing the build"></a>定制化构建 Customizing the build</h2><h3 id="BuildConfig-and-resources"><a href="#BuildConfig-and-resources" class="headerlink" title="BuildConfig and resources"></a>BuildConfig and resources</h3><p>自从SDK17以来，构建工具会生成一个BuildConfig类，包含着静态变量DEBUG和一些信息。<br>如果你想在区分debug和正式版，比如打log，这个BuildConfig类很有用。<br>可以通过Gradle来扩展这个类，让它拥有更多的静态变量。</p>
<p>以NewProj工程为例，<code>app\build.gradle</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">25</span></span><br><span class="line">    buildToolsVersion <span class="string">&quot;25.0.2&quot;</span></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.xxx.rust.newproj&quot;</span></span><br><span class="line">        minSdkVersion <span class="number">18</span></span><br><span class="line">        targetSdkVersion <span class="number">25</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;BASE_URL&quot;</span>, <span class="string">&quot;\&quot;http://www.baidu.com\&quot;&quot;</span>)</span><br><span class="line">            buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;A_CONTENT&quot;</span>, <span class="string">&quot;\&quot;debug content\&quot;&quot;</span>)</span><br><span class="line">            resValue(<span class="string">&quot;string&quot;</span>, <span class="string">&quot;str_version&quot;</span>, <span class="string">&quot;debug_ver&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;BASE_URL&quot;</span>, <span class="string">&quot;\&quot;http://www.qq.com\&quot;&quot;</span>)</span><br><span class="line">            buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;A_CONTENT&quot;</span>, <span class="string">&quot;\&quot;release content\&quot;&quot;</span>)</span><br><span class="line">            resValue(<span class="string">&quot;string&quot;</span>, <span class="string">&quot;str_version&quot;</span>, <span class="string">&quot;release_ver&quot;</span>)</span><br><span class="line"></span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的<code>buildConfigField</code>和<code>resValue</code>在编译后，能在源代码中使用<br>注意上面那个转义的分号不可少；注意里面的大小写，这里传入的参数就像是直接填入的代码一样</p>
<p>下面是编译后生成的BuildConfig文件，可以看到buildConfigField的东西已经在里面了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BuildConfig</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">DEBUG</span> <span class="operator">=</span> Boolean.parseBoolean(<span class="string">&quot;true&quot;</span>);</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">APPLICATION_ID</span> <span class="operator">=</span> <span class="string">&quot;com.xxx.rust.newproj&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUILD_TYPE</span> <span class="operator">=</span> <span class="string">&quot;debug&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FLAVOR</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERSION_CODE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VERSION_NAME</span> <span class="operator">=</span> <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line">  <span class="comment">// Fields from build type: debug</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">A_CONTENT</span> <span class="operator">=</span> <span class="string">&quot;debug content&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://www.baidu.com&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>resValue会被添加到资源文件中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mTv2.setText(R.string.str_version);</span><br></pre></td></tr></table></figure>
<h3 id="通过-build-gradle-增加获取-applicationId-的方式"><a href="#通过-build-gradle-增加获取-applicationId-的方式" class="headerlink" title="通过 build.gradle 增加获取 applicationId 的方式"></a>通过 build.gradle 增加获取 applicationId 的方式</h3><p>模块<code>build.gradle</code>中添加属性<code>applicationId</code>，会被编译到BuildConfig中<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">project.afterEvaluate &#123;</span><br><span class="line">    project.android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">        <span class="keyword">def</span> applicationId = [variant.mergedFlavor.applicationId, variant.buildType.applicationIdSuffix].findAll().join()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在代码中可以直接使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">appID</span> <span class="operator">=</span> BuildConfig.APPLICATION_ID;</span><br></pre></td></tr></table></figure></p>
<h3 id="获取时间的方法"><a href="#获取时间的方法" class="headerlink" title="获取时间的方法"></a>获取时间的方法</h3><p>模块<code>build.gradle</code>中添加方法<code>getTime()</code>，并在<code>buildTypes</code>中添加域。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前时间</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">def</span> getTime() &#123;</span><br><span class="line">    String timeNow = <span class="keyword">new</span> Date().format(<span class="string">&#x27;YYYYMMdd-HHmmss&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> timeNow</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            buildConfigField <span class="string">&quot;String&quot;</span>, <span class="string">&quot;BUILD_TIME&quot;</span>, <span class="string">&quot;\&quot;&quot;</span> + getTime() + <span class="string">&quot;\&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            buildConfigField <span class="string">&quot;String&quot;</span>, <span class="string">&quot;BUILD_TIME&quot;</span>, <span class="string">&quot;\&quot;&quot;</span> + getTime() + <span class="string">&quot;\&quot;&quot;</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>BuildConfig.java</code>中得到这个域。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fields from build type: debug</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUILD_TIME</span> <span class="operator">=</span> <span class="string">&quot;20180912-100335&quot;</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="修改release-apk文件名的方法"><a href="#修改release-apk文件名的方法" class="headerlink" title="修改release apk文件名的方法"></a>修改release apk文件名的方法</h3><p>gradle版本3.1.4。使用了上面的方法<code>getTime()</code>。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 修改release的apk名字</span></span><br><span class="line">    applicationVariants.all &#123; variant -&gt;</span><br><span class="line">        variant.outputs.all &#123;</span><br><span class="line">            <span class="keyword">if</span> (variant.buildType.name == <span class="string">&#x27;release&#x27;</span>) &#123;</span><br><span class="line">                outputFileName = <span class="string">&quot;xxx_release_$&#123;defaultConfig.versionName&#125;_$&#123;getTime()&#125;.apk&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以前的方法可能会遇到问题：<code>Cannot set the value of read-only property &#39;outputFile&#39; for ApkVariantOutputImpl_Decorated</code>。<br>参考：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/44239235/android-gradle-3-0-0-alpha2-plugin-cannot-set-the-value-of-read-only-property">https://stackoverflow.com/questions/44239235/android-gradle-3-0-0-alpha2-plugin-cannot-set-the-value-of-read-only-property</a></p>
<h3 id="工程范围的设置"><a href="#工程范围的设置" class="headerlink" title="工程范围的设置"></a>工程范围的设置</h3><p>如果一个工程中有多个模块，可以对整个工程应用设置，而不用去修改每一个模块。</p>
<p><code>NewProj\build.gradle</code><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ext &#123;</span><br><span class="line">    compileSDKVersion = <span class="number">25</span></span><br><span class="line">    local = <span class="string">&#x27;Hello from the top-level build&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每一个<code>build.gradle</code>文件都能定义额外的属性，在ext代码块中。</p>
<p>在一个模块的<code>libmodule\build.gradle</code>文件中，可以引用rootProject的ext属性</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion rootProject.ext.compileSDKVersion</span><br><span class="line">    buildToolsVersion <span class="string">&quot;25.0.2&quot;</span></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="工程属性-Project-properties"><a href="#工程属性-Project-properties" class="headerlink" title="工程属性 Project properties"></a>工程属性 Project properties</h3><p>定义properties的地方</p>
<ul>
<li>ext代码块</li>
<li>gradle.properties文件</li>
<li>命令行 -P 参数</li>
</ul>
<p>工程<code>build.gradle</code>文件<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">    compileSDKVersion = <span class="number">25</span></span><br><span class="line">    local = <span class="string">&#x27;Hello from the top-level build&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Print properties info</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">task aPrintSomeInfo &#123;</span><br><span class="line">    println(local)</span><br><span class="line">    println(<span class="string">&#x27;project dir: &#x27;</span> + projectDir)</span><br><span class="line">    println(projectPropertiesFileText)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task aPrintAllProperites() &#123;</span><br><span class="line">    println(<span class="string">&#x27;\nthis is aPrintAllProperites task\n&#x27;</span>)</span><br><span class="line">    Iterator pIt = properties.iterator()</span><br><span class="line">    <span class="keyword">while</span> (pIt.hasNext()) &#123;</span><br><span class="line">        println(pIt.next())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>gradle.properties文件中增加<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">projectPropertiesFileText = Hello there from gradle.properties</span><br></pre></td></tr></table></figure></p>
<p>在as的Gradle栏上双击执行aPrintSomeInfo，会连带下一个task也执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">13:08:10: Executing external task &#x27;aPrintSomeInfo&#x27;...</span><br><span class="line">Hello from the top-level build</span><br><span class="line">project dir: G:\openSourceProject\NewProj</span><br><span class="line">Hello there from gradle.properties</span><br><span class="line"></span><br><span class="line">this is aPrintAllProperites task</span><br><span class="line">......</span><br><span class="line">BUILD SUCCESSFUL</span><br><span class="line"></span><br><span class="line">Total time: 1.025 secs</span><br><span class="line">13:08:11: External task execution finished &#x27;aPrintSomeInfo&#x27;.</span><br></pre></td></tr></table></figure>
<p>参考：<em>Gradle for Android</em>  Kevin Pelgrims</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-01-19T11:01:15.000Z" title="2017/1/19 19:01:15">2017-01-19</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:39:00.302Z" title="2021/6/18 17:39:00">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">9 分钟读完 (大约1415个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/01/19/Android/Gradle_for_android_Start/">Gradle for Android 开始</a></p><div class="content"><h1 id="Gradle-for-Android开始"><a href="#Gradle-for-Android开始" class="headerlink" title="Gradle for Android开始"></a>Gradle for Android开始</h1><p>Google在Gradle中的目标：能复用代码，创建构建变量，能配置和定制构建过程。</p>
<h2 id="Gradle基础"><a href="#Gradle基础" class="headerlink" title="Gradle基础"></a>Gradle基础</h2><p>Gradle构建脚本并不是用XML来写的，而是基于Groovy的一种（domain-specifc language）<br>DSL语言。这是一种运行在JVM上的动态语言。</p>
<p>如果要构建新的任务和插件，我们需要了解这门语言。</p>
<h2 id="Projects-and-tasks"><a href="#Projects-and-tasks" class="headerlink" title="Projects and tasks"></a>Projects and tasks</h2><p>这是Gradle种最重要的两个概念。每个构建（build）至少包含一个project，每一个project包含<br>一个或多个task。每个<code>build.gradle</code>代表一个project。task被定义在这个构建脚本中。<br>一个task对象包含一列需要被执行的Action对象。一个Action对象就是一块被执行的代码，就像<br>Java中的方法。</p>
<p>当初始化构建进程时，Gradle收集build文件中的project和task对象。</p>
<h2 id="构建的生命周期（The-build-lifecycle）"><a href="#构建的生命周期（The-build-lifecycle）" class="headerlink" title="构建的生命周期（The build lifecycle）"></a>构建的生命周期（The build lifecycle）</h2><p>为简化构建过程，构建工具创造了一种工作流的动态模型DAG（Directed Acyclic Graph）。<br>这意味着所有的任务会一个接一个地执行，不会出现循环的情况。<br>一个任务一旦被执行就不会再被调用。没有依赖的任务永远是最优先执行的。<br>在配置过程中生成依赖关系。</p>
<p>一个Gradle构建过程有3个步骤：</p>
<ul>
<li>初始化：工程实例被创建时初始化。如果有多个模块，每个模块有自己的<code>build.gradle</code>文件，<br>多个project被创建。</li>
<li>配置：这一步执行build脚本，创建并配置每个project的task。</li>
<li>执行：Gradle决定执行那些任务。根据当前目录和传入参数执行task。</li>
</ul>
<h2 id="build配置文件"><a href="#build配置文件" class="headerlink" title="build配置文件"></a>build配置文件</h2><p><code>build.gradle</code>文件。配置build的地方。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:2.2.2&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>repositories块中，指定JCenter作为依赖仓库。<br>这个脚本获取了Android构建工具。这个Android插件提供了构建和测试应用所需的功能。</p>
<p>插件被用来扩展Gradle构建脚本的功能。在project中使用插件，就可以定义属性和任务。</p>
<h2 id="Gradle-Wrapper初步"><a href="#Gradle-Wrapper初步" class="headerlink" title="Gradle Wrapper初步"></a>Gradle Wrapper初步</h2><p>Gradle是一个开发中的工具。使用Gradle Wrapper可以避免一些问题，确保能构建顺利。<br>Gradle在Windows系统上提供了batch文件，在其他系统上提供了shell脚本。试图运行脚本时，会<br>自动检查并下载Gradle。但在我们的网络比较令人着急。可以尝试在网络上找资源。</p>
<p>比如我下载了一个<code>gradle-2.14.1-all.zip</code>，将其放到Android工程的gradle/wrapper下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gradle</span><br><span class="line">`-- wrapper</span><br><span class="line">    |-- gradle-2.14.1-all.zip</span><br><span class="line">    |-- gradle-wrapper.jar</span><br><span class="line">    `-- gradle-wrapper.properties</span><br></pre></td></tr></table></figure>
<p>然后修改<code>gradle-wrapper.properties</code>文件，把Url修改成<br><code>distributionUrl=gradle-2.14.1-all.zip</code></p>
<p>在Android Studio提供的Terminal中运行<code>grawdlew</code>，先unzipping，然后开始下载依赖文件。<br>这些文件在windows中默认存放到<br><code>C:\Users\UserName\.gradle\wrapper\dists\gradle-2.14.1-all</code>，还是很占空间的。<br>此时你可以在项目下的命令行中使用grawdlew命令。比如查看版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">G:\rust_proj\NDKProj&gt;gradlew -v</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Gradle 2.14.1</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Build time:   2016-07-18 06:38:37 UTC</span><br><span class="line">Revision:     d9e2113d9fb05a5caabba61798bdb8dfdca83719</span><br><span class="line"></span><br><span class="line">Groovy:       2.4.4</span><br><span class="line">Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015</span><br><span class="line">JVM:          1.8.0_77 (Oracle Corporation 25.77-b03)</span><br><span class="line">OS:           Windows 7 6.1 amd64</span><br></pre></td></tr></table></figure>
<p>如果在另一个Android项目下同样复制了<code>gradle-2.14.1-all.zip</code>，并且尝试运行gradlew，<br>C盘里相应目录下又会多一个文件夹。</p>
<h2 id="获取Gradle-Wrapper"><a href="#获取Gradle-Wrapper" class="headerlink" title="获取Gradle Wrapper"></a>获取Gradle Wrapper</h2><p>打开Windows CMD，进入前面配置好的Android工程目录，同样可以运行gradlew。</p>
<p>此时我们的C盘里已经有<code>gradle-2.14.1-all.zip</code>了。找到<code>gradle.bat</code>的路径，将其添加到<br>电脑PATH中。这里添加到用户的环境变量中。</p>
<p>在G盘新建一个目录<code>gradleTest</code>，然后创建一个<code>build.gradle</code>文件；其中填写如下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">task wrapper(type: Wrapper) &#123;</span><br><span class="line">    gradleVersion = &#x27;2.4&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入刚才的目录，在CMD中直接运行gradle</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">G:\gradleTest&gt;gradle</span><br><span class="line">:help</span><br><span class="line">Welcome to Gradle 2.14.1.</span><br><span class="line">To run a build, run gradle &lt;task&gt; ...</span><br><span class="line">To see a list of available tasks, run gradle tasks</span><br><span class="line">To see a list of command-line options, run gradle --help</span><br><span class="line">To see more detail about a task, run gradle help --task &lt;task&gt;</span><br><span class="line">BUILD SUCCESSFUL</span><br><span class="line">Total time: 1.714 secs</span><br></pre></td></tr></table></figure>
<p>此时目录下生成了一个<code>.gradle</code>目录</p>
<p>如果当前目录下没有<code>build.gradle</code>文件，gradle也会执行并生成<code>.gradle</code>目录。</p>
<p>我们来观察Android项目里Gradle Wrapper的情况<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NDKProj/</span><br><span class="line">├── gradlew</span><br><span class="line">├── gradlew.bat</span><br><span class="line">└── gradle/wrapper/</span><br><span class="line">    ├── gradle-wrapper.jar</span><br><span class="line">    └── gradle-wrapper.properties</span><br></pre></td></tr></table></figure><br>Gradle Wrapper包含3个部分：</p>
<ul>
<li>MS可执行的gradlew.bat和Linux， Mac OS X可执行的gradlew</li>
<li>脚本需要的Jar文件</li>
<li>一个properties文件</li>
</ul>
<p>在前面我们已经把properties文件修改成了这样：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#Mon Aug 29 19:26:36 CST 2016</span><br><span class="line">distributionBase=GRADLE_USER_HOME</span><br><span class="line">distributionPath=wrapper/dists</span><br><span class="line">zipStoreBase=GRADLE_USER_HOME</span><br><span class="line">zipStorePath=wrapper/dists</span><br><span class="line">distributionUrl=gradle-2.14.1-all.zip</span><br></pre></td></tr></table></figure></p>
<p>原distributionUrl如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">distributionUrl=https\://services.gradle.org/distributions/gradle-2.14.1-all.zip</span><br></pre></td></tr></table></figure></p>
<p>这意味着我们可以使用不同的URL和Gradle。我们前面已经这么做了。</p>
<h2 id="运行基本的构建任务（task）"><a href="#运行基本的构建任务（task）" class="headerlink" title="运行基本的构建任务（task）"></a>运行基本的构建任务（task）</h2><p>进入Android工程目录下，用命令行执行gradlew<br><code>gradlew tasks</code>会打印出任务列表；<code>gradlew tasks --all</code>打印出所有的任务</p>
<p><code>gradlew assembleDebug</code>编译当前项目，创建一个debug版本的apk</p>
<p><code>gradlew clean</code>清理当前项目的output</p>
<p><code>gradlew check</code>运行所有的检查，通常是在真机或者模拟器上运行测试</p>
<p><code>gradlew build</code>触发assemble 和 check</p>
<p>这些功能在Android Studio上都有相应按键</p>
<p>参考：<em>Gradle for Android</em>  Kevin Pelgrims</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-12-28T13:05:25.000Z" title="2016/12/28 21:05:25">2016-12-28</time>发表</span><span class="level-item"><time dateTime="2018-09-21T01:03:47.000Z" title="2018/9/21 09:03:47">2018-09-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/PyQt/">PyQt</a></span><span class="level-item">6 分钟读完 (大约828个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/12/28/PyQt_note/PyQt-QMainWindow_simple_practice/">PyQt QMainWindow 简单使用</a></p><div class="content"><p>QMainWindow继承自QWidget<br>QMainWindow相当于程序的主界面，内置了menu和toolBar。<br>使用 Qt Designer 可以很方便地添加menu选项。</p>
<p>对于较大型的界面，用Qt Designer比较方便。<code>.ui</code>文件就像Android中使用xml一样。<br>画出的ui文件可以用PyQt中的PyUIC转换成py文件。转换后的py文件中有一个class。<br>新建一个继承自QMainWindow的类，来调用生成的这个类。</p>
<p>主窗口关闭时，会调用<code>closeEvent(self, *args, **kwargs)</code>，可复写这个方法，加上一些关闭时的操作。<br>比如终止子线程，关闭数据库接口，释放资源等等操作。</p>
<h2 id="PyQt5-手写-QMainWindow-示例"><a href="#PyQt5-手写-QMainWindow-示例" class="headerlink" title="PyQt5 手写 QMainWindow 示例"></a>PyQt5 手写 QMainWindow 示例</h2><p>Win7  PyCharm  Python3.5.1  PyQt5</p>
<p>手写一个main window，主要使用了菜单栏、文本编辑框、工具栏和状态栏<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|-- main.py</span><br><span class="line">|-- res</span><br><span class="line">|   `-- sword.png</span><br><span class="line">`-- ui</span><br><span class="line">    `-- app_main_window.py</span><br></pre></td></tr></table></figure></p>
<p><code>main.py</code>主文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication</span><br><span class="line"><span class="keyword">from</span> ui.app_main_window <span class="keyword">import</span> AppMainWindow</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    window = AppMainWindow()</span><br><span class="line">    window.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure></p>
<p><code>app_main_window.py</code>窗口实现文件<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QCoreApplication</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> QIcon</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QAction</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QMainWindow</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QTextEdit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppMainWindow</span>(<span class="title class_ inherited__">QMainWindow</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    菜单栏、文本编辑框、工具栏和状态栏</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.init_ui()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_ui</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 菜单栏</span></span><br><span class="line">        self.statusBar().showMessage(<span class="string">&#x27;Main window is ready&#x27;</span>)</span><br><span class="line">        self.setGeometry(<span class="number">500</span>, <span class="number">500</span>, <span class="number">450</span>, <span class="number">220</span>)</span><br><span class="line">        self.setMinimumSize(<span class="number">150</span>, <span class="number">120</span>)</span><br><span class="line">        self.setWindowTitle(<span class="string">&#x27;MainWindow&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 文本编辑框</span></span><br><span class="line">        text_edit = QTextEdit()</span><br><span class="line">        self.setCentralWidget(text_edit)  <span class="comment"># 填充剩下的位置</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 定义退出动作</span></span><br><span class="line">        exit_action = QAction(QIcon(<span class="string">&#x27;res/sword.png&#x27;</span>), <span class="string">&#x27;Exit&#x27;</span>, self)</span><br><span class="line">        exit_action.setShortcut(<span class="string">&#x27;Ctrl+Q&#x27;</span>)</span><br><span class="line">        exit_action.setStatusTip(<span class="string">&#x27;Exit App&#x27;</span>)  <span class="comment"># 鼠标指向选项时在窗口状态栏出现的提示</span></span><br><span class="line">        <span class="comment"># exit_action.triggered.connect(QCoreApplication.instance().quit)</span></span><br><span class="line">        exit_action.triggered.connect(self.close)  <span class="comment"># 关闭app</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 定义菜单栏，添加一个选项</span></span><br><span class="line">        menu_bar = self.menuBar()</span><br><span class="line">        file_menu = menu_bar.addMenu(<span class="string">&#x27;&amp;File&#x27;</span>)</span><br><span class="line">        file_menu.addAction(exit_action)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 定义工具栏，添加一个退出动作</span></span><br><span class="line">        toolbar = self.addToolBar(<span class="string">&#x27;&amp;Exit&#x27;</span>)</span><br><span class="line">        toolbar.addAction(exit_action)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>有的时候PyCharm给的代码提示不完全。网上说PyCharm配合vim插件来使用能带来很好的体验。<br>生成的界面中，工具栏可以自由的拖动，可以放在上下左右4个地方。</p>
<p>同样的代码，可以很方便地移植到PyQt4中。</p>
<h2 id="使用designer画出来的界面"><a href="#使用designer画出来的界面" class="headerlink" title="使用designer画出来的界面"></a>使用designer画出来的界面</h2><p>Ubuntu</p>
<p>使用designer绘制好界面后，讲ui文件转换成py代码。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QMainWindow, QApplication</span><br><span class="line"><span class="keyword">from</span> ui_main_window <span class="keyword">import</span> Ui_UAppMainWindow</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RustMainWindow</span>(<span class="title class_ inherited__">QMainWindow</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;主界面类&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(RustMainWindow, self).__init__()</span><br><span class="line">        self.ma = Ui_UAppMainWindow()  <span class="comment"># designer画的界面</span></span><br><span class="line">        self.ma.setupUi(self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    main_window = RustMainWindow()</span><br><span class="line">    main_window.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>复写<code>__init__</code>初始化方法时需要调用父类方法</p>
<h2 id="PyQt4手写窗口代码"><a href="#PyQt4手写窗口代码" class="headerlink" title="PyQt4手写窗口代码"></a>PyQt4手写窗口代码</h2><p>和上面那个功能类似。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt4.QtGui <span class="keyword">import</span> QMainWindow, QTextEdit, QAction, QIcon, QApplication</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppMainWindow</span>(<span class="title class_ inherited__">QMainWindow</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(AppMainWindow, self).__init__()</span><br><span class="line">        self.init_ui()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_ui</span>(<span class="params">self</span>):</span><br><span class="line">        self.statusBar().showMessage(<span class="string">&#x27;Main window is ready&#x27;</span>)</span><br><span class="line">        self.setGeometry(<span class="number">500</span>, <span class="number">500</span>, <span class="number">450</span>, <span class="number">220</span>)</span><br><span class="line">        self.setMinimumSize(<span class="number">150</span>, <span class="number">120</span>)</span><br><span class="line">        self.setWindowTitle(<span class="string">&#x27;MainWindow&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        text_edit = QTextEdit()</span><br><span class="line">        self.setCentralWidget(text_edit)</span><br><span class="line"></span><br><span class="line">        exit_action = QAction(QIcon(<span class="string">&#x27;res/ic_s1.png&#x27;</span>), <span class="string">&#x27;Exit&#x27;</span>, self)</span><br><span class="line">        exit_action.setShortcut(<span class="string">&#x27;Ctrl+Q&#x27;</span>)</span><br><span class="line">        exit_action.setStatusTip(<span class="string">&#x27;Exit App&#x27;</span>)</span><br><span class="line">        exit_action.triggered.connect(self.close)</span><br><span class="line"></span><br><span class="line">        menu_bar = self.menuBar()</span><br><span class="line">        file_menu = menu_bar.addMenu(<span class="string">&#x27;&amp;File&#x27;</span>)</span><br><span class="line">        file_menu.addAction(exit_action)</span><br><span class="line"></span><br><span class="line">        toolbar = self.addToolBar(<span class="string">&#x27;&amp;Exit&#x27;</span>)</span><br><span class="line">        toolbar.addAction(exit_action)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    window = AppMainWindow()</span><br><span class="line">    window.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看出，PyQt4 和 5 的代码基本上是通用的。复写<code>__init__</code>的方法不同。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-12-28T12:25:10.000Z" title="2016/12/28 20:25:10">2016-12-28</time>发表</span><span class="level-item"><time dateTime="2018-09-21T01:03:47.000Z" title="2018/9/21 09:03:47">2018-09-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/PyQt/">PyQt</a></span><span class="level-item">4 分钟读完 (大约636个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/12/28/PyQt_note/PyQt5-Custom_QWidget/">PyQt 创建自定义QWidget</a></p><div class="content"><h2 id="PyQt5-QtWidgets-示例"><a href="#PyQt5-QtWidgets-示例" class="headerlink" title="PyQt5.QtWidgets 示例"></a>PyQt5.QtWidgets 示例</h2><p>Win7  PyCharm  Python3.5.1  PyQt5</p>
<p>主要文件：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|-- main.py</span><br><span class="line">|-- res</span><br><span class="line">|   `-- fish.jpg</span><br><span class="line">`-- ui</span><br><span class="line">    `-- app_widget.py</span><br></pre></td></tr></table></figure></p>
<p><code>main.py</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ui.app_widget <span class="keyword">import</span> AppQWidget</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    w = AppQWidget()</span><br><span class="line">    w.show()</span><br><span class="line"></span><br><span class="line">    sys.exit(app.exec_())</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p><code>app_main_window.py</code>自定义了一个居中显示的窗口，关闭时弹确认框</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QCoreApplication</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> QIcon</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QWidget, QPushButton, QDesktopWidget, QMessageBox</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppQWidget</span>(<span class="title class_ inherited__">QWidget</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A custom QWidget by Rust Fisher</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.init_ui()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_ui</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># self.setGeometry(300, 300, 400, 200)  # 相当于move和resize</span></span><br><span class="line">        self.resize(<span class="number">300</span>, <span class="number">200</span>)</span><br><span class="line">        self.move_to_center()</span><br><span class="line">        self.setWindowTitle(<span class="string">&#x27;Demo1&#x27;</span>)</span><br><span class="line">        self.setWindowIcon(QIcon(<span class="string">&#x27;res/fish.jpg&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        btn1 = QPushButton(<span class="string">&#x27;Quit&#x27;</span>, self)</span><br><span class="line">        btn1.setToolTip(<span class="string">&#x27;Click to quit&#x27;</span>)</span><br><span class="line">        btn1.resize(btn1.sizeHint())</span><br><span class="line">        btn1.move(<span class="number">200</span>, <span class="number">150</span>)</span><br><span class="line">        btn1.clicked.connect(QCoreApplication.instance().quit)  <span class="comment"># cannot locate function connect</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">closeEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">        reply = QMessageBox.question(self, <span class="string">&#x27;Message&#x27;</span>,</span><br><span class="line">                                     <span class="string">&#x27;Are you sure to quit now?&#x27;</span>,</span><br><span class="line">                                     QMessageBox.Yes | QMessageBox.No,</span><br><span class="line">                                     QMessageBox.No)</span><br><span class="line">        <span class="keyword">if</span> reply == QMessageBox.Yes:</span><br><span class="line">            event.accept()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            event.ignore()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">move_to_center</span>(<span class="params">self</span>):</span><br><span class="line">        qr = self.frameGeometry()</span><br><span class="line">        cp = QDesktopWidget().availableGeometry().center()  <span class="comment"># got center info here</span></span><br><span class="line">        qr.moveCenter(cp)</span><br><span class="line">        self.move(qr.topLeft())  <span class="comment"># 应用窗口的左上方的点到qr矩形的左上方的点，因此居中显示在我们的屏幕上</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><h3 id="多控件可以存在list中"><a href="#多控件可以存在list中" class="headerlink" title="多控件可以存在list中"></a>多控件可以存在list中</h3><p>存在一起，需要对整体操作时直接遍历列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"># 同组的控件可以存在同一个list中</span></span><br><span class="line">    self.cb_list = [</span><br><span class="line">        self.ma.i2cCB,</span><br><span class="line">        self.ma.mipiCB,</span><br><span class="line">        self.ma.eepromCB,</span><br><span class="line">        self.ma.tem_sensorCB,</span><br><span class="line">        self.ma.lensCB,</span><br><span class="line">        self.ma.vcmCB,</span><br><span class="line">        self.ma.mirrorCB,</span><br><span class="line">        self.ma.mirrorCaliCB, ]</span><br><span class="line"></span><br><span class="line">    self.test_count_et_list = [</span><br><span class="line">        self.ma.i2cCountEt,</span><br><span class="line">        self.ma.mipiCountEt,</span><br><span class="line">        self.ma.eepromCountEt,</span><br><span class="line">        self.ma.tem_sensorCountEt,</span><br><span class="line">        self.ma.lensCountEt,</span><br><span class="line">        self.ma.vcmCountEt,</span><br><span class="line">        self.ma.mirrorCountEt,</span><br><span class="line">        self.ma.mirrorCaliCountEt,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要操作某组控件时  直接遍历列表</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_click_test_item_cb</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; Update [choose all checkbox] by all test item state &quot;&quot;&quot;</span></span><br><span class="line">    choose_all = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> cb <span class="keyword">in</span> self.cb_list:</span><br><span class="line">        choose_all = choose_all &amp; cb.isChecked()</span><br><span class="line">    self.ma.selecteAllCB.setChecked(choose_all)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="QApplication与QWidget"><a href="#QApplication与QWidget" class="headerlink" title="QApplication与QWidget"></a><code>QApplication</code>与<code>QWidget</code></h2><p><code>QApplication</code>是一个单例，在<code>QWidget</code>中可以通过<code>QApplication.instance()</code>获取到对象</p>
<p>实际上在实例化QApplication前就使用<code>QtGui.QWidget()</code>是会报错的<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>QtGui.QWidget()</span><br><span class="line">QWidget: Must construct a QApplication before a QPaintDevice</span><br></pre></td></tr></table></figure><br>参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17601896/how-qapplication-and-qwidget-objects-are-connected-in-pyside-pyqt">How QApplication() and QWidget() objects are connected in PySide/PyQt?</a></p>
<p>在我们自定义的<code>QMainWindow</code>中，也可以直接获取到<code>QApplication</code>的实例。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RustMainWindow</span>(<span class="title class_ inherited__">QMainWindow</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; This is the main class &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_trigger_english</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Change to English&quot;</span>, QApplication.instance()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Change to English &lt;PyQt4.QtGui.QApplication object at 0x02ABE3A0&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="注意widget持有外部对象引用的问题"><a href="#注意widget持有外部对象引用的问题" class="headerlink" title="注意widget持有外部对象引用的问题"></a>注意widget持有外部对象引用的问题</h3><p>如果在程序启动的地方将引用交给widget，退出时会造成应用无法关闭的问题（类似内存泄漏）。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    <span class="comment"># 这里把app交给了MainWindow，MainWindow关闭时是无法正常退出应用的</span></span><br><span class="line">    main_d = RustMainWindow(app)  <span class="comment"># 不建议这么做</span></span><br><span class="line">    main_d.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br></pre></td></tr></table></figure></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-12-28T12:15:20.000Z" title="2016/12/28 20:15:20">2016-12-28</time>发表</span><span class="level-item"><time dateTime="2018-09-21T01:03:47.000Z" title="2018/9/21 09:03:47">2018-09-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/PyQt/">PyQt</a></span><span class="level-item">2 分钟读完 (大约363个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/12/28/PyQt_note/PyCharm-Install_and_config/">PyCharm 安装和配置</a></p><div class="content"><p>安装和配置PyCharm<br>修改默认配置，修改config和system的路径，避免占据C盘太多的空间<br>将PyQt中的工具<code>PyUIC</code>安装到PyCharm中，使用更便捷（Windows和Ubuntu平台）</p>
<ul>
<li>win7</li>
<li>Python3.5.1</li>
<li>PyQt5-5.6</li>
</ul>
<p>PyCharm版本： JetBrains PyCharm Community Edition 2016.3.1(64)</p>
<p>安装路径： <code>E:\IntelliJ IDEA Community Edition 2016.1.1</code></p>
<h2 id="PyCharm默认配置"><a href="#PyCharm默认配置" class="headerlink" title="PyCharm默认配置"></a>PyCharm默认配置</h2><p>和Android Studio类似，可以自定义IDE的配置</p>
<p>在第一次启动前，找到<code>bin\idea.properties</code>，修改一下路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">idea.config.path=E:/IntelliJIDEAPath/config</span><br><span class="line"></span><br><span class="line">idea.system.path=E:/IntelliJIDEAPath/system</span><br></pre></td></tr></table></figure>
<p>启动后，可以发现config和system都在<code>E:/IntelliJIDEAPath</code>下<br>此举是为了避免C盘挤爆</p>
<h2 id="PyCharm工程配置"><a href="#PyCharm工程配置" class="headerlink" title="PyCharm工程配置"></a>PyCharm工程配置</h2><p>打开Settings<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Build, Execution, Deployment</span><br><span class="line">    Console</span><br><span class="line">        Python Console</span><br><span class="line">            Python interpreter 选择 Python 3.5.1</span><br></pre></td></tr></table></figure></p>
<p>假设有一个工程<code>gui_app</code>，同样要检查一下设置<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Project: gui_app</span><br><span class="line">    Project interpreter</span><br><span class="line">        选择3.5.1  后面会显示路径</span><br></pre></td></tr></table></figure></p>
<h2 id="安装扩展工具"><a href="#安装扩展工具" class="headerlink" title="安装扩展工具"></a>安装扩展工具</h2><p>打开Settings &gt; Tools &gt; External Tools</p>
<p>选择新建<code>+</code>，或者编辑</p>
<h3 id="安装QtDesigner"><a href="#安装QtDesigner" class="headerlink" title="安装QtDesigner"></a>安装QtDesigner</h3><p>Name: QtDesigner<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Tool Settings</span><br><span class="line">    Program: E:\Python351\Lib\site-packages\PyQt5\designer.exe</span><br><span class="line">    ## 选择安装好的PyQt5\designer.exe</span><br><span class="line"></span><br><span class="line">    Working directory: $FileDir$</span><br></pre></td></tr></table></figure></p>
<h3 id="安装PyUIC"><a href="#安装PyUIC" class="headerlink" title="安装PyUIC"></a>安装PyUIC</h3><p>将designer生成的ui文件转为py文件的工具；这是Python自带的工具</p>
<p>Name: PyUIC<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Tool Settings</span><br><span class="line">    Program: E:\Python351\python.exe</span><br><span class="line">    ## 选择安装好的python.exe</span><br><span class="line"></span><br><span class="line">    Parameters: -m PyQt5.uic.pyuic  $FileName$ -o $FileNameWithoutExtension$.py</span><br><span class="line">    Working directory: $FileDir$</span><br></pre></td></tr></table></figure></p>
<h4 id="Ubuntu下PyCharm配置"><a href="#Ubuntu下PyCharm配置" class="headerlink" title="Ubuntu下PyCharm配置"></a>Ubuntu下PyCharm配置</h4><p>将designer生成的ui文件转为py文件的工具<br>需要<code>sudo apt-get install pyqt5-dev-tools</code><br>配置工具[Tool Settings]<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Program: pyuic5</span><br><span class="line">Parameters: -o $FileNameWithoutExtension$.py $FileNameWithoutExtension$.ui</span><br><span class="line">Working directory: $FileDir$</span><br></pre></td></tr></table></figure></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-12-28T10:55:20.000Z" title="2016/12/28 18:55:20">2016-12-28</time>发表</span><span class="level-item"><time dateTime="2020-10-09T12:44:36.395Z" title="2020/10/9 20:44:36">2020-10-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/PyQt/">PyQt</a></span><span class="level-item">2 分钟读完 (大约286个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/12/28/PyQt_note/Python-PyQt5_Python351_install/">Python3.5 PyQt5 安装</a></p><div class="content"><p>在Windows和Ubuntu下安装PyQt5<br>需要先安装并配置好Python，Windows下需要配置环境变量。PyQt需要对应上Python版本。</p>
<h2 id="Windows环境"><a href="#Windows环境" class="headerlink" title="Windows环境"></a>Windows环境</h2><h3 id="用pip3安装PyQt5"><a href="#用pip3安装PyQt5" class="headerlink" title="用pip3安装PyQt5"></a>用pip3安装PyQt5</h3><p>先确认Python相关环境变量已经配置好，比如：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\python36;D:\python36\Scripts;D:\python36\libs;</span><br></pre></td></tr></table></figure><br>然后运行pip3，<a target="_blank" rel="noopener" href="https://riverbankcomputing.com/software/pyqt/download5">参考 PyQt5 Download</a><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install PyQt5</span><br></pre></td></tr></table></figure><br>从网上下载相关文件并安装，等待过程比较长。</p>
<h3 id="PyQt5-5-6-gpl-exe-安装方式"><a href="#PyQt5-5-6-gpl-exe-安装方式" class="headerlink" title="PyQt5-5.6-gpl exe 安装方式"></a>PyQt5-5.6-gpl exe 安装方式</h3><p>Win7  Python3.5.1</p>
<p>PyQt5-5.6-gpl-Py3.5-Qt5.6.0-x64-2.exe  （最新版本已经不再提供exe版本）</p>
<p>先安装Python3.5.1到 <code>E:\Python351</code><br>再去官网下载PyQt5，翻墙后下载速度更快。双击安装，PyQt5会自动找到Python35的目录。<br>本例中PyQt5安装到 <code>E:\Python351\Lib\site-packages\PyQt5</code></p>
<p>现在就可以使用PyQt5了。</p>
<p><code>&gt;&gt;&gt; from PyQt5.QtWidgets import *</code></p>
<p>在命令行显示一个label试一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtWidgets</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>app = QtWidgets.QApplication(sys.argv)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>label = QtWidgets.QLabel(<span class="string">&#x27;Label&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>label.resize(<span class="number">150</span>,<span class="number">100</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>label.show()</span><br></pre></td></tr></table></figure>
<h2 id="Ubuntu-16-04"><a href="#Ubuntu-16-04" class="headerlink" title="Ubuntu 16.04"></a>Ubuntu 16.04</h2><p>Python3.5<br>直接安装<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python3-dev</span><br><span class="line">sudo apt-get install python3-pyqt5</span><br><span class="line">sudo apt-get install qt5-default qttools5-dev-tools</span><br><span class="line">designer # 启动designer</span><br></pre></td></tr></table></figure></p>
<p>安装pyuic5<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install pyqt5-dev-tools</span><br></pre></td></tr></table></figure></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-12-27T10:55:20.000Z" title="2016/12/27 18:55:20">2016-12-27</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:42:44.051Z" title="2021/6/18 17:42:44">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a></span><span class="level-item">5 分钟读完 (大约786个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/12/27/Python/Python-rw_in_csv/">Python3 读写csv文件中的数字</a></p><div class="content"><p>环境与工具</p>
<ul>
<li>Python3</li>
<li>PyCharm CE</li>
</ul>
<h2 id="csv简介"><a href="#csv简介" class="headerlink" title="csv简介"></a>csv简介</h2><p>什么是csv？csv是逗号分隔的一种文件格式。<br>例如下面这个csv格式的文本。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">姓名,年龄,标签</span><br><span class="line">Rust Fisher,18,Python</span><br><span class="line">Tom Hanks,29,Java</span><br></pre></td></tr></table></figure></p>
<p>这样的<code>.csv</code>文件可以用Excel或者WPS打开，会给出表格的形式。</p>
<p><img src="py_csv_demo1.png" alt=""></p>
<p>要注意的是，csv是文本格式，并不是Excel的格式。我们用文本编辑器（例如xcode，记事本）是可以直接编辑它的。</p>
<h2 id="读写csv文件"><a href="#读写csv文件" class="headerlink" title="读写csv文件"></a>读写csv文件</h2><p>读文件时先产生str的列表，把最后的换行符删掉；然后一个个str转换成int<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 读写csv文件</span></span><br><span class="line">csv_file = <span class="string">&#x27;datas.csv&#x27;</span></span><br><span class="line"></span><br><span class="line">csv = <span class="built_in">open</span>(csv_file,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">20</span>):</span><br><span class="line">    csv.write(<span class="built_in">str</span>(i) + <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">10</span> == <span class="number">0</span>:</span><br><span class="line">        csv.write(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">csv.close()</span><br><span class="line"></span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(csv_file,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        linelist = line.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        linelist.pop()<span class="comment"># delete: \n</span></span><br><span class="line">        <span class="keyword">for</span> index, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(linelist):</span><br><span class="line">            result.append(<span class="built_in">int</span>(item))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\nResult is \n&#x27;</span> , result)</span><br></pre></td></tr></table></figure></p>
<p>输出：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Result is</span><br><span class="line"> [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]</span><br></pre></td></tr></table></figure></p>
<h3 id="检查目录是否存在"><a href="#检查目录是否存在" class="headerlink" title="检查目录是否存在"></a>检查目录是否存在</h3><p>若目标目录不存在，则新建一个目录<br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">json_dir = <span class="string">&quot;../dir_json/2017-04/&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(json_dir):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;json dir not found&quot;</span>)</span><br><span class="line">    os.makedirs(json_dir)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Create dir  &quot;</span> + json_dir)</span><br></pre></td></tr></table></figure></p>
<h3 id="写文件时指定格式"><a href="#写文件时指定格式" class="headerlink" title="写文件时指定格式"></a>写文件时指定格式</h3><p>参考下面的代码，打开文件时指定utf8，转换成json时指定<code>ensure_ascii=False</code><br><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">json_file = <span class="built_in">open</span>(json_dir + <span class="built_in">id</span> + <span class="string">&#x27;.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">json_file.write(json.dumps(data_dict, ensure_ascii=<span class="literal">False</span>))</span><br></pre></td></tr></table></figure><br>避免写成的json文件乱码</p>
<h3 id="函数-enumerate-iterable-start-0"><a href="#函数-enumerate-iterable-start-0" class="headerlink" title="函数 enumerate(iterable, start=0)"></a>函数 enumerate(iterable, start=0)</h3><p>返回一个enumerate对象。iterable必须是一个句子，迭代器或者支持迭代的对象。</p>
<p>enumerate示例1：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; data = [1,2,3]</span><br><span class="line">&gt;&gt;&gt; for i, item in enumerate(data):</span><br><span class="line">	print(i,item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0 1</span><br><span class="line">1 2</span><br><span class="line">2 3</span><br></pre></td></tr></table></figure><br>示例2：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; line = &#x27;one&#x27;</span><br><span class="line">&gt;&gt;&gt; for i, item in enumerate(line,4):</span><br><span class="line">	print(i,item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4 o</span><br><span class="line">5 n</span><br><span class="line">6 e</span><br></pre></td></tr></table></figure><br>参考： <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/functions.html?highlight=enumerate#enumerate">https://docs.python.org/3/library/functions.html?highlight=enumerate#enumerate</a></p>
<h3 id="class-int-x-0"><a href="#class-int-x-0" class="headerlink" title="class int(x=0)"></a>class int(x=0)</h3><p>class int(x, base=10)<br>返回一个Integer对象。对于浮点数，会截取成整数。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print(int(&#x27;-100&#x27;),int(&#x27;0&#x27;),int(&#x27;3&#x27;))</span><br><span class="line">-100 0 3</span><br><span class="line">&gt;&gt;&gt; int(7788)</span><br><span class="line">7788</span><br><span class="line">&gt;&gt;&gt; int(7.98)</span><br><span class="line">7</span><br><span class="line">&gt;&gt;&gt; int(&#x27;2.33&#x27;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;pyshell#27&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">    int(&#x27;2.33&#x27;)</span><br><span class="line">ValueError: invalid literal for int() with base 10: &#x27;2.33&#x27;</span><br></pre></td></tr></table></figure></p>
<h2 id="读取binary文件"><a href="#读取binary文件" class="headerlink" title="读取binary文件"></a>读取binary文件</h2><p>逐个byte读取，注意用<code>b&#39;&#39;</code>来判断是否读到文件尾部<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_bin_to_csv</span>(<span class="params">bin_file_path, csv_file_path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(bin_file_path):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Binary file is not exist! &quot;</span> + bin_file_path)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(bin_file_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> bin_f:</span><br><span class="line">        cur_byte = bin_f.read(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">while</span> cur_byte != <span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">            <span class="comment"># Do stuff with byte.</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">int</span>.from_bytes(cur_byte, byteorder=<span class="string">&#x27;big&#x27;</span>, signed=<span class="literal">True</span>))</span><br><span class="line">            cur_byte = bin_f.read(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p>
<p>读取到的byte可以转换为int，<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/stdtypes.html#int.from_bytes">参考文档</a></p>
<p>这里 <code>cur_byte</code> 类似于 <code>b&#39;\x08&#39;</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">int</span>.from_bytes(cur_byte, byteorder=<span class="string">&#x27;big&#x27;</span>, signed=<span class="literal">True</span>))</span><br></pre></td></tr></table></figure></p>
<h3 id="从bin中读取数据并存入CSV文件中"><a href="#从bin中读取数据并存入CSV文件中" class="headerlink" title="从bin中读取数据并存入CSV文件中"></a>从bin中读取数据并存入CSV文件中</h3><p>先从bin中读取byte，规定好几个字节凑成1个数字。<br>按每行一个数字的格式写入CSV文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_bin_to_csv</span>(<span class="params">bin_file_path, csv_file_path, byte_count=<span class="number">1</span>, byte_order=<span class="string">&#x27;big&#x27;</span>, digit_signed=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(bin_file_path):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Binary file is not exist! &quot;</span> + bin_file_path)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(csv_file_path, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> csv_f:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(bin_file_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> bin_f:</span><br><span class="line">            cur_byte = bin_f.read(byte_count)</span><br><span class="line">            <span class="keyword">while</span> cur_byte != <span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">                csv_f.write(<span class="built_in">str</span>(<span class="built_in">int</span>.from_bytes(cur_byte, byteorder=byte_order, signed=digit_signed)) + <span class="string">&quot;,\n&quot;</span>)</span><br><span class="line">                cur_byte = bin_f.read(byte_count)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>bin存储的数据格式一定要商量好。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-08-02T00:08:16.000Z" title="2016/8/2 08:08:16">2016-08-02</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:39:12.416Z" title="2021/6/18 17:39:12">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">17 分钟读完 (大约2552个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/08/02/Android/NDK-use_sample_1/">Android NDK 示例-返回字符串，数组，Java对象；兼容性问题</a></p><div class="content"><p>Android Studio 2.2.3 创建工程 NDKProj</p>
<h3 id="工程准备"><a href="#工程准备" class="headerlink" title="工程准备"></a>工程准备</h3><p>在<code>SmartAlgorithm.java</code>中加载了库文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line">`-- com</span><br><span class="line">    `-- rustfisher</span><br><span class="line">        `-- ndkproj</span><br><span class="line">            |-- MainActivity.java</span><br><span class="line">            `-- SmartAlgorithm.java</span><br></pre></td></tr></table></figure><br>JNI目录，需要mk文件，头文件和源文件。这里头文件和源文件故意不统一文件名，也可实现效果。<br>但还是建议用同样的文件名，方便定位。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jni/</span><br><span class="line">|-- Android.mk</span><br><span class="line">|-- Application.mk</span><br><span class="line">|-- com_rustfisher_ndkproj_SmartAlgorithm.h</span><br><span class="line">`-- com_rustfisher_ndkproj_SmartAlgorithm_if_not_the_same.cpp</span><br></pre></td></tr></table></figure></p>
<h3 id="NDK返回值"><a href="#NDK返回值" class="headerlink" title="NDK返回值"></a>NDK返回值</h3><p>加载<code>SmartAlgorithm</code>；这个是统一标示。LOCAL_MODULE 与 APP_MODULES 均为此标示。<br>NDK中的方法要声明为native。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rustfisher.ndkproj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmartAlgorithm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;SmartAlgorithm&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">getMsg</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><strong>注意</strong>，Java文件生成头文件后，Java文件的路径不能轻易改动。</p>
<p>编写Android.mk文件；ABI 选择all，编译出支持多个平台的so文件。<br>填入源文件的文件名。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line">LOCAL_MODULE := SmartAlgorithm</span><br><span class="line">TARGET_ARCH_ABI := all</span><br><span class="line">LOCAL_SRC_FILES := com_rustfisher_ndkproj_SmartAlgorithm_if_not_the_same.cpp</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_SHARED_LIBRARY)</span></span><br></pre></td></tr></table></figure></p>
<p>编写Application.mk文件（网上copy来的）。同样ABI 选择all。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">APP_PLATFORM := android-16</span><br><span class="line">APP_MODULES := SmartAlgorithm</span><br><span class="line">APP_ABI := all</span><br><span class="line">APP_STL := stlport_static</span><br><span class="line">APP_CPPFLAGS += -fexceptions</span><br><span class="line"><span class="comment"># for using c++ features,you need to enable these in your Makefile</span></span><br><span class="line">APP_CPP_FEATURES += exceptions rtti</span><br></pre></td></tr></table></figure></p>
<p>修改工程build.gradle文件，添加jni的配置。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sourceSets</span> &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">        jni.srcDirs = []</span><br><span class="line">        jniLibs.srcDirs = [<span class="string">&#x27;src/main/libs&#x27;</span>]<span class="comment">// 指定so库的位置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译出头文件，得到 <code>com_rustfisher_ndkproj_SmartAlgorithm.h</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKProj/app/src/main/java</span><br><span class="line">javah com.rustfisher.ndkproj.SmartAlgorithm</span><br></pre></td></tr></table></figure>
<p>将头文件放到jni目录下，与源文件一起。</p>
<p>生成的头文件不要手动去修改，直接使用即可。<br><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class com_rustfisher_ndkproj_SmartAlgorithm */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _Included_com_rustfisher_ndkproj_SmartAlgorithm</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _Included_com_rustfisher_ndkproj_SmartAlgorithm</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_rustfisher_ndkproj_SmartAlgorithm</span></span><br><span class="line"><span class="comment"> * Method:    getMsg</span></span><br><span class="line"><span class="comment">* Signature: ()Ljava/lang/String;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_com_rustfisher_ndkproj_SmartAlgorithm_getMsg</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_rustfisher_ndkproj_SmartAlgorithm</span></span><br><span class="line"><span class="comment"> * Method:    add</span></span><br><span class="line"><span class="comment">* Signature: (II)I</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_rustfisher_ndkproj_SmartAlgorithm_add</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject, jint, jint)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>编写源文件，实现头文件中的方法。一个是返回字符串，一个是加法。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;com_rustfisher_ndkproj_SmartAlgorithm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Already define in com_rustfisher_ndkproj_SmartAlgorithm.h, no need to extern C here.</span></span><br><span class="line"><span class="comment">extern &quot;C&quot; &#123;</span></span><br><span class="line"><span class="comment">    JNIEXPORT jstring JNICALL Java_com_rustfisher_ndkproj_SmartAlgorithm_getMsg(JNIEnv *env, jobject obj);</span></span><br><span class="line"><span class="comment">    JNIEXPORT jint JNICALL Java_com_rustfisher_ndkproj_SmartAlgorithm_add(JNIEnv *env, jobject obj, jint a, jint b);</span></span><br><span class="line"><span class="comment">&#125;;*/</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_com_rustfisher_ndkproj_SmartAlgorithm_getMsg</span><span class="params">(JNIEnv *env, jobject obj)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">&quot;Hello from the JNI.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_rustfisher_ndkproj_SmartAlgorithm_add</span><span class="params">(JNIEnv *env, jobject obj, jint a, jint b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;<span class="comment">//*</span></span><br></pre></td></tr></table></figure></p>
<p>然后在命令行 ndk-build。这里是win7下的Cygwin。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKProj/app/src/main/jni</span><br><span class="line">$ ndk-build.cmd</span><br><span class="line">[all] Compile++      : SmartAlgorithm &lt;= com_rustfisher_ndkproj_SmartAlgorithm_if_not_the_same.cpp</span><br><span class="line">[all] SharedLibrary  : libSmartAlgorithm.so</span><br><span class="line">[all] Install        : libSmartAlgorithm.so =&gt; libs/arm64-v8a/libSmartAlgorithm.so</span><br><span class="line"><span class="comment"># ...... 后面还有很多</span></span><br></pre></td></tr></table></figure></p>
<p>在libs目录下出现了对应的so库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKProj/app/src/main/libs</span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">|-- arm64-v8a</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- armeabi</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- armeabi-v7a</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- mips</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- mips64</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- x86</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">`-- x86_64</span><br><span class="line">    `-- libSmartAlgorithm.so</span><br><span class="line"></span><br><span class="line">7 directories, 7 files</span><br></pre></td></tr></table></figure></p>
<p>在MainActivity中调用这两个方法。<br>运行apk到机器上，查看log。发现调用成功。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.rustfisher.ndkproj D/MainActivity: onCreate: Hello from the JNI.</span><br><span class="line">com.rustfisher.ndkproj D/MainActivity: onCreate: 3</span><br></pre></td></tr></table></figure>
<h3 id="处理数组的方法"><a href="#处理数组的方法" class="headerlink" title="处理数组的方法"></a>处理数组的方法</h3><p>1.不要直接操作输入的数组；<br>2.注意释放本地引用，防止溢出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">short</span>[] getConvertedArray(<span class="type">short</span>[] data, <span class="type">int</span> dataLen);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jshortArray JNICALL <span class="title">Java_com_rustfisher_ndkproj_SmartAlgorithm_getConvertedArray</span><span class="params">(JNIEnv *env, jobject obj, jshortArray input, jint len)</span> </span>&#123;</span><br><span class="line">    jshort* inputPtr;</span><br><span class="line">    inputPtr = env-&gt;<span class="built_in">GetShortArrayElements</span>(input,<span class="number">0</span>);<span class="comment">// 直接操作指针会改变Android Dalvik中的值</span></span><br><span class="line">    jshort* resPtr;</span><br><span class="line">    jshortArray result;</span><br><span class="line">    result = env-&gt;<span class="built_in">NewShortArray</span>(len);<span class="comment">// 创建新的数组</span></span><br><span class="line">    resPtr = env-&gt;<span class="built_in">GetShortArrayElements</span>(result,<span class="number">0</span>);<span class="comment">// 指针</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(jint i = <span class="number">0</span>;i &lt; len;i++) &#123;</span><br><span class="line">        resPtr[i] = inputPtr[i] * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseShortArrayElements</span>(input, inputPtr, <span class="number">0</span>);<span class="comment">// 释放本地引用</span></span><br><span class="line">    env-&gt;<span class="built_in">SetShortArrayRegion</span>(result,<span class="number">0</span>,len,resPtr);     <span class="comment">// 存入数据</span></span><br><span class="line">    env-&gt;<span class="built_in">ReleaseShortArrayElements</span>(result, resPtr, <span class="number">0</span>); <span class="comment">// 释放本地引用</span></span><br><span class="line">    <span class="keyword">return</span> result;<span class="comment">// 返回结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JNI层-unsigned-char-与-jbyte-数组转换"><a href="#JNI层-unsigned-char-与-jbyte-数组转换" class="headerlink" title="JNI层 unsigned char 与 jbyte 数组转换"></a>JNI层 unsigned char 与 jbyte 数组转换</h3><p>本例说明的是unsigned char 与 jbyte之间互相转换<br>注意方法：<code>(*env)-&gt;SetByteArrayRegion(env, jbyte_arr, 0, len, uc_ptr);</code><br>java代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] getByteArrayFromJNI() &#123;</span><br><span class="line">    <span class="keyword">return</span> nativeGetByteArray();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] byteArrayTravelJNI(<span class="type">byte</span>[] input) &#123;</span><br><span class="line">    <span class="keyword">return</span> nativeSendByteArray(input, input.length);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">byte</span>[] nativeGetByteArray(); <span class="comment">// 从JNI中获取byte数组</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输入byte数组，在JNI中转换后再获取回来</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">byte</span>[] nativeSendByteArray(<span class="type">byte</span>[] input, <span class="type">int</span> len);</span><br></pre></td></tr></table></figure></p>
<p>JNI C代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// return byte array from unsigned char array.  jbytes:  1 2 0 7f 80 81 ff 0 1</span></span><br><span class="line">JNIEXPORT jbyteArray JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_NDKUtils_nativeGetByteArray</span><span class="params">(JNIEnv *env, jobject jObj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> uc_arr[] = &#123;<span class="number">1</span>, <span class="number">-2</span>, <span class="number">0</span>, <span class="number">127</span>, <span class="number">128</span>, <span class="number">129</span>, <span class="number">255</span>, <span class="number">256</span>, <span class="number">257</span>&#125;;</span><br><span class="line">    <span class="type">int</span> uc_arr_len = <span class="keyword">sizeof</span>(uc_arr) / <span class="keyword">sizeof</span>(uc_arr[<span class="number">0</span>]);</span><br><span class="line">    jbyte byte_array[uc_arr_len];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;i &lt; uc_arr_len; i++) &#123;</span><br><span class="line">        byte_array[i] = uc_arr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    jbyteArray jbyte_arr = (*env)-&gt;NewByteArray(env, uc_arr_len);</span><br><span class="line">    (*env)-&gt;SetByteArrayRegion(env, jbyte_arr, <span class="number">0</span>, uc_arr_len, byte_array);</span><br><span class="line">    <span class="keyword">return</span> jbyte_arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jbyte -&gt; unsigned char -&gt; jbyte</span></span><br><span class="line">JNIEXPORT jbyteArray JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_NDKUtils_nativeSendByteArray</span></span><br><span class="line">    <span class="params">(JNIEnv *env, jobject jObj, jbyteArray input_byte_arr, jint input_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> len = (<span class="type">int</span>)input_len;</span><br><span class="line">    jbyte *jbyte_ptr = (*env)-&gt;GetByteArrayElements(env, input_byte_arr, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *uc_ptr = (<span class="type">unsigned</span> <span class="type">char</span> *)jbyte_ptr;</span><br><span class="line"></span><br><span class="line">    jbyteArray jbyte_arr = (*env)-&gt;NewByteArray(env, len);</span><br><span class="line">    jbyte byte_array[input_len];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;i &lt; input_len; i++) &#123;</span><br><span class="line">        byte_array[i] = uc_ptr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    (*env)-&gt;SetByteArrayRegion(env, jbyte_arr, <span class="number">0</span>, len, byte_array);</span><br><span class="line">    (*env)-&gt;ReleaseByteArrayElements(env, input_byte_arr, jbyte_ptr, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> jbyte_arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于<code>SetByteArrayRegion</code>这个方法<br>方法说明：<code>void SetXxxArrayRegion(JNIEnv *env, jarray array, jint start, jint length, Xxx elems[])</code><br>将C数组的元素复制到Java数组中。注意最后一个参数要和前面的对应上。</p>
<p><code>void ReleaseXxxArrayElements(JNIEnv *env, jarray array, Xxx elems[], jint mode)</code><br>通知虚拟机通过GetXxxArrayElements获得的一个指针已经不再需要了。Mode是0，更新数组<br>元素后释放elems缓存。</p>
<p>在这里遇到过一个bug，同样的代码在armeabi上正常运行，但是到了v7a或v8a平台上就闪退。<br>使用<code>SetXxxArrayRegion</code>这个方法时，传入的参数一定要和方法名中的<code>Xxx</code>对应上<br>详细可以参考<em>Core Java</em>中的Java Native和Android Develop上关于abi的解释</p>
<p>测试调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NDKUtils</span> <span class="variable">ndkUtils</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NDKUtils</span>();</span><br><span class="line"><span class="type">byte</span>[] res = ndkUtils.getByteArrayFromJNI(); <span class="comment">// 从JNI中获取byte数组</span></span><br><span class="line">logBytes(res);</span><br><span class="line">Log.d(TAG, <span class="string">&quot;-------------------------------------------------------------&quot;</span>);</span><br><span class="line"><span class="type">byte</span>[] inputBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">127</span>, (<span class="type">byte</span>) <span class="number">128</span>, (<span class="type">byte</span>) <span class="number">255</span>, -<span class="number">120</span>&#125;;</span><br><span class="line"><span class="type">byte</span>[] tRes = ndkUtils.byteArrayTravelJNI(inputBytes); <span class="comment">// 让byte数组在JNI中旅游一圈</span></span><br><span class="line">logBytes(inputBytes);</span><br><span class="line">logBytes(tRes);</span><br></pre></td></tr></table></figure></p>
<p>输出<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bytes:  1 2 0 7f 80 81 ff 0 1 </span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">bytes:  1 2 7f 80 ff 88 </span><br><span class="line">bytes:  1 2 7f 80 ff 88 </span><br></pre></td></tr></table></figure></p>
<h3 id="直接操作输入的数组"><a href="#直接操作输入的数组" class="headerlink" title="直接操作输入的数组"></a>直接操作输入的数组</h3><p>以int数组为例<br>输入一个数组后，获取数组然后直接改变数组中的元素，最后释放掉本地引用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT <span class="type">void</span> JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_NDKUtils_nativeModifyArray</span></span><br><span class="line">  <span class="params">(JNIEnv *env, jobject jObj, jintArray input_arr, jint input_len)</span> &#123;</span><br><span class="line">    <span class="type">int</span> * input_ptr = (*env)-&gt;GetIntArrayElements(env, input_arr, <span class="number">0</span>);</span><br><span class="line">    input_ptr[input_len - <span class="number">1</span>] =  input_ptr[input_len - <span class="number">1</span>] - <span class="number">1</span>;</span><br><span class="line">    (*env)-&gt;ReleaseIntArrayElements(env, input_arr, input_ptr, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NDKUtils</span> <span class="variable">moUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NDKUtils</span>();</span><br><span class="line"><span class="type">int</span>[] origin = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;;</span><br><span class="line">Log.d(TAG, <span class="string">&quot;origin before: &quot;</span> + Arrays.toString(origin));</span><br><span class="line">moUtil.modifyArray(origin);</span><br><span class="line">Log.d(TAG, <span class="string">&quot;origin after:  &quot;</span> + Arrays.toString(origin));</span><br></pre></td></tr></table></figure>
<p>观察输出可以看出，输入的数组直接被改变了<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">origin before: [1, 2, 3, 4, 5, 6, 7]</span><br><span class="line">origin after:  [1, 2, 3, 4, 5, 6, 6]</span><br></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_com_rustfisher_face_1detect_1lib_CalHelper_cvtNV21</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *env, jclass jcls, jbyteArray input_arr,jint in_arr_len,</span></span></span><br><span class="line"><span class="params"><span class="function">   jbyteArray target_arr, jint nv21_size, jint y_size, jint yuv_gap)</span> </span>&#123;</span><br><span class="line">    jbyte *in_ptr = env-&gt;<span class="built_in">GetByteArrayElements</span>(input_arr, <span class="literal">false</span>);</span><br><span class="line">    jbyte *target_ptr = env-&gt;<span class="built_in">GetByteArrayElements</span>(target_arr, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = y_size; i &lt; nv21_size; i+=<span class="number">2</span>)&#123;</span><br><span class="line">        target_ptr[i] = in_ptr[i + yuv_gap + <span class="number">1</span>];</span><br><span class="line">        target_ptr[i + <span class="number">1</span>] = in_ptr[i + yuv_gap];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="返回Java对象"><a href="#返回Java对象" class="headerlink" title="返回Java对象"></a>返回Java对象</h3><p>NDK中可以创建Java对象并返回。<br>例如我们新建一个<code>JavaUser</code>类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaUser</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JavaUser</span><span class="params">(<span class="type">int</span> age, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name + <span class="string">&quot;, &quot;</span> + age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>native方法返回一个JavaUser对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NDKUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;NDKMan&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JavaUser <span class="title function_">createUser</span><span class="params">(<span class="type">int</span> age, String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nativeGetUser(age, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> JavaUser <span class="title function_">nativeGetUser</span><span class="params">(<span class="type">int</span> age, String name)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>c文件实现代码。注意参数签名的写法，要参照标准。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jobject JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_NDKUtils_nativeGetUser</span></span><br><span class="line">    <span class="params">(JNIEnv *env, jobject jObj, jint age, jstring name)</span></span><br><span class="line">&#123;</span><br><span class="line">    jclass userClass = (*env)-&gt;FindClass(env, <span class="string">&quot;com/rustfisher/ndkalgo/JavaUser&quot;</span>);</span><br><span class="line">    jmethodID userConstruct = (*env)-&gt;GetMethodID(env, userClass, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(ILjava/lang/String;)V&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;NewObject(env, userClass, userConstruct, age, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用native方法生成对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testJavaUserNDK</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">NDKUtils</span> <span class="variable">ndkUtils</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NDKUtils</span>();</span><br><span class="line">    <span class="type">JavaUser</span> <span class="variable">tom</span> <span class="operator">=</span> ndkUtils.createUser(<span class="number">20</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">    Log.d(TAG, tom.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="NDK兼容性问题"><a href="#NDK兼容性问题" class="headerlink" title="NDK兼容性问题"></a>NDK兼容性问题</h3><p>Vivo x6plus 兼容性问题。Vivo x6plus 打开Parrot界面即崩溃。但是Parrot官方APP能够正常使用。<br>我自己的so库与Parrot的so库不兼容，出现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java.lang.UnsatisfiedLinkError:</span><br><span class="line">dalvik.system.PathClassLoader[DexPathList[[zip file &quot;/data/app/com.xx.xx.xxx-1/base.apk&quot;],nativeLibraryDirectories=[/data/app/com.xx.xx.xxx-1/lib/arm64, /vendor/lib64, /system/lib64]]] couldn&#x27;t find &quot;libjson.so&quot;</span><br><span class="line">    at java.lang.Runtime.loadLibrary(Runtime.java:366)</span><br><span class="line">    at java.lang.System.loadLibrary(System.java:988)</span><br><span class="line">    at com.parrot.arsdk.ARSDK.loadSDKLibs(ARSDK.java:20)</span><br><span class="line">    at com.parrot.sdk.activity.DronesListActivity.&lt;clinit&gt;(DronesListActivity.java:44)</span><br><span class="line">    at java.lang.reflect.Constructor.newInstance(Native Method)</span><br></pre></td></tr></table></figure>
<h4 id="分析处理兼容性问题"><a href="#分析处理兼容性问题" class="headerlink" title="分析处理兼容性问题"></a>分析处理兼容性问题</h4><p>将Parrot官方apk解包后，找到so库文件。发现只有x86、mips、armeabi_v7a、armeabi 这4个。<br>而我加载了有更多的库。</p>
<p>将我自己的so文件删除至只剩下Parrot那4个即可。</p>
<p>Android.mk<br><code>TARGET_ARCH_ABI := x86 mips armeabi armeabi-v7a</code></p>
<h3 id="同名so文件引起UnsatisfiedLinkError"><a href="#同名so文件引起UnsatisfiedLinkError" class="headerlink" title="同名so文件引起UnsatisfiedLinkError"></a>同名so文件引起UnsatisfiedLinkError</h3><p>主工程<code>app</code>中带有C工程与so文件。现需要将所有的C工程移到新的模块<code>mylib</code>中。</p>
<p>新建模块<code>mylib</code>，将C工程复制进来。gradle中配置jni，因为修改了文件路径，重新生成头文件并修改cpp文件。<br>在模块中进行ndk-build，获得so库。</p>
<p>安装运行app，出现UnsatisfiedLinkError：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.UnsatisfiedLinkError: No implementation found for void com.xx.jni.MyJNI.init(java.lang.String) </span><br><span class="line">(tried Java_com_xx_jni_MyJNI_init and Java_com_xx_jni_MyJNI_init__Ljava_lang_String_2)</span><br></pre></td></tr></table></figure><br>分析原因，app能够正常加载库文件，但未找到实现方法。app使用的so库，究竟是不是我们指定的那个。</p>
<p>尝试进行修复，原app工程的<code>Android.mk</code>中<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE := main</span><br></pre></td></tr></table></figure><br>移动到模块后，新的<code>Android.mk</code>修改为<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE := mynewmain</span><br></pre></td></tr></table></figure><br>库改了名字后，修改Java代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    System.loadLibrary(<span class="string">&quot;mynewmain&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>重装app即可正常使用。</p>
<p>经过分析与尝试，删除原app工程中所有的so文件，再次重装app即可正常运行。不需要修改so库的名字。</p>
<p>错误原因猜想：app主工程与模块<code>mylib</code>中有同名的so文件，安装app时会优先使用app主工程中的so库。</p>
<h3 id="jstring转为char的方法-jstring-gt-char"><a href="#jstring转为char的方法-jstring-gt-char" class="headerlink" title="jstring转为char的方法 jstring -&gt; char"></a>jstring转为char的方法 jstring -&gt; char</h3><p>jstring转为char的方法<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span> *<span class="title">jstringToChar</span><span class="params">(JNIEnv *env, jstring jstr)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> *rtn = <span class="literal">NULL</span>;</span><br><span class="line">    jclass clsstring = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    jstring strencode = env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">    jmethodID mid = env-&gt;<span class="built_in">GetMethodID</span>(clsstring, <span class="string">&quot;getBytes&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)[B&quot;</span>);</span><br><span class="line">    jbyteArray barr = (jbyteArray) env-&gt;<span class="built_in">CallObjectMethod</span>(jstr, mid, strencode);</span><br><span class="line">    jsize alen = env-&gt;<span class="built_in">GetArrayLength</span>(barr);</span><br><span class="line">    jbyte *ba = env-&gt;<span class="built_in">GetByteArrayElements</span>(barr, JNI_FALSE);</span><br><span class="line">    <span class="keyword">if</span> (alen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        rtn = (<span class="type">char</span> *) <span class="built_in">malloc</span>(alen + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(rtn, ba, alen);</span><br><span class="line">        rtn[alen] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseByteArrayElements</span>(barr, ba, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> rtn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考 <a target="_blank" rel="noopener" href="https://blog.csdn.net/xlxxcc/article/details/51106721">JNI中string 、 char* 和 jstring 两种转换 - CSDN xlxxcc</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-06-14T07:08:16.000Z" title="2016/6/14 15:08:16">2016-06-14</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:39:14.845Z" title="2021/6/18 17:39:14">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">11 分钟读完 (大约1719个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/06/14/Android/NDK-use_sample_2/">Android NDK 初步</a></p><div class="content"><ul>
<li>开发环境： win7 64，Android Studio 2.1</li>
</ul>
<p>需要工具：NDK，Cygwin</p>
<h3 id="使用adb查看手机CPU架构信息"><a href="#使用adb查看手机CPU架构信息" class="headerlink" title="使用adb查看手机CPU架构信息"></a>使用adb查看手机CPU架构信息</h3><p>将手机通过USB连接到电脑，adb shell进入手机根目录，执行<code>cat /proc/cpuinfo</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">shell@hnCHE-H:/ $ cat /proc/cpuinfo</span><br><span class="line">cat /proc/cpuinfo</span><br><span class="line">Processor       : AArch64 Processor rev 3 (aarch64)</span><br><span class="line">processor       : 0</span><br><span class="line">processor       : 1</span><br><span class="line">processor       : 2</span><br><span class="line">processor       : 3</span><br><span class="line">processor       : 4</span><br><span class="line">processor       : 5</span><br><span class="line">processor       : 6</span><br><span class="line">processor       : 7</span><br><span class="line">Features        : fp asimd evtstrm aes pmull sha1 sha2 crc32</span><br><span class="line">CPU implementer : 0x41</span><br><span class="line">CPU architecture: AArch64</span><br><span class="line">CPU variant     : 0x0</span><br><span class="line">CPU part        : 0xd03</span><br><span class="line">CPU revision    : 3</span><br><span class="line"></span><br><span class="line">Hardware        : hi6210sft</span><br></pre></td></tr></table></figure><br>可以看到手机处理器的信息</p>
<h3 id="使用-SDK-Manager-配置安装-NDK"><a href="#使用-SDK-Manager-配置安装-NDK" class="headerlink" title="使用 SDK Manager 配置安装 NDK"></a>使用 SDK Manager 配置安装 NDK</h3><p>添加系统环境变量 <code>G:\SDK\ndk-bundle;G:\SDK\platform-tools</code></p>
<p>下载并安装Cygwin：<a target="_blank" rel="noopener" href="https://cygwin.com/install.html">https://cygwin.com/install.html</a></p>
<p>Cygwin 安装NDK需要的工具包（如果第一次安装时没有选择工具包，可以再次启动安装）：<br>make, gcc, gdb, mingw64-x86_64-gcc, binutils<br><img src="https://raw.githubusercontent.com/RustFisher/RustNotes/master/Android_note/pics/Cygwin_tools.png" alt="tools"></p>
<p>配置<code>G:\soft\Cygwin\home\Administrator\.bashrc</code>，添加下面的指令，使用英文界面。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LANG=&#x27;en_US&#x27;</span><br><span class="line">export LC_ALL=&#x27;en_US.GBK&#x27;</span><br></pre></td></tr></table></figure><br>配置text选项，在option里的text可设置。<br>可以在<code>G:\soft\Cygwin\home\Administrator\.minttyrc</code>中看到。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Locale=zh_CN</span><br><span class="line">Charset=GBK</span><br></pre></td></tr></table></figure>
<p>设置完字体后可以避免中文乱码。</p>
<p>配置 <code>G:\soft\Cygwin\home\Administrator\.bash_profile</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NDK=/cygdrive/G/SDK/ndk-bundle/ndk-build.cmd</span><br><span class="line">export NDK</span><br></pre></td></tr></table></figure>
<p>在Cygwin中查找NDK位置，可以看到在SDK目录里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/soft/Cygwin/home/Administrator</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$NDK</span></span><br><span class="line">/cygdrive/G/SDK/ndk-bundle/ndk-build.cmd</span><br></pre></td></tr></table></figure>
<h3 id="操作示例NDK工程"><a href="#操作示例NDK工程" class="headerlink" title="操作示例NDK工程"></a>操作示例NDK工程</h3><p><em>JDK10已经不提供<code>javah</code>这个工具了，我们可以使用as支持c++的功能；详情见下文</em></p>
<p>生成一次试试。从github上获取android-ndk-android-mk，进入hello-jni工程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/android-ndk-android-mk/hello-jni</span><br><span class="line">$ ndk-build.cmd</span><br><span class="line"><span class="comment"># 输出很多信息</span></span><br></pre></td></tr></table></figure>
<p>编译成功后，自动生成一个libs目录，编译生成的.so文件放在里面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKTest/app/src/main</span><br><span class="line">$ ndk-build.cmd</span><br><span class="line">[armeabi] Install        : librust_ndk.so =&gt; libs/armeabi/librust_ndk.so</span><br><span class="line"># 进入java目录，编译.h文件</span><br><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKTest/app/src/main/java</span><br><span class="line">$ javah com.rustfisher.ndktest.HelloJNI</span><br><span class="line"># 会生成一个.h文件</span><br></pre></td></tr></table></figure>
<p>将它复制到jni文件夹下；这个就是JNI层的代码。</p>
<p>Ubuntu下javah报错。需要添加参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javah -cp /home/rust/Android/Sdk/platforms/android-25/android.jar:. com.example.LibUtil</span><br></pre></td></tr></table></figure>
<h3 id="使用C-C-实现JNI"><a href="#使用C-C-实现JNI" class="headerlink" title="使用C/C++实现JNI"></a>使用C/C++实现JNI</h3><p>遇到错误： Error:Execution failed for task ‘:app:compileDebugNdk’.</p>
<blockquote>
<p>Error: NDK integration is deprecated in the current plugin.  Consider trying the new experimental plugin.  For details, see <a target="_blank" rel="noopener" href="http://tools.android.com/tech-docs/new-build-system/gradle-experimental">http://tools.android.com/tech-docs/new-build-system/gradle-experimental</a>.  Set “android.useDeprecatedNdk=true” in gradle.properties to continue using the current NDK integration.</p>
</blockquote>
<p>解决办法：在<code>app\build.gradle</code>文件中添加<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sourceSets.main &#123;</span><br><span class="line">    jniLibs.srcDir &#x27;src/main/libs&#x27;</span><br><span class="line">    jni.srcDirs = [] //disable automatic ndk-build call</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>文件有3种：接口文件<code>.h</code>； 实现文件<code>.c</code>，注意与前面的<code>.h</code>文件同名； <code>.h</code>与<code>.c</code>生成的库文件<code>.so</code></p>
<h3 id="操作步骤小结"><a href="#操作步骤小结" class="headerlink" title="操作步骤小结"></a>操作步骤小结</h3><p>From Java to C/C++<br>Step 1 定义Java接口文件，里面定义好native方法。<br>Step 2 javah生成.h接口文件 。<br>Step 3 复制.h文件的文件名，编写C/C++文件。注意要实现.h中的接口。  </p>
<h3 id="NDK遇到的问题与注意事项"><a href="#NDK遇到的问题与注意事项" class="headerlink" title="NDK遇到的问题与注意事项"></a>NDK遇到的问题与注意事项</h3><h4 id="文件关联问题"><a href="#文件关联问题" class="headerlink" title="文件关联问题"></a>文件关联问题</h4><p>写cpp源文件的时候，忘记include头文件。产生<code>java.lang.UnsatisfiedLinkError: No implementation found for</code> 之类的错误<br>stackoverflow上有关于<code>Android NDK C++ JNI (no implementation found for native…)</code>的问题。</p>
<h4 id="NDK本地对象数量溢出问题-Local-ref-table-overflow"><a href="#NDK本地对象数量溢出问题-Local-ref-table-overflow" class="headerlink" title="NDK本地对象数量溢出问题 Local ref table overflow"></a>NDK本地对象数量溢出问题 <code>Local ref table overflow</code></h4><p>NDK本地只允许持有512个本地对象，return后会销毁这些对象。必须注意，在循环中创建的本地对象要在使用后销毁掉。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;<span class="built_in">DeleteLocalRef</span>(local_ref);<span class="comment">// local_ref 是本地创建的对象</span></span><br></pre></td></tr></table></figure>
<h4 id="调用Java方法时，注意指定返回值"><a href="#调用Java方法时，注意指定返回值" class="headerlink" title="调用Java方法时，注意指定返回值"></a>调用Java方法时，注意指定返回值</h4><p><code>env-&gt;CallBooleanMethod(resArrayList,arrayList_add, javaObject);</code> ArrayList的add方法返回Boolean</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html">https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html</a></p>
<h4 id="C-调用C方法"><a href="#C-调用C方法" class="headerlink" title="C++调用C方法"></a>C++调用C方法</h4><p>C++文件中，需要调用C里面的方法。如果未经任何处理，会出现无引用错误<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: undefined reference to &#x27;......</span><br></pre></td></tr></table></figure></p>
<p>因此在C++文件中涉及到C方法，需要声明。<br>例如<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;c_file_header.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// ___ 结束声明</span></span><br></pre></td></tr></table></figure></p>
<p>javah生成的JNI头文件中也有extern，可作为参考</p>
<h3 id="NDK中使用logcat"><a href="#NDK中使用logcat" class="headerlink" title="NDK中使用logcat"></a>NDK中使用logcat</h3><p>配置：Cygwin， NDK 14.1…<br>可以在NDK中使用logcat，方便调试<br>需要在mk文件中添加<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_LDLIBS := -L$(SYSROOT)/usr/lib -llog</span><br></pre></td></tr></table></figure></p>
<p>代码中添加头文件，即可调用logcat的方法<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG    <span class="string">&quot;rustApp&quot;</span></span></span><br><span class="line"></span><br><span class="line">__android_log_write(ANDROID_LOG_VERBOSE, LOG_TAG, <span class="string">&quot;My Log&quot;</span>);</span><br></pre></td></tr></table></figure></p>
<p>此时编译出现了错误：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">G:/SDK/ndk-bundle/build//../toolchains/x86_64-4.9/prebuilt/windows-x86_64/lib/gcc/x86_64-linux-android/4.9.x/../../../../x86_64-linux-android/bin\ld: warning: skipping incompatible G:/SDK/ndk-bundle/build//../platforms/android-21/arch-x86_64/usr/lib/libc.a while searching for c</span><br><span class="line">G:/SDK/ndk-bundle/build//../toolchains/x86_64-4.9/prebuilt/windows-x86_64/lib/gcc/x86_64-linux-android/4.9.x/../../../../x86_64-linux-android/bin\ld: error: treating warnings as errors</span><br><span class="line">clang++.exe: error: linker command failed with exit code 1 (use -v to see invocation)</span><br><span class="line">make: *** [G:/openSourceProject/NDKAlgo/app/src/main/obj/local/x86_64/libNDKMan.so] Error 1</span><br></pre></td></tr></table></figure></p>
<p>出现了<code>error: treating warnings as errors</code><br>处理方法，在mk文件中添加<code>LOCAL_DISABLE_FATAL_LINKER_WARNINGS=true</code><br>再次编译即可</p>
<p>我们可以使用宏定义简化打log的写法<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG    <span class="string">&quot;rustApp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGV(...) __android_log_write(ANDROID_LOG_VERBOSE, LOG_TAG, __VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG , LOG_TAG, __VA_ARGS__)  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO , LOG_TAG, __VA_ARGS__)  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGW(...) __android_log_print(ANDROID_LOG_WARN , LOG_TAG, __VA_ARGS__)  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR , LOG_TAG, __VA_ARGS__)  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">LOGV(<span class="string">&quot;This is my log&quot;</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="Android-Studio-3-为library-module添加C-支持"><a href="#Android-Studio-3-为library-module添加C-支持" class="headerlink" title="Android Studio 3 为library module添加C++支持"></a>Android Studio 3 为library module添加C++支持</h3><p>as在新建project的时候可以选择支持C++，可以新建一个支持C++的项目来参考。<br>可以不用自己javah来生成头文件。</p>
<p>在工程中新建android library，将<code>CMakeLists.txt</code>添加到模块中。这里模块名是<code>native-lib</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.4.1)</span><br><span class="line"></span><br><span class="line">add_library( # Sets the name of the library.</span><br><span class="line">             native-lib</span><br><span class="line"></span><br><span class="line">             # Sets the library as a shared library.</span><br><span class="line">             SHARED</span><br><span class="line"></span><br><span class="line">             # Provides a relative path to your source file(s).</span><br><span class="line">             src/main/cpp/native-lib.cpp</span><br><span class="line">             src/main/cpp/imagetool.cpp)</span><br><span class="line"></span><br><span class="line">find_library( # Sets the name of the path variable.</span><br><span class="line">              log-lib</span><br><span class="line"></span><br><span class="line">              # Specifies the name of the NDK library that</span><br><span class="line">              # you want CMake to locate.</span><br><span class="line">              log )</span><br><span class="line"></span><br><span class="line">target_link_libraries( # Specifies the target library.</span><br><span class="line">                       native-lib</span><br><span class="line"></span><br><span class="line">                       # Links the target library to the log library</span><br><span class="line">                       # included in the NDK.</span><br><span class="line">                       $&#123;log-lib&#125; )</span><br></pre></td></tr></table></figure></p>
<p>修改模块的<code>build.gradle</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion 26</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion 19</span><br><span class="line">        targetSdkVersion 26</span><br><span class="line">        versionCode 1</span><br><span class="line">        versionName &quot;1.0&quot;</span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</span><br><span class="line">        // 添加</span><br><span class="line">        externalNativeBuild &#123;</span><br><span class="line">            cmake &#123;</span><br><span class="line">                cppFlags &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled false</span><br><span class="line">            proguardFiles getDefaultProguardFile(&#x27;proguard-android.txt&#x27;), &#x27;proguard-rules.pro&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 添加</span><br><span class="line">    externalNativeBuild &#123;</span><br><span class="line">        cmake &#123;</span><br><span class="line">            path &quot;CMakeLists.txt&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新建Java文件和C++文件，大致目录如下<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line">|-- AndroidManifest.xml</span><br><span class="line">|-- cpp</span><br><span class="line">|   |-- imagetool.cpp   // cpp文件</span><br><span class="line">|   `-- native-lib.cpp</span><br><span class="line">|-- java</span><br><span class="line">|   `-- com</span><br><span class="line">|       `-- example</span><br><span class="line">|           `-- myclib</span><br><span class="line">|               `-- ImageDetect.java // Java文件</span><br><span class="line">`-- res</span><br></pre></td></tr></table></figure></p>
<p>ImageDetect.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageDetect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">inputPath</span><span class="params">(String path)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getOne</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>native-lib.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring</span></span><br><span class="line"><span class="function">JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_myclib_ImageDetect_stringFromJNI</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv *env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>)</span> </span>&#123;</span><br><span class="line">    std::string hello = <span class="string">&quot;In myclib Hello from C++&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jint</span></span><br><span class="line"><span class="function">JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_myclib_ImageDetect_getOne</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv *env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">9257</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>imagetool.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_myclib_ImageDetect_inputPath</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv *env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>jobj, jstring inputPath)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// just test</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译运行即可。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-05-16T14:11:01.000Z" title="2016/5/16 22:11:01">2016-05-16</time>发表</span><span class="level-item"><time dateTime="2020-01-11T08:43:35.967Z" title="2020/1/11 16:43:35">2020-01-11</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Design-pattern/">Design_pattern</a></span><span class="level-item">6 分钟读完 (大约882个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/05/16/DesignPattern/Listener_pattern_practice_in_Java_Android/">监听者模式 - 在Java与Android中的使用</a></p><div class="content"><p>监听者模式（观察者模式）能降低对象之间耦合程度。为两个相互依赖调用的类进行解耦。<br>便于进行模块化开发工作。不同模块的开发者可以专注于自身的代码。<br>监听者用来监听自已感兴趣的事件，当收到自已感兴趣的事件时执行自定义的操作。<br>在某些数据变化时，其他的类做出一些响应。处理数据（或者分发事件）的类主动投送消息，感兴趣的类主动“订阅”消息。</p>
<p>监听者模式在Android中有大量的运用，相信大家都不会感到陌生。在Android开发中，Button控件的点击事件就是监听者模式最常见的例子。<br>当Button被点击，执行了 <code>OnClickListener.onClick</code>。<br>Activity中给这个Button设置了自己实现的<code>OnClickListener</code>，并复写了<code>onClick</code>方法，就能执行自定义操作了。</p>
<h3 id="Java代码实例"><a href="#Java代码实例" class="headerlink" title="Java代码实例"></a>Java代码实例</h3><p>下面来用Java来实现监听者模式。<br>这个例子是给“计算类”持续地传入数据，处理好数据后，发出结果。感兴趣的类接收结果。<br>2个文件：<code>AlgoCalculator.java</code>；<code>MainUser.java</code>  </p>
<ul>
<li><code>AlgoCalculator.java</code>是计算部分，接收数据并进行计算。并将结果传递出去。</li>
<li><code>MainUser.java</code>是调用方，将基本数据传入AlgoCalculator并监听结果。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.algo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AlgoCalculator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="type">short</span>[]&gt; mDataBuffer = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AlgoCalculator</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个Listener接口；可将一个boolean值传递出去</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ResultChangeListener</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onChange</span><span class="params">(<span class="type">boolean</span> found)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ResultChangeListener resultChangeListener;</span><br><span class="line">    <span class="comment">// 调用方能够设置并实现这个接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResultChangedListener</span><span class="params">(ResultChangeListener resultChangedListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.resultChangeListener = resultChangedListener;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 传输数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDataStream</span><span class="params">(<span class="type">short</span>[] data)</span> &#123;</span><br><span class="line">        checkData(data);<span class="comment">// 处理数据方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理数据，并送出结果</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkData</span><span class="params">(<span class="type">short</span>[] data)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (data.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">short</span> b : data) &#123;</span><br><span class="line">            sum += b;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sum &gt; <span class="number">40</span>) &#123;</span><br><span class="line">            resultChangeListener.onChange(<span class="literal">true</span>); <span class="comment">// 数据处理结果</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resultChangeListener.onChange(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主程序；调用方传入数据，获取结果<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.algo.AlgoCalculator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainUser</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AlgoCalculator</span> <span class="variable">algoCalculator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlgoCalculator</span>(); <span class="comment">// 初始化</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置监听器，并在里面增加要执行的动作</span></span><br><span class="line">        algoCalculator.setResultChangedListener(<span class="keyword">new</span> <span class="title class_">AlgoCalculator</span>.ResultChangeListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onChange</span><span class="params">(<span class="type">boolean</span> found)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;result: &quot;</span> + found);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">short</span>[] data1 = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>,&#125;;</span><br><span class="line">        <span class="type">short</span>[] data2 = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>&#125;;</span><br><span class="line">        <span class="type">short</span>[] data3 = &#123;<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>&#125;;</span><br><span class="line">        <span class="type">short</span>[] data4 = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="comment">// 传入数据</span></span><br><span class="line">        algoCalculator.setDataStream(data1);    <span class="comment">// output false</span></span><br><span class="line">        algoCalculator.setDataStream(data2);    <span class="comment">// output true</span></span><br><span class="line">        algoCalculator.setDataStream(data3);    <span class="comment">// output false</span></span><br><span class="line">        algoCalculator.setDataStream(data4);    <span class="comment">// output false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>在另外的类里，能够很方便地调用<code>AlgoCalculator</code>的计算能力并获取计算结果。<br>在这里，每传入一次数据，就能获取一个结果。如果每秒钟传入一次数据，每秒钟就能获取一个结果。<br>我们可以把复杂的算法封装起来，客户端只需要传入数据，即可获得（监听到）结果。  </p>
<p>很多场景中都使用了监听者模式。开发者也可能在不知不觉中就运用了这个模式。</p>
<h3 id="Android中使用监听器"><a href="#Android中使用监听器" class="headerlink" title="Android中使用监听器"></a>Android中使用监听器</h3><p>最常见的例子是给Button设置点击事件监听器。<br>类似上个例子，设计一个接口当做监听器。Android中回调时可以利用handler，控制调用的线程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Handler mMainHandler;</span><br><span class="line"></span><br><span class="line">mMainHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper());<span class="comment">// 在主线程中运行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">notifySthChange</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> state)</span> &#123;</span><br><span class="line">    mMainHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            ArrayList&lt;SListener&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(mListeners);</span><br><span class="line">            <span class="keyword">for</span> (SListener l : list) &#123;</span><br><span class="line">                l.OnSthChanged(state);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>在回调中可以直接更新UI。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-12-25T06:40:43.000Z" title="2015/12/25 14:40:43">2015-12-25</time>发表</span><span class="level-item"><time dateTime="2019-11-10T14:00:50.634Z" title="2019/11/10 22:00:50">2019-11-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">5 分钟读完 (大约747个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/25/Dev-note/dev-note-aboutView/">aboutView 开发记录</a></p><div class="content"><p>工程地址 <a target="_blank" rel="noopener" href="https://github.com/RustFisher/aboutView">https://github.com/RustFisher/aboutView</a></p>
<h2 id="虚拟键盘-VKeyboard"><a href="#虚拟键盘-VKeyboard" class="headerlink" title="虚拟键盘 - VKeyboard"></a>虚拟键盘 - VKeyboard</h2><p>VKeyboard - Virtual keyboard</p>
<h3 id="定义按键类"><a href="#定义按键类" class="headerlink" title="定义按键类"></a>定义按键类</h3><p>定义Key类，代表按键。属性有ascii码，是否使用TextView，是否使用ImageView，按键类别（功能键，普通键）等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Key</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> keyType; <span class="comment">// 按键种类 是普通按键或者是功能按键</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">uiType</span> <span class="operator">=</span> UI_TEXT_VIEW; <span class="comment">// UI使用的View类型</span></span><br><span class="line">    <span class="keyword">private</span> String keyText; <span class="comment">// 显示的文字</span></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UI控制器实现"><a href="#UI控制器实现" class="headerlink" title="UI控制器实现"></a>UI控制器实现</h3><p>实现一个虚拟键盘。采用给LinearLayout添加子view的方式。<br>做一个UI控制器（Widget），需要传入一个LinearLayout作为根view。根据设置的键盘宽度动态调整每个按键的大小。</p>
<p>这种方式不太适合组件化。</p>
<h3 id="创建组件的方式"><a href="#创建组件的方式" class="headerlink" title="创建组件的方式"></a>创建组件的方式</h3><p>将「按键」装配到键盘上。采用适配器模式，将View添加到ViewGroup中。</p>
<p>VKey代表按键，VKeyboardBody代表键盘，VRow代表键盘上的一行，VKeyboardListener是监听器。<br>VKeyboard继承Framelayout，创建适配器VKeyboard.Adapter，将「按键」装配到键盘上。</p>
<p><img src="https://raw.githubusercontent.com/RustFisher/aboutView/master/pics/vk-1.png" alt="vk"></p>
<h4 id="VKey-按键"><a href="#VKey-按键" class="headerlink" title="VKey - 按键"></a>VKey - 按键</h4><p>代表按键。装载着keyCode，背景资源等等属性值。</p>
<h4 id="VKeyboardBody-键盘"><a href="#VKeyboardBody-键盘" class="headerlink" title="VKeyboardBody - 键盘"></a>VKeyboardBody - 键盘</h4><p>代表键盘的显示样式。比如UI的padding值和margin值。</p>
<h4 id="VRow-行"><a href="#VRow-行" class="headerlink" title="VRow - 行"></a>VRow - 行</h4><p>一行按键。实际上是一个LinearLayout的属性值合集。</p>
<h4 id="VKeyboardListener-监听器"><a href="#VKeyboardListener-监听器" class="headerlink" title="VKeyboardListener - 监听器"></a>VKeyboardListener - 监听器</h4><p>事件监听器。例如点击事件等等。</p>
<h4 id="VKeyboard-键盘UI类"><a href="#VKeyboard-键盘UI类" class="headerlink" title="VKeyboard - 键盘UI类"></a>VKeyboard - 键盘UI类</h4><p>实际上继承了FrameLayout。通过VKeyboard.Adapter获取到键盘的按键配置信息。<br>创建对应的子View，并添加到FrameLayout中。</p>
<h5 id="VKeyboard构造函数"><a href="#VKeyboard构造函数" class="headerlink" title="VKeyboard构造函数"></a>VKeyboard构造函数</h5><p>构造函数中有<code>AttributeSet</code>。attrs里面有id，layout_width，layout_height等等信息。</p>
<p>想在View的构造器中获取到定义中xml中的属性，需要从AttributeSet中获取。可能会获取到-1或-2，分别代表MATCH_PARENT和WRAP_CONTENT。<br>因此要判断获取到的数字是否大于0，如果大于0则表明是一个指定的宽度，直接记下这个宽度值。<br>获取到xml中指定的宽度后，再计算子view的宽度。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">VKeyboard</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@Nullable</span> AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">    <span class="type">int</span>[] attrsArray = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;</span><br><span class="line">            android.R.attr.id, <span class="comment">// 0</span></span><br><span class="line">            android.R.attr.background, <span class="comment">// 1</span></span><br><span class="line">            android.R.attr.layout_width, <span class="comment">// 2</span></span><br><span class="line">            android.R.attr.layout_height <span class="comment">// 3</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">TypedArray</span> <span class="variable">a</span> <span class="operator">=</span> context.obtainStyledAttributes(attrs, attrsArray);</span><br><span class="line">    <span class="type">int</span> <span class="variable">layoutWidth</span> <span class="operator">=</span> a.getLayoutDimension(<span class="number">2</span>, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">    <span class="keyword">if</span> (layoutWidth &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        keyboardWidthPx = layoutWidth;</span><br><span class="line">    &#125;</span><br><span class="line">    a.recycle();</span><br><span class="line">    initKeyboardUI(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8037101/how-to-get-attributeset-properties">https://stackoverflow.com/questions/8037101/how-to-get-attributeset-properties</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">MapView</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] attrsArray = <span class="keyword">new</span> <span class="title class_">int</span>[] &#123;</span><br><span class="line">        android.R.attr.id, <span class="comment">// 0</span></span><br><span class="line">        android.R.attr.background, <span class="comment">// 1</span></span><br><span class="line">        android.R.attr.layout_width, <span class="comment">// 2</span></span><br><span class="line">        android.R.attr.layout_height <span class="comment">// 3</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">TypedArray</span> <span class="variable">ta</span> <span class="operator">=</span> context.obtainStyledAttributes(attrs, attrsArray);</span><br><span class="line">    <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> ta.getResourceId(<span class="number">0</span> <span class="comment">/* index of attribute in attrsArray */</span>, View.NO_ID);</span><br><span class="line">    <span class="type">Drawable</span> <span class="variable">background</span> <span class="operator">=</span> ta.getDrawable(<span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">layout_width</span> <span class="operator">=</span> ta. getLayoutDimension(<span class="number">2</span>, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">    <span class="type">int</span> <span class="variable">layout_height</span> <span class="operator">=</span> ta. getLayoutDimension(<span class="number">3</span>, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">    ta.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>给Keyboard添加按键（key）。在activity onCreate的时候，Keyboard已经执行了构造函数。<br>之后我们通过setAdapter的方式给它添加key。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-12-16T14:11:01.000Z" title="2015/12/16 22:11:01">2015-12-16</time>发表</span><span class="level-item"><time dateTime="2021-06-17T06:13:08.450Z" title="2021/6/17 14:13:08">2021-06-17</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Linux-note/">Linux_note</a></span><span class="level-item">2 分钟读完 (大约337个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/16/Linux/awk-use/">awk命令的使用</a></p><div class="content"><p>Ubuntu14.04</p>
<h2 id="目的：想用awk来统计某个文本中单词出现的次数，并以一定的格式输出结构"><a href="#目的：想用awk来统计某个文本中单词出现的次数，并以一定的格式输出结构" class="headerlink" title="目的：想用awk来统计某个文本中单词出现的次数，并以一定的格式输出结构"></a>目的：想用awk来统计某个文本中单词出现的次数，并以一定的格式输出结构</h2><p>通常，awk逐行处理文本。awk每接收文件的一行，然后执行相应的命令来处理。</p>
<p>用legal文件来做示例<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/legal</span><br><span class="line"></span><br><span class="line">The programs included with the Ubuntu system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by</span><br><span class="line">applicable law.</span><br></pre></td></tr></table></figure></p>
<h3 id="搜索统计单词“law”的个数"><a href="#搜索统计单词“law”的个数" class="headerlink" title="搜索统计单词“law”的个数"></a>搜索统计单词“law”的个数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ awk -F : &#x27;/law/&#123;count++&#125; END&#123;print &quot;the count is &quot;,count&#125;&#x27; /etc/legal</span><br><span class="line">the count is  1</span><br></pre></td></tr></table></figure>
<h3 id="统计单词“the”的个数"><a href="#统计单词“the”的个数" class="headerlink" title="统计单词“the”的个数"></a>统计单词“the”的个数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ awk -F : &#x27;/the/&#123;count++&#125; END&#123;print &quot;the count is &quot;,count&#125;&#x27; /etc/legal</span><br><span class="line">the count is  3</span><br></pre></td></tr></table></figure>
<p>找到指定单词，自定义变量count自增，最后输出语句和count值</p>
<p>命令sort，把各行按首字母排列顺序重新排列起来</p>
<ul>
<li>sort -nr，每行都以数字开头，按数字从达到小，排列各行</li>
<li>uniq -c，统计各行出现的次数，并把次数打印在每行前端</li>
<li>awk参数 NF - 浏览记录的域的个数</li>
</ul>
<p>综合起来，命令就是<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">awk -F&#x27; &#x27; &#x27;&#123;for(i=1;i&lt;=NF;i=i+1)&#123;print $i&#125;&#125;&#x27; /etc/legal |</span><br><span class="line">sort|uniq -c|sort -nr|awk -F&#x27; &#x27; &#x27;&#123;printf(&quot;%s %s\n&quot;,$2,$1)&#125;&#x27;</span><br></pre></td></tr></table></figure><br>统计/etc/legal中单词出现次数，并以“单词 次数”格式输出结果</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-11-29T03:58:17.000Z" title="2015/11/29 11:58:17">2015-11-29</time>发表</span><span class="level-item"><time dateTime="2021-11-23T00:24:34.333Z" title="2021/11/23 08:24:34">2021-11-23</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Linux-note/">Linux_note</a></span><span class="level-item">11 分钟读完 (大约1601个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/11/29/Linux/grep_note/">grep 搜索字符串</a></p><div class="content"><h2 id="grep-搜索，怎样排除某些目录？"><a href="#grep-搜索，怎样排除某些目录？" class="headerlink" title="grep 搜索，怎样排除某些目录？"></a>grep 搜索，怎样排除某些目录？</h2><p>使用 <code>--exclude-dir</code> 选项。</p>
<p>语法:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--exclude-dir=DIR</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Exclude directories matching the pattern DIR from recursive searches.</p>
</blockquote>
<h3 id="单个目录示例"><a href="#单个目录示例" class="headerlink" title="单个目录示例"></a>单个目录示例</h3><p><code>-R</code>是表示启用正则<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E &quot;http&quot;  ./ -R --exclude-dir=.git</span><br></pre></td></tr></table></figure></p>
<h3 id="多个目录示例"><a href="#多个目录示例" class="headerlink" title="多个目录示例"></a>多个目录示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E <span class="string">&quot;http&quot;</span>  . -R --exclude-dir=&#123;.git,res,bin&#125;</span><br></pre></td></tr></table></figure>
<h3 id="多个文件示例"><a href="#多个文件示例" class="headerlink" title="多个文件示例"></a>多个文件示例</h3><h4 id="排除扩展名为-java-和-js-的文件"><a href="#排除扩展名为-java-和-js-的文件" class="headerlink" title="排除扩展名为 java 和 js 的文件"></a>排除扩展名为 java 和 js 的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E <span class="string">&quot;http&quot;</span>  . -R --exclude=*.&#123;java,js&#125;</span><br></pre></td></tr></table></figure>
<h4 id="排除扩展名为-java，md-和-js-的文件"><a href="#排除扩展名为-java，md-和-js-的文件" class="headerlink" title="排除扩展名为 java，md~ 和 js 的文件"></a>排除扩展名为 java，md~ 和 js 的文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/wd/rustNote/Linux_note$ grep -E DIR -R --exclude=*.&#123;java,js,md~&#125;</span><br><span class="line">grep_note.md:    --exclude-dir=DIR</span><br><span class="line">grep_note.md:	    Exclude directories matching the pattern DIR from recursive searches.</span><br></pre></td></tr></table></figure>
<p>排除扩展名为java， js 和 md~ 的文件</p>
<p>排除一些文件，并且显示行号<code>-n</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -n -E <span class="string">&quot;org/webrtc/&quot;</span> . -R --exclude=*.&#123;java,ninja,TOC,so,o,jar&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="如何在-Linux-系统和类-Unix-的操作系统中使用带正则表达式的-grep-命令呢？"><a href="#如何在-Linux-系统和类-Unix-的操作系统中使用带正则表达式的-grep-命令呢？" class="headerlink" title="如何在 Linux 系统和类 Unix 的操作系统中使用带正则表达式的 grep 命令呢？"></a>如何在 Linux 系统和类 Unix 的操作系统中使用带正则表达式的 grep 命令呢？</h2><p>Linux 系统自带了支持拓展正则表达式的 GNU 版本 grep 工具。所有的 Linux 系统中默认安装的都是 GNU 版 grep 。<br>grep 命令被用来检索一台服务器或工作站上任何位置的文本信息。</p>
<h3 id="快速了解正则表达式"><a href="#快速了解正则表达式" class="headerlink" title="快速了解正则表达式"></a>快速了解正则表达式</h3><h4 id="如何匹配你要查找的内容？"><a href="#如何匹配你要查找的内容？" class="headerlink" title="如何匹配你要查找的内容？"></a>如何匹配你要查找的内容？</h4><p>正则表达式只不过是每个输入行匹配的模式。模式是一个字符序列。下面都是范例：</p>
<p>例如：<code>^w1”、“w1|w2”、“[^ ]</code>。</p>
<p>在 <code>/etc/passswd</code> 中检索 <code>vivek</code> ： <code>grep vivek /etc/passwd</code></p>
<p>输出结果案例：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vivek:x:1000:1000:Vivek Gite,,,:/home/vivek:/bin/bash</span><br><span class="line">vivekgite:x:1001:1001::/home/vivekgite:/bin/sh</span><br><span class="line">gitevivek:x:1002:1002::/home/gitevivek:/bin/sh</span><br></pre></td></tr></table></figure><br>在任何情况下都搜索 ‘vivek’  (即不区分大小)：<code>grep -i -w vivek /etc/passwd</code><br>不区分大小写地检索 ‘vivek’ 和 ‘raj’ ： <code>grep -E -i -w &#39;vivek|raj&#39; /etc/passwd</code><br>在最后一个例子中，使用了扩展正则表达式的模式。</p>
<p>固定检索内容的位置：<br>你可以使用 ^ 和 $ 符号强制一个正则表达式分别匹配一行的开始或结束的位置。<br>下面的示例显示以 ‘vivek’ 开头的文本： <code>grep ^vivek /etc/passwd</code><br>输出结果示例：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vivek:x:1000:1000:Vivek Gite,,,:/home/vivek:/bin/bash</span><br><span class="line">vivekgite:x:1001:1001::/home/vivekgite:/bin/sh</span><br></pre></td></tr></table></figure></p>
<p>以<code>#!</code>开头的行<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rust@rust-pc:~/note/Linux_note$ grep &#x27;^#!&#x27; *</span><br><span class="line">organize_so_names.sh:#! /bin/sh</span><br><span class="line">sort_ranking_solution.md:#! /bin/sh</span><br></pre></td></tr></table></figure></p>
<p>你可以只显示以 vivek 开头的文本行。举例说就是不显示 vivekgite , vivekg 这样单词开头的。<br><code>grep -w ^vivek /etc/passwd</code></p>
<p>检索以 ‘foo’ 结尾的文本格式：<code>grep &#39;foo$&#39; FILENAME</code></p>
<p>你还可以用下面这样的方式搜索空白行：<code>grep &#39;^$&#39; FILENAME</code></p>
<h4 id="如何匹配具体字符？"><a href="#如何匹配具体字符？" class="headerlink" title="如何匹配具体字符？"></a>如何匹配具体字符？</h4><p>匹配 ‘Vivek’ 或 ‘vivek’ ：<code>grep &#39;[vV]ivek&#39; FILENAME</code></p>
<p>或者可以这样：<code>grep &#39;[vV][iI][Vv][Ee][kK]&#39; FILENAME</code></p>
<p>你可以匹配数字（例如匹配 vivek1 或 Vivek2 ）：<code>grep -w &#39;[vV]ivek[0-9]&#39; FILENAME</code></p>
<p>你可以匹配两位数（例如匹配 foo11 ， foo12 ）：<code>grep &#39;foo[0-9][0-9]&#39; FILENAME</code></p>
<p>不仅仅是数字，你可以匹配字母：<code>grep &#39;[A-Za-z]&#39; FILENAME</code></p>
<p>显示所有包含 “w” 或 “n” 字母的文本行：<code>grep [wn] FILENAME</code></p>
<p>在括号内的表达式中，在“ [: ”和“ :] ”中所附的字符类的名称：代表属于该类的所有字符的列表。标准字符类名称：</p>
<ul>
<li>[:alnum:] – 字母数字字符</li>
<li>[:alpha:] – 字母顺序</li>
<li>[:blank:] – 空格和制表符</li>
<li>[:digit:] – 数字： ‘0 1 2 3 4 5 6 7 8 9’</li>
<li>[:lower:] – 小写字母：‘a b c d e f ’</li>
<li>[:space:] – 特殊字符：制表符，换行符，垂直制表符、换页，回车，和空间</li>
<li>[:upper:] – 大写字母：‘A B C D E F G H I J K L M N O P Q R S T U V W X Y Z’</li>
</ul>
<p>在下面这个例子中，匹配所有大写字母：<code>grep &#39;[:upper:]&#39; FILENAME</code></p>
<h4 id="如何使用通配符？"><a href="#如何使用通配符？" class="headerlink" title="如何使用通配符？"></a>如何使用通配符？</h4><p>你可以用 “.” 来代替单个字符。在下面的例子中，查询了所有以字母 “b” 开头、字母 “t” 结尾的三个字符的单词。<br><code>grep &#39;\&lt;b.t\&gt;&#39; FILENAME</code><br>在上面的例子中，<br><code>\&lt;</code> 在单词的开始位置匹配空格字符串<br><code>\&gt;</code> 在单词的结尾匹配空格字符串<br>检索并输出所有两个字母的结果：<code>grep &#39;^..$&#39; FILENAME</code><br>检索并显示所有以 ‘.’ 和数字开头的结果：<code>grep &#39;^\.[0-9]&#39; FILENAME</code><br>转义字符’.’<br>正则表达式查找 IP 地址 192.168.1.254 将不能获得预期的结果：<code>grep &#39;192.168.1.254&#39; /etc/hosts</code><br>其中三个点都需要被转义：<code>grep &#39;192\.168\.1\.254&#39; /etc/hosts</code></p>
<p>以下示例将只匹配一个地址：<br><code>egrep &#39;[[:digit:]]&#123;1,3&#125;\.[[:digit:]]&#123;1,3&#125;\.[[:digit:]]&#123;1,3&#125;\.[[:digit:]]&#123;1,3&#125;&#39; FILENAME</code></p>
<p>以下将不分大小写地匹配单词 Linux 或 Unix ：<code>egrep -i &#39;^(linux|unix)&#39; FILENAME</code></p>
<h3 id="深入探索-grep-高级查找模式"><a href="#深入探索-grep-高级查找模式" class="headerlink" title="深入探索 grep 高级查找模式"></a>深入探索 grep 高级查找模式</h3><h4 id="如何检索一个具有以-‘-‘-开头的的模式？"><a href="#如何检索一个具有以-‘-‘-开头的的模式？" class="headerlink" title="如何检索一个具有以 ‘-‘ 开头的的模式？"></a>如何检索一个具有以 ‘-‘ 开头的的模式？</h4><p>使用 -e 选项搜索所有匹配 ‘–test–‘ 的结果。grep 会尝试把 ‘–test–‘ 作为一个选项解析：<br><code>grep -e &#39;--test--&#39; FILENAME</code></p>
<h4 id="如何在grep中使用-OR-的逻辑运算-？"><a href="#如何在grep中使用-OR-的逻辑运算-？" class="headerlink" title="如何在grep中使用 OR 的逻辑运算 ？"></a>如何在grep中使用 OR 的逻辑运算 ？</h4><p><code>grep -E &#39;word1|word2&#39; FILENAME</code> 或者 <code>egrep &#39;word1|word2&#39; FILENAME</code><br>或者可以这样做<code>grep &#39;word1\|word2&#39; FILENAME</code></p>
<h4 id="如何在grep中使用-AND-的逻辑运算-？"><a href="#如何在grep中使用-AND-的逻辑运算-？" class="headerlink" title="如何在grep中使用 AND 的逻辑运算 ？"></a>如何在grep中使用 AND 的逻辑运算 ？</h4><p>按照下面的语法显示所有包含了单词 ‘word1′ 和 ‘word2′ 的结果：<br><code>grep &#39;word1&#39; FILENAME | grep &#39;word2&#39;</code></p>
<p>或者可以这样：<code>grep &#39;foo.*bar\|word3.*word4&#39; FILENAME</code></p>
<h4 id="如何测试序列？"><a href="#如何测试序列？" class="headerlink" title="如何测试序列？"></a>如何测试序列？</h4><p>你可以使用下面的语法测试一个字符在序列中的重复的次数：</p>
<ul>
<li>{N}</li>
<li>{N,}</li>
<li>{min,max}</li>
</ul>
<p>匹配包含两个字母 v 的字符串结果：<code>egrep &quot;v&#123;2&#125;&quot; FILENAME</code></p>
<p>下面的例子中将检索文件内包含 “col” 和 “cool” 的字符串结果：<code>egrep &#39;co&#123;1,2&#125;l&#39; FILENAME</code></p>
<p>搜索<code>pattern</code>或<code>patern</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rust@rust-pc:~/note/Linux_note$ egrep &#x27;pat&#123;1,2&#125;ern&#x27; *</span><br><span class="line">grep_note.md:Exclude directories matching the pattern DIR from recursive searches.</span><br><span class="line">grep_note.md:grep_note.md:	    Exclude directories matching the pattern DIR from recursive searches.</span><br></pre></td></tr></table></figure><br>下面的例子中将匹配至少含有3个字母 c 的结果：<code>egrep &#39;c&#123;3,&#125;&#39; FILENAME</code></p>
<p>下面的示例将匹配 “91-1234567890″ 格式的手机号码（即 “两位数字-十位数字”）<br><code>grep &quot;[[:digit:]]\&#123;2\&#125;[ -]\?[[:digit:]]\&#123;10\&#125;&quot; FILENAME</code></p>
<h4 id="如何使-grep-的输出结果高亮标注？"><a href="#如何使-grep-的输出结果高亮标注？" class="headerlink" title="如何使 grep 的输出结果高亮标注？"></a>如何使 grep 的输出结果高亮标注？</h4><p>使用下面例子的语法：<code>grep --color regex FILENAME</code></p>
<h4 id="如何使-grep-的输出只显示匹配的部分而不是整行？"><a href="#如何使-grep-的输出只显示匹配的部分而不是整行？" class="headerlink" title="如何使 grep 的输出只显示匹配的部分而不是整行？"></a>如何使 grep 的输出只显示匹配的部分而不是整行？</h4><p>使用下面例子的语法：<code>grep -o regex FILENAME</code></p>
<h2 id="统计行数"><a href="#统计行数" class="headerlink" title="统计行数"></a>统计行数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;&quot; -r . | wc -l</span><br></pre></td></tr></table></figure></div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/7/">上一页</a></div><div class="pagination-next"><a href="/page/9/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/7/">7</a></li><li><a class="pagination-link is-current" href="/page/8/">8</a></li><li><a class="pagination-link" href="/page/9/">9</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/fish.png" alt="RustFisher"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">RustFisher</p><p class="is-size-6 is-block">技术，学习，实践，开发，读书</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">107</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">19</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">55</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/RustFisher" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/RustFisher"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7286632197002340" data-ad-slot="8064535079" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://an.rustfisher.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">技术记录</span></span><span class="level-right"><span class="level-item tag">an.rustfisher.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Android-note/"><span class="level-start"><span class="level-item">Android_note</span></span><span class="level-end"><span class="level-item tag">37</span></span></a></li><li><a class="level is-mobile" href="/categories/Android-tutorial-2020/"><span class="level-start"><span class="level-item">Android_tutorial_2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/CocosCreator/"><span class="level-start"><span class="level-item">CocosCreator</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Database/"><span class="level-start"><span class="level-item">Database</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Design-pattern/"><span class="level-start"><span class="level-item">Design_pattern</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Flutter-note/"><span class="level-start"><span class="level-item">Flutter_note</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/HTTP/"><span class="level-start"><span class="level-item">HTTP</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux-note/"><span class="level-start"><span class="level-item">Linux_note</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/MongoDB/"><span class="level-start"><span class="level-item">MongoDB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/NestJS/"><span class="level-start"><span class="level-item">NestJS</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/PyQt/"><span class="level-start"><span class="level-item">PyQt</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/TypeScript/"><span class="level-start"><span class="level-item">TypeScript</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/WebRTC/"><span class="level-start"><span class="level-item">WebRTC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Web-note/"><span class="level-start"><span class="level-item">Web_note</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/miniprogram/"><span class="level-start"><span class="level-item">miniprogram</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/unclassified/"><span class="level-start"><span class="level-item">unclassified</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%80%BB%E7%BB%93/"><span class="level-start"><span class="level-item">总结</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-18T08:32:32.000Z">2023-01-18</time></p><p class="title"><a href="/2023/01/18/unclassified/web-res-move-2023/">网站迁移说明</a></p><p class="categories"><a href="/categories/unclassified/">unclassified</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-30T15:59:59.000Z">2021-11-30</time></p><p class="title"><a href="/2021/11/30/Summary/2021-11/">2021年11月总结</a></p><p class="categories"><a href="/categories/%E6%80%BB%E7%BB%93/">总结</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-09T12:28:11.000Z">2021-11-09</time></p><p class="title"><a href="/2021/11/09/WebRTC/webRTC-concept-intro/">WebRTC概念介绍</a></p><p class="categories"><a href="/categories/WebRTC/">WebRTC</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-13T15:15:14.000Z">2021-10-13</time></p><p class="title"><a href="/2021/10/13/Python/scrapy-hw-blog-record/">Python抓取博客记录，获取标题与url</a></p><p class="categories"><a href="/categories/Python/">Python</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-30T15:59:59.000Z">2021-09-30</time></p><p class="title"><a href="/2021/09/30/Summary/2021-9/">2021年9月总结</a></p><p class="categories"><a href="/categories/%E6%80%BB%E7%BB%93/">总结</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/"><span class="level-start"><span class="level-item">2019</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/"><span class="level-start"><span class="level-item">2018</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/"><span class="level-start"><span class="level-item">2017</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/"><span class="level-start"><span class="level-item">2016</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/"><span class="level-start"><span class="level-item">2015</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AIDL/"><span class="tag">AIDL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-2020/"><span class="tag">Android-2020</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-Broadcast/"><span class="tag">Android_Broadcast</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-Media/"><span class="tag">Android_Media</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-View/"><span class="tag">Android_View</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-service/"><span class="tag">Android_service</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android%E6%BA%90%E7%A0%81/"><span class="tag">Android源码</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Binder/"><span class="tag">Binder</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocos-Creator/"><span class="tag">Cocos Creator</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Excel/"><span class="tag">Excel</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Handler/"><span class="tag">Handler</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Matplotlib/"><span class="tag">Matplotlib</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Media/"><span class="tag">Media</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MediaPlayer/"><span class="tag">MediaPlayer</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NDK/"><span class="tag">NDK</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NestJS/"><span class="tag">NestJS</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Network/"><span class="tag">Network</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OkHttp/"><span class="tag">OkHttp</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell/"><span class="tag">Shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thread/"><span class="tag">Thread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tools/"><span class="tag">Tools</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebRTC/"><span class="tag">WebRTC</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebSocket/"><span class="tag">WebSocket</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/css/"><span class="tag">css</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/echarts/"><span class="tag">echarts</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/for/"><span class="tag">for</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gradle/"><span class="tag">gradle</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo%E4%B8%BB%E9%A2%98/"><span class="tag">hexo主题</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/http/"><span class="tag">http</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mac/"><span class="tag">mac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mmap/"><span class="tag">mmap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/network/"><span class="tag">network</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openpyxl/"><span class="tag">openpyxl</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/plot/"><span class="tag">plot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/plt/"><span class="tag">plt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pyecharts/"><span class="tag">pyecharts</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%AC%E4%BC%97%E5%8F%B7/"><span class="tag">公众号</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91%E7%A4%BE%E5%8C%BA/"><span class="tag">华为云社区</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%8E%E7%AB%AF/"><span class="tag">后端</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%89%E8%A3%85mysql/"><span class="tag">安装mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"><span class="tag">小程序</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"><span class="tag">开发记录</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%BB%E7%BB%93/"><span class="tag">总结</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">数据库</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%88%AC%E8%99%AB/"><span class="tag">爬虫</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="tag">设计模式</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%90%E8%90%A5%E7%9A%84Python%E6%8C%87%E5%8D%97/"><span class="tag">运营的Python指南</span><span class="tag">4</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/fish.png" alt="RustFisher的自留地" height="28"></a><p class="is-size-7"><span>&copy; 2023 Rust Fisher</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2023 Rust Fisher</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>