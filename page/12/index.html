<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>RustFisher的自留地</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="RustFisher的自留地"><meta name="msapplication-TileImage" content="/img/fish.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="RustFisher的自留地"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="技术学习与实践，一些开发记录，读书笔记"><meta property="og:type" content="blog"><meta property="og:title" content="RustFisher的自留地"><meta property="og:url" content="https://blog.rustfisher.com/"><meta property="og:site_name" content="RustFisher的自留地"><meta property="og:description" content="技术学习与实践，一些开发记录，读书笔记"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.rustfisher.com/img/og_image.png"><meta property="article:author" content="Rust Fisher"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.rustfisher.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.rustfisher.com"},"headline":"RustFisher的自留地","image":["https://blog.rustfisher.com/img/og_image.png"],"author":{"@type":"Person","name":"Rust Fisher"},"publisher":{"@type":"Organization","name":"RustFisher的自留地","logo":{"@type":"ImageObject","url":"https://blog.rustfisher.com/img/fish.png"}},"description":"技术学习与实践，一些开发记录，读书笔记"}</script><link rel="icon" href="/img/fish.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-NT4BCBCQTP" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-NT4BCBCQTP');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><script data-ad-client="ca-pub-7286632197002340" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/fish.png" alt="RustFisher的自留地" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/RustFisher"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/03/01/Android/Android-MediaMuxer_MediaExtractor_mp4/"><img class="fill" src="/img/android-cover-2.png" alt="Android 使用 MediaExtractor 和 MediaMuxer 解析和封装 mp4 文件"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-03-01T13:21:16.000Z" title="2018/3/1 21:21:16">2018-03-01</time>发表</span><span class="level-item"><time dateTime="2023-04-09T06:26:01.975Z" title="2023/4/9 14:26:01">2023-04-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">11 分钟读完 (大约1608个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/01/Android/Android-MediaMuxer_MediaExtractor_mp4/">Android 使用 MediaExtractor 和 MediaMuxer 解析和封装 mp4 文件</a></p><div class="content"><p>本文目的：使用 MediaExtractor 和 MediaMuxer 解析和封装 mp4 文件</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>MP4或称MPEG-4第14部分（英语：MPEG-4 Part 14）是一种标准的数字多媒体容器格式。</p>
<p>MP4中的音频格式通常为AAC(audio/mp4a-latm)</p>
<h4 id="MediaExtractor"><a href="#MediaExtractor" class="headerlink" title="MediaExtractor"></a>MediaExtractor</h4><p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaExtractor.html">MediaExtractor</a> 可用于分离多媒体容器中视频track和音频track</p>
<p><code>setDataSource()</code> 设置数据源，数据源可以是本地文件地址，也可以是网络地址</p>
<p><code>getTrackFormat(int index)</code> 来获取各个track的<code>MediaFormat</code>，通过<code>MediaFormat</code>来获取track的详细信息，如：MimeType、分辨率、采样频率、帧率等等</p>
<p><code>selectTrack(int index)</code> 通过下标选择指定的通道</p>
<p><code>readSampleData(ByteBuffer buffer, int offset)</code> 获取当前编码好的数据并存在指定好偏移量的buffer中</p>
<h4 id="MediaMuxer"><a href="#MediaMuxer" class="headerlink" title="MediaMuxer"></a>MediaMuxer</h4><p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaMuxer.html">MediaMuxer</a> 可用于混合基本码流。将所有的信道的信息合成一个视频。<br>目前输出格式支持MP4，Webm，3GP。从Android Nougat开始支持向MP4中混入B-frames。</p>
<h3 id="提取并输出MP4文件中的视频部分"><a href="#提取并输出MP4文件中的视频部分" class="headerlink" title="提取并输出MP4文件中的视频部分"></a>提取并输出MP4文件中的视频部分</h3><p>从一个MP4文件中提取出视频，得到不含音频的MP4文件。</p>
<p>实现流程，首先是使用<code>MediaExtractor</code>提取，然后使用<code>MediaMuxer</code>输出MP4文件。</p>
<ul>
<li><code>MediaExtractor</code>设置数据源，找到并选择视频轨道的格式和下标</li>
<li><code>MediaMuxer</code>设置输出格式为<code>MUXER_OUTPUT_MPEG_4</code>，添加前面选定的格式，调用<code>start()</code>启动</li>
<li><code>MediaExtractor</code>读取帧数据，不停地将帧数据和相关信息传入<code>MediaMuxer</code></li>
<li>最后停止并释放<code>MediaMuxer</code>和<code>MediaExtractor</code><br>最好放在子线程中操作。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提取视频</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sourceVideoPath 原始视频文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception 出错</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">extractVideo</span><span class="params">(String sourceVideoPath, String outVideoPath)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">MediaExtractor</span> <span class="variable">sourceMediaExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">    sourceMediaExtractor.setDataSource(sourceVideoPath);</span><br><span class="line">    <span class="type">int</span> <span class="variable">numTracks</span> <span class="operator">=</span> sourceMediaExtractor.getTrackCount();</span><br><span class="line">    <span class="type">int</span> <span class="variable">sourceVideoTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// 原始视频文件视频轨道参数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numTracks; ++i) &#123;</span><br><span class="line">        <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> sourceMediaExtractor.getTrackFormat(i);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mime</span> <span class="operator">=</span> format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;MediaFormat: &quot;</span> + mime);</span><br><span class="line">        <span class="keyword">if</span> (mime.startsWith(<span class="string">&quot;video/&quot;</span>)) &#123;</span><br><span class="line">            sourceMediaExtractor.selectTrack(i);</span><br><span class="line">            sourceVideoTrackIndex = i;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;selectTrack index=&quot;</span> + i + <span class="string">&quot;; format: &quot;</span> + mime);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">MediaMuxer</span> <span class="variable">outputMediaMuxer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaMuxer</span>(outVideoPath,</span><br><span class="line">            MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line">    outputMediaMuxer.addTrack(sourceMediaExtractor.getTrackFormat(sourceVideoTrackIndex));</span><br><span class="line">    outputMediaMuxer.start();</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">inputBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">2</span>); <span class="comment">// 分配的内存要尽量大一些</span></span><br><span class="line">    MediaCodec.<span class="type">BufferInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">    <span class="type">int</span> sampleSize;</span><br><span class="line">    <span class="keyword">while</span> ((sampleSize = sourceMediaExtractor.readSampleData(inputBuffer, <span class="number">0</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">presentationTimeUs</span> <span class="operator">=</span> sourceMediaExtractor.getSampleTime();</span><br><span class="line">        info.offset = <span class="number">0</span>;</span><br><span class="line">        info.size = sampleSize;</span><br><span class="line">        info.flags = MediaCodec.BUFFER_FLAG_SYNC_FRAME;</span><br><span class="line">        info.presentationTimeUs = presentationTimeUs;</span><br><span class="line">        outputMediaMuxer.writeSampleData(sourceVideoTrackIndex, inputBuffer, info);</span><br><span class="line">        sourceMediaExtractor.advance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    outputMediaMuxer.stop();</span><br><span class="line">    outputMediaMuxer.release();    <span class="comment">// 停止并释放 MediaMuxer</span></span><br><span class="line">    sourceMediaExtractor.release();</span><br><span class="line">    sourceMediaExtractor = <span class="literal">null</span>;   <span class="comment">// 释放 MediaExtractor</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
如果上面的<code>ByteBuffer</code>分配的空间太小，<code>readSampleData(inputBuffer, 0)</code>可能会出现<code>IllegalArgumentException</code>异常。</li>
</ul>
<h3 id="提取MP4文件中的音频部分，获取音频文件"><a href="#提取MP4文件中的音频部分，获取音频文件" class="headerlink" title="提取MP4文件中的音频部分，获取音频文件"></a>提取MP4文件中的音频部分，获取音频文件</h3><h4 id="基于Java-MP4-Parser提取出AAC文件的方法"><a href="#基于Java-MP4-Parser提取出AAC文件的方法" class="headerlink" title="基于Java MP4 Parser提取出AAC文件的方法"></a>基于<code>Java MP4 Parser</code>提取出AAC文件的方法</h4><p><code>Java MP4 Parser</code> - <a target="_blank" rel="noopener" href="https://github.com/sannies/mp4parser">https://github.com/sannies/mp4parser</a><br>Java实现读、写和创建MP4容器。但是和编解码音视频有区别。这里主要是提取与再合成。</p>
<p>下载<code>isoparser-1.1.22.jar</code>并添加进工程中；尝试过gradle直接导入，但不成功</p>
<p>找到视频文件中所有的音轨，将它们提取出来写入新的文件中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">extractAudioFromMP4</span><span class="params">(String outAudioPath, String sourceMP4Path)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Movie</span> <span class="variable">movie</span> <span class="operator">=</span> MovieCreator.build(sourceMP4Path);</span><br><span class="line">    List&lt;Track&gt; audioTracks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Track t : movie.getTracks()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t.getHandler().equals(<span class="string">&quot;soun&quot;</span>)) &#123;</span><br><span class="line">            audioTracks.add(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Movie</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Movie</span>();</span><br><span class="line">    <span class="keyword">if</span> (audioTracks.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        result.addTrack(<span class="keyword">new</span> <span class="title class_">AppendTrack</span>(audioTracks.toArray(<span class="keyword">new</span> <span class="title class_">Track</span>[audioTracks.size()])));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Container</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMp4Builder</span>().build(result);</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">fc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(outAudioPath, <span class="string">&quot;rw&quot;</span>).getChannel();</span><br><span class="line">    out.writeContainer(fc);</span><br><span class="line">    fc.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>在红米手机上测试成功。从MP4文件（时长约2分20秒）中提取出的AAC文件可在手机上直接播放。</p>
<h3 id="将AAC音轨换到另一个MP4文件"><a href="#将AAC音轨换到另一个MP4文件" class="headerlink" title="将AAC音轨换到另一个MP4文件"></a>将AAC音轨换到另一个MP4文件</h3><p>MediaExtractor可以直接从提取AAC文件或MP4文件中提取ACC音轨，MediaMuxer来写入新的MP4文件。</p>
<p>提供音频的文件可以是MP4文件，也可以是AAC文件；另一个提供视频，混合输出新的MP4文件。</p>
<p>生成的视频的长度由提供视频的文件决定。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> outputVideoFilePath 输出视频文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> videoProviderPath   提供视频的MP4文件 时长以此为准</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> audioProviderPath   提供音频的文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception 运行异常  例如读写文件异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">replaceAudioForMP4File</span><span class="params">(String outputVideoFilePath, String videoProviderPath,</span></span><br><span class="line"><span class="params">                                          String audioProviderPath)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">MediaMuxer</span> <span class="variable">mediaMuxer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaMuxer</span>(outputVideoFilePath,</span><br><span class="line">            MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 视频 MediaExtractor</span></span><br><span class="line">    <span class="type">MediaExtractor</span> <span class="variable">mVideoExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">    mVideoExtractor.setDataSource(videoProviderPath);</span><br><span class="line">    <span class="type">int</span> <span class="variable">videoTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mVideoExtractor.getTrackCount(); i++) &#123;</span><br><span class="line">        <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> mVideoExtractor.getTrackFormat(i);</span><br><span class="line">        <span class="keyword">if</span> (format.getString(MediaFormat.KEY_MIME).startsWith(<span class="string">&quot;video/&quot;</span>)) &#123;</span><br><span class="line">            mVideoExtractor.selectTrack(i);</span><br><span class="line">            videoTrackIndex = mediaMuxer.addTrack(format);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Video: format:&quot;</span> + format);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 音频 MediaExtractor</span></span><br><span class="line">    <span class="type">MediaExtractor</span> <span class="variable">audioExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">    audioExtractor.setDataSource(audioProviderPath);</span><br><span class="line">    <span class="type">int</span> <span class="variable">audioTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; audioExtractor.getTrackCount(); i++) &#123;</span><br><span class="line">        <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> audioExtractor.getTrackFormat(i);</span><br><span class="line">        <span class="keyword">if</span> (format.getString(MediaFormat.KEY_MIME).startsWith(<span class="string">&quot;audio/&quot;</span>)) &#123;</span><br><span class="line">            audioExtractor.selectTrack(i);</span><br><span class="line">            audioTrackIndex = mediaMuxer.addTrack(format);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Audio: format:&quot;</span> + format);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mediaMuxer.start(); <span class="comment">// 添加完所有轨道后start</span></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">videoEndPreTimeUs</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 封装视频track</span></span><br><span class="line">    <span class="keyword">if</span> (-<span class="number">1</span> != videoTrackIndex) &#123;</span><br><span class="line">        MediaCodec.<span class="type">BufferInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">        info.presentationTimeUs = <span class="number">0</span>;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">        <span class="type">int</span> sampleSize;</span><br><span class="line">        <span class="keyword">while</span> ((sampleSize = mVideoExtractor.readSampleData(buffer, <span class="number">0</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            info.offset = <span class="number">0</span>;</span><br><span class="line">            info.size = sampleSize;</span><br><span class="line">            info.flags = MediaCodec.BUFFER_FLAG_SYNC_FRAME;</span><br><span class="line">            info.presentationTimeUs = mVideoExtractor.getSampleTime();</span><br><span class="line">            videoEndPreTimeUs = info.presentationTimeUs;</span><br><span class="line">            mediaMuxer.writeSampleData(videoTrackIndex, buffer, info);</span><br><span class="line">            mVideoExtractor.advance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;视频 videoEndPreTimeUs &quot;</span> + videoEndPreTimeUs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装音频track</span></span><br><span class="line">    <span class="keyword">if</span> (-<span class="number">1</span> != audioTrackIndex) &#123;</span><br><span class="line">        MediaCodec.<span class="type">BufferInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">        info.presentationTimeUs = <span class="number">0</span>;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">        <span class="type">int</span> sampleSize;</span><br><span class="line">        <span class="keyword">while</span> ((sampleSize = audioExtractor.readSampleData(buffer, <span class="number">0</span>)) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                audioExtractor.getSampleTime() &lt;= videoEndPreTimeUs) &#123;</span><br><span class="line">            info.offset = <span class="number">0</span>;</span><br><span class="line">            info.size = sampleSize;</span><br><span class="line">            info.flags = MediaCodec.BUFFER_FLAG_SYNC_FRAME;</span><br><span class="line">            info.presentationTimeUs = audioExtractor.getSampleTime();</span><br><span class="line">            mediaMuxer.writeSampleData(audioTrackIndex, buffer, info);</span><br><span class="line">            audioExtractor.advance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mVideoExtractor.release(); <span class="comment">// 释放MediaExtractor</span></span><br><span class="line">    audioExtractor.release();</span><br><span class="line">    mediaMuxer.stop();</span><br><span class="line">    mediaMuxer.release();     <span class="comment">// 释放MediaMuxer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Video: format:&#123;csd-1=java.nio.ByteArrayBuffer[position=0,limit=9,capacity=9], mime=video/avc, frame-rate=30, height=1080, width=1920, max-input-size=1572864, isDMCMMExtractor=1, durationUs=12425577, csd-0=java.nio.ByteArrayBuffer[position=0,limit=20,capacity=20]&#125;</span><br><span class="line">Audio: format:&#123;max-input-size=5532, aac-profile=2, mime=audio/mp4a-latm, durationUs=340101875, csd-0=java.nio.ByteArrayBuffer[position=0,limit=2,capacity=2], channel-count=2, sample-rate=44100&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MP3转换为AAC"><a href="#MP3转换为AAC" class="headerlink" title="MP3转换为AAC"></a>MP3转换为AAC</h3><h4 id="使用-AndroidAudioConverter"><a href="#使用-AndroidAudioConverter" class="headerlink" title="使用 AndroidAudioConverter"></a>使用 AndroidAudioConverter</h4><p>AndroidAudioConverter - <a target="_blank" rel="noopener" href="https://github.com/adrielcafe/AndroidAudioConverter">https://github.com/adrielcafe/AndroidAudioConverter</a></p>
<p>基于FFmpeg的第三方库。支持格式有AAC, MP3, M4A, WMA, WAV 和 FLAC</p>
<p>使用方法：</p>
<p><code>app/build.gradle</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">  maven &#123;</span><br><span class="line">    url &quot;https://jitpack.io&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">  compile &#x27;com.github.adrielcafe:AndroidAudioConverter:0.0.8&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>申请读写外部存储权限<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><br>在<code>Application</code>类中加载库<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MuxerApp</span> <span class="keyword">extends</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate();</span><br><span class="line">        AndroidAudioConverter.load(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">ILoadCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">// Great!</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                <span class="comment">// FFmpeg is not supported by device</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>使用转换功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">sourceMP3Path</span> <span class="operator">=</span> SOURCE_PATH + File.separator + <span class="string">&quot;music1.mp3&quot;</span>;</span><br><span class="line">Log.d(TAG, <span class="string">&quot;转换开始 &quot;</span> + sourceMP3Path);</span><br><span class="line"><span class="type">File</span> <span class="variable">srcFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(sourceMP3Path);</span><br><span class="line"><span class="type">IConvertCallback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IConvertCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(File convertedFile)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onSuccess: &quot;</span> + convertedFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;onFailure: &quot;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">AndroidAudioConverter.with(getApplicationContext())</span><br><span class="line">        <span class="comment">// Your current audio file</span></span><br><span class="line">        .setFile(srcFile)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Your desired audio format</span></span><br><span class="line">        .setFormat(AudioFormat.AAC)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// An callback to know when conversion is finished</span></span><br><span class="line">        .setCallback(callback)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start conversion</span></span><br><span class="line">        .convert();</span><br></pre></td></tr></table></figure></p>
<p>在三星Note4上测试，转换13MB的MP3文件用了大约3分18秒。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaExtractor.html">MediaExtractor - Android Developer</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaMuxer.html">MediaMuxer - Android Developer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sannies/mp4parser">Java MP4 Parser</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/tags/Android-Media/">Android音视频相关文章</a><br><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/12/08/Android_tutorial_2020/Android-tutorial_2020_a_menu/">Android tutorial 2020</a></p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2018/02/05/Android/adb_mock_touch_and_monkeyrunner/"><img class="fill" src="/img/android-cover-2.png" alt="Android 模拟用户点击"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-02-05T12:56:57.000Z" title="2018/2/5 20:56:57">2018-02-05</time>发表</span><span class="level-item"><time dateTime="2023-04-09T06:26:01.914Z" title="2023/4/9 14:26:01">2023-04-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">6 分钟读完 (大约952个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/05/Android/adb_mock_touch_and_monkeyrunner/">Android 模拟用户点击</a></p><div class="content"><p>Android模拟用户点击。在自动化测试中可使用的工具。<br>可以利用adb命令，也可以使用Android SDK中的<code>monkeyrunner</code>工具。</p>
<ul>
<li>win7-64</li>
<li>gitbash</li>
</ul>
<h1 id="使用adb命令"><a href="#使用adb命令" class="headerlink" title="使用adb命令"></a>使用adb命令</h1><p>主要使用input命令<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">usage: input ...</span><br><span class="line"></span><br><span class="line">       input text &lt;string&gt;</span><br><span class="line">       input keyevent &lt;key code number or name&gt;</span><br><span class="line">       input tap &lt;x&gt; &lt;y&gt;</span><br><span class="line">       input swipe &lt;x1&gt; &lt;y1&gt; &lt;x2&gt; &lt;y2&gt;</span><br></pre></td></tr></table></figure><br>keyevent指的是android对应的keycode，比如home键的keycode=3，back键的keycode=4</p>
<p>tap是touch屏幕的事件，只需给出x、y坐标即可</p>
<p>swipe模拟滑动的事件，给出起点和终点的坐标即可</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 模拟点击位置 (<span class="number">100</span>,<span class="number">100</span>)</span><br><span class="line">adb shell input tap <span class="number">100</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line"># 模拟滑动 从(<span class="number">650</span>, <span class="number">250</span>)到(<span class="number">200</span>,<span class="number">300</span>)</span><br><span class="line">adb shell input swipe <span class="number">650</span> <span class="number">250</span> <span class="number">200</span> <span class="number">300</span></span><br></pre></td></tr></table></figure>
<p>编写一个bat脚本，模拟用户滑动<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">echo</span> --------- Mock <span class="built_in">start</span> ----------</span><br><span class="line"></span><br><span class="line">:tag_start</span><br><span class="line"><span class="built_in">echo</span> running...</span><br><span class="line">adb shell input swipe <span class="number">650</span> <span class="number">250</span> <span class="number">200</span> <span class="number">666</span></span><br><span class="line">@<span class="built_in">ping</span> <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -n <span class="number">8</span> &gt;<span class="built_in">nul</span></span><br><span class="line"><span class="keyword">goto</span> tag_start</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> --------- Mock finish ---------</span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure></p>
<p>死循环发送滑动命令，延时语句<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">ping</span> <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -n <span class="number">8</span> &gt;<span class="built_in">nul</span></span><br></pre></td></tr></table></figure></p>
<h1 id="monkeyrunner"><a href="#monkeyrunner" class="headerlink" title="monkeyrunner"></a>monkeyrunner</h1><p>环境配置，配置好Java与Android SDK的环境变量。手机连接到电脑。<br>系统变量中加入<code>ANDROID_SWT</code>，此例中路径为<code>G:\SDK\tools\lib\x86_64</code></p>
<p>修改后的脚本<code>rustmonkeyrunner.bat</code>，Windows环境下需要在gitbash或CMD里运行</p>
<p>来自<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/44666939/unable-to-access-jarfile-framework-monkeyrunner-25-3-2-jar">unable-to-access-jarfile-framework-monkeyrunner-25-3-2-jar</a><br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="comment">rem Copyright (C) 2010 The Android Open Source Project</span></span><br><span class="line"><span class="comment">rem</span></span><br><span class="line"><span class="comment">rem Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">rem you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">rem You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">rem</span></span><br><span class="line"><span class="comment">rem      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">rem</span></span><br><span class="line"><span class="comment">rem Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">rem distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">rem See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">rem limitations under the License.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem don&#x27;t modify the caller&#x27;s environment</span></span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Set up prog to be the path of this script, including following symlinks,</span></span><br><span class="line"><span class="comment">rem and set up progdir to be the fully-qualified pathname of its directory.</span></span><br><span class="line"><span class="built_in">set</span> prog=%~f0</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Change current directory and drive to where the script is, to avoid</span></span><br><span class="line"><span class="comment">rem issues with directories containing whitespaces.</span></span><br><span class="line"><span class="built_in">cd</span> /d %~dp0</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Check we have a valid Java.exe in the path.</span></span><br><span class="line"><span class="built_in">set</span> java_exe=</span><br><span class="line"><span class="keyword">call</span> ..\lib\find_java.bat</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> java_exe <span class="keyword">goto</span> :EOF</span><br><span class="line"><span class="keyword">for</span> /f <span class="variable">%%a</span> <span class="keyword">in</span> (&quot;<span class="variable">%APP_HOME%</span>\lib\monkeyrunner-<span class="number">25</span>.<span class="number">3</span>.<span class="number">2</span>.jar&quot;) <span class="keyword">do</span> <span class="built_in">set</span> jarfile=<span class="variable">%%~</span>nxa</span><br><span class="line"><span class="built_in">set</span> frameworkdir=.</span><br><span class="line"><span class="built_in">set</span> libdir=</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">exist</span> <span class="variable">%frameworkdir%</span>\<span class="variable">%jarfile%</span> <span class="keyword">goto</span> JarFileOk</span><br><span class="line">    <span class="built_in">set</span> frameworkdir=..\lib</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">exist</span> <span class="variable">%frameworkdir%</span>\<span class="variable">%jarfile%</span> <span class="keyword">goto</span> JarFileOk</span><br><span class="line">    <span class="built_in">set</span> frameworkdir=..\framework</span><br><span class="line"></span><br><span class="line">:JarFileOk</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> jarpath=<span class="variable">%frameworkdir%</span>\<span class="variable">%jarfile%</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> ANDROID_SWT <span class="keyword">goto</span> QueryArch</span><br><span class="line">    <span class="built_in">set</span> swt_path=<span class="variable">%ANDROID_SWT%</span></span><br><span class="line">    <span class="keyword">goto</span> SwtDone</span><br><span class="line"></span><br><span class="line">:QueryArch</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> /f &quot;delims=&quot; <span class="variable">%%a</span> <span class="keyword">in</span> (&#x27;<span class="variable">%frameworkdir%</span>\..\bin\archquery&#x27;) <span class="keyword">do</span> <span class="built_in">set</span> swt_path=<span class="variable">%frameworkdir%</span>\<span class="variable">%%a</span></span><br><span class="line"></span><br><span class="line">:SwtDone</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">exist</span> &quot;<span class="variable">%swt_path%</span>&quot; <span class="keyword">goto</span> SetPath</span><br><span class="line">    <span class="built_in">echo</span> SWT folder &#x27;<span class="variable">%swt_path%</span>&#x27; does <span class="keyword">not</span> <span class="keyword">exist</span>.</span><br><span class="line">    <span class="built_in">echo</span> Please <span class="built_in">set</span> ANDROID_SWT to point to the folder containing swt.jar <span class="keyword">for</span> your platform.</span><br><span class="line">    <span class="keyword">exit</span> /B</span><br><span class="line"></span><br><span class="line">:SetPath</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> &quot;<span class="variable">%java_exe%</span>&quot; -Xmx512m &quot;-Djava.ext.dirs=<span class="variable">%frameworkdir%</span>;<span class="variable">%swt_path%</span>&quot; -Dcom.android.monkeyrunner.bindir=..\..\platform-tools -jar <span class="variable">%jarpath%</span> %*</span><br></pre></td></tr></table></figure></p>
<p>运行脚本<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC ~</span><br><span class="line">$ /cygdrive/g/SDK/tools/bin/rustmonkeyrunner.bat</span><br><span class="line">Jython 2.5.3 (2.5:c56500f08d34+, Aug 13 2012, 14:54:35)</span><br><span class="line">[Java HotSpot(TM) 64-Bit Server VM (Oracle Corporation)] on java1.8.0_77</span><br></pre></td></tr></table></figure></p>
<p>首次运行时import模块迟迟没有反应<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from com.android.monkeyrunner import MonkeyRunner, MonkeyDevice, MonkeyImage</span><br></pre></td></tr></table></figure></p>
<p>尝试运行脚本<code>an_test2.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;importing module...&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> com.android.monkeyrunner <span class="keyword">import</span> MonkeyRunner, MonkeyDevice, MonkeyImage</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;waiting for connection...&quot;</span>)</span><br><span class="line">device = MonkeyRunner.waitForConnection()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;device found!&quot;</span>)</span><br><span class="line"></span><br><span class="line">s_wid = <span class="built_in">int</span>(device.getProperty(<span class="string">&quot;display.width&quot;</span>))     <span class="comment"># 获取屏幕宽度像素</span></span><br><span class="line">s_height = <span class="built_in">int</span>(device.getProperty(<span class="string">&quot;display.height&quot;</span>)) <span class="comment"># 获取屏幕高度像素</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;build.version.sdk &quot;</span> + <span class="built_in">str</span>(device.getProperty(<span class="string">&quot;build.version.sdk&quot;</span>)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;display.width     &quot;</span> + <span class="built_in">str</span>(s_wid))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;display.height    &quot;</span> + <span class="built_in">str</span>(s_height))</span><br><span class="line"></span><br><span class="line">drag_point_left_x = <span class="number">20</span></span><br><span class="line">drag_point_right_x = s_wid - <span class="number">20</span></span><br><span class="line">drag_point_y = s_height / <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;current loop is &quot;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">    device.drag((drag_point_right_x, drag_point_y), (drag_point_left_x, drag_point_y), <span class="number">1.0</span>, <span class="number">50</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;waiting...&quot;</span>)</span><br><span class="line">    MonkeyRunner.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;continue&quot;</span>)</span><br><span class="line">    device.drag((drag_point_left_x, drag_point_y), (drag_point_right_x, drag_point_y), <span class="number">0.5</span>, <span class="number">3</span>)</span><br><span class="line">    MonkeyRunner.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-------- finish --------&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>命令行直接执行，可以看到执行结果和相应的报错信息<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;G:\SDK\tools\bin\rustmonkeyrunner.bat H:\fisher_p\py_ws\an_test2.py</span><br><span class="line">importing module...</span><br><span class="line">waiting for connection...</span><br><span class="line">device found!</span><br><span class="line">build.version.sdk 23</span><br><span class="line">display.width     1440</span><br><span class="line">display.height    2560</span><br><span class="line">current loop is 0</span><br><span class="line">waiting...</span><br><span class="line">continue</span><br><span class="line">current loop is 1</span><br><span class="line"># .....</span><br><span class="line">-------- finish --------</span><br></pre></td></tr></table></figure><br>测试中发现，脚本可以运行在系统app。若当前打开的是第三方app，会直接报错，获取不到相应信息</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15935622/getproperty-getsystemproperty-in-monkeyrunner-return-none">monkeyrunner 获取系统信息</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/studio/test/monkeyrunner/MonkeyDevice.html">Android MonkeyDevice - Google</a></li>
</ul>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/12/20/Android/Android-MediaCodec_use_demo/"><img class="fill" src="/img/android-cover-2.png" alt="Android MediaCodec 编解码"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-12-20T12:59:14.000Z" title="2017/12/20 20:59:14">2017-12-20</time>发表</span><span class="level-item"><time dateTime="2023-04-09T06:26:01.974Z" title="2023/4/9 14:26:01">2023-04-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">16 分钟读完 (大约2460个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/12/20/Android/Android-MediaCodec_use_demo/">Android MediaCodec 编解码</a></p><div class="content"><h2 id="Android-MediaCodec-使用方式"><a href="#Android-MediaCodec-使用方式" class="headerlink" title="Android MediaCodec 使用方式"></a>Android MediaCodec 使用方式</h2><p>使用MediaCodec进行编解码。输入H.264格式的数据，输出帧数据并发送给监听器。  </p>
<h4 id="H-264的配置"><a href="#H-264的配置" class="headerlink" title="H.264的配置"></a>H.264的配置</h4><p>创建并配置codec。配置codec时，若手动创建MediaFormat对象的话，一定要记得<strong>设置”csd-0”和”csd-1”这两个参数</strong>。<br>“csd-0”和”csd-1”这两个参数一定要和接收到的帧对应上。  </p>
<h4 id="输入数据"><a href="#输入数据" class="headerlink" title="输入数据"></a>输入数据</h4><p>给codec输入数据时，如果对输入数据进行排队，需要检查排队队列的情况。<br>例如一帧数据暂用1M内存，1秒30帧，排队队列有可能会暂用30M的内存。当内存暂用过高，我们需要采取一定的措施来减小内存占用。<br>codec硬解码时会受到手机硬件的影响。若手机性能不佳，编解码的速度有可能慢于原始数据输入。不得已的情况我们可以将排队中的旧数据抛弃，输入新数据。  </p>
<h4 id="解码器性能"><a href="#解码器性能" class="headerlink" title="解码器性能"></a>解码器性能</h4><p>对视频实时性要求高的场景，codec没有可用的输入缓冲区，<code>mCodec.dequeueInputBuffer</code>返回-1。<br>为了实时性，这里会强制释放掉输入输出缓冲区<code>mCodec.flush()</code>。  </p>
<h4 id="问题1-MediaCodec输入数据和输出数据数量之间有没有特定的关系"><a href="#问题1-MediaCodec输入数据和输出数据数量之间有没有特定的关系" class="headerlink" title="问题1 - MediaCodec输入数据和输出数据数量之间有没有特定的关系"></a>问题1 - MediaCodec输入数据和输出数据数量之间有没有特定的关系</h4><p>对于MediaCodec，输入数据和输出数据数量之间有没有特定的关系？假设输入10帧的数据，可以得到多少次输出？</p>
<p>实测发现，不能百分百保证输入输出次数是相等的。例如vivo x6 plus，输入30帧，能得到28帧结果。或者300次输入，得到298次输出。</p>
<h4 id="异常1-dequeueInputBuffer-0-一直返回-1"><a href="#异常1-dequeueInputBuffer-0-一直返回-1" class="headerlink" title="异常1 - dequeueInputBuffer(0)一直返回-1"></a>异常1 - dequeueInputBuffer(0)一直返回-1</h4><p>某些手机长时间编解码后，可能会出现尝试获取codec输入缓冲区时下标一直返回-1。<br>例如vivo x6 plus，运行约20分钟后，<code>mCodec.dequeueInputBuffer(0)</code>一直返回-1。</p>
<p>处理方法：如果一直返回-1，同步方式下尝试调用<code>codec.flush()</code>方法，异步方式下尝试<code>codec.flush()</code>后再调用<code>codec.start()</code>方法。</p>
<p>有一些手机解码速度太慢，有可能会经常返回-1。不要频繁调用<code>codec.flush()</code>，以免显示不正常。</p>
<h3 id="代码示例-同步方式进行编解码"><a href="#代码示例-同步方式进行编解码" class="headerlink" title="代码示例 - 同步方式进行编解码"></a>代码示例 - 同步方式进行编解码</h3><p>这一个例子使用同步方式进行编解码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解码器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodecDecoder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;CodecDecoder&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MIME_TYPE</span> <span class="operator">=</span> <span class="string">&quot;video/avc&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CSD0</span> <span class="operator">=</span> <span class="string">&quot;csd-0&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CSD1</span> <span class="operator">=</span> <span class="string">&quot;csd-1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIME_INTERNAL</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DECODER_TIME_INTERNAL</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MediaCodec mCodec;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">mCount</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 媒体解码器MediaCodec用的</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 送入编解码器前的缓冲队列</span></span><br><span class="line">    <span class="comment">// 需要实时监控这个队列所暂用的内存情况  在这里堵塞的话很容易引起OOM</span></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;<span class="type">byte</span>[]&gt; data = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DecoderThread decoderThread;</span><br><span class="line">    <span class="keyword">private</span> CodecListener listener; <span class="comment">// 自定义的监听器  当解码得到帧数据时通过它发送出去</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CodecDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        data = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCodecCreated</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mCodec!=<span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">createCodec</span><span class="params">(CodecListener listener, <span class="type">byte</span>[] spsBuffer, <span class="type">byte</span>[] ppsBuffer, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.listener = listener;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mCodec = MediaCodec.createDecoderByType(Constants.MIME_TYPE);</span><br><span class="line">            <span class="type">MediaFormat</span> <span class="variable">mediaFormat</span> <span class="operator">=</span> createVideoFormat(spsBuffer, ppsBuffer, width, height);</span><br><span class="line">            mCodec.configure(mediaFormat, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">            mCodec.start();</span><br><span class="line"></span><br><span class="line">            Log.d(TAG, <span class="string">&quot;decoderThread mediaFormat in:&quot;</span> + mediaFormat);</span><br><span class="line"></span><br><span class="line">            decoderThread = <span class="keyword">new</span> <span class="title class_">DecoderThread</span>();</span><br><span class="line">            decoderThread.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;MediaCodec create error:&quot;</span> + e.getMessage());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MediaFormat <span class="title function_">createVideoFormat</span><span class="params">(<span class="type">byte</span>[] spsBuffer, <span class="type">byte</span>[] ppsBuffer, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        MediaFormat mediaFormat;</span><br><span class="line">        mediaFormat = MediaFormat.createVideoFormat(MIME_TYPE, width, height);</span><br><span class="line">        mediaFormat.setByteBuffer(CSD0, ByteBuffer.wrap(spsBuffer));</span><br><span class="line">        mediaFormat.setByteBuffer(CSD1, ByteBuffer.wrap(ppsBuffer));</span><br><span class="line">        mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT,</span><br><span class="line">                MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Flexible);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mediaFormat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastInQueueTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入H.264帧数据  这里会监控排队情况</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addData</span><span class="params">(<span class="type">byte</span>[] dataBuffer)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timeDiff</span> <span class="operator">=</span> System.currentTimeMillis() - lastInQueueTime;</span><br><span class="line">        <span class="keyword">if</span> (timeDiff &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            lastInQueueTime = System.currentTimeMillis();</span><br><span class="line">            <span class="type">int</span> <span class="variable">queueSize</span> <span class="operator">=</span> data.size(); <span class="comment">// ConcurrentLinkedQueue查询长度时会遍历一次 在数据量巨大的情况下尽量少用这个方法</span></span><br><span class="line">            <span class="keyword">if</span> (queueSize &gt; <span class="number">30</span>) &#123;</span><br><span class="line">                data.clear();</span><br><span class="line">                LogInFile.getLogger().e(<span class="string">&quot;frame queue 帧数据队列超出上限，自动清除数据 &quot;</span> + queueSize);</span><br><span class="line">            &#125;</span><br><span class="line">            data.add(dataBuffer.clone());</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;frame queue 添加一帧数据&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogInFile.getLogger().e(<span class="string">&quot;frame queue 添加速度太快,跳过此帧. timeDiff=&quot;</span> + timeDiff);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyCodec</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCodec != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(data!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    data.clear();</span><br><span class="line">                    data = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(decoderThread!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    decoderThread.stopThread();</span><br><span class="line">                    decoderThread = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mCodec.release();</span><br><span class="line">                mCodec = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;destroyCodec exception:&quot;</span> + e.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">DecoderThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INPUT_BUFFER_FULL_COUNT_MAX</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> isRunning;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">inputBufferFullCount</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 输入缓冲区满了多少次</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopThread</span><span class="params">()</span> &#123;</span><br><span class="line">            isRunning = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            setName(<span class="string">&quot;CodecDecoder_DecoderThread-&quot;</span> + getId());</span><br><span class="line">            isRunning = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (data != <span class="literal">null</span> &amp;&amp; !data.isEmpty()) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">inputBufferIndex</span> <span class="operator">=</span> mCodec.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (inputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="type">byte</span>[] buf = data.poll();</span><br><span class="line">                            <span class="type">ByteBuffer</span> <span class="variable">inputBuffer</span> <span class="operator">=</span> mCodec.getInputBuffer(inputBufferIndex);</span><br><span class="line">                            <span class="keyword">if</span> (<span class="literal">null</span> != inputBuffer) &#123;</span><br><span class="line">                                inputBuffer.clear();</span><br><span class="line">                                inputBuffer.put(buf, <span class="number">0</span>, buf.length);</span><br><span class="line">                                mCodec.queueInputBuffer(inputBufferIndex, <span class="number">0</span>,</span><br><span class="line">                                        buf.length, mCount * TIME_INTERNAL, <span class="number">0</span>);</span><br><span class="line">                                mCount++;</span><br><span class="line">                            &#125;</span><br><span class="line">                            inputBufferFullCount = <span class="number">0</span>; <span class="comment">// 还有缓冲区可以用的时候重置计数</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            inputBufferFullCount++;</span><br><span class="line">                            LogInFile.getLogger().e(TAG, <span class="string">&quot;decoderThread inputBuffer full.  inputBufferFullCount=&quot;</span> + inputBufferFullCount);</span><br><span class="line">                            <span class="keyword">if</span> (inputBufferFullCount &gt; INPUT_BUFFER_FULL_COUNT_MAX) &#123;</span><br><span class="line">                                mCount = <span class="number">0</span>;</span><br><span class="line">                                mCodec.flush(); <span class="comment">// 在这里清除所有缓冲区</span></span><br><span class="line">                                LogInFile.getLogger().e(TAG, <span class="string">&quot;mCodec.flush()...&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Get output buffer index</span></span><br><span class="line">                    MediaCodec.<span class="type">BufferInfo</span> <span class="variable">bufferInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">outputBufferIndex</span> <span class="operator">=</span> mCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> outputBufferIndex;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;releaseOutputBuffer &quot;</span> + Thread.currentThread().toString());</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">ByteBuffer</span> <span class="variable">outputBuffer</span> <span class="operator">=</span> byteBufferClone(mCodec.getOutputBuffer(index));</span><br><span class="line">                        <span class="type">Image</span> <span class="variable">image</span> <span class="operator">=</span> mCodec.getOutputImage(index);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="literal">null</span> != image) &#123;</span><br><span class="line">                            <span class="comment">// 获取NV21格式的数据</span></span><br><span class="line">                            <span class="keyword">final</span> <span class="type">byte</span>[] nv21 = ImageUtil.getDataFromImage(image, FaceDetectUtil.COLOR_FormatNV21);</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">imageWid</span> <span class="operator">=</span> image.getWidth();</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">imageHei</span> <span class="operator">=</span> image.getHeight();</span><br><span class="line">                            <span class="comment">// 这里选择创建新的线程去发送数据 - 这是可优化的地方</span></span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                                    listener.onDataDecoded(outputBuffer,</span><br><span class="line">                                            mCodec.getOutputFormat().getInteger(MediaFormat.KEY_COLOR_FORMAT),</span><br><span class="line">                                            nv21, imageWid, imageHei);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;).start();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            listener.onDataDecoded(outputBuffer,</span><br><span class="line">                                    mCodec.getOutputFormat().getInteger(MediaFormat.KEY_COLOR_FORMAT),</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0</span>&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mCodec.releaseOutputBuffer(index, <span class="literal">false</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                            android.util.Log.e(TAG, <span class="string">&quot;releaseOutputBuffer ERROR&quot;</span>, ex);</span><br><span class="line">                        &#125;</span><br><span class="line">                        outputBufferIndex = mCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;decoderThread exception:&quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(DECODER_TIME_INTERNAL);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deep clone byteBuffer</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ByteBuffer <span class="title function_">byteBufferClone</span><span class="params">(ByteBuffer buffer)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (buffer.remaining() == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ByteBuffer.wrap(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">clone</span> <span class="operator">=</span> ByteBuffer.allocate(buffer.remaining());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (buffer.hasArray()) &#123;</span><br><span class="line">            System.arraycopy(buffer.array(), buffer.arrayOffset() + buffer.position(), clone.array(), <span class="number">0</span>, buffer.remaining());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            clone.put(buffer.duplicate());</span><br><span class="line">            clone.flip();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h3 id="代码示例-工具函数"><a href="#代码示例-工具函数" class="headerlink" title="代码示例 - 工具函数"></a>代码示例 - 工具函数</h3><p>一些工具函数。比如从image中取出NV21格式的数据。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] getDataFromImage(Image image) &#123;</span><br><span class="line">    <span class="keyword">return</span> getDataFromImage(image, COLOR_FormatNV21);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将Image根据colorFormat类型的byte数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] getDataFromImage(Image image, <span class="type">int</span> colorFormat) &#123;</span><br><span class="line">    <span class="keyword">if</span> (colorFormat != COLOR_FormatI420 &amp;&amp; colorFormat != COLOR_FormatNV21) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;only support COLOR_FormatI420 &quot;</span> + <span class="string">&quot;and COLOR_FormatNV21&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isImageFormatSupported(image)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;can&#x27;t convert Image to byte array, format &quot;</span> + image.getFormat());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Rect</span> <span class="variable">crop</span> <span class="operator">=</span> image.getCropRect();</span><br><span class="line">    <span class="type">int</span> <span class="variable">format</span> <span class="operator">=</span> image.getFormat();</span><br><span class="line">    <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> crop.width();</span><br><span class="line">    <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> crop.height();</span><br><span class="line">    Image.Plane[] planes = image.getPlanes();</span><br><span class="line">    <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[width * height * ImageFormat.getBitsPerPixel(format) / <span class="number">8</span>];</span><br><span class="line">    <span class="type">byte</span>[] rowData = <span class="keyword">new</span> <span class="title class_">byte</span>[planes[<span class="number">0</span>].getRowStride()];</span><br><span class="line">    <span class="type">int</span> <span class="variable">channelOffset</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">outputStride</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; planes.length; i++) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                channelOffset = <span class="number">0</span>;</span><br><span class="line">                outputStride = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (colorFormat == COLOR_FormatI420) &#123;</span><br><span class="line">                    channelOffset = width * height;</span><br><span class="line">                    outputStride = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorFormat == COLOR_FormatNV21) &#123;</span><br><span class="line">                    channelOffset = width * height + <span class="number">1</span>;</span><br><span class="line">                    outputStride = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> (colorFormat == COLOR_FormatI420) &#123;</span><br><span class="line">                    channelOffset = (<span class="type">int</span>) (width * height * <span class="number">1.25</span>);</span><br><span class="line">                    outputStride = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorFormat == COLOR_FormatNV21) &#123;</span><br><span class="line">                    channelOffset = width * height;</span><br><span class="line">                    outputStride = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> planes[i].getBuffer();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rowStride</span> <span class="operator">=</span> planes[i].getRowStride();</span><br><span class="line">        <span class="type">int</span> <span class="variable">pixelStride</span> <span class="operator">=</span> planes[i].getPixelStride();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">shift</span> <span class="operator">=</span> (i == <span class="number">0</span>) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> width &gt;&gt; shift;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> height &gt;&gt; shift;</span><br><span class="line">        buffer.position(rowStride * (crop.top &gt;&gt; shift) + pixelStride * (crop.left &gt;&gt; shift));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> <span class="number">0</span>; row &lt; h; row++) &#123;</span><br><span class="line">            <span class="type">int</span> length;</span><br><span class="line">            <span class="keyword">if</span> (pixelStride == <span class="number">1</span> &amp;&amp; outputStride == <span class="number">1</span>) &#123;</span><br><span class="line">                length = w;</span><br><span class="line">                buffer.get(data, channelOffset, length);</span><br><span class="line">                channelOffset += length;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                length = (w - <span class="number">1</span>) * pixelStride + <span class="number">1</span>;</span><br><span class="line">                buffer.get(rowData, <span class="number">0</span>, length);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">col</span> <span class="operator">=</span> <span class="number">0</span>; col &lt; w; col++) &#123;</span><br><span class="line">                    data[channelOffset] = rowData[col * pixelStride];</span><br><span class="line">                    channelOffset += outputStride;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (row &lt; h - <span class="number">1</span>) &#123;</span><br><span class="line">                buffer.position(buffer.position() + rowStride - length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否是支持的数据类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isImageFormatSupported</span><span class="params">(Image image)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">format</span> <span class="operator">=</span> image.getFormat();</span><br><span class="line">    <span class="keyword">switch</span> (format) &#123;</span><br><span class="line">        <span class="keyword">case</span> ImageFormat.YUV_420_888:</span><br><span class="line">        <span class="keyword">case</span> ImageFormat.NV21:</span><br><span class="line">        <span class="keyword">case</span> ImageFormat.YV12:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>“csd-0”和”csd-1”是什么，对于H264视频的话，它对应的是sps和pps，对于AAC音频的话，对应的是ADTS，做音视频开发的人应该都知道，它一般存在于编码器生成的IDR帧之中。</p>
<p>得到的mediaFormat<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaFormat in:&#123;height=720, width=1280, csd-1=java.nio.ByteArrayBuffer[position=0,limit=7,capacity=7], mime=video/avc, csd-0=java.nio.ByteArrayBuffer[position=0,limit=13,capacity=13], color-format=2135033992&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="存储图片的方法"><a href="#存储图片的方法" class="headerlink" title="存储图片的方法"></a>存储图片的方法</h3><p>Image类在Android API21及以后功能十分强大。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dumpFile</span><span class="params">(String fileName, <span class="type">byte</span>[] data)</span> &#123;</span><br><span class="line">    FileOutputStream outStream;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(fileName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unable to create output file &quot;</span> + fileName, ioe);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outStream.write(data);</span><br><span class="line">        outStream.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;failed writing data to file &quot;</span> + fileName, ioe);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">compressToJpeg</span><span class="params">(String fileName, Image image)</span> &#123;</span><br><span class="line">    FileOutputStream outStream;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(fileName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unable to create output file &quot;</span> + fileName, ioe);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Rect</span> <span class="variable">rect</span> <span class="operator">=</span> image.getCropRect();</span><br><span class="line">    <span class="type">YuvImage</span> <span class="variable">yuvImage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YuvImage</span>(getDataFromImage(image, COLOR_FormatNV21), ImageFormat.NV21, rect.width(), rect.height(), <span class="literal">null</span>);</span><br><span class="line">    yuvImage.compressToJpeg(rect, <span class="number">100</span>, outStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NV21转bitmap的方法"><a href="#NV21转bitmap的方法" class="headerlink" title="NV21转bitmap的方法"></a>NV21转bitmap的方法</h3><p>直接存入文件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in try catch</span></span><br><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(Environment.getExternalStorageDirectory() + <span class="string">&quot;/imagename.jpg&quot;</span>);</span><br><span class="line"><span class="type">YuvImage</span> <span class="variable">yuvImage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YuvImage</span>(nv21bytearray, ImageFormat.NV21, width, height, <span class="literal">null</span>);</span><br><span class="line">yuvImage.compressToJpeg(<span class="keyword">new</span> <span class="title class_">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, width, height), <span class="number">100</span>, fos);</span><br><span class="line">fos.close();</span><br></pre></td></tr></table></figure></p>
<p>获得Bitmap对象的方法，这个方法耗时耗内存<br>NV21 -&gt; yuvImage -&gt; jpeg -&gt; bitmap<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in try catch</span></span><br><span class="line"><span class="type">YuvImage</span> <span class="variable">yuvImage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YuvImage</span>(nv21bytearray, ImageFormat.NV21, width, height, <span class="literal">null</span>);</span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">yuvImage.compressToJpeg(<span class="keyword">new</span> <span class="title class_">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, width, height), <span class="number">100</span>, os);</span><br><span class="line"><span class="type">byte</span>[] jpegByteArray = os.toByteArray();</span><br><span class="line"><span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> BitmapFactory.decodeByteArray(jpegByteArray, <span class="number">0</span>, jpegByteArray.length);</span><br><span class="line">os.close();</span><br></pre></td></tr></table></figure></p>
<p>参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/32276522/convert-nv21-byte-array-into-bitmap-readable-format">https://stackoverflow.com/questions/32276522/convert-nv21-byte-array-into-bitmap-readable-format</a></p>
<h3 id="codec选择YUV420格式输出OutputBuffer的问题"><a href="#codec选择YUV420格式输出OutputBuffer的问题" class="headerlink" title="codec选择YUV420格式输出OutputBuffer的问题"></a>codec选择YUV420格式输出OutputBuffer的问题</h3><p>假设codec选择的格式是<code>COLOR_FormatYUV420Flexible</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Flexible);</span><br></pre></td></tr></table></figure><br>解码后，得到的格式是<code>COLOR_QCOM_FormatYUV420SemiPlanar32m // 0x7FA30C04</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mCodec.getOutputFormat().getInteger(MediaFormat.KEY_COLOR_FORMAT)</span><br></pre></td></tr></table></figure><br>解码出来的<code>ByteBuffer oBuffer = mCodec.getOutputBuffer(index);</code>包含元素个数为1413120；记为<code>nv21Codec</code><br>而通过<code>mCodec.getOutputImage(index)</code>得到的image对象获取到的nv21数组元素个数为1382400；记为<code>nv21</code>，这些是我们想要的数据</p>
<p>对比这2个数组我们发现，前面的y部分是相同的。<code>nv21</code>前921600个元素是y数据，后460800个元素是uv数据。<br><code>nv21Codec</code>前921600个元素是y数据，之后的20480个字节都是0，再接下来的460800个元素是uv数据。最后的10240个字节是0</p>
<p><code>nv21</code>和<code>nv21Codec</code>的uv部分存储顺序是相反的。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.polarxiong.com/archives/Android-MediaCodec%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E7%A1%AC%E4%BB%B6%E8%A7%A3%E7%A0%81-%E9%AB%98%E6%95%88%E7%8E%87%E5%BE%97%E5%88%B0YUV%E6%A0%BC%E5%BC%8F%E5%B8%A7-%E5%BF%AB%E9%80%9F%E4%BF%9D%E5%AD%98JPEG%E5%9B%BE%E7%89%87-%E4%B8%8D%E4%BD%BF%E7%94%A8OpenGL.html">Android: MediaCodec视频文件硬件解码,高效率得到YUV格式帧,快速保存JPEG图片(不使用OpenGL)(附Demo)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.polarxiong.com/archives/Android-Image%E7%B1%BB%E6%B5%85%E6%9E%90-%E7%BB%93%E5%90%88YUV_420_888.html">Android: Image类浅析(结合YUV_420_888)</a></li>
<li><a target="_blank" rel="noopener" href="http://bigflake.com/mediacodec/">Android MediaCodec stuff</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/leixiaohua1020/">雷霄骅(leixiaohua1020)的专栏</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/leixiaohua1020/article/details/15811977">[总结]FFMPEG视音频编解码零基础学习方法 - 雷霄骅</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Bilibili/ijkplayer">Bilibili/ijkplayer - Github</a></li>
</ul>
<p>Android音视频相关文章请参考 <a target="_blank" rel="noopener" href="https://rustfisher.com/tags/Android-Media/">https://rustfisher.com/tags/Android-Media/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-11-23T09:53:15.000Z" title="2017/11/23 17:53:15">2017-11-23</time>发表</span><span class="level-item"><time dateTime="2018-09-21T01:03:47.000Z" title="2018/9/21 09:03:47">2018-09-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/PyQt/">PyQt</a></span><span class="level-item">1 分钟读完 (大约140个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/23/PyQt_note/PyQt-QFileDialog_use/">PyQt QFileDialog 文件选择弹窗</a></p><div class="content"><p>弹出文件选择框。可以自定义选择框的标题，默认位置，目标文件后缀</p>
<p>选择框弹出后，会阻塞UI线程。</p>
<h2 id="PyQt5文件选择框的例子"><a href="#PyQt5文件选择框的例子" class="headerlink" title="PyQt5文件选择框的例子"></a>PyQt5文件选择框的例子</h2><p>这里只选择一个bat文件。如果默认目录不存在，则查找当前目录<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_click_tu_choose_file_path_btn1</span>(<span class="params">self</span>):</span><br><span class="line">    default_path = <span class="string">&#x27;C:\MY&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(default_path):</span><br><span class="line">        default_path = os.getcwd()</span><br><span class="line">    dlg = QFileDialog(<span class="literal">None</span>, <span class="string">&quot;choose_bat_file&quot;</span>, default_path, <span class="string">&#x27;All Files(*.bat)&#x27;</span>)</span><br><span class="line">    dlg.setFileMode(QFileDialog.AnyFile)</span><br><span class="line">    <span class="keyword">if</span> dlg.exec_():</span><br><span class="line">        selected_name = dlg.selectedFiles()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> selected_name:</span><br><span class="line">            self.ma.tu_filePathTv1.setText(self.tr(selected_name))</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/2017/11/21/Python/Python-logging-use/"><img class="fill" src="/img/python-logo.png" alt="Python logging 基本用法"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-11-21T10:47:20.000Z" title="2017/11/21 18:47:20">2017-11-21</time>发表</span><span class="level-item"><time dateTime="2023-04-09T06:26:01.999Z" title="2023/4/9 14:26:01">2023-04-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Python/">Python</a></span><span class="level-item">1 分钟读完 (大约152个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/11/21/Python/Python-logging-use/">Python logging 基本用法</a></p><div class="content"><p>本文记录<strong>logging</strong>模块的用法</p>
<p>创建文件<code>logger.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">LOG_FILE = <span class="string">&#x27;app_history.log&#x27;</span></span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.INFO,</span><br><span class="line">                    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(filename)s[line:%(lineno)d] %(levelname)s %(message)s&#x27;</span>,</span><br><span class="line">                    <span class="comment"># datefmt=&#x27;%Y_%m_%d_%H:%M:%S&#x27;,</span></span><br><span class="line">                    filename=LOG_FILE,</span><br><span class="line">                    filemode=<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">console = logging.StreamHandler()</span><br><span class="line">console.setLevel(logging.INFO)</span><br><span class="line">formatter = logging.Formatter(<span class="string">&#x27;%(name)-12s: %(levelname)-8s %(message)s&#x27;</span>)</span><br><span class="line">console.setFormatter(formatter)</span><br><span class="line">logging.getLogger(LOG_FILE).addHandler(console)</span><br></pre></td></tr></table></figure>
<p>调用<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger.logging.info(<span class="string">&quot;%-13s connected: %r&quot;</span> % (ip_address, connected))</span><br></pre></td></tr></table></figure></p>
<p><code>%(asctime)s</code> 表示这个位置上是字符串形式的当前时间<br><code>datefmt=&#39;%Y_%m_%d_%H:%M:%S&#39;</code> 指定了时间格式；我们也可以不指定时间格式</p>
<p>查看写出的log文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2017-11-23 13:39:35,295 - xxx.py[line:122] INFO [MainWindow] --------- App Starts ---------</span><br></pre></td></tr></table></figure></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-10-25T03:36:05.000Z" title="2017/10/25 11:36:05">2017-10-25</time>发表</span><span class="level-item"><time dateTime="2018-09-21T01:03:47.000Z" title="2018/9/21 09:03:47">2018-09-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/PyQt/">PyQt</a></span><span class="level-item">7 分钟读完 (大约999个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/10/25/PyQt_note/PyQt-Install_licensed_PyQt/">PyQt5 安装商业版</a></p><div class="content"><p>对于Windows7上的Python2，需要如下工具：</p>
<ul>
<li>visual studio</li>
<li>sip</li>
<li>Qt(SDK)</li>
</ul>
<p>如果电脑上已经装有了PyQt4，建议再装一份Python。与原来的分开。</p>
<h2 id="win7安装社区版Visual-Studio"><a href="#win7安装社区版Visual-Studio" class="headerlink" title="win7安装社区版Visual Studio"></a>win7安装社区版Visual Studio</h2><p>使用Visual Studio是为了它的编译工具和相关库。安装时选上Windows SDK。</p>
<p>对于VS2017来说，使用的是这个工具 “D:\Microsoft Visual Studio\2017\Community\Common7\Tools\VsDevCmd.bat”<br>开始-所有程序-Visual Studio 2017-Visual Studio Tools</p>
<p>vs安装路径 <code>D:\Microsoft Visual Studio</code><br>环境变量<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D:\Microsoft Visual Studio\2017\Community\VC\Tools\MSVC\14.11.25503\bin\Hostx64\x64;</span><br><span class="line">D:\Microsoft Visual Studio\2017\Community\VC\Tools\MSVC\14.11.25503\lib;</span><br></pre></td></tr></table></figure></p>
<h2 id="Python2-7安装sip"><a href="#Python2-7安装sip" class="headerlink" title="Python2.7安装sip"></a>Python2.7安装sip</h2><p>win7 64位系统，但Python2.7是32位</p>
<p>下载sip源码包（例如sip-4.19.3），解压到任意位置。进入sip源码包，执行<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python configure.py</span><br></pre></td></tr></table></figure><br>这里Python2.7安装在<code>D:\python27</code>；于是sip位置在<code>D:\python27\Lib\site-packages\sip-4.19.3</code><br>打开vs的命令行，进入sip在Python中的目录，执行<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmake</span><br><span class="line">nmake install</span><br></pre></td></tr></table></figure></p>
<h2 id="win7安装Qt5"><a href="#win7安装Qt5" class="headerlink" title="win7安装Qt5"></a>win7安装Qt5</h2><p>到Qt官网下载安装包。为了照顾32位的Python2.7，这里选择Qt 5.6.3 for Windows 32-bit (VS 2015, 869 MB)</p>
<p>添加到环境变量中<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\Qt\Qt5\5.6.3\msvc2015\bin;D:\Qt\Qt5\Tools\QtCreator\bin</span><br></pre></td></tr></table></figure></p>
<h2 id="win7编译安装商业版PyQt5"><a href="#win7编译安装商业版PyQt5" class="headerlink" title="win7编译安装商业版PyQt5"></a>win7编译安装商业版PyQt5</h2><p>Python2.7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python configure.py --disable QtNfc</span><br><span class="line">nmake</span><br><span class="line">nmake install</span><br></pre></td></tr></table></figure>
<p>参考PyQt5的README<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COMMERCIAL VERSION</span><br><span class="line"></span><br><span class="line">If you have the Commercial version of PyQt5 then you should also have a</span><br><span class="line">license file that you downloaded separately.  The license file must be copied</span><br><span class="line">to the &quot;sip&quot; directory before starting to build PyQt5.</span><br></pre></td></tr></table></figure><br>我们把买来的license文件复制到sip目录下。</p>
<p>在<code>E:\ws\doc\PyQtCommercial\PyQt5_commercial-5.9</code>中，把付费后得到的<code>pyqt-commercial.sip</code>复制到sip目录下</p>
<p>使用vs2017的命令行工具！</p>
<p><code>python configure.py</code>出现错误<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: Use the --qmake argument to explicitly specify a working Qt qmake.</span><br></pre></td></tr></table></figure><br>网上说是因为没有配置好Qt SDK的原因<br>可参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7854599/pyqt-setup-for-qt-4-7-4">PyQt setup for Qt 4.7.4</a><br>解决错误后，会提示是否接受license。根据提示输入yes。</p>
<p>执行<code>python configure.py --disable QtNfc</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Querying qmake about your Qt installation...</span><br><span class="line">Determining the details of your Qt installation...</span><br><span class="line">This is the commercial version of PyQt 5.9 (licensed under the PyQt Commercial</span><br><span class="line">License) for Python 2.7.13 on win32.</span><br></pre></td></tr></table></figure></p>
<h3 id="nmake报错-cannot-open-file-“msvcprt-lib”"><a href="#nmake报错-cannot-open-file-“msvcprt-lib”" class="headerlink" title="nmake报错 cannot open file “msvcprt.lib”"></a>nmake报错 cannot open file “msvcprt.lib”</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error LNK1104: cannot open file “msvcprt.lib”</span><br></pre></td></tr></table></figure>
<p>把lib路径添加到环境变量 <code>D:\Microsoft Visual Studio\2017\Community\VC\Tools\MSVC\14.11.25503\lib;</code></p>
<h3 id="nmake报错-QtNfc-dll-fatal-error-LNK1169-one-or-more-multiply-defined-symbols-found"><a href="#nmake报错-QtNfc-dll-fatal-error-LNK1169-one-or-more-multiply-defined-symbols-found" class="headerlink" title="nmake报错 QtNfc.dll : fatal error LNK1169: one or more multiply defined symbols found"></a>nmake报错 QtNfc.dll : fatal error LNK1169: one or more multiply defined symbols found</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">release\QtNfc.dll : fatal error LNK1169: 找到一个或多个多重定义的符号</span><br><span class="line">NMAKE : fatal error U1077: “&quot;D:\Microsoft Visual Studio\2017\Community\VC\Tools</span><br><span class="line">\MSVC\14.11.25503\bin\HostX86\x86\link.EXE&quot;”: 返回代码“0x491”</span><br><span class="line">Stop.</span><br><span class="line">NMAKE : fatal error U1077: “&quot;D:\Microsoft Visual Studio\2017\Community\VC\Tools</span><br><span class="line">\MSVC\14.11.25503\bin\HostX86\x86\nmake.exe&quot;”: 返回代码“0x2”</span><br><span class="line">Stop.</span><br><span class="line">NMAKE : fatal error U1077: “cd”: 返回代码“0x2”</span><br><span class="line">Stop.</span><br></pre></td></tr></table></figure>
<p>网上有相关的建议，把QtNfc“取消”掉，其实就是不编译QtNfc。</p>
<p><code>E:\ws\doc\PyQtCommercial\PyQt5_commercial-5.9&gt;python configure.py --disable QtNfc</code></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://python.6.x6.nabble.com/error-building-QtNfc-td5185657.html">http://python.6.x6.nabble.com/error-building-QtNfc-td5185657.html</a></p>
</blockquote>
<p><code>nmake</code> 需要一段时间。电脑比较差的话，大概要1个小时。<br><code>nmake install</code> 耗时约5分钟</p>
<h3 id="试运行PyQt5"><a href="#试运行PyQt5" class="headerlink" title="试运行PyQt5"></a>试运行PyQt5</h3><p>导入PyQt5模块试一试<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QTranslator</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure></p>
<p>对于Python2.7 PyQt5，使用pyinstaller来打包成exe文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller ui_main.py</span><br></pre></td></tr></table></figure><br>得到相应的文件目录</p>
<h4 id="运行exe弹窗报错Qt-platform-plugin"><a href="#运行exe弹窗报错Qt-platform-plugin" class="headerlink" title="运行exe弹窗报错Qt platform plugin"></a>运行exe弹窗报错<code>Qt platform plugin</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">this application failed to start because it could not find or load the Qt platform plugin &quot;windows&quot; in &quot;&quot;</span><br><span class="line">Reinstalling the application may fix this problem.</span><br></pre></td></tr></table></figure>
<p>报错原因是找不到 <code>Qt platform plugin</code><br>在Qt5，在安装目录下可找到 <code>D:\Qt\Qt5\Tools\QtCreator\bin\plugins\platforms</code><br>对于Python3，安装了GPL的PyQt5，可以找到 <code>D:\python35\Lib\site-packages\PyQt5\Qt\plugins\platforms</code></p>
<p>处理方法：<br>不打包成一个单一的exe文件，使用<code>pyinstaller ui_main.py</code>生成文件目录<br>在dist中，与exe文件同级的目录<code>PyQt5/qt/plugins</code>中，有platforms目录<br>把platforms文件夹复制到与exe文件同级的位置即可  </p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/25589103/how-to-install-pyqt5-on-windows-for-python-2">How to install PyQt5 on Windows for Python 2?</a></p>
<p><a target="_blank" rel="noopener" href="http://python.6.x6.nabble.com/PyQT-Sip-installation-td1923578.html">编译安装PyQt5的过程</a></p>
<p><a target="_blank" rel="noopener" href="https://riverbankcomputing.com/pipermail/pyqt/2012-July/031691.html">安装sip的建议</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/11/">上一页</a></div><div class="pagination-next"><a href="/page/13/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/11/">11</a></li><li><a class="pagination-link is-current" href="/page/12/">12</a></li><li><a class="pagination-link" href="/page/13/">13</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/18/">18</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/fish.png" alt="RustFisher"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">RustFisher</p><p class="is-size-6 is-block">技术，学习，实践，开发，读书</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">108</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">20</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">56</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/RustFisher" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/RustFisher"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7286632197002340" data-ad-slot="8064535079" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://an.rustfisher.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">技术记录</span></span><span class="level-right"><span class="level-item tag">an.rustfisher.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Android-note/"><span class="level-start"><span class="level-item">Android_note</span></span><span class="level-end"><span class="level-item tag">37</span></span></a></li><li><a class="level is-mobile" href="/categories/Android-tutorial-2020/"><span class="level-start"><span class="level-item">Android_tutorial_2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/CocosCreator/"><span class="level-start"><span class="level-item">CocosCreator</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Database/"><span class="level-start"><span class="level-item">Database</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Design-pattern/"><span class="level-start"><span class="level-item">Design_pattern</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Flutter-note/"><span class="level-start"><span class="level-item">Flutter_note</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/HTTP/"><span class="level-start"><span class="level-item">HTTP</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux-note/"><span class="level-start"><span class="level-item">Linux_note</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/MongoDB/"><span class="level-start"><span class="level-item">MongoDB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/NestJS/"><span class="level-start"><span class="level-item">NestJS</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/PyQt/"><span class="level-start"><span class="level-item">PyQt</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/TypeScript/"><span class="level-start"><span class="level-item">TypeScript</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/WebRTC/"><span class="level-start"><span class="level-item">WebRTC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Web-note/"><span class="level-start"><span class="level-item">Web_note</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/miniprogram/"><span class="level-start"><span class="level-item">miniprogram</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/reading/"><span class="level-start"><span class="level-item">reading</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/unclassified/"><span class="level-start"><span class="level-item">unclassified</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%80%BB%E7%BB%93/"><span class="level-start"><span class="level-item">总结</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-04-11T06:12:59.000Z">2023-04-11</time></p><p class="title"><a href="/2023/04/11/reading/SocialScience/TRIBE-OF-MENTORS-note/">《巨人的方法》读书笔记</a></p><p class="categories"><a href="/categories/reading/">reading</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-18T08:32:32.000Z">2023-01-18</time></p><p class="title"><a href="/2023/01/18/unclassified/web-res-move-2023/">网站资源迁移说明</a></p><p class="categories"><a href="/categories/unclassified/">unclassified</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-30T15:59:59.000Z">2021-11-30</time></p><p class="title"><a href="/2021/11/30/Summary/2021-11/">2021年11月总结</a></p><p class="categories"><a href="/categories/%E6%80%BB%E7%BB%93/">总结</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-09T12:28:11.000Z">2021-11-09</time></p><p class="title"><a href="/2021/11/09/WebRTC/webRTC-concept-intro/">WebRTC概念介绍</a></p><p class="categories"><a href="/categories/WebRTC/">WebRTC</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-13T15:15:14.000Z">2021-10-13</time></p><p class="title"><a href="/2021/10/13/Python/scrapy-hw-blog-record/">Python抓取博客记录，获取标题与url</a></p><p class="categories"><a href="/categories/Python/">Python</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/"><span class="level-start"><span class="level-item">2019</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/"><span class="level-start"><span class="level-item">2018</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/"><span class="level-start"><span class="level-item">2017</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/"><span class="level-start"><span class="level-item">2016</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/"><span class="level-start"><span class="level-item">2015</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AIDL/"><span class="tag">AIDL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-2020/"><span class="tag">Android-2020</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-Broadcast/"><span class="tag">Android_Broadcast</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-Media/"><span class="tag">Android_Media</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-View/"><span class="tag">Android_View</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-service/"><span class="tag">Android_service</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android%E6%BA%90%E7%A0%81/"><span class="tag">Android源码</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Binder/"><span class="tag">Binder</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocos-Creator/"><span class="tag">Cocos Creator</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Excel/"><span class="tag">Excel</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Handler/"><span class="tag">Handler</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Matplotlib/"><span class="tag">Matplotlib</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Media/"><span class="tag">Media</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MediaPlayer/"><span class="tag">MediaPlayer</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NDK/"><span class="tag">NDK</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NestJS/"><span class="tag">NestJS</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Network/"><span class="tag">Network</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OkHttp/"><span class="tag">OkHttp</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell/"><span class="tag">Shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thread/"><span class="tag">Thread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tools/"><span class="tag">Tools</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebRTC/"><span class="tag">WebRTC</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebSocket/"><span class="tag">WebSocket</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/css/"><span class="tag">css</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/echarts/"><span class="tag">echarts</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/for/"><span class="tag">for</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gradle/"><span class="tag">gradle</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo%E4%B8%BB%E9%A2%98/"><span class="tag">hexo主题</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/http/"><span class="tag">http</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mac/"><span class="tag">mac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mmap/"><span class="tag">mmap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/network/"><span class="tag">network</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openpyxl/"><span class="tag">openpyxl</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/plot/"><span class="tag">plot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/plt/"><span class="tag">plt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pyecharts/"><span class="tag">pyecharts</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%AC%E4%BC%97%E5%8F%B7/"><span class="tag">公众号</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91%E7%A4%BE%E5%8C%BA/"><span class="tag">华为云社区</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%8E%E7%AB%AF/"><span class="tag">后端</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%89%E8%A3%85mysql/"><span class="tag">安装mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"><span class="tag">小程序</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"><span class="tag">开发记录</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%BB%E7%BB%93/"><span class="tag">总结</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">数据库</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%88%AC%E8%99%AB/"><span class="tag">爬虫</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="tag">设计模式</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"><span class="tag">读书笔记</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%90%E8%90%A5%E7%9A%84Python%E6%8C%87%E5%8D%97/"><span class="tag">运营的Python指南</span><span class="tag">4</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/fish.png" alt="RustFisher的自留地" height="28"></a><p class="is-size-7"><span>&copy; 2023 Rust Fisher</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2023 Rust Fisher</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>