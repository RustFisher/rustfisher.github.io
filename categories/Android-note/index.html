<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>分类: Android_note - RustFisher的自留地</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="RustFisher的自留地"><meta name="msapplication-TileImage" content="/img/fish.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="RustFisher的自留地"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="技术学习与实践，一些开发记录，读书笔记"><meta property="og:type" content="blog"><meta property="og:title" content="RustFisher的自留地"><meta property="og:url" content="https://blog.rustfisher.com/"><meta property="og:site_name" content="RustFisher的自留地"><meta property="og:description" content="技术学习与实践，一些开发记录，读书笔记"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.rustfisher.com/img/og_image.png"><meta property="article:author" content="Rust Fisher"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://blog.rustfisher.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.rustfisher.com"},"headline":"RustFisher的自留地","image":["https://blog.rustfisher.com/img/og_image.png"],"author":{"@type":"Person","name":"Rust Fisher"},"publisher":{"@type":"Organization","name":"RustFisher的自留地","logo":{"@type":"ImageObject","url":"https://blog.rustfisher.com/img/fish.png"}},"description":"技术学习与实践，一些开发记录，读书笔记"}</script><link rel="icon" href="/img/fish.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-NT4BCBCQTP" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-NT4BCBCQTP');</script><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/fish.png" alt="RustFisher的自留地" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/RustFisher"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">分类</a></li><li class="is-active"><a href="#" aria-current="page">Android_note</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-01-11T13:52:04.000Z" title="2020/1/11 21:52:04">2020-01-11</time>发表</span><span class="level-item"><time dateTime="2021-06-18T14:28:32.028Z" title="2021/6/18 22:28:32">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">10 分钟读完 (大约1427个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/01/11/Android/Android-Camera_SurfaceView_TextureView_get_nv21/">Android SurfaceView TextureView 预览Camera，获取NV21数据</a></p><div class="content"><ul>
<li>win7</li>
<li>Android Studio 3.0.1</li>
</ul>
<p>本文目的：使用 Camera API 进行视频的采集，分别使用 SurfaceView、TextureView 来预览 Camera 数据，取到 NV21 的数据回调</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>使用相机权限<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.CAMERA&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><br>camera预览回调中默认使用NV21格式。</p>
<p>检查手机是否支持摄像头。</p>
<p>UI准备<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 全屏显示 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;FullScreenTheme&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;AppTheme&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;windowNoTitle&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowFullscreen&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><br>承载预览图像<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/camera_preview&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="使用-SurfaceView-预览-Camera，取到NV21数据"><a href="#使用-SurfaceView-预览-Camera，取到NV21数据" class="headerlink" title="使用 SurfaceView 预览 Camera，取到NV21数据"></a>使用 SurfaceView 预览 Camera，取到NV21数据</h3><p>自定义<code>CameraPreview</code>继承<code>SurfaceView</code>，实现<code>SurfaceHolder.Callback</code>接口</p>
<p>获取NV21数据，<code>Camera.setPreviewCallback()</code> 要放在 <code>Camera.startPreview()</code> 之前。<br>使用<code>Camera.PreviewCallback</code>获取预览数据回调。默认是NV21格式。</p>
<p><code>surfaceChanged</code>中，camera启动预览前可以进行设置，例如设置尺寸，调整方向<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * camera预览视图</span></span><br><span class="line"><span class="comment"> * Created by Rust on 2018/2/26.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CameraPreview</span> <span class="keyword">extends</span> <span class="title class_">SurfaceView</span> <span class="keyword">implements</span> <span class="title class_">SurfaceHolder</span>.Callback &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;rustApp&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> SurfaceHolder mHolder;</span><br><span class="line">    <span class="keyword">private</span> Camera mCamera;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mFrameCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CameraPreview</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CameraPreview</span><span class="params">(Context context, Camera camera)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">        mCamera = camera;</span><br><span class="line">        mHolder = getHolder();</span><br><span class="line">        mHolder.addCallback(<span class="built_in">this</span>);</span><br><span class="line">        mHolder.setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCamera</span><span class="params">(Camera c)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mCamera = c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">surfaceCreated</span><span class="params">(SurfaceHolder holder)</span> &#123;</span><br><span class="line">        <span class="comment">// 开启预览</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mCamera.setPreviewDisplay(holder);</span><br><span class="line">            mCamera.startPreview();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Error setting camera preview: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">surfaceDestroyed</span><span class="params">(SurfaceHolder holder)</span> &#123;</span><br><span class="line">        <span class="comment">// 可在此释放camera</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">surfaceChanged</span><span class="params">(SurfaceHolder holder, <span class="type">int</span> format, <span class="type">int</span> w, <span class="type">int</span> h)</span> &#123;</span><br><span class="line">        <span class="comment">// 若需要旋转、更改大小或重新设置，请确保证已停止预览</span></span><br><span class="line">        <span class="keyword">if</span> (mHolder.getSurface() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mCamera.stopPreview();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// ignore: tried to stop a non-existent preview</span></span><br><span class="line">        &#125;</span><br><span class="line">        Camera.<span class="type">Parameters</span> <span class="variable">parameters</span> <span class="operator">=</span> mCamera.getParameters();</span><br><span class="line">        <span class="comment">// ImageFormat.NV21 == 17</span></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;parameters.getPreviewFormat(): &quot;</span> + parameters.getPreviewFormat());</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.getResources().getConfiguration().orientation != Configuration.ORIENTATION_LANDSCAPE) &#123;</span><br><span class="line">            mCamera.setDisplayOrientation(<span class="number">90</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mCamera.setDisplayOrientation(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mCamera.setPreviewDisplay(mHolder);</span><br><span class="line">            mCamera.setPreviewCallback(mCameraPreviewCallback); <span class="comment">// 回调要放在 startPreview() 之前</span></span><br><span class="line">            mCamera.startPreview();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Error starting camera preview: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Camera.<span class="type">PreviewCallback</span> <span class="variable">mCameraPreviewCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Camera</span>.PreviewCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPreviewFrame</span><span class="params">(<span class="type">byte</span>[] data, Camera camera)</span> &#123;</span><br><span class="line">            mFrameCount++;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onPreviewFrame: data.length=&quot;</span> + data.length + <span class="string">&quot;, frameCount=&quot;</span> + mFrameCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了防止阻塞UI线程，在子线程中打开camera。camera常放在try catch中使用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;rustApp&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Camera mCamera;</span><br><span class="line">    <span class="keyword">private</span> CameraPreview mPreview;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InitCameraThread</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == mCamera) &#123;</span><br><span class="line">            <span class="keyword">if</span> (safeCameraOpen()) &#123;</span><br><span class="line">                mPreview.setCamera(mCamera); <span class="comment">// 重新获取camera操作权</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;无法操作camera&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.onResume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onPause();</span><br><span class="line">        releaseCamera();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">safeCameraOpen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">qOpened</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            releaseCamera();</span><br><span class="line">            mCamera = Camera.open();</span><br><span class="line">            qOpened = (mCamera != <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;failed to open Camera&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> qOpened;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">releaseCamera</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCamera != <span class="literal">null</span>) &#123;</span><br><span class="line">            mCamera.setPreviewCallback(<span class="literal">null</span>);</span><br><span class="line">            mCamera.release();        <span class="comment">// release the camera for other applications</span></span><br><span class="line">            mCamera = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">InitCameraThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">            <span class="keyword">if</span> (safeCameraOpen()) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;开启摄像头&quot;</span>);</span><br><span class="line">                runOnUiThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        mPreview = <span class="keyword">new</span> <span class="title class_">CameraPreview</span>(MainActivity.<span class="built_in">this</span>, mCamera);</span><br><span class="line">                        <span class="type">FrameLayout</span> <span class="variable">preview</span> <span class="operator">=</span> findViewById(R.id.camera_preview);</span><br><span class="line">                        preview.addView(mPreview);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="使用-TextureView-预览-Camera，取到NV21数据"><a href="#使用-TextureView-预览-Camera，取到NV21数据" class="headerlink" title="使用 TextureView 预览 Camera，取到NV21数据"></a>使用 TextureView 预览 Camera，取到NV21数据</h3><p><code>TextureView</code>可用于显示内容流。内容流可以是视频或者OpenGL的场景。内容流可来自应用进程或是远程其它进程。</p>
<p><code>Textureview</code>必须在硬件加速开启的窗口中使用。若是软解，<code>TextureView</code>不会显示东西。</p>
<p>不同于<code>SurfaceView</code>，<code>TextureView</code>不会建立一个单独的窗口，而是像一个常规的View一样（个人认为这是个优点）。<br>这使得<code>TextureView</code>可以被移动，转换或是添加动画。比如，可以调用<code>myView.setAlpha(0.5f)</code>将其设置成半透明。</p>
<p>使用<code>TextureView</code>很简单：获取到它的<code>SurfaceTexture</code>，使用<code>SurfaceTexture</code>呈现内容。</p>
<p><code>CameraPreview</code>继承了<code>TextureView</code>，外部需要传入camera实例。在<code>onSurfaceTextureAvailable</code>中，配置camera，比如设置图像方向。<br>通过设置<code>Camera.PreviewCallback</code>来取得预览数据。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.Configuration;</span><br><span class="line"><span class="keyword">import</span> android.graphics.SurfaceTexture;</span><br><span class="line"><span class="keyword">import</span> android.hardware.Camera;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.TextureView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CameraPreview</span> <span class="keyword">extends</span> <span class="title class_">TextureView</span> <span class="keyword">implements</span> <span class="title class_">TextureView</span>.SurfaceTextureListener &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;rustApp&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> Camera mCamera;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CameraPreview</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CameraPreview</span><span class="params">(Context context, Camera camera)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">        mCamera = camera;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCamera</span><span class="params">(Camera camera)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mCamera = camera;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSurfaceTextureAvailable</span><span class="params">(SurfaceTexture surface, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;TextureView onSurfaceTextureAvailable&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.getResources().getConfiguration().orientation != Configuration.ORIENTATION_LANDSCAPE) &#123;</span><br><span class="line">            mCamera.setDisplayOrientation(<span class="number">90</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mCamera.setDisplayOrientation(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mCamera.setPreviewCallback(mCameraPreviewCallback);</span><br><span class="line">            mCamera.setPreviewTexture(surface); <span class="comment">// 使用SurfaceTexture</span></span><br><span class="line">            mCamera.startPreview();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            <span class="comment">// Something bad happened</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSurfaceTextureSizeChanged</span><span class="params">(SurfaceTexture surface, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;TextureView onSurfaceTextureSizeChanged&quot;</span>); <span class="comment">// Ignored, Camera does all the work for us</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onSurfaceTextureDestroyed</span><span class="params">(SurfaceTexture surface)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;TextureView onSurfaceTextureDestroyed&quot;</span>);</span><br><span class="line">        mCamera.stopPreview();</span><br><span class="line">        mCamera.release();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSurfaceTextureUpdated</span><span class="params">(SurfaceTexture surface)</span> &#123;</span><br><span class="line">        <span class="comment">// Invoked every time there&#x27;s a new Camera preview frame</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Camera.<span class="type">PreviewCallback</span> <span class="variable">mCameraPreviewCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Camera</span>.PreviewCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPreviewFrame</span><span class="params">(<span class="type">byte</span>[] data, Camera camera)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onPreviewFrame: data.length=&quot;</span> + data.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>操作界面<code>TextureAct</code>。获取camera操作权，初始化<code>CameraPreview</code>并添加到布局中。第一次获取camera时在子线程中操作。</p>
<p>在<code>onPause</code>中释放camera，<code>onResume</code>中尝试取回camera控制权。这样应用暂时退回后台时，其他应用可以操作摄像头。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TextureAct</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;rustApp&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> Camera mCamera;</span><br><span class="line">    <span class="keyword">private</span> CameraPreview mPreview;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_texture);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InitCameraThread</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == mCamera) &#123;</span><br><span class="line">            <span class="keyword">if</span> (safeCameraOpen()) &#123;</span><br><span class="line">                mPreview.setCamera(mCamera); <span class="comment">// 重新获取camera操作权</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;无法操作camera&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">super</span>.onResume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onPause();</span><br><span class="line">        releaseCamera();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        releaseCamera();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">safeCameraOpen</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">qOpened</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            releaseCamera();</span><br><span class="line">            mCamera = Camera.open();</span><br><span class="line">            qOpened = (mCamera != <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;failed to open Camera&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> qOpened;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">releaseCamera</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCamera != <span class="literal">null</span>) &#123;</span><br><span class="line">            mCamera.setPreviewCallback(<span class="literal">null</span>);</span><br><span class="line">            mCamera.release();        <span class="comment">// release the camera for other applications</span></span><br><span class="line">            mCamera = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">InitCameraThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">            <span class="keyword">if</span> (safeCameraOpen()) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;TextureAct 开启摄像头&quot;</span>);</span><br><span class="line">                runOnUiThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        mPreview = <span class="keyword">new</span> <span class="title class_">CameraPreview</span>(TextureAct.<span class="built_in">this</span>, mCamera);</span><br><span class="line">                        mPreview.setSurfaceTextureListener(mPreview);</span><br><span class="line">                        <span class="type">FrameLayout</span> <span class="variable">preview</span> <span class="operator">=</span> findViewById(R.id.camera_preview);</span><br><span class="line">                        preview.addView(mPreview);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><code>Textureview</code>必须在硬件加速开启的窗口中使用。<code>android:hardwareAccelerated=&quot;true&quot;</code> 默认的这个属性就是true，无需再设置。</p>
<p>每接到一帧数据，就会调用一次<code>onSurfaceTextureUpdated()</code>。通过这个接口。能够将上来的SurfaceTexture送给OpenGL再去处理。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/training/camera/cameradirect.html">Controlling the Camera - Android Developer</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/media/camera.html">Camera API - Android Developer</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/view/TextureView.html">TextureView - Android Developer</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-01-10T17:15:01.000Z" title="2020/1/11 01:15:01">2020-01-11</time>发表</span><span class="level-item"><time dateTime="2021-06-18T14:30:38.015Z" title="2021/6/18 22:30:38">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">7 分钟读完 (大约1069个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/01/11/Android/Android-Camera_record_video_and_output/">Android Camera API 音视频采集、编码、封包成mp4</a></p><div class="content">使用camera的api录制音视频，输出mp4文件。完整示例。</div><a class="article-more button is-small is-size-7" href="/2020/01/11/Android/Android-Camera_record_video_and_output/#more">阅读更多</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-01-10T10:52:12.000Z" title="2020/1/10 18:52:12">2020-01-10</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:37:53.305Z" title="2021/6/18 17:37:53">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">18 分钟读完 (大约2650个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/01/10/Android/Android-AudioRecord_AudioTrack_pcm_wav/">Android 音频PCM数据的采集和播放，读写音频wav文件</a></p><div class="content"><p>本文目的：使用 AudioRecord 和 AudioTrack 完成音频PCM数据的采集和播放，并读写音频wav文件</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>Android提供了AudioRecord和MediaRecord。MediaRecord可选择录音的格式。<br>AudioRecord得到PCM编码格式的数据。AudioRecord能够设置模拟信号转化为数字信号的相关参数，包括采样率和量化深度，同时也包括通道数目等。</p>
<h3 id="PCM"><a href="#PCM" class="headerlink" title="PCM"></a>PCM</h3><p>PCM是在由模拟信号向数字信号转化的一种常用的编码格式，称为脉冲编码调制，PCM将模拟信号按照一定的间距划分为多段，然后通过二进制去量化每一个间距的强度。<br>PCM表示的是音频文件中随着时间的流逝的一段音频的振幅。Android在WAV文件中支持PCM的音频数据。</p>
<h3 id="WAV"><a href="#WAV" class="headerlink" title="WAV"></a>WAV</h3><p>WAV，MP3等比较常见的音频格式，不同的编码格式对应不通过的原始音频。为了方便传输，通常会压缩原始音频。<br>为了辨别出音频格式，每种格式有特定的头文件（header）。<br>WAV以RIFF为标准。RIFF是一种资源交换档案标准。RIFF将文件存储在每一个标记块中。<br>基本构成单位是trunk，每个trunk由标记位，数据大小，数据存储，三个部分构成。 </p>
<h3 id="PCM打包成WAV"><a href="#PCM打包成WAV" class="headerlink" title="PCM打包成WAV"></a>PCM打包成WAV</h3><p>PCM是原始音频数据，WAV是windows中常见的音频格式，只是在pcm数据中添加了一个文件头。</p>
<table>
<thead>
<tr>
<th style="text-align:left">起始地址</th>
<th style="text-align:left">占用空间</th>
<th style="text-align:left">本地址数字的含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">00H</td>
<td style="text-align:left">4byte</td>
<td style="text-align:left">RIFF，资源交换文件标志。</td>
</tr>
<tr>
<td style="text-align:left">04H</td>
<td style="text-align:left">4byte</td>
<td style="text-align:left">从下一个地址开始到文件尾的总字节数。高位字节在后面，这里就是001437ECH，换成十进制是1325036byte，算上这之前的8byte就正好1325044byte了。</td>
</tr>
<tr>
<td style="text-align:left">08H</td>
<td style="text-align:left">4byte</td>
<td style="text-align:left">WAVE，代表wav文件格式。</td>
</tr>
<tr>
<td style="text-align:left">0CH</td>
<td style="text-align:left">4byte</td>
<td style="text-align:left">FMT ，波形格式标志</td>
</tr>
<tr>
<td style="text-align:left">10H</td>
<td style="text-align:left">4byte</td>
<td style="text-align:left">00000010H，16PCM，我的理解是用16bit的数据表示一个量化结果。</td>
</tr>
<tr>
<td style="text-align:left">14H</td>
<td style="text-align:left">2byte</td>
<td style="text-align:left">为1时表示线性PCM编码，大于1时表示有压缩的编码。这里是0001H。</td>
</tr>
<tr>
<td style="text-align:left">16H</td>
<td style="text-align:left">2byte</td>
<td style="text-align:left">1为单声道，2为双声道，这里是0001H。</td>
</tr>
<tr>
<td style="text-align:left">18H</td>
<td style="text-align:left">4byte</td>
<td style="text-align:left">采样频率，这里是00002B11H，也就是11025Hz。</td>
</tr>
<tr>
<td style="text-align:left">1CH</td>
<td style="text-align:left">4byte</td>
<td style="text-align:left">Byte率=<code>采样频率*音频通道数*每次采样得到的样本位数/8</code>，00005622H，也就是<code>22050Byte/s=11025*1*16/2</code></td>
</tr>
<tr>
<td style="text-align:left">20H</td>
<td style="text-align:left">2byte</td>
<td style="text-align:left">块对齐=通道数<em>每次采样得到的样本位数/8，0002H，也就是 `2 == 1</em>16/8`</td>
</tr>
<tr>
<td style="text-align:left">22H</td>
<td style="text-align:left">2byte</td>
<td style="text-align:left">样本数据位数，0010H即16，一个量化样本占2byte。</td>
</tr>
<tr>
<td style="text-align:left">24H</td>
<td style="text-align:left">4byte</td>
<td style="text-align:left">data，一个标志而已。</td>
</tr>
<tr>
<td style="text-align:left">28H</td>
<td style="text-align:left">4byte</td>
<td style="text-align:left">Wav文件实际音频数据所占的大小，这里是001437C8H即1325000，再加上2CH就正好是1325044，整个文件的大小。</td>
</tr>
<tr>
<td style="text-align:left">2CH</td>
<td style="text-align:left">不定</td>
<td style="text-align:left">量化数据</td>
</tr>
</tbody>
</table>
<h3 id="AudioRecord"><a href="#AudioRecord" class="headerlink" title="AudioRecord"></a>AudioRecord</h3><p>AudioRecord可实现从音频输入设备记录声音的功能。得到PCM格式的音频。<br>读取音频的方法有<code>read(byte[], int, int)</code>， <code>read(short[], int, int)</code> 或 <code>read(ByteBuffer, int)</code>。<br>可根据存储方式和需求选择使用这项方法。</p>
<p>需要权限<code>&lt;uses-permission android:name=&quot;android.permission.RECORD_AUDIO&quot; /&gt;</code></p>
<h4 id="AudioRecord-构造函数"><a href="#AudioRecord-构造函数" class="headerlink" title="AudioRecord 构造函数"></a>AudioRecord 构造函数</h4><p><code>public AudioRecord(int audioSource, int sampleRateInHz, int channelConfig, int audioFormat, int bufferSizeInBytes)</code></p>
<ul>
<li>audioSource 音源设备，常用麦克风<code>MediaRecorder.AudioSource.MIC</code></li>
<li>samplerateInHz 采样频率，44100Hz是目前所有设备都支持的频率</li>
<li>channelConfig 音频通道，单声道还是立体声</li>
<li>audioFormat 该参数为量化深度，即为每次采样的位数</li>
<li>bufferSizeInBytes 可通过<code>getMinBufferSize()</code>方法确定，每次从硬件读取数据所需要的缓冲区的大小。</li>
</ul>
<h4 id="获取wav文件"><a href="#获取wav文件" class="headerlink" title="获取wav文件"></a>获取wav文件</h4><p>若要获得wav文件，需要在PCM基础上增加一个header。可以将PCM文件转换成wav，这里提供一种PCM与wav几乎同时生成的思路。</p>
<p>PCM与wav同时创建，给wav文件一个默认的header。录制线程启动后，同时写PCM与wav。<br>录制完成时，重新生成header，利用<code>RandomAccessFile</code>修改wav文件的header。</p>
<h3 id="AudioTrack"><a href="#AudioTrack" class="headerlink" title="AudioTrack"></a>AudioTrack</h3><p>使用<code>AudioTrack</code>播放音频。初始化AudioTrack时，要根据录制时的参数进行设定。</p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>工具类<code>WindEar</code>实现音频PCM数据的采集和播放，与读写音频wav文件的功能。</p>
<ul>
<li><code>AudioRecordThread</code> 使用<code>AudioRecord</code>录制PCM文件，可选择同时生成wav文件</li>
<li><code>AudioTrackPlayThread</code> 使用AudioTrack播放PCM或wav音频文件的线程</li>
<li><code>WindState</code> 表示当前状态，例如是否在播放，录制等等</li>
</ul>
<p>PCM文件的读写采用<code>FileOutputStream</code>和<code>FileInputStream</code></p>
<p><code>generateWavFileHeader</code>方法可以生成wav文件的header</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 音频录制器</span></span><br><span class="line"><span class="comment"> * 使用 AudioRecord 和 AudioTrack API 完成音频 PCM 数据的采集和播放，并实现读写音频 wav 文件</span></span><br><span class="line"><span class="comment"> * 检查权限，检查麦克风的工作放在Activity中进行</span></span><br><span class="line"><span class="comment"> * Created by Rust on 2018/2/24.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WindEar</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;rustApp&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TMP_FOLDER_NAME</span> <span class="operator">=</span> <span class="string">&quot;AnWindEar&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RECORD_AUDIO_BUFFER_TIMES</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAY_AUDIO_BUFFER_TIMES</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">AUDIO_FREQUENCY</span> <span class="operator">=</span> <span class="number">44100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RECORD_CHANNEL_CONFIG</span> <span class="operator">=</span> AudioFormat.CHANNEL_IN_STEREO;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PLAY_CHANNEL_CONFIG</span> <span class="operator">=</span> AudioFormat.CHANNEL_OUT_STEREO;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">AUDIO_ENCODING</span> <span class="operator">=</span> AudioFormat.ENCODING_PCM_16BIT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AudioRecordThread aRecordThread;           <span class="comment">// 录制线程</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">WindState</span> <span class="variable">state</span> <span class="operator">=</span> WindState.IDLE; <span class="comment">// 当前状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">File</span> <span class="variable">tmpPCMFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">File</span> <span class="variable">tmpWavFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> OnState onStateListener;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Handler</span> <span class="variable">mainHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PCM缓存目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String cachePCMFolder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * wav缓存目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String wavFolderPath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">WindEar</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WindEar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">WindEar</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> WindEar <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == instance) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">WindEar</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOnStateListener</span><span class="params">(OnState onStateListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.onStateListener = onStateListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="comment">// 存储在App内或SD卡上</span></span><br><span class="line"><span class="comment">//        cachePCMFolder = context.getFilesDir().getAbsolutePath() + File.separator + TMP_FOLDER_NAME;</span></span><br><span class="line">        cachePCMFolder = Environment.getExternalStorageDirectory().getAbsolutePath() + File.separator</span><br><span class="line">                + TMP_FOLDER_NAME;</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">folder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(cachePCMFolder);</span><br><span class="line">        <span class="keyword">if</span> (!folder.exists()) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">f</span> <span class="operator">=</span> folder.mkdirs();</span><br><span class="line">            Log.d(TAG, String.format(Locale.CHINA, <span class="string">&quot;PCM目录:%s -&gt; %b&quot;</span>, cachePCMFolder, f));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (File f : folder.listFiles()) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">d</span> <span class="operator">=</span> f.delete();</span><br><span class="line">                Log.d(TAG, String.format(Locale.CHINA, <span class="string">&quot;删除PCM文件:%s %b&quot;</span>, f.getName(), d));</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, String.format(Locale.CHINA, <span class="string">&quot;PCM目录:%s&quot;</span>, cachePCMFolder));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        wavFolderPath = Environment.getExternalStorageDirectory().getAbsolutePath() + File.separator</span><br><span class="line">                + TMP_FOLDER_NAME;</span><br><span class="line"><span class="comment">//        wavFolderPath = context.getFilesDir().getAbsolutePath() + File.separator + TMP_FOLDER_NAME;</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">wavDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(wavFolderPath);</span><br><span class="line">        <span class="keyword">if</span> (!wavDir.exists()) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">w</span> <span class="operator">=</span> wavDir.mkdirs();</span><br><span class="line">            Log.d(TAG, String.format(Locale.CHINA, <span class="string">&quot;wav目录:%s -&gt; %b&quot;</span>, wavFolderPath, w));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.d(TAG, String.format(Locale.CHINA, <span class="string">&quot;wav目录:%s&quot;</span>, wavFolderPath));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始录制音频</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startRecord</span><span class="params">(<span class="type">boolean</span> createWav)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!state.equals(WindState.IDLE)) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;无法开始录制，当前状态为 &quot;</span> + state);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tmpPCMFile = File.createTempFile(<span class="string">&quot;recording&quot;</span>, <span class="string">&quot;.pcm&quot;</span>, <span class="keyword">new</span> <span class="title class_">File</span>(cachePCMFolder));</span><br><span class="line">            <span class="keyword">if</span> (createWav) &#123;</span><br><span class="line">                <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyMMdd_HHmmss&quot;</span>, Locale.CHINA);</span><br><span class="line">                tmpWavFile = <span class="keyword">new</span> <span class="title class_">File</span>(wavFolderPath + File.separator + <span class="string">&quot;r&quot;</span> + sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot;.wav&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;tmp file &quot;</span> + tmpPCMFile.getName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != aRecordThread) &#123;</span><br><span class="line">            aRecordThread.interrupt();</span><br><span class="line">            aRecordThread = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        aRecordThread = <span class="keyword">new</span> <span class="title class_">AudioRecordThread</span>(createWav);</span><br><span class="line">        aRecordThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">stopRecord</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!state.equals(WindState.RECORDING)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        state = WindState.STOP_RECORD;</span><br><span class="line">        notifyState(state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 播放录制好的PCM文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startPlayPCM</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isIdle()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AudioTrackPlayThread</span>(tmpPCMFile).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 播放录制好的wav文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startPlayWav</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isIdle()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AudioTrackPlayThread</span>(tmpWavFile).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">stopPlay</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!state.equals(WindState.PLAYING)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        state = WindState.STOP_PLAY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">isIdle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> WindState.IDLE.equals(state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 音频录制线程</span></span><br><span class="line"><span class="comment">     * 使用FileOutputStream来写文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">AudioRecordThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        AudioRecord aRecord;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bufferSize</span> <span class="operator">=</span> <span class="number">10240</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">createWav</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        AudioRecordThread(<span class="type">boolean</span> createWav) &#123;</span><br><span class="line">            <span class="built_in">this</span>.createWav = createWav;</span><br><span class="line">            bufferSize = AudioRecord.getMinBufferSize(AUDIO_FREQUENCY,</span><br><span class="line">                    RECORD_CHANNEL_CONFIG, AUDIO_ENCODING) * RECORD_AUDIO_BUFFER_TIMES;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;record buffer size = &quot;</span> + bufferSize);</span><br><span class="line">            aRecord = <span class="keyword">new</span> <span class="title class_">AudioRecord</span>(MediaRecorder.AudioSource.MIC, AUDIO_FREQUENCY,</span><br><span class="line">                    RECORD_CHANNEL_CONFIG, AUDIO_ENCODING, bufferSize);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            state = WindState.RECORDING;</span><br><span class="line">            notifyState(state);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;录制开始&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 这里选择FileOutputStream而不是DataOutputStream</span></span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">pcmFos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(tmpPCMFile);</span><br><span class="line"></span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">wavFos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(tmpWavFile);</span><br><span class="line">                <span class="keyword">if</span> (createWav) &#123;</span><br><span class="line">                    writeWavFileHeader(wavFos, bufferSize, AUDIO_FREQUENCY, aRecord.getChannelCount());</span><br><span class="line">                &#125;</span><br><span class="line">                aRecord.startRecording();</span><br><span class="line">                <span class="type">byte</span>[] byteBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[bufferSize];</span><br><span class="line">                <span class="keyword">while</span> (state.equals(WindState.RECORDING) &amp;&amp; !isInterrupted()) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> aRecord.read(byteBuffer, <span class="number">0</span>, byteBuffer.length);</span><br><span class="line">                    pcmFos.write(byteBuffer, <span class="number">0</span>, end);</span><br><span class="line">                    pcmFos.flush();</span><br><span class="line">                    <span class="keyword">if</span> (createWav) &#123;</span><br><span class="line">                        wavFos.write(byteBuffer, <span class="number">0</span>, end);</span><br><span class="line">                        wavFos.flush();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                aRecord.stop(); <span class="comment">// 录制结束</span></span><br><span class="line">                pcmFos.close();</span><br><span class="line">                wavFos.close();</span><br><span class="line">                <span class="keyword">if</span> (createWav) &#123;</span><br><span class="line">                    <span class="comment">// 修改header</span></span><br><span class="line">                    <span class="type">RandomAccessFile</span> <span class="variable">wavRaf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(tmpWavFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">                    <span class="type">byte</span>[] header = generateWavFileHeader(tmpPCMFile.length(), AUDIO_FREQUENCY, aRecord.getChannelCount());</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;header: &quot;</span> + getHexString(header));</span><br><span class="line">                    wavRaf.seek(<span class="number">0</span>);</span><br><span class="line">                    wavRaf.write(header);</span><br><span class="line">                    wavRaf.close();</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;tmpWavFile.length: &quot;</span> + tmpWavFile.length());</span><br><span class="line">                &#125;</span><br><span class="line">                Log.i(TAG, <span class="string">&quot;audio tmp PCM file len: &quot;</span> + tmpPCMFile.length());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;AudioRecordThread:&quot;</span>, e);</span><br><span class="line">                notifyState(WindState.ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">            notifyState(state);</span><br><span class="line">            state = WindState.IDLE;</span><br><span class="line">            notifyState(state);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;录制结束&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getHexString</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : bytes) &#123;</span><br><span class="line">            sb.append(Integer.toHexString(b)).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AudioTrack播放音频线程</span></span><br><span class="line"><span class="comment">     * 使用FileInputStream读取文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">AudioTrackPlayThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        AudioTrack track;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bufferSize</span> <span class="operator">=</span> <span class="number">10240</span>;</span><br><span class="line">        <span class="type">File</span> <span class="variable">audioFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        AudioTrackPlayThread(File aFile) &#123;</span><br><span class="line">            setPriority(Thread.MAX_PRIORITY);</span><br><span class="line">            audioFile = aFile;</span><br><span class="line">            <span class="type">int</span> <span class="variable">bufferSize</span> <span class="operator">=</span> AudioTrack.getMinBufferSize(AUDIO_FREQUENCY,</span><br><span class="line">                    PLAY_CHANNEL_CONFIG, AUDIO_ENCODING) * PLAY_AUDIO_BUFFER_TIMES;</span><br><span class="line">            track = <span class="keyword">new</span> <span class="title class_">AudioTrack</span>(AudioManager.STREAM_MUSIC,</span><br><span class="line">                    AUDIO_FREQUENCY,</span><br><span class="line">                    PLAY_CHANNEL_CONFIG, AUDIO_ENCODING, bufferSize,</span><br><span class="line">                    AudioTrack.MODE_STREAM);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.run();</span><br><span class="line">            state = WindState.PLAYING;</span><br><span class="line">            notifyState(state);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(audioFile);</span><br><span class="line">                track.play();</span><br><span class="line">                <span class="type">byte</span>[] aByteBuffer = <span class="keyword">new</span> <span class="title class_">byte</span>[bufferSize];</span><br><span class="line">                <span class="keyword">while</span> (state.equals(WindState.PLAYING) &amp;&amp;</span><br><span class="line">                        fis.read(aByteBuffer) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    track.write(aByteBuffer, <span class="number">0</span>, aByteBuffer.length);</span><br><span class="line">                &#125;</span><br><span class="line">                track.stop();</span><br><span class="line">                track.release();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;AudioTrackPlayThread:&quot;</span>, e);</span><br><span class="line">                notifyState(WindState.ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">            state = WindState.STOP_PLAY;</span><br><span class="line">            notifyState(state);</span><br><span class="line">            state = WindState.IDLE;</span><br><span class="line">            notifyState(state);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">notifyState</span><span class="params">(<span class="keyword">final</span> WindState currentState)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != onStateListener) &#123;</span><br><span class="line">            mainHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    onStateListener.onStateChanged(currentState);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OnState</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onStateChanged</span><span class="params">(WindState currentState)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 表示当前状态</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">WindState</span> &#123;</span><br><span class="line">        ERROR,</span><br><span class="line">        IDLE,</span><br><span class="line">        RECORDING,</span><br><span class="line">        STOP_RECORD,</span><br><span class="line">        PLAYING,</span><br><span class="line">        STOP_PLAY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out            wav音频文件流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> totalAudioLen  不包括header的音频数据总长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> longSampleRate 采样率,也就是录制时使用的频率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channels       audioRecord的频道数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException 写文件错误</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeWavFileHeader</span><span class="params">(FileOutputStream out, <span class="type">long</span> totalAudioLen, <span class="type">long</span> longSampleRate,</span></span><br><span class="line"><span class="params">                                    <span class="type">int</span> channels)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] header = generateWavFileHeader(totalAudioLen, longSampleRate, channels);</span><br><span class="line">        out.write(header, <span class="number">0</span>, header.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任何一种文件在头部添加相应的头文件才能够确定的表示这种文件的格式，</span></span><br><span class="line"><span class="comment">     * wave是RIFF文件结构，每一部分为一个chunk，其中有RIFF WAVE chunk，</span></span><br><span class="line"><span class="comment">     * FMT Chunk，Fact chunk,Data chunk,其中Fact chunk是可以选择的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pcmAudioByteCount 不包括header的音频数据总长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> longSampleRate    采样率,也就是录制时使用的频率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channels          audioRecord的频道数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] generateWavFileHeader(<span class="type">long</span> pcmAudioByteCount, <span class="type">long</span> longSampleRate, <span class="type">int</span> channels) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">totalDataLen</span> <span class="operator">=</span> pcmAudioByteCount + <span class="number">36</span>; <span class="comment">// 不包含前8个字节的WAV文件总长度</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">byteRate</span> <span class="operator">=</span> longSampleRate * <span class="number">2</span> * channels;</span><br><span class="line">        <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">44</span>];</span><br><span class="line">        header[<span class="number">0</span>] = <span class="string">&#x27;R&#x27;</span>; <span class="comment">// RIFF</span></span><br><span class="line">        header[<span class="number">1</span>] = <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">        header[<span class="number">2</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">        header[<span class="number">3</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        header[<span class="number">4</span>] = (<span class="type">byte</span>) (totalDataLen &amp; <span class="number">0xff</span>);<span class="comment">//数据大小</span></span><br><span class="line">        header[<span class="number">5</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">6</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">7</span>] = (<span class="type">byte</span>) ((totalDataLen &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">        header[<span class="number">8</span>] = <span class="string">&#x27;W&#x27;</span>;<span class="comment">//WAVE</span></span><br><span class="line">        header[<span class="number">9</span>] = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        header[<span class="number">10</span>] = <span class="string">&#x27;V&#x27;</span>;</span><br><span class="line">        header[<span class="number">11</span>] = <span class="string">&#x27;E&#x27;</span>;</span><br><span class="line">        <span class="comment">//FMT Chunk</span></span><br><span class="line">        header[<span class="number">12</span>] = <span class="string">&#x27;f&#x27;</span>; <span class="comment">// &#x27;fmt &#x27;</span></span><br><span class="line">        header[<span class="number">13</span>] = <span class="string">&#x27;m&#x27;</span>;</span><br><span class="line">        header[<span class="number">14</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">        header[<span class="number">15</span>] = <span class="string">&#x27; &#x27;</span>;<span class="comment">//过渡字节</span></span><br><span class="line">        <span class="comment">//数据大小</span></span><br><span class="line">        header[<span class="number">16</span>] = <span class="number">16</span>; <span class="comment">// 4 bytes: size of &#x27;fmt &#x27; chunk</span></span><br><span class="line">        header[<span class="number">17</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">18</span>] = <span class="number">0</span>;</span><br><span class="line">        header[<span class="number">19</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//编码方式 10H为PCM编码格式</span></span><br><span class="line">        header[<span class="number">20</span>] = <span class="number">1</span>; <span class="comment">// format = 1</span></span><br><span class="line">        header[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//通道数</span></span><br><span class="line">        header[<span class="number">22</span>] = (<span class="type">byte</span>) channels;</span><br><span class="line">        header[<span class="number">23</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//采样率，每个通道的播放速度</span></span><br><span class="line">        header[<span class="number">24</span>] = (<span class="type">byte</span>) (longSampleRate &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">25</span>] = (<span class="type">byte</span>) ((longSampleRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">26</span>] = (<span class="type">byte</span>) ((longSampleRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">27</span>] = (<span class="type">byte</span>) ((longSampleRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="comment">//音频数据传送速率,采样率*通道数*采样深度/8</span></span><br><span class="line">        header[<span class="number">28</span>] = (<span class="type">byte</span>) (byteRate &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">29</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">30</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">31</span>] = (<span class="type">byte</span>) ((byteRate &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="comment">// 确定系统一次要处理多少个这样字节的数据，确定缓冲区，通道数*采样位数</span></span><br><span class="line">        header[<span class="number">32</span>] = (<span class="type">byte</span>) (<span class="number">2</span> * channels);</span><br><span class="line">        header[<span class="number">33</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//每个样本的数据位数</span></span><br><span class="line">        header[<span class="number">34</span>] = <span class="number">16</span>;</span><br><span class="line">        header[<span class="number">35</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//Data chunk</span></span><br><span class="line">        header[<span class="number">36</span>] = <span class="string">&#x27;d&#x27;</span>;<span class="comment">//data</span></span><br><span class="line">        header[<span class="number">37</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        header[<span class="number">38</span>] = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">        header[<span class="number">39</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        header[<span class="number">40</span>] = (<span class="type">byte</span>) (pcmAudioByteCount &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">41</span>] = (<span class="type">byte</span>) ((pcmAudioByteCount &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">42</span>] = (<span class="type">byte</span>) ((pcmAudioByteCount &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        header[<span class="number">43</span>] = (<span class="type">byte</span>) ((pcmAudioByteCount &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xff</span>);</span><br><span class="line">        <span class="keyword">return</span> header;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/AudioRecord.html">AudioRecord - developer.android.com</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/AudioTrack.html">AudioTrack - developer.android.com</a></li>
</ul>
<p>Android音视频相关文章请参考 <a target="_blank" rel="noopener" href="https://rustfisher.com/tags/Android-Media/">https://rustfisher.com/tags/Android-Media/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-10-18T11:42:00.000Z" title="2019/10/18 19:42:00">2019-10-18</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:42.403Z" title="2021/6/18 17:38:42">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">4 分钟读完 (大约650个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/10/18/Android/Android-OkHttp_Retrofit_download_file_partial/">Android OkHttp + Retrofit 断点续传</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file_partial/">本文链接</a></p>
<p>前面我们已经知道如何<a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file/">使用OkHttp+Retrofit下载文件</a>。<br>下载文件时，可能会遇到一些意外情况，比如网络错误或是用户暂停了下载。<br>再次启动下载，如果又要从头开始，会白白浪费前面下载好的内容。<br>断点续传功能可以从上次停止的地方继续下载文件。</p>
<h2 id="http范围请求"><a href="#http范围请求" class="headerlink" title="http范围请求"></a>http范围请求</h2><p>Range 是一个请求首部，告知服务器返回文件的哪一部分。<br>在一个 Range 首部中，可以一次性请求多个部分，服务器会以 multipart 文件的形式将其返回。<br>如果服务器返回的是范围响应，需要使用 206 Partial Content 状态码。<br>假如所请求的范围不合法，那么服务器会返回  416 Range Not Satisfiable 状态码，表示客户端错误。<br>服务器允许忽略Range首部，从而返回整个文件，状态码用200。</p>
<p>示例<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-</span><br><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;</span><br><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;</span><br><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;</span><br></pre></td></tr></table></figure></p>
<p>发起请求时，一般Range的内容写成 bytes=0-100 这样的形式。<br>或者请求多个部分时，指定多个范围。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Range: bytes=200-1000, 2000-6576, 19000- </span><br></pre></td></tr></table></figure></p>
<p>Content-Range 表示主体长度或者尺寸。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range</a></p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>参考<br><a target="_blank" rel="noopener" href="https://github.com/AnRFDev/android-Basic4/tree/master/appdowloadsample">https://github.com/AnRFDev/android-Basic4/tree/master/appdowloadsample</a></p>
<p>使用OkHttp添加Range头部，告知服务器我们需要的文件数据范围。</p>
<p>定义的方法中要求传入 @Header(“Range”)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">interface</span> <span class="title class_">ApiService</span> &#123;</span><br><span class="line">    <span class="meta">@Streaming</span></span><br><span class="line">    <span class="meta">@GET</span></span><br><span class="line">    Observable&lt;ResponseBody&gt; <span class="title function_">downloadPartial</span><span class="params">(<span class="meta">@Url</span> String url, <span class="meta">@Header(&quot;Range&quot;)</span> String range)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>需要传入的Range字符串形如 bytes=200-1000</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">retrofit.create(ApiService.class)</span><br><span class="line">    .downloadPartial(callBack.getUrl(), <span class="string">&quot;bytes=&quot;</span> + startByte + <span class="string">&quot;-&quot;</span>)</span><br><span class="line">    .subscribeOn(Schedulers.newThread())</span><br><span class="line">    .observeOn(Schedulers.io())</span><br><span class="line">    .doOnNext(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;ResponseBody&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(ResponseBody responseBody)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            callBack.saveFile(responseBody);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .doOnError(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;Throwable&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Throwable throwable)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            tellDownloadError(callBack.getUrl(), throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">    .subscribe(<span class="keyword">new</span> <span class="title class_">Observer</span>&lt;ResponseBody&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Disposable d)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(ResponseBody responseBody)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">            callBack.setState(DownloadTaskState.ERROR);</span><br><span class="line">            tellDownloadError(callBack.getUrl(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>我们也可以在下载前，先去检查文件已下载的部分的大小，再决定Range范围。<br>续传时，写入本地文件注意选择流的append模式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>更多请参考：</p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2018/08/22/Android/Android-OkHttp_Retrofit_use_intro/">Android OkHttp + Retrofit 使用示例</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/06/26/Android/Android-OkHttp_Retrofit_cancel_request/">Android OkHttp + Retrofit 取消请求的方法</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file/">Android OkHttp + Retrofit 下载文件与进度监听</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file_partial/">Android OkHttp + Retrofit 断点续传</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-10-18T11:35:00.000Z" title="2019/10/18 19:35:00">2019-10-18</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:45.112Z" title="2021/6/18 17:38:45">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">8 分钟读完 (大约1142个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/10/18/Android/Android-OkHttp_Retrofit_download_file/">Android OkHttp + Retrofit 下载文件与进度监听</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file/">本文链接</a></p>
<p>下载文件是一个比较常见的需求。给定一个url，我们可以<a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/23/Android/Android-Media_download_stream_file/">使用URLConnection下载文件</a>。<br>使用OkHttp也可以通过流来下载文件。<br>给OkHttp中添加拦截器，即可实现下载进度的监听功能。</p>
<h2 id="使用流来实现下载文件"><a href="#使用流来实现下载文件" class="headerlink" title="使用流来实现下载文件"></a>使用流来实现下载文件</h2><p>代码可以参考：<a target="_blank" rel="noopener" href="https://github.com/AnRFDev/android-Basic4/tree/master/appdowloadsample">https://github.com/AnRFDev/android-Basic4/tree/master/appdowloadsample</a></p>
<p>获取并使用字节流，需要注意两个要点，一个是服务接口方法的 @Streaming 注解，另一个是获取到ResponseBody。</p>
<p>获取流（Stream）。先定义一个服务ApiService。给方法添加上@Streaming的注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">interface</span> <span class="title class_">ApiService</span> &#123;</span><br><span class="line">    <span class="meta">@Streaming</span></span><br><span class="line">    <span class="meta">@GET</span></span><br><span class="line">    Observable&lt;ResponseBody&gt; <span class="title function_">download</span><span class="params">(<span class="meta">@Url</span> String url)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化OkHttp。记得填入你的baseUrl。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">        .connectTimeout(<span class="number">8</span>, TimeUnit.SECONDS)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">retrofit = <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">        .client(okHttpClient)</span><br><span class="line">        .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</span><br><span class="line">        .baseUrl(<span class="string">&quot;https://yourbaseurl.com&quot;</span>)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure></p>
<p>发起网络请求。获取到ResponseBody。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">downUrl</span> <span class="operator">=</span> <span class="string">&quot;xxx.com/aaa.apk&quot;</span>;</span><br><span class="line">retrofit.create(ApiService.class)</span><br><span class="line">        .download(downUrl)</span><br><span class="line">        .subscribeOn(Schedulers.io())</span><br><span class="line">        .observeOn(Schedulers.io())</span><br><span class="line">        .doOnNext(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;ResponseBody&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(ResponseBody responseBody)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="comment">// 处理 ResponseBody 中的流</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .doOnError(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;Throwable&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(Throwable throwable)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;accept on error: &quot;</span> + downUrl, throwable);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">        .subscribe(<span class="keyword">new</span> <span class="title class_">Observer</span>&lt;ResponseBody&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Disposable d)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(ResponseBody responseBody)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Download center retrofit onError: &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></p>
<p>通过ResponseBody拿到字节流 body.byteStream()。这里会先创建一个临时文件tmpFile，把数据写到临时文件里。<br>下载完成后再重命名成目标文件targetFile。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveFile</span><span class="params">(ResponseBody body)</span> &#123;</span><br><span class="line">    state = DownloadTaskState.DOWNLOADING;</span><br><span class="line">    <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;saveFile: body content length: &quot;</span> + body.contentLength());</span><br><span class="line">        srcInputStream = body.byteStream();</span><br><span class="line">        <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> tmpFile.getParentFile();</span><br><span class="line">        <span class="keyword">if</span> (dir == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;target file has no dir.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">m</span> <span class="operator">=</span> dir.mkdirs();</span><br><span class="line">            onInfo(<span class="string">&quot;Create dir &quot;</span> + m + <span class="string">&quot;, &quot;</span> + dir);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> tmpFile;</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">c</span> <span class="operator">=</span> file.createNewFile();</span><br><span class="line">            onInfo(<span class="string">&quot;Create new file &quot;</span> + c);</span><br><span class="line">        &#125;</span><br><span class="line">        fos = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">while</span> ((len = srcInputStream.read(buf)) != -<span class="number">1</span> &amp;&amp; !isCancel) &#123;</span><br><span class="line">            fos.write(buf, <span class="number">0</span>, len);</span><br><span class="line">            <span class="type">int</span> <span class="variable">duration</span> <span class="operator">=</span> (<span class="type">int</span>) (System.currentTimeMillis() - time);</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">overBytes</span> <span class="operator">=</span> len - downloadBytePerMs() * duration;</span><br><span class="line">            <span class="keyword">if</span> (overBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(overBytes / downloadBytePerMs());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            time = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">if</span> (isCancel) &#123;</span><br><span class="line">                state = DownloadTaskState.CLOSING;</span><br><span class="line">                srcInputStream.close();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isCancel) &#123;</span><br><span class="line">            fos.flush();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">rename</span> <span class="operator">=</span> tmpFile.renameTo(targetFile);</span><br><span class="line">            <span class="keyword">if</span> (rename) &#123;</span><br><span class="line">                setState(DownloadTaskState.DONE);</span><br><span class="line">                onSuccess(url);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setState(DownloadTaskState.ERROR);</span><br><span class="line">                onError(url, <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;Rename file fail. &quot;</span> + tmpFile));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;saveFile: FileNotFoundException &quot;</span>, e);</span><br><span class="line">        setState(DownloadTaskState.ERROR);</span><br><span class="line">        onError(url, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;saveFile: IOException &quot;</span>, e);</span><br><span class="line">        setState(DownloadTaskState.ERROR);</span><br><span class="line">        onError(url, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (srcInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                srcInputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fos != <span class="literal">null</span>) &#123;</span><br><span class="line">                fos.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;saveFile&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isCancel) &#123;</span><br><span class="line">            onCancel(url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>每次读数据的循环，计算读了多少数据和用了多少时间。超过限速后主动sleep一下，达到控制下载速度的效果。<br>要注意不能sleep太久，以免socket关闭。<br>这里控制的是网络数据流与本地文件的读写速度。</p>
<h2 id="下载进度监听"><a href="#下载进度监听" class="headerlink" title="下载进度监听"></a>下载进度监听</h2><p>OkHttp实现下载进度监听，可以从字节流的读写那里入手。也可以使用拦截器，参考<a target="_blank" rel="noopener" href="https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/Progress.java">官方的例子</a>。<br>这里用拦截器的方式实现网络下载进度监听功能。</p>
<h3 id="定义回调与网络拦截器"><a href="#定义回调与网络拦截器" class="headerlink" title="定义回调与网络拦截器"></a>定义回调与网络拦截器</h3><p>先定义回调。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProgressListener</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(String url, <span class="type">long</span> bytesRead, <span class="type">long</span> contentLength, <span class="type">boolean</span> done)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>自定义ProgressResponseBody。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProgressResponseBody</span> <span class="keyword">extends</span> <span class="title class_">ResponseBody</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResponseBody responseBody;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProgressListener progressListener;</span><br><span class="line">    <span class="keyword">private</span> BufferedSource bufferedSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line"></span><br><span class="line">    ProgressResponseBody(String url, ResponseBody responseBody, ProgressListener progressListener) &#123;</span><br><span class="line">        <span class="built_in">this</span>.responseBody = responseBody;</span><br><span class="line">        <span class="built_in">this</span>.progressListener = progressListener;</span><br><span class="line">        <span class="built_in">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MediaType <span class="title function_">contentType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> responseBody.contentType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">contentLength</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> responseBody.contentLength();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BufferedSource <span class="title function_">source</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (bufferedSource == <span class="literal">null</span>) &#123;</span><br><span class="line">            bufferedSource = Okio.buffer(source(responseBody.source()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bufferedSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Source <span class="title function_">source</span><span class="params">(<span class="keyword">final</span> Source source)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ForwardingSource</span>(source) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">totalBytesRead</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">read</span><span class="params">(Buffer sink, <span class="type">long</span> byteCount)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">bytesRead</span> <span class="operator">=</span> <span class="built_in">super</span>.read(sink, byteCount);</span><br><span class="line">                <span class="comment">// read() returns the number of bytes read, or -1 if this source is exhausted.</span></span><br><span class="line">                totalBytesRead += bytesRead != -<span class="number">1</span> ? bytesRead : <span class="number">0</span>;</span><br><span class="line">                progressListener.update(url, totalBytesRead, responseBody.contentLength(), bytesRead == -<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> bytesRead;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>定义拦截器。从Response中获取信息。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProgressInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ProgressListener progressListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProgressInterceptor</span><span class="params">(ProgressListener progressListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.progressListener = progressListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(<span class="meta">@NotNull</span> Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Response</span> <span class="variable">originalResponse</span> <span class="operator">=</span> chain.proceed(chain.request());</span><br><span class="line">        <span class="keyword">return</span> originalResponse.newBuilder()</span><br><span class="line">                .body(<span class="keyword">new</span> <span class="title class_">ProgressResponseBody</span>(chain.request().url().url().toString(), originalResponse.body(), progressListener))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="添加拦截器"><a href="#添加拦截器" class="headerlink" title="添加拦截器"></a>添加拦截器</h3><p>在创建OkHttpClient时添加ProgressInterceptor。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">        .connectTimeout(<span class="number">8</span>, TimeUnit.SECONDS)</span><br><span class="line">        .addInterceptor(<span class="keyword">new</span> <span class="title class_">ProgressInterceptor</span>(<span class="keyword">new</span> <span class="title class_">ProgressListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(String url, <span class="type">long</span> bytesRead, <span class="type">long</span> contentLength, <span class="type">boolean</span> done)</span> &#123;</span><br><span class="line">                <span class="comment">// tellProgress(url, bytesRead, contentLength, done);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;))</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure></p>
<p>值得注意的是这里的进度更新非常频繁。并不一定每次回调都要去更新UI。</p>
<p>更多请参考：</p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2018/08/22/Android/Android-OkHttp_Retrofit_use_intro/">Android OkHttp + Retrofit 使用示例</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/06/26/Android/Android-OkHttp_Retrofit_cancel_request/">Android OkHttp + Retrofit 取消请求的方法</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file/">Android OkHttp + Retrofit 下载文件与进度监听</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file_partial/">Android OkHttp + Retrofit 断点续传</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-09-25T02:48:00.000Z" title="2019/9/25 10:48:00">2019-09-25</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:33.765Z" title="2021/6/18 17:38:33">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">5 分钟读完 (大约689个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/09/25/Android/Android-MediaPlayer_use_play_speed/">Android MediaPlayer 音频倍速播放，调整播放速度</a></p><div class="content"><p>本文链接： <a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/25/Android/Android-MediaPlayer_use_play_speed/">Android MediaPlayer 音频倍速播放，调整播放速度</a></p>
<p>现在市面上的很多音视频App都有倍速播放的功能，例如把播放速度调整为0.5、1.5、2倍等等。</p>
<p>从Android API 23 (Android M)开始，MediaPlayer支持调整播放速度。<br>使用的方法是setPlaybackParams，传入一个代表播放属性的类PlaybackParams。</p>
<p>本文介绍如何使用MediaPlayer调整播放速度。</p>
<h2 id="MediaPlayer-setPlaybackParams-说明"><a href="#MediaPlayer-setPlaybackParams-说明" class="headerlink" title="MediaPlayer.setPlaybackParams 说明"></a>MediaPlayer.setPlaybackParams 说明</h2><p>播放速度设置在PlaybackParams对象中，再将此对象传入setPlaybackParams。</p>
<p>setPlaybackParams是一个native方法。<br>如果MediaPlayer没有准备（在prepared之前），调用此方法并不会改变MediaPlayer的状态。<br>在MediaPlayer成功prepare之后，如果设置的速度为0，相当于调用了pause方法；如果设置速度不为0，相当于调用了start方法。</p>
<h3 id="异常情况"><a href="#异常情况" class="headerlink" title="异常情况"></a>异常情况</h3><p>如果MediaPlayer没有初始化或者已经被释放，即处于Idle或End状态，调用setPlaybackParams方法会抛出IllegalStateException异常。</p>
<p>如果传入的PlaybackParams不被支持，则抛出IllegalArgumentException异常。</p>
<p>如果设置速度小于0，则抛出java.lang.IllegalArgumentException异常。</p>
<h2 id="MediaPlayer-setPlaybackParams-方法示例"><a href="#MediaPlayer-setPlaybackParams-方法示例" class="headerlink" title="MediaPlayer.setPlaybackParams 方法示例"></a>MediaPlayer.setPlaybackParams 方法示例</h2><p>设置播放速度。先判断当前系统版本。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">setPlaySpeed</span><span class="params">(<span class="type">float</span> speed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">        <span class="type">PlaybackParams</span> <span class="variable">params</span> <span class="operator">=</span> mediaPlayer.getPlaybackParams();</span><br><span class="line">        params.setSpeed(speed);</span><br><span class="line">        mediaPlayer.setPlaybackParams(params);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getPlaybackParams可以获取到MediaPlayer当前的PlaybackParams对象。<br>也可以给这个方法加上try catch，结合返回的boolean值判断设置速度是否成功。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">setPlaySpeed</span><span class="params">(<span class="type">float</span> speed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PlaybackParams</span> <span class="variable">params</span> <span class="operator">=</span> mediaPlayer.getPlaybackParams();</span><br><span class="line">            params.setSpeed(speed);</span><br><span class="line">            mediaPlayer.setPlaybackParams(params);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;setPlaySpeed: &quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考代码 <a target="_blank" rel="noopener" href="https://github.com/RustFisher/android-MediaPlayer">https://github.com/RustFisher/android-MediaPlayer</a></p>
<h2 id="PlaybackParams-包含的速度值"><a href="#PlaybackParams-包含的速度值" class="headerlink" title="PlaybackParams 包含的速度值"></a>PlaybackParams 包含的速度值</h2><p>调整MediaPlayer播放速度时，我们使用了PlaybackParams对象。AudioTrack也会用到这个类。</p>
<p>PlaybackParams包含着播放时候的一些属性。例如speed就是播放速度。</p>
<h3 id="PlaybackParams-setSpeed-float-speed"><a href="#PlaybackParams-setSpeed-float-speed" class="headerlink" title="PlaybackParams.setSpeed(float speed)"></a>PlaybackParams.setSpeed(float speed)</h3><p>传入速度倍率值。会标记当前设置过了速度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PlaybackParams <span class="title function_">setSpeed</span><span class="params">(<span class="type">float</span> speed)</span> &#123;</span><br><span class="line">    mSpeed = speed;</span><br><span class="line">    mSet |= SET_SPEED;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="PlaybackParams-getSpeed"><a href="#PlaybackParams-getSpeed" class="headerlink" title="PlaybackParams.getSpeed()"></a>PlaybackParams.getSpeed()</h3><p>获取已设置的速度值。如果之前没设置过速度，则抛出IllegalStateException异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getSpeed</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((mSet &amp; SET_SPEED) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;speed not set&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mSpeed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更多参考：</p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/19/Android/Android-MediaPlayer_intro/">Android MediaPlayer 基础简介</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/22/Android/Android-MediaPlayer_use_play_audio/">Android MediaPlayer 播放音频</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/23/Android/Android-Media_download_stream_file/">Android 使用URLConnection下载音频文件</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/25/Android/Android-MediaPlayer_use_play_speed/">Android MediaPlayer 音频倍速播放，调整播放速度</a></p>
<p>Android音视频相关文章请参考 <a target="_blank" rel="noopener" href="https://rustfisher.com/tags/Android-Media/">https://rustfisher.com/tags/Android-Media/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-09-23T02:00:00.000Z" title="2019/9/23 10:00:00">2019-09-23</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:18.935Z" title="2021/6/18 17:38:18">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">4 分钟读完 (大约548个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/09/23/Android/Android-Media_download_stream_file/">Android 使用URLConnection下载音频文件</a></p><div class="content"><p>本文链接： <a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/23/Android/Android-Media_download_stream_file/">Android 使用URLConnection下载音频文件</a></p>
<p>使用MediaPlayer播放在线音频，请参考<a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/22/Android/Android-MediaPlayer_use_play_audio/">Android MediaPlayer 播放音频</a></p>
<p>有时候我们会需要下载音频文件。这里提供一种思路，将在线音频文件通过流写到本地文件中。<br>使用URLConnection来建立连接，获取到的数据写到文件中。</p>
<p>URLConnection建立连接后，可以获取到数据长度。由此我们可以计算出下载进度。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DownloadStreamThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    String urlStr;</span><br><span class="line">    <span class="keyword">final</span> String targetFileAbsPath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DownloadStreamThread</span><span class="params">(String urlStr, String targetFileAbsPath)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.urlStr = urlStr;</span><br><span class="line">        <span class="built_in">this</span>.targetFileAbsPath = targetFileAbsPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.run();</span><br><span class="line">        <span class="type">int</span> count;</span><br><span class="line">        <span class="type">File</span> <span class="variable">targetFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(targetFileAbsPath);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">n</span> <span class="operator">=</span> targetFile.createNewFile();</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Create new file: &quot;</span> + n + <span class="string">&quot;, &quot;</span> + targetFile);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;run: &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(urlStr);</span><br><span class="line">            <span class="type">URLConnection</span> <span class="variable">connection</span> <span class="operator">=</span> url.openConnection();</span><br><span class="line">            connection.connect();</span><br><span class="line">            <span class="type">int</span> <span class="variable">contentLength</span> <span class="operator">=</span> connection.getContentLength();</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(url.openStream());</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(targetFileAbsPath);</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((count = input.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                total += count;</span><br><span class="line">                Log.d(TAG, String.format(Locale.CHINA, <span class="string">&quot;Download progress: %.2f%%&quot;</span>, <span class="number">100</span> * (total / (<span class="type">double</span>) contentLength)));</span><br><span class="line">                output.write(buffer, <span class="number">0</span>, count);</span><br><span class="line">            &#125;</span><br><span class="line">            output.flush();</span><br><span class="line">            output.close();</span><br><span class="line">            input.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;run: &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>启动下载，即启动线程。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">DownloadStreamThread</span>(urlStr, targetFileAbsPath).start();</span><br></pre></td></tr></table></figure></p>
<p>值得注意的是，如果本地已经有了文件，需要做一些逻辑判断。例如是否删掉旧文件，重新下载。或是判断出已有文件，中止此次下载任务。<br>例如可以用connection.getContentLength()与当前文件长度来比较，如果不一致，则删掉本地文件，重新下载。</p>
<p>实际上，URLConnection能处理很多流媒体。在这里是用来下载音频文件。可以实现下载功能和类似“边下边播”的功能。</p>
<p>代码可以参考示例工程： <a target="_blank" rel="noopener" href="https://github.com/RustFisher/android-MediaPlayer">https://github.com/RustFisher/android-MediaPlayer</a></p>
<p>更多参考：</p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/19/Android/Android-MediaPlayer_intro/">Android MediaPlayer 基础简介</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/22/Android/Android-MediaPlayer_use_play_audio/">Android MediaPlayer 播放音频</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/23/Android/Android-Media_download_stream_file/">Android 使用URLConnection下载音频文件</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/25/Android/Android-MediaPlayer_use_play_speed/">Android MediaPlayer 音频倍速播放，调整播放速度</a></p>
<p>Android音视频相关文章请参考 <a target="_blank" rel="noopener" href="https://rustfisher.com/tags/Android-Media/">https://rustfisher.com/tags/Android-Media/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-09-22T09:57:00.000Z" title="2019/9/22 17:57:00">2019-09-22</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:30.950Z" title="2021/6/18 17:38:30">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">10 分钟读完 (大约1485个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/09/22/Android/Android-MediaPlayer_use_play_audio/">Android MediaPlayer 播放音频</a></p><div class="content"><p>本文链接： <a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/22/Android/Android-MediaPlayer_use_play_audio/">Android MediaPlayer 播放音频</a></p>
<p>主要介绍使用MediaPlayer播放音频的方式。关于MediaPlayer的基础知识，比如状态，可以参考<a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/19/Android/Android-MediaPlayer_intro/">Android MediaPlayer 基础简介</a>。</p>
<p>为了方便表达，定义变量名为mediaPlayer。</p>
<h2 id="MediaPlayer的使用方式"><a href="#MediaPlayer的使用方式" class="headerlink" title="MediaPlayer的使用方式"></a>MediaPlayer的使用方式</h2><h3 id="创建MediaPlayer"><a href="#创建MediaPlayer" class="headerlink" title="创建MediaPlayer"></a>创建MediaPlayer</h3><p>可以直接 new MediaPlayer，也可以用MediaPlayer提供的create方法创建。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer = <span class="keyword">new</span> <span class="title class_">MediaPlayer</span>();</span><br></pre></td></tr></table></figure></p>
<p>使用create方法创建成功后，mediaPlayer处于Prepared状态。可以直接start播放。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer = MediaPlayer.create(getApplicationContext(), Uri.fromFile(file));</span><br><span class="line">mediaPlayer.start();</span><br></pre></td></tr></table></figure></p>
<h3 id="设置音源-setDataSource"><a href="#设置音源-setDataSource" class="headerlink" title="设置音源 - setDataSource"></a>设置音源 - setDataSource</h3><p>通过调用<code>setDataSource</code>来设置音源。<code>setDataSource</code>有多个重载方法，我们来看常用的几种。</p>
<p>例如设置使用assets里的资源。实际情况可能需要try catch。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AssetFileDescriptor</span> <span class="variable">fd</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">MediaPlayer</span> <span class="variable">mediaPlayer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaPlayer</span>();</span><br><span class="line">fd = context.getApplicationContext().getAssets().openFd(name);</span><br><span class="line">mediaPlayer.setDataSource(fd.getFileDescriptor(), fd.getStartOffset(), fd.getLength());</span><br></pre></td></tr></table></figure></p>
<p>本地文件，需要文件的绝对路径。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.setDataSource(file.getAbsolutePath());</span><br></pre></td></tr></table></figure></p>
<p>或者获取文件的Uri来创建mediaPlayer。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer = MediaPlayer.create(getApplicationContext(), Uri.fromFile(file));</span><br></pre></td></tr></table></figure></p>
<p>设置网络音频，也是用setDataSource方法，设置url。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.setDataSource(<span class="string">&quot;https://demo.com/sample.mp3&quot;</span>));</span><br></pre></td></tr></table></figure></p>
<p>播放网络音频时，如果使用的是http，有可能会报错<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.IOException: Cleartext HTTP traffic to demo.com not permitted</span><br></pre></td></tr></table></figure></p>
<p>可以简单地设置一下manifest，设置usesCleartextTraffic=”true”<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:usesCleartextTraffic</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="准备-prepare"><a href="#准备-prepare" class="headerlink" title="准备 - prepare"></a>准备 - prepare</h3><p>同步和异步准备音频资源。prepareAsync()是异步的方式，prepare是同步的。注意线程调度问题，同时不要阻塞UI线程。</p>
<p>使用异步方式准备音频，经常与MediaPlayer.OnPreparedListener监听器配合使用。异步准备时，也可以进行其他的设置。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.prepareAsync();</span><br><span class="line">mediaPlayer.setOnPreparedListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnPreparedListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPrepared</span><span class="params">(MediaPlayer mediaPlayer)</span> &#123;</span><br><span class="line">        mediaPlayer.start(); <span class="comment">// 准备好了就播放</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="循环播放-Looping"><a href="#循环播放-Looping" class="headerlink" title="循环播放 - Looping"></a>循环播放 - Looping</h3><p>设置循环播放setLooping。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.setLooping(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><br>播放完毕后，不会回调OnCompletionListener，而是从头播放当前音频。</p>
<h3 id="播放-start"><a href="#播放-start" class="headerlink" title="播放 - start"></a>播放 - start</h3><p>播放音频，调用start方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.start();</span><br></pre></td></tr></table></figure></p>
<p>处于Prepared，Pause和PlaybackComplete状态时，可以调用start方法，进入Started状态。</p>
<h3 id="暂停-pause"><a href="#暂停-pause" class="headerlink" title="暂停 - pause"></a>暂停 - pause</h3><p>暂停播放，使用pause方法。在暂停前先判断一下mediaPlayer的是否在播放。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mediaPlayer.isPlaying()) &#123;</span><br><span class="line">    mediaPlayer.pause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>暂停成功则处于Paused状态。</p>
<h3 id="停止-stop"><a href="#停止-stop" class="headerlink" title="停止 - stop"></a>停止 - stop</h3><p>回顾一下MediaPlayer状态切换的图示，我们可以得知在播放中，暂停，播放完成这3个状态下，可以调用stop方法，进入Stopped状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.stop();</span><br></pre></td></tr></table></figure>
<h3 id="调进度-seekTo"><a href="#调进度-seekTo" class="headerlink" title="调进度 - seekTo"></a>调进度 - seekTo</h3><p>调整播放进度。我们平时使用音乐播放软件一般都会有这个功能。<br>seekTo方法接受一个毫秒参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">targetMS</span> <span class="operator">=</span> (<span class="type">int</span>) (percent * mediaPlayer.getDuration());</span><br><span class="line">mediaPlayer.seekTo(targetMS);</span><br></pre></td></tr></table></figure>
<p>seekTo并不会改变MediaPlayer的状态。</p>
<h3 id="重置-reset"><a href="#重置-reset" class="headerlink" title="重置 - reset"></a>重置 - reset</h3><p>reset后的mediaPlayer进入Idle状态。需要重新设置音源与准备。</p>
<h3 id="释放-release"><a href="#释放-release" class="headerlink" title="释放 - release"></a>释放 - release</h3><p>不再使用这个mediaPlayer时，应当尽快释放掉，以释放相关的资源。<br>调用release后，mediaPlayer进入End状态。此时这个mediaPlayer就不能再使用了。</p>
<h2 id="常用监听器"><a href="#常用监听器" class="headerlink" title="常用监听器"></a>常用监听器</h2><h3 id="缓冲监听器-OnBufferingUpdateListener"><a href="#缓冲监听器-OnBufferingUpdateListener" class="headerlink" title="缓冲监听器 OnBufferingUpdateListener"></a>缓冲监听器 OnBufferingUpdateListener</h3><p>比如我们加载网络音频的时候，常用这个监听器来监听缓冲进度。显示缓冲进度，也可以提高用户体验。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mMediaPlayer.prepareAsync();</span><br><span class="line">mMediaPlayer.setOnBufferingUpdateListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnBufferingUpdateListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBufferingUpdate</span><span class="params">(MediaPlayer mp, <span class="type">int</span> percent)</span> &#123;</span><br><span class="line">        <span class="comment">// percent代表缓冲百分比</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="错误监听器-OnErrorListener"><a href="#错误监听器-OnErrorListener" class="headerlink" title="错误监听器 OnErrorListener"></a>错误监听器 OnErrorListener</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.setOnErrorListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnErrorListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onError</span><span class="params">(MediaPlayer mediaPlayer, <span class="type">int</span> i, <span class="type">int</span> i1)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 返回true表示在此处理错误，不会回调onCompletion</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>注意onError的返回值。可以选择自己处理error。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> * <span class="meta">@return</span> True <span class="keyword">if</span> the method handled the error, <span class="literal">false</span> <span class="keyword">if</span> it didn<span class="string">&#x27;t.</span></span><br><span class="line"><span class="string"> * Returning false, or not having an OnErrorListener at all, will</span></span><br><span class="line"><span class="string"> * cause the OnCompletionListener to be called.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">boolean onError(MediaPlayer mp, int what, int extra);</span></span><br></pre></td></tr></table></figure>
<h3 id="播放完毕监听器-OnCompletionListener"><a href="#播放完毕监听器-OnCompletionListener" class="headerlink" title="播放完毕监听器 OnCompletionListener"></a>播放完毕监听器 OnCompletionListener</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.setOnCompletionListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnCompletionListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompletion</span><span class="params">(MediaPlayer mediaPlayer)</span> &#123;</span><br><span class="line">        <span class="comment">// 播放完毕</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><h3 id="播放assets里的音频"><a href="#播放assets里的音频" class="headerlink" title="播放assets里的音频"></a>播放assets里的音频</h3><p>播放assets里的音频文件，使用到AssetFileDescriptor类。使用后记得关闭AssetFileDescriptor。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">playAssetsAudio</span><span class="params">(<span class="keyword">final</span> String name, Context context)</span> &#123;</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;playAssetWordSound: try to play assets sound file. -&gt; &quot;</span> + name);</span><br><span class="line">    <span class="type">AssetFileDescriptor</span> <span class="variable">fd</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        MediaPlayer mediaPlayer;</span><br><span class="line">        Log.v(TAG, <span class="string">&quot;Looking in assets.&quot;</span>);</span><br><span class="line">        fd = context.getApplicationContext().getAssets().openFd(name);</span><br><span class="line">        mediaPlayer = <span class="keyword">new</span> <span class="title class_">MediaPlayer</span>();</span><br><span class="line">        mediaPlayer.reset();</span><br><span class="line">        mediaPlayer.setDataSource(fd.getFileDescriptor(), fd.getStartOffset(), fd.getLength());</span><br><span class="line">        mediaPlayer.prepareAsync();</span><br><span class="line">        mediaPlayer.setOnPreparedListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnPreparedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPrepared</span><span class="params">(MediaPlayer mediaPlayer)</span> &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;onPrepared: &quot;</span> + name);</span><br><span class="line">                mediaPlayer.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        mediaPlayer.setOnCompletionListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnCompletionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompletion</span><span class="params">(MediaPlayer mp)</span> &#123;</span><br><span class="line">                mp.release();</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;onCompletion: &quot;</span> + name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        mediaPlayer.setOnErrorListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnErrorListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onError</span><span class="params">(MediaPlayer mp, <span class="type">int</span> i, <span class="type">int</span> i1)</span> &#123;</span><br><span class="line">                mp.release();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fd != <span class="literal">null</span>) &#123;</span><br><span class="line">                fd.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;Exception close fd: &quot;</span>, e1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fd != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fd.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Finally, close fd &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="播放本地音频文件"><a href="#播放本地音频文件" class="headerlink" title="播放本地音频文件"></a>播放本地音频文件</h3><p>尝试播放音频文件。仅播放一次。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">playAudioFile</span><span class="params">(<span class="keyword">final</span> File file)</span> &#123;</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;playAudioFile: &quot;</span> + file.getAbsolutePath());</span><br><span class="line">    MediaPlayer mediaPlayer;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mediaPlayer = <span class="keyword">new</span> <span class="title class_">MediaPlayer</span>();</span><br><span class="line">        mediaPlayer.setLooping(<span class="literal">false</span>);</span><br><span class="line">        mediaPlayer.setDataSource(file.getAbsolutePath());</span><br><span class="line">        mediaPlayer.prepare();</span><br><span class="line">        mediaPlayer.start();</span><br><span class="line">        mediaPlayer.setOnCompletionListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnCompletionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompletion</span><span class="params">(MediaPlayer mp)</span> &#123;</span><br><span class="line">                mp.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        mediaPlayer.setOnErrorListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnErrorListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onError</span><span class="params">(MediaPlayer mediaPlayer, <span class="type">int</span> i, <span class="type">int</span> i1)</span> &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;Play local sound onError: &quot;</span> + i + <span class="string">&quot;, &quot;</span> + i1);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;playAudioFile: &quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="播放在线音频"><a href="#播放在线音频" class="headerlink" title="播放在线音频"></a>播放在线音频</h3><p>设置url，播放在线音频</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">playOnlineSound</span><span class="params">(String soundUrlDict)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">MediaPlayer</span> <span class="variable">mediaPlayer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaPlayer</span>();</span><br><span class="line">        mediaPlayer.setDataSource(soundUrlDict);</span><br><span class="line">        mediaPlayer.prepareAsync();</span><br><span class="line">        mediaPlayer.setOnPreparedListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnPreparedListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPrepared</span><span class="params">(MediaPlayer mediaPlayer)</span> &#123;</span><br><span class="line">                mediaPlayer.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        mediaPlayer.setOnCompletionListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnCompletionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompletion</span><span class="params">(MediaPlayer mp)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (mp != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mp.release();</span><br><span class="line">                &#125;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;onCompletion: play sound.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        mediaPlayer.setOnErrorListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnErrorListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onError</span><span class="params">(MediaPlayer mediaPlayer, <span class="type">int</span> i, <span class="type">int</span> i1)</span> &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;Play online sound onError: &quot;</span> + i + <span class="string">&quot;, &quot;</span> + i1);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;url: &quot;</span>, e1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码可以参考示例工程： <a target="_blank" rel="noopener" href="https://github.com/RustFisher/android-MediaPlayer">https://github.com/RustFisher/android-MediaPlayer</a></p>
<p>更多参考：</p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/19/Android/Android-MediaPlayer_intro/">Android MediaPlayer 基础简介</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/22/Android/Android-MediaPlayer_use_play_audio/">Android MediaPlayer 播放音频</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/23/Android/Android-Media_download_stream_file/">Android 使用URLConnection下载音频文件</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/25/Android/Android-MediaPlayer_use_play_speed/">Android MediaPlayer 音频倍速播放，调整播放速度</a></p>
<p>Android音视频相关文章请参考 <a target="_blank" rel="noopener" href="https://rustfisher.com/tags/Android-Media/">https://rustfisher.com/tags/Android-Media/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-09-19T11:30:00.000Z" title="2019/9/19 19:30:00">2019-09-19</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:27.267Z" title="2021/6/18 17:38:27">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">14 分钟读完 (大约2113个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/09/19/Android/Android-MediaPlayer_intro/">Android MediaPlayer 基础简介</a></p><div class="content"><p>本文链接： <a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/19/Android/Android-MediaPlayer_intro/">Android MediaPlayer 基础简介</a></p>
<p>简单介绍MediaPlayer的基本概念，状态，常用的方法与监听器。</p>
<h2 id="什么是MediaPlayer"><a href="#什么是MediaPlayer" class="headerlink" title="什么是MediaPlayer"></a>什么是MediaPlayer</h2><p>MediaPlayer类可以用来播放音视频文件，或者是音频流。开发者可以用它来播放本地音频，或者是网络在线音频。</p>
<p>MediaPlayer属于<code>android.media</code>包。</p>
<h2 id="MediaPlayer的状态"><a href="#MediaPlayer的状态" class="headerlink" title="MediaPlayer的状态"></a>MediaPlayer的状态</h2><p>播放控制由状态机控制。在日常生活中，我们常见的音频状态有播放中，暂停，停止，缓冲等等。<br>MediaPlayer的状态有如下几种：</p>
<ul>
<li>Idle</li>
<li>End</li>
<li>Error</li>
<li>Initialized</li>
<li>Preparing</li>
<li>Prepared</li>
<li>Started</li>
<li>Stopped</li>
<li>Paused</li>
<li>PlaybackCompleted</li>
</ul>
<p>状态的切换参考<a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaPlayer">官方</a>图例。<br>这里稍微解释一下状态转换图片。椭圆代表MediaPlayer可能停留的状态。椭圆之间的箭头表示方法调用，状态切换的方向。单箭头表示方法同步调用，双箭头表示异步调用。</p>
<p><img src="http://rustblogres.rustfisher.com/Android-mediaplayer_state_diagram.gif" alt="mediaplayer_state_diagram"></p>
<p>从图中我们可以看出状态切换的路径和涉及到的方法。</p>
<h3 id="Idle与End状态"><a href="#Idle与End状态" class="headerlink" title="Idle与End状态"></a>Idle与End状态</h3><p>当new一个MediaPlayer或者调用了reset方法，当前MediaPlayer会处于Idle状态。调用release后，会处于End状态。在这2个状态之间的状态可以看做是MediaPlayer对象的生命周期。</p>
<p>在新创建MediaPlayer和调用reset的MediaPlayer之间有一些细微的差别。<br>这两种情况都处于Idle状态，调用 getCurrentPosition(), getDuration(), getVideoHeight(), getVideoWidth(), setAudioAttributes(android.media.AudioAttributes), setLooping(boolean), setVolume(float, float), pause(), start(), stop(), seekTo(long, int), prepare() 或 prepareAsync()方法都会抛出错误，如果是新实例化的MediaPlayer，不会回调 OnErrorListener.onError()；但如果是reset后的MediaPlayer，会回调 OnErrorListener.onError()并且转换到Error状态。</p>
<p>如果MediaPlayer对象不再使用了，立即调用release()方法，释放内部播放器占用的资源。这些资源可能是唯一的，比如硬件加速组件。如果调用release失败，可能会引起一连串的MediaPlayer实例失效。当MediaPlayer处于End状态，它就不能再转移到其它状态了。</p>
<p>new一个MediaPlayer，处于Idle状态。如果用create方法创建实例，当创建完成时处于Prepared状态。</p>
<h3 id="发生错误"><a href="#发生错误" class="headerlink" title="发生错误"></a>发生错误</h3><p>一些情形可能会让MediaPlayer操作失败，比如不支持的音视频格式，分辨率过高，网络超时等等。<br>因此在这些情形下错误处理和恢复非常重要。有时候编程错误也会导致MediaPlayer操作错误。<br>开发者可以设置错误监听器<code>setOnErrorListener(android.media.MediaPlayer.OnErrorListener)</code>。当错误发生时，会调用用户实现的OnErrorListener.onError()方法。</p>
<p>不管有没有设置监听器，错误发生时MediaPlayer会进入Error状态。</p>
<p>为了重复使用同一个MediaPlayer对象，可以使用<code>reset()</code>方法把它从Error状态恢复到Idle状态。<br>设置错误监听器OnErrorListener是一个好的编程习惯。开发者可以监听到播放引擎的错误通知。<br>有时候会抛出IllegalStateException异常，比如在错误的状态调用了prepare(), prepareAsync()方法，或是setDataSource方法。</p>
<h3 id="设置音源-setDataSource"><a href="#设置音源-setDataSource" class="headerlink" title="设置音源 setDataSource"></a>设置音源 setDataSource</h3><p>调用setDataSource(java.io.FileDescriptor), 或者 setDataSource(java.lang.String), 或者 setDataSource(android.content.Context, android.net.Uri), 或者 setDataSource(java.io.FileDescriptor, long, long), 或者 setDataSource(android.media.MediaDataSource) 可以将MediaPlayer的状态从Idle转到Initialized状态。<br>如果在Idle状态之外的状态调用了setDataSource()，会抛出IllegalStateException异常。<br>开发者应该留意setDataSource方法抛出的IllegalArgumentException和IOException异常。</p>
<h3 id="播放音频前必须在Prepared状态"><a href="#播放音频前必须在Prepared状态" class="headerlink" title="播放音频前必须在Prepared状态"></a>播放音频前必须在Prepared状态</h3><p>MediaPlayer在开始播放音频前必须处于Prepared状态。</p>
<p>MediaPlayer有同步和异步2种方式来进入Prepared状态。如果是异步的方式，会先转到Preparing状态，再转到Prepared状态。<br>当准备完成时，内部的播放引擎会回调用户之前设置的OnPreparedListener的onPrepared()方法。</p>
<p>开发者必须注意的是，Preparing状态是一个过渡状态（transient state）。</p>
<p>处于Prepared状态时，可以通过相对应的方法设置音量，屏幕常亮，播放循环等。</p>
<h3 id="开始播放"><a href="#开始播放" class="headerlink" title="开始播放"></a>开始播放</h3><p>播放音频必须调用start()方法。调用start()返回成功后，MediaPlayer处于Started状态。<br>可以通过isPlaying()来判断当前是否在Started状态。</p>
<p>如果开发者设置了OnBufferingUpdateListener，Android内部播放器会向外传递buffer信息。</p>
<p>如果当前处于Started状态，再调用start()方法没有效果。</p>
<h3 id="暂停播放与继续播放"><a href="#暂停播放与继续播放" class="headerlink" title="暂停播放与继续播放"></a>暂停播放与继续播放</h3><p>音频可以被暂停播放和继续播放，也可以调整播放的位置。通过pause()方法来暂停音频播放。<br>成功调用pause()方法后，MediaPlayer进入Paused状态。<br>应当注意的是，MediaPlayer在Started状态与Paused状态之间切换是异步的。播放音频流的时候，这个转换过程可能会需要几秒钟。</p>
<p>MediaPlayer暂停时，start()方法可以从暂停的位置继续播放。成功调用start方法后会进入Started状态。</p>
<p>处于Paused状态时，调用pause()方法没有效果。</p>
<h3 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h3><p>调用stop()方法让MediaPlayer从Started, Paused, Prepared 或 PlaybackCompleted 状态进入 Stopped 状态。</p>
<p>在Stopped状态时，必须先调用prepare() 或 prepareAsync()进入Prepared状态后，才能播放音频。</p>
<p>处于Stopped状态时，调用stop()方法没有效果。</p>
<h3 id="调整播放位置"><a href="#调整播放位置" class="headerlink" title="调整播放位置"></a>调整播放位置</h3><p>调用seekTo(long, int)来调整播放位置。</p>
<p>seekTo(long, int)是一个异步方法，虽然它能立刻返回，但实际的位置调整可能会消耗一段时间，特别是在播放音频流的时候。当实际播放位置调整后，内部播放器会回调开发者设置的OnSeekComplete.onSeekComplete()。</p>
<p>在Prepared, Paused 和 PlaybackCompleted状态中，都可以调用seekTo方法。</p>
<p>可以通过getCurrentPosition()方法来获取当前播放位置。开发者可以得知当前播放的进度等等。</p>
<h3 id="播放完毕"><a href="#播放完毕" class="headerlink" title="播放完毕"></a>播放完毕</h3><p>音频播放完成后，播放完毕。</p>
<p>如果调用setLooping(boolean)为true，MediaPlayer会停留在Started状态。</p>
<p>如果setLooping为false，内部播放器会调用开发者设置的OnCompletion.onCompletion()，并且进入PlaybackCompleted状态。</p>
<p>处于PlaybackCompleted状态时，调用start()方法可以从头开始播放音频。</p>
<h2 id="常用监听器"><a href="#常用监听器" class="headerlink" title="常用监听器"></a>常用监听器</h2><p>开发者可以设置一些监听器，监听MediaPlayer的状态，错误事件等等。开发者应在同一个线程中创建MediaPlayer与设置的监听器。</p>
<p><code>setOnPreparedListener(android.media.MediaPlayer.OnPreparedListener)</code><br>监听MediaPlayer准备完成。一般与<code>prepareAsync</code>配合使用。</p>
<p><code>setOnVideoSizeChangedListener(android.media.MediaPlayer.OnVideoSizeChangedListener)</code><br>获知video大小或video大小改变时的监听。</p>
<p><code>setOnSeekCompleteListener(android.media.MediaPlayer.OnSeekCompleteListener)</code><br>监听调整位置完成。</p>
<p><code>setOnCompletionListener(android.media.MediaPlayer.OnCompletionListener)</code><br>播放完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.setOnCompletionListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnCompletionListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompletion</span><span class="params">(MediaPlayer mediaPlayer)</span> &#123;</span><br><span class="line">        <span class="comment">// 当前播放完毕</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>setOnBufferingUpdateListener(android.media.MediaPlayer.OnBufferingUpdateListener)</code><br>监听缓冲进度。在播放网络音频时常用。</p>
<p>缓冲监听器<code>OnBufferingUpdateListener</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mMediaPlayer.prepareAsync();</span><br><span class="line">mMediaPlayer.setOnBufferingUpdateListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnBufferingUpdateListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBufferingUpdate</span><span class="params">(MediaPlayer mp, <span class="type">int</span> percent)</span> &#123;</span><br><span class="line">        <span class="comment">// 例如在这里更新UI</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>setOnInfoListener(android.media.MediaPlayer.OnInfoListener)</code><br>监听普通信息或者警告信息。</p>
<p><code>setOnErrorListener(android.media.MediaPlayer.OnErrorListener)</code><br>监听错误信息。错误发生时，可以在这里处理错误。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mediaPlayer.setOnErrorListener(<span class="keyword">new</span> <span class="title class_">MediaPlayer</span>.OnErrorListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onError</span><span class="params">(MediaPlayer mediaPlayer, <span class="type">int</span> i, <span class="type">int</span> i1)</span> &#123;</span><br><span class="line">        LogUtil.e(TAG_PREFIX + <span class="string">&quot; onERR i = &quot;</span> + i + <span class="string">&quot; i1 = &quot;</span> + i1);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 返回true表示在此处理错误，不会回调onCompletion</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>注意onError的返回值。可以选择自己处理error。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> * <span class="meta">@return</span> True <span class="keyword">if</span> the method handled the error, <span class="literal">false</span> <span class="keyword">if</span> it didn<span class="string">&#x27;t.</span></span><br><span class="line"><span class="string"> * Returning false, or not having an OnErrorListener at all, will</span></span><br><span class="line"><span class="string"> * cause the OnCompletionListener to be called.</span></span><br><span class="line"><span class="string"> */</span></span><br><span class="line"><span class="string">boolean onError(MediaPlayer mp, int what, int extra);</span></span><br></pre></td></tr></table></figure>
<h2 id="需要的权限"><a href="#需要的权限" class="headerlink" title="需要的权限"></a>需要的权限</h2><p>播放网络音频时需要Manifest.permission.INTERNET权限。</p>
<p>更多参考：</p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/19/Android/Android-MediaPlayer_intro/">Android MediaPlayer 基础简介</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/22/Android/Android-MediaPlayer_use_play_audio/">Android MediaPlayer 播放音频</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/23/Android/Android-Media_download_stream_file/">Android 使用URLConnection下载音频文件</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/25/Android/Android-MediaPlayer_use_play_speed/">Android MediaPlayer 音频倍速播放，调整播放速度</a></p>
<p>Android音视频相关文章请参考 <a target="_blank" rel="noopener" href="https://rustfisher.com/tags/Android-Media/">https://rustfisher.com/tags/Android-Media/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-08-20T14:18:16.000Z" title="2019/8/20 22:18:16">2019-08-20</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:36.572Z" title="2021/6/18 17:38:36">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">8 分钟读完 (大约1259个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/08/20/Android/Android-mmap_intro_and_use/">Android mmap 文件映射到内存介绍</a></p><div class="content"><p>本文链接： <a target="_blank" rel="noopener" href="https://rustfisher.com/2019/08/20/Android/Android-mmap_intro_and_use/">Android mmap 文件映射到内存介绍</a></p>
<p>Android开发中，我们可能需要记录一些文件。例如记录log文件。如果使用流来写文件，频繁操作文件io可能会引起性能问题。<br>为了降低写文件的频率，我们可能会采用缓存一定数量的log，再一次性把它们写到文件中。如果app异常退出，我们有可能会丢失内存中的log信息。<br>那么有什么比较稳妥的写文件方式，既能降低io，又能尽可能地保证数据被写入文件呢？</p>
<h2 id="mmap简介"><a href="#mmap简介" class="headerlink" title="mmap简介"></a>mmap简介</h2><h3 id="mmap概念"><a href="#mmap概念" class="headerlink" title="mmap概念"></a>mmap概念</h3><p>mmap是一种内存映射文件的方法，即将一个文件或者其它对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系。 </p>
<p>特点：实现这样的映射关系后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写脏页面到对应的文件磁盘上，即完成了对文件的操作而不必再调用read,write等系统调用函数。相反，内核空间对这段区域的修改也直接反映用户空间，从而可以实现不同进程间的文件共享。如下图所示： </p>
<p><img src="http://rustblogres.rustfisher.com/Android-mmap-intro1.jpg" alt="mmap简介"></p>
<h3 id="mmap内存映射原理"><a href="#mmap内存映射原理" class="headerlink" title="mmap内存映射原理"></a>mmap内存映射原理</h3><p>mmap内存映射的实现过程，总的来说可以分为三个阶段：</p>
<p>应用进程启动映射，在进程的虚拟地址空间中，寻找一段空闲的满足要求的连续的虚拟地址作为映射区域；<br>调用系统函数mmap，实现文件物理地址和进程虚拟地址的一一映射；<br>应用进程对映射区域访问，引发缺页异常，实现文件内容到物理内存（主存）的拷贝。</p>
<h3 id="mmap优缺点"><a href="#mmap优缺点" class="headerlink" title="mmap优缺点"></a>mmap优缺点</h3><p>只有一次数据拷贝：当发生缺页异常时，直接将数据从磁盘拷贝到进程的用户空间，跳过了页缓存。<br>实现了用户空间和内核空间的高效交互方式：两空间的各自修改操作可以直接反映在映射的区域内，从而被对方空间及时捕捉。<br>提供进程间共享内存及相互通信的方式。 </p>
<p>不管是父子进程还是无亲缘关系的进程，都可以将自身用户空间映射到同一个文件或匿名映射到同一片区域。从而通过各自对映射区域的改动，达到进程间通信和进程间共享的目的。 </p>
<p>同时，如果进程A和进程B都映射了区域C，当A第一次读取C时通过缺页从磁盘复制文件页到内存中；但当B再读C的相同页面时，虽然也会产生缺页异常，但是不再需要从磁盘中复制文件过来，而可直接使用已经保存在内存中的文件数据。</p>
<h3 id="mmap注意点"><a href="#mmap注意点" class="headerlink" title="mmap注意点"></a>mmap注意点</h3><p>对于大文件而言，内存映射比普通IO流要快，小文件则未必；<br>不要经常调用MappedByteBuffer.force()方法，这个方法强制操作系统将内存中的内容写入硬盘，所以如果你在每次写内存映射文件后都调用force()方法，你就不能真正从内存映射文件中获益，而是跟disk IO差不多。<br>读写内存映射文件是操作系统来负责的，因此，即使你的Java程序在写入内存后就挂掉了，只要操作系统工作正常，数据就会写入磁盘。<br>如果电源故障或者主机瘫痪，有可能内存映射文件还没有写入磁盘，意味着可能会丢失一些关键数据。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/258091/when-should-i-use-mmap-for-file-access">https://stackoverflow.com/questions/258091/when-should-i-use-mmap-for-file-access</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/187eada7b900">https://www.jianshu.com/p/187eada7b900</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5c3ec9ebf265da61223a93de#heading-0">https://juejin.im/post/5c3ec9ebf265da61223a93de#heading-0</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/30180268/android-ndk-mmap-call-broken-on-32-bit-devices-after-upgrading-to-lollipop">https://stackoverflow.com/questions/30180268/android-ndk-mmap-call-broken-on-32-bit-devices-after-upgrading-to-lollipop</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/33897711/android-mmap-fails-with-out-of-memory">https://stackoverflow.com/questions/33897711/android-mmap-fails-with-out-of-memory</a></li>
</ul>
<p>Android中的Binder也利用的mmap。Binder传递数据时，只需要复制一次，就能把数据传递到另一个进程中。参考<a target="_blank" rel="noopener" href="https://rustfisher.com/2019/08/08/Android/Android-Binder_%E6%9C%BA%E5%88%B6%E4%BB%8B%E7%BB%8D/">Binder机制介绍</a></p>
<h2 id="Android中使用mmap"><a href="#Android中使用mmap" class="headerlink" title="Android中使用mmap"></a>Android中使用mmap</h2><p>Android中使用mmap，可以通过RandomAccessFile与MappedByteBuffer来配合。参考<a target="_blank" rel="noopener" href="https://rustfisher.com/2018/07/29/Dev-note/dev-note-app-drone/">drone开发记录 - log记录工具</a></p>
<p>通过<code>randomAccessFile.getChannel().map</code>获取到<code>MappedByteBuffer</code>。然后调用ByteBuffer的put方法添加数据。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-08-08T02:49:53.000Z" title="2019/8/8 10:49:53">2019-08-08</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:37:57.567Z" title="2021/6/18 17:37:57">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">27 分钟读完 (大约4002个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/08/08/Android/Android-Binder_mechanism_intro/">Android Binder 机制介绍</a></p><div class="content"><h2 id="面向对象的IPC-Binder"><a href="#面向对象的IPC-Binder" class="headerlink" title="面向对象的IPC - Binder"></a>面向对象的IPC - Binder</h2><p>c/s架构，客户端要找得到服务端。<br>Binder使用Client-Server通信方式：一个进程作为Server提供诸如视频/音频解码，视频捕获，地址本查询，网络连接等服务；多个进程作为Client向Server发起服务请求，获得所需要的服务。要想实现Client-Server通信据必须实现以下两点：一是server必须有确定的访问接入点或者说地址来接受Client的请求，并且Client可以通过某种途径获知Server的地址；二是制定Command-Reply协议来传输数据。例如在网络通信中Server的访问接入点就是Server主机的IP地址+端口号，传输协议为TCP协议。对Binder而言，Binder可以看成Server提供的实现某个特定服务的访问接入点， Client通过这个‘地址’向Server发送请求来使用该服务；对Client而言，Binder可以看成是通向Server的管道入口，要想和某个Server通信首先必须建立这个管道并获得管道入口。</p>
<p>与其它IPC不同，Binder使用了面向对象的思想来描述作为访问接入点的Binder及其在Client中的入口。Binder是一个实体位于Server中的对象，该对象提供了一套方法用以实现对服务的请求，就象类的成员函数。遍布于client中的入口可以看成指向这个binder对象的‘指针’，一旦获得了这个‘指针’就可以调用该对象的方法访问server。在Client看来，通过Binder‘指针’调用其提供的方法和通过指针调用其它任何本地对象的方法并无区别，尽管前者的实体位于远端Server中，而后者实体位于本地内存中。‘指针’是C++的术语，而更通常的说法是引用，即Client通过Binder的引用访问Server。而软件领域另一个术语‘句柄’也可以用来表述Binder在Client中的存在方式。从通信的角度看，Client中的Binder也可以看作是Server Binder的‘代理’，在本地代表远端Server为Client提供服务。本文中会使用‘引用’或‘句柄’这个两广泛使用的术语。</p>
<p><strong>Binder对象是一个可以跨进程引用的对象，它的实体位于一个进程中，而它的引用却遍布于系统的各个进程之中。</strong></p>
<p>面向对象思想的引入将进程间通信转化为通过对某个Binder对象的引用调用该对象的方法，而其独特之处在于Binder对象是一个可以跨进程引用的对象，它的实体位于一个进程中，而它的引用却遍布于系统的各个进程之中。最诱人的是，这个引用和java里引用一样既可以是强类型，也可以是弱类型，而且可以从一个进程传给其它进程，让大家都能访问同一Server，就象将一个对象或引用赋值给另一个引用一样。Binder模糊了进程边界，淡化了进程间通信过程，整个系统仿佛运行于同一个面向对象的程序之中。形形色色的Binder对象以及星罗棋布的引用仿佛粘接各个应用程序的胶水，这也是Binder在英文里的原意。</p>
<p>当然面向对象只是针对应用程序而言，对于Binder驱动和内核其它模块一样使用C语言实现，没有类和对象的概念。Binder驱动为面向对象的进程间通信提供底层支持。</p>
<h2 id="Binder-通信模型"><a href="#Binder-通信模型" class="headerlink" title="Binder 通信模型"></a>Binder 通信模型</h2><p>Binder框架定义了四个角色：Server，Client，ServiceManager（以后简称SMgr）以及Binder驱动。其中Server，Client，SMgr运行于用户空间，驱动运行于内核空间。这四个角色的关系和互联网类似：Server是服务器，Client是客户终端，SMgr是域名服务器（DNS），驱动是路由器。</p>
<h3 id="Binder-驱动"><a href="#Binder-驱动" class="headerlink" title="Binder 驱动"></a>Binder 驱动</h3><p>和路由器一样，Binder驱动虽然默默无闻，却是通信的核心。尽管名叫‘驱动’，实际上和硬件设备没有任何关系，只是实现方式和设备驱动程序是一样的：它工作于内核态，提供open()，mmap()，poll()，ioctl()等标准文件操作，以字符驱动设备中的misc设备注册在设备目录/dev下，用户通过/dev/binder访问该它。驱动负责进程之间Binder通信的建立，Binder在进程之间的传递，Binder引用计数管理，数据包在进程之间的传递和交互等一系列底层支持。驱动和应用程序之间定义了一套接口协议，主要功能由ioctl()接口实现，不提供read()，write()接口，因为ioctl()灵活方便，且能够一次调用实现先写后读以满足同步交互，而不必分别调用write()和read()。Binder驱动的代码位于linux目录的drivers/misc/binder.c中。</p>
<h4 id="ServiceManager-与实名Binder"><a href="#ServiceManager-与实名Binder" class="headerlink" title="ServiceManager 与实名Binder"></a>ServiceManager 与实名Binder</h4><p>和DNS类似，SMgr的作用是将字符形式的Binder名字转化成Client中对该Binder的引用，使得Client能够通过Binder名字获得对Server中Binder实体的引用。注册了名字的Binder叫实名Binder，就象每个网站除了有IP地址外还有自己的网址。Server创建了Binder实体，为其取一个字符形式，可读易记的名字，将这个Binder连同名字以数据包的形式通过Binder驱动发送给SMgr，通知SMgr注册一个名叫张三的Binder，它位于某个Server中。驱动为这个穿过进程边界的Binder创建位于内核中的实体节点以及SMgr对实体的引用，将名字及新建的引用打包传递给SMgr。SMgr收数据包后，从中取出名字和引用填入一张查找表中。</p>
<h4 id="ServiceManager什么时候注册的"><a href="#ServiceManager什么时候注册的" class="headerlink" title="ServiceManager什么时候注册的"></a>ServiceManager什么时候注册的</h4><p>细心的读者可能会发现其中的蹊跷：SMgr是一个进程，Server是另一个进程，Server向SMgr注册Binder必然会涉及进程间通信。当前实现的是进程间通信却又要用到进程间通信，这就好象蛋可以孵出鸡前提却是要找只鸡来孵蛋。Binder的实现比较巧妙：预先创造一只鸡来孵蛋：SMgr和其它进程同样采用Binder通信，SMgr是Server端，有自己的Binder对象（实体），其它进程都是Client，需要通过这个Binder的引用来实现Binder的注册，查询和获取。SMgr提供的Binder比较特殊，它没有名字也不需要注册，当一个进程使用BINDER_SET_CONTEXT_MGR命令将自己注册成SMgr时Binder驱动会自动为它创建Binder实体（这就是那只预先造好的鸡）。其次这个Binder的引用在所有Client中都固定为0而无须通过其它手段获得。也就是说，一个Server若要向SMgr注册自己Binder就必需通过0这个引用号和SMgr的Binder通信。类比网络通信，0号引用就好比域名服务器的地址，你必须预先手工或动态配置好。要注意这里说的Client是相对SMgr而言的，一个应用程序可能是个提供服务的Server，但对SMgr来说它仍然是个Client。</p>
<h4 id="Client-获得实名Binder的引用"><a href="#Client-获得实名Binder的引用" class="headerlink" title="Client 获得实名Binder的引用"></a>Client 获得实名Binder的引用</h4><p>Server向SMgr注册了Binder实体及其名字后，Client就可以通过名字获得该Binder的引用了。Client也利用保留的0号引用向SMgr请求访问某个Binder：我申请获得名字叫张三的Binder的引用。SMgr收到这个连接请求，从请求数据包里获得Binder的名字，在查找表里找到该名字对应的条目，从条目中取出Binder的引用，将该引用作为回复发送给发起请求的Client。从面向对象的角度，这个Binder对象现在有了两个引用：一个位于SMgr中，一个位于发起请求的Client中。如果接下来有更多的Client请求该Binder，系统中就会有更多的引用指向该Binder，就象java里一个对象存在多个引用一样。而且类似的这些指向Binder的引用是强类型，从而确保只要有引用Binder实体就不会被释放掉。通过以上过程可以看出，SMgr象个火车票代售点，收集了所有火车的车票，可以通过它购买到乘坐各趟火车的票-得到某个Binder的引用。</p>
<h4 id="匿名-Binder"><a href="#匿名-Binder" class="headerlink" title="匿名 Binder"></a>匿名 Binder</h4><p>并不是所有Binder都需要注册给SMgr广而告之的。Server端可以通过已经建立的Binder连接将创建的Binder实体传给Client，当然这条已经建立的Binder连接必须是通过实名Binder实现。由于这个Binder没有向SMgr注册名字，所以是个匿名Binder。Client将会收到这个匿名Binder的引用，通过这个引用向位于Server中的实体发送请求。匿名Binder为通信双方建立一条私密通道，只要Server没有把匿名Binder发给别的进程，别的进程就无法通过穷举或猜测等任何方式获得该Binder的引用，向该Binder发送请求。</p>
<p>下图展示了参与Binder通信的所有角色，将在后面的内容中一一提到。</p>
<p><img src="http://rustblogres.rustfisher.com/Android-Binder-sys.png" alt="Binder通信模型"></p>
<h4 id="Binder-内存映射和接收缓存区管理"><a href="#Binder-内存映射和接收缓存区管理" class="headerlink" title="Binder 内存映射和接收缓存区管理"></a>Binder 内存映射和接收缓存区管理</h4><p>暂且撇开Binder，考虑一下传统的IPC方式中，数据是怎样从发送端到达接收端的呢？通常的做法是，发送方将准备好的数据存放在缓存区中，调用API通过系统调用进入内核中。内核服务程序在内核空间分配内存，将数据从发送方缓存区复制到内核缓存区中。接收方读数据时也要提供一块缓存区，内核将数据从内核缓存区拷贝到接收方提供的缓存区中并唤醒接收线程，完成一次数据发送。这种存储-转发机制有两个缺陷：首先是效率低下，需要做两次拷贝：用户空间-&gt;内核空间-&gt;用户空间。Linux使用copy_from_user()和copy_to_user()实现这两个跨空间拷贝，在此过程中如果使用了高端内存（high memory），这种拷贝需要临时建立/取消页面映射，造成性能损失。其次是接收数据的缓存要由接收方提供，可接收方不知道到底要多大的缓存才够用，只能开辟尽量大的空间或先调用API接收消息头获得消息体大小，再开辟适当的空间接收消息体。两种做法都有不足，不是浪费空间就是浪费时间。</p>
<p>Binder采用一种全新策略：由Binder驱动负责管理数据接收缓存。我们注意到Binder驱动实现了mmap()系统调用，这对字符设备是比较特殊的，因为mmap()通常用在有物理存储介质的文件系统上，而象Binder这样没有物理介质，纯粹用来通信的字符设备没必要支持mmap()。Binder驱动当然不是为了在物理介质和用户空间做映射，而是用来创建数据接收的缓存空间。先看mmap()是如何使用的：</p>
<p>fd = open(“/dev/binder”, O_RDWR);</p>
<p>mmap(NULL, MAP_SIZE, PROT_READ, MAP_PRIVATE, fd, 0);</p>
<p>这样Binder的接收方就有了一片大小为MAP_SIZE的接收缓存区。mmap()的返回值是内存映射在用户空间的地址，不过这段空间是由驱动管理，用户不必也不能直接访问（映射类型为PROT_READ，只读映射）。</p>
<p>接收缓存区映射好后就可以做为缓存池接收和存放数据了。前面说过，接收数据包的结构为binder_transaction_data，但这只是消息头，真正的有效负荷位于data.buffer所指向的内存中。这片内存不需要接收方提供，恰恰是来自mmap()映射的这片缓存池。在数据从发送方向接收方拷贝时，驱动会根据发送数据包的大小，使用最佳匹配算法从缓存池中找到一块大小合适的空间，将数据从发送缓存区复制过来。要注意的是，存放binder_transaction_data结构本身以及表4中所有消息的内存空间还是得由接收者提供，但这些数据大小固定，数量也不多，不会给接收方造成不便。映射的缓存池要足够大，因为接收方的线程池可能会同时处理多条并发的交互，每条交互都需要从缓存池中获取目的存储区，一旦缓存池耗竭将产生导致无法预期的后果。</p>
<p>有分配必然有释放。接收方在处理完数据包后，就要通知驱动释放data.buffer所指向的内存区。在介绍Binder协议时已经提到，这是由命令BC_FREE_BUFFER完成的。</p>
<p>通过上面介绍可以看到，驱动为接收方分担了最为繁琐的任务：分配/释放大小不等，难以预测的有效负荷缓存区，而接收方只需要提供缓存来存放大小固定，最大空间可以预测的消息头即可。在效率上，由于mmap()分配的内存是映射在接收方用户空间里的，所有总体效果就相当于对有效负荷数据做了一次从发送方用户空间到接收方用户空间的直接数据拷贝，省去了内核中暂存这个步骤，提升了一倍的性能。顺便再提一点，Linux内核实际上没有从一个用户空间到另一个用户空间直接拷贝的函数，需要先用copy_from_user()拷贝到内核空间，再用copy_to_user()拷贝到另一个用户空间。为了实现用户空间到用户空间的拷贝，mmap()分配的内存除了映射进了接收方进程里，还映射进了内核空间。所以调用copy_from_user()将数据拷贝进内核空间也相当于拷贝进了接收方的用户空间，这就是Binder只需一次拷贝的‘秘密’。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://blog.csdn.net/universus/article/details/6211589">universus的专栏 - Android Binder设计与实现 - 设计篇</a><br><a target="_blank" rel="noopener" href="https://rustfisher.com/2015/10/26/Android/Android-AIDL_intro_and_use/">Android AIDL简介与使用</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-08-06T13:35:43.000Z" title="2019/8/6 21:35:43">2019-08-06</time>发表</span><span class="level-item"><time dateTime="2020-01-07T14:29:42.862Z" title="2020/1/7 22:29:42">2020-01-07</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">6 分钟读完 (大约924个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/08/06/Dev-note/dev-note-app-PhoneInfo/">「PhoneInfo」开发记录</a></p><div class="content"><p>开发过程中，一些低频使用的API不太记得，每次都要查一下。比如Build这个类。<br>做一个app，一边显示代码，一边显示结果，岂不美哉。</p>
<p>发布地址</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.coolapk.com/apk/238562">PhoneInfo - 酷安</a></li>
<li><a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=com.rustfisher.phoneinfoapp">PhoneInfo - PlayStore</a></li>
</ul>
<h2 id="页面布局"><a href="#页面布局" class="headerlink" title="页面布局"></a>页面布局</h2><p>ViewPager + TabLayout</p>
<p>承载多个fragment，显示不同的信息。</p>
<p>TabLayout字体大小改小一点。</p>
<p>style.xml里增加<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;DashPageTabText&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;TextAppearance.AppCompat.Button&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:textSize&quot;</span>&gt;</span>10sp<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;DashPageTabLayout&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;Widget.Design.TabLayout&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;tabTextAppearance&quot;</span>&gt;</span>@style/DashPageTabText<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--&lt;item name=&quot;tabSelectedTextColor&quot;&gt;SELECTED TAB TEXT COLOR&lt;/item&gt;--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--&lt;item name=&quot;tabIndicatorColor&quot;&gt;SELECTED TAB INDICATOR COLOR&lt;/item&gt;--&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>tabLayout中增加style<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.google.android.material.tabs.TabLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/dash_page_tabs&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">&quot;@style/DashPageTabLayout&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;40dp&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31471177/text-size-of-android-design-tablayout-tabs">https://stackoverflow.com/questions/31471177/text-size-of-android-design-tablayout-tabs</a></p>
<p>或者设置选中和未选中tab时文字的颜色，设置tab可以滚动<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.google.android.material.tabs.TabLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/dash_page_tabs&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">&quot;@style/DashPageTabLayout&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;40dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabMode</span>=<span class="string">&quot;scrollable&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabSelectedTextColor</span>=<span class="string">&quot;#000&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabTextColor</span>=<span class="string">&quot;#99222222&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="TabLayout-ViewPager-联动"><a href="#TabLayout-ViewPager-联动" class="headerlink" title="TabLayout ViewPager 联动"></a>TabLayout ViewPager 联动</h3><p><code>DashPagerAdapter</code>类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.annotation.NonNull;</span><br><span class="line"><span class="keyword">import</span> androidx.fragment.app.Fragment;</span><br><span class="line"><span class="keyword">import</span> androidx.fragment.app.FragmentManager;</span><br><span class="line"><span class="keyword">import</span> androidx.fragment.app.FragmentPagerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DashPagerAdapter</span> <span class="keyword">extends</span> <span class="title class_">FragmentPagerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> fragCount;</span><br><span class="line">    <span class="comment">// 装着fragment</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DashPagerAdapter</span><span class="params">(FragmentManager fm, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(fm);</span><br><span class="line">        fragCount = count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fragCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Fragment <span class="title function_">getItem</span><span class="params">(<span class="type">int</span> position)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// 返回对应的fragment;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isViewFromObject</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@NonNull</span> Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.isViewFromObject(view, object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>onCreate里初始化<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mTabLayout = findViewById(R.id.dash_page_tabs);</span><br><span class="line">mViewPager = findViewById(R.id.dash_page_vp);</span><br><span class="line">mTabLayout.addTab(mTabLayout.newTab().setText(<span class="string">&quot;Build&quot;</span>));</span><br><span class="line">mTabLayout.addTab(mTabLayout.newTab().setText(<span class="string">&quot;Screen&quot;</span>));</span><br><span class="line">mTabLayout.addTab(mTabLayout.newTab().setText(<span class="string">&quot;WiFi&quot;</span>));</span><br><span class="line">mTabLayout.addTab(mTabLayout.newTab().setText(<span class="string">&quot;ext-Storage&quot;</span>));</span><br><span class="line">mTabLayout.addTab(mTabLayout.newTab().setText(<span class="string">&quot;app-Storage&quot;</span>));</span><br><span class="line">mTabLayout.addTab(mTabLayout.newTab().setText(<span class="string">&quot;uri&quot;</span>));</span><br><span class="line">mTabLayout.addTab(mTabLayout.newTab().setText(<span class="string">&quot;battery&quot;</span>));</span><br><span class="line"></span><br><span class="line">mDashPagerAdapter = <span class="keyword">new</span> <span class="title class_">DashPagerAdapter</span>(getSupportFragmentManager(), mTabLayout.getTabCount());</span><br><span class="line"></span><br><span class="line">mViewPager.setAdapter(mDashPagerAdapter);</span><br><span class="line">mViewPager.addOnPageChangeListener(<span class="keyword">new</span> <span class="title class_">TabLayout</span>.TabLayoutOnPageChangeListener(mTabLayout));</span><br><span class="line">mTabLayout.addOnTabSelectedListener(<span class="keyword">new</span> <span class="title class_">TabLayout</span>.OnTabSelectedListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTabSelected</span><span class="params">(TabLayout.Tab tab)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> tab.getPosition();</span><br><span class="line">        mViewPager.setCurrentItem(pos);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTabUnselected</span><span class="params">(TabLayout.Tab tab)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTabReselected</span><span class="params">(TabLayout.Tab tab)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="Build类"><a href="#Build类" class="headerlink" title="Build类"></a>Build类</h2><p>比如这样</p>
<p><img src="http://rustblogres.rustfisher.com/phoneinfo-app-build-page-1p.jpg" alt="展示Build类的API"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O &amp;&amp;</span><br><span class="line">        PackageManager.PERMISSION_GRANTED == ContextCompat.checkSelfPermission(<span class="built_in">this</span>, Manifest.permission.READ_PHONE_STATE)) &#123;</span><br><span class="line">    mInfoReAdapter.addOrUpdate(K_SERIAL, <span class="string">&quot;Build.getSerial()&quot;</span>, Build.getSerial());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mInfoReAdapter.addOrUpdate(Build.SERIAL, <span class="string">&quot;Build.SERIAL&quot;</span>, Build.SERIAL);</span><br><span class="line">&#125;</span><br><span class="line">mInfoReAdapter.addOrUpdate(<span class="string">&quot;Build.getRadioVersion()&quot;</span>, <span class="string">&quot;Build.getRadioVersion()&quot;</span>, Build.getRadioVersion());</span><br><span class="line">mInfoReAdapter.addOrUpdate(<span class="string">&quot;Build.ID               &quot;</span>, <span class="string">&quot;Build.ID&quot;</span>, Build.ID);</span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line">mInfoReAdapter.addOrUpdate(<span class="string">&quot;Build.USER             &quot;</span>, <span class="string">&quot;Build.USER&quot;</span>, Build.USER);</span><br><span class="line">mInfoReAdapter.notifyDataSetChanged();</span><br></pre></td></tr></table></figure>
<h2 id="屏幕信息"><a href="#屏幕信息" class="headerlink" title="屏幕信息"></a>屏幕信息</h2><p>获取屏幕宽高。获取屏幕宽高的方法大约有3种，这里直接用view.post(runnable)的方式来获取实际宽高。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">View</span> <span class="variable">root</span> <span class="operator">=</span> findViewById(R.id.container);</span><br><span class="line">root.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">wid</span> <span class="operator">=</span> root.getWidth();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> root.getHeight();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;phone screen size [&quot;</span> + wid + <span class="string">&quot;, &quot;</span> + height + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        mDashPagerAdapter.setPhoneScreenSize(wid, height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>把像素转换成dp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> <span class="title function_">pxToDp</span><span class="params">(<span class="type">int</span> px)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (px / Resources.getSystem().getDisplayMetrics().density);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="存储路径信息"><a href="#存储路径信息" class="headerlink" title="存储路径信息"></a>存储路径信息</h2><p>比如获取到外部存储的路径等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mInfoReAdapter.addOrUpdateUpDown(<span class="string">&quot;root&quot;</span>, <span class="string">&quot;Environment.getRootDirectory().getAbsolutePath()&quot;</span>,</span><br><span class="line">        Environment.getRootDirectory().getAbsolutePath());</span><br></pre></td></tr></table></figure>
<h2 id="Uri类信息"><a href="#Uri类信息" class="headerlink" title="Uri类信息"></a>Uri类信息</h2><p>展示Uri类的一些信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.fromFile(getActivity().getApplicationContext().getFilesDir());</span><br></pre></td></tr></table></figure>
<h2 id="crash-java-lang-ClassNotFoundException"><a href="#crash-java-lang-ClassNotFoundException" class="headerlink" title="crash java.lang.ClassNotFoundException"></a>crash java.lang.ClassNotFoundException</h2><p>Google play console 收集到的crash信息。崩溃机型是华为和三星。</p>
<p>Galaxy A40 (a40)， Note9 (crownlte)， A70 (a70q)， Note8 (greatlte)；Mate 10 Pro (HWBLA)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: </span><br><span class="line">  at android.app.ActivityThread.handleReceiver (ActivityThread.java:3586)</span><br><span class="line">  at android.app.ActivityThread.access$1300 (ActivityThread.java:240)</span><br><span class="line">  at android.app.ActivityThread$H.handleMessage (ActivityThread.java:1808)</span><br><span class="line">  at android.os.Handler.dispatchMessage (Handler.java:106)</span><br><span class="line">  at android.os.Looper.loop (Looper.java:214)</span><br><span class="line">  at android.app.ActivityThread.main (ActivityThread.java:7094)</span><br><span class="line">  at java.lang.reflect.Method.invoke (Native Method)</span><br><span class="line">  at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run (RuntimeInit.java:494)</span><br><span class="line">  at com.android.internal.os.ZygoteInit.main (ZygoteInit.java:975)</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: </span><br><span class="line">  at dalvik.system.BaseDexClassLoader.findClass (BaseDexClassLoader.java:134)</span><br><span class="line">  at java.lang.ClassLoader.loadClass (ClassLoader.java:379)</span><br><span class="line">  at java.lang.ClassLoader.loadClass (ClassLoader.java:312)</span><br><span class="line">  at android.app.AppComponentFactory.instantiateReceiver (AppComponentFactory.java:84)</span><br><span class="line">  at androidx.core.app.CoreComponentFactory.instantiateReceiver (CoreComponentFactory.java:56)</span><br><span class="line">  at android.app.ActivityThread.handleReceiver (ActivityThread.java:3579)</span><br></pre></td></tr></table></figure>
<p>根据<code>ActivityThread.handleReceiver</code>猜测，有一个广播接收器示例化失败了。<br>应用里只有一个动态注册的广播接收器。应该是注册失败了。手头上没有三星和华为。暂时没法重现。</p>
<h2 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h2><ul>
<li>[1.1.4] 2020-1-7<ul>
<li>使用新的UI样式</li>
</ul>
</li>
<li>[1.1.1] 2019-11-10<ul>
<li>修改电池广播接收器的信息类型</li>
</ul>
</li>
<li>[1.0.9] 2019-9-14<ul>
<li>修改ui</li>
</ul>
</li>
<li>[1.0.8] 2019-9-13<ul>
<li>增加了Uri类的信息</li>
</ul>
</li>
<li>[1.0.6] 2019-9-4<ul>
<li>增加了Environment类的信息</li>
<li>修复了定位权限对Wi-Fi信息界面的影响</li>
</ul>
</li>
<li>2019-8-17<ul>
<li>增加了屏幕尺寸信息</li>
<li>采用ViewPager + TabLayout显示多个页面</li>
</ul>
</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-07-29T01:11:15.000Z" title="2019/7/29 09:11:15">2019-07-29</time>发表</span><span class="level-item"><time dateTime="2019-08-02T09:13:34.000Z" title="2019/8/2 17:13:34">2019-08-02</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">14 分钟读完 (大约2123个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/07/29/Dev-note/dev-note-app-SDEdit/">「SD编辑」开发记录</a></p><div class="content"><p>SD - Slam Dump（并不是）</p>
<p>这个App的主要目的是满足广大人民群众对图片编辑的需求。</p>
<h2 id="字体问题"><a href="#字体问题" class="headerlink" title="字体问题"></a>字体问题</h2><p>Android默认的字体不太好看，也不一定能很好地匹配背景图。如果内置字体，遇到最大的问题是版权问题。<br>因此决定增加用户自行导入字体的功能，由用户来决定使用什么字体。</p>
<p>原来的字体文件是放在asset中。<code>Typeface.createFromAsset</code>直接引入并使用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Typeface</span> <span class="variable">tf</span> <span class="operator">=</span> Typeface.createFromAsset(mgr, <span class="string">&quot;fonts/fz_grid.ttf&quot;</span>);</span><br><span class="line">mContentTv.setTypeface(tf);</span><br></pre></td></tr></table></figure></p>
<p>设计一个字体管理界面。用户自行选择将字体文件复制到App内部存储路径。<br>使用字体时，再用<code>Typeface.createFromFile()</code>获取Typeface。</p>
<h2 id="选择文件"><a href="#选择文件" class="headerlink" title="选择文件"></a>选择文件</h2><p>调用系统文件选择器<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REQ_CODE_CHOOSE_FILE</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动选择文件...</span></span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_GET_CONTENT);</span><br><span class="line">    intent.setType(<span class="string">&quot;*/*&quot;</span>);</span><br><span class="line">    startActivityForResult(intent, REQ_CODE_CHOOSE_FILE);</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理选择的文件</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(<span class="type">int</span> requestCode, <span class="type">int</span> resultCode, <span class="meta">@Nullable</span> Intent data)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> REQ_CODE_CHOOSE_FILE:</span><br><span class="line">                <span class="keyword">if</span> (data != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> data.getData();</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;onActivityResult: uri: &quot;</span> + uri);</span><br><span class="line">                    <span class="keyword">if</span> (uri != <span class="literal">null</span> &amp;&amp; !TextUtils.isEmpty(uri.getPath())) &#123;</span><br><span class="line">                        copyFile(uri);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Log.e(TAG, <span class="string">&quot;onActivityResult: 选择的文件无效&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    showShort(getApplicationContext(), <span class="string">&quot;没选中文件&quot;</span>);</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;onActivityResult: data is NULL 没选中文件&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">super</span>.onActivityResult(requestCode, resultCode, data);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h2 id="处理uri"><a href="#处理uri" class="headerlink" title="处理uri"></a>处理uri</h2><p>uri形如 </p>
<p>content://com.android.externalstorage.documents/document/primary%3ADownload%2Ffz_grid.ttf</p>
<p>uri.getPath获取到的并不是文件的绝对路径。但我们可以利用ContentResolver来获取到InputStream。<br>也可以获取到uri的文件名。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">copyFile</span><span class="params">(<span class="keyword">final</span> Uri uri)</span> &#123;</span><br><span class="line">    mAddIv.setClickable(<span class="literal">false</span>);</span><br><span class="line">    <span class="type">Animation</span> <span class="variable">rotate</span> <span class="operator">=</span> AnimationUtils.loadAnimation(getApplicationContext(), R.anim.rotate_scan);</span><br><span class="line">    rotate.setDuration(<span class="number">400</span>);</span><br><span class="line">    mAddIv.startAnimation(rotate);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> getContentResolver().query(uri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">nameIndex</span> <span class="operator">=</span> cursor.getColumnIndex(OpenableColumns.DISPLAY_NAME);</span><br><span class="line">                cursor.moveToFirst();</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> cursor.getString(nameIndex);</span><br><span class="line">                cursor.close();</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">fis</span> <span class="operator">=</span> getContentResolver().openInputStream(uri);</span><br><span class="line">                <span class="type">File</span> <span class="variable">outputFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(TypefaceStore.getStorePath(getApplicationContext()), name);</span><br><span class="line">                <span class="keyword">if</span> (outputFile.exists()) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">d</span> <span class="operator">=</span> outputFile.delete();</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;删除旧文件: &quot;</span> + d);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">n</span> <span class="operator">=</span> outputFile.createNewFile();</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;copyFile: 新建文件 &quot;</span> + n);</span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outputFile);</span><br><span class="line">                <span class="type">byte</span>[] tmp = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];</span><br><span class="line">                <span class="type">int</span> i;</span><br><span class="line">                <span class="keyword">while</span> ((i = fis.read(tmp)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    fos.write(tmp, <span class="number">0</span>, i);</span><br><span class="line">                &#125;</span><br><span class="line">                fos.flush();</span><br><span class="line">                fos.close();</span><br><span class="line">                fis.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;copyFile ERROR:&quot;</span>, e);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以简单地使用uri.getLastPathSegment来获取文件名<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uri.getLastPathSegment();</span><br><span class="line">String[] t = uriPath.split(File.separator);</span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> t[t.length - <span class="number">1</span>];</span><br></pre></td></tr></table></figure></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4263002/how-to-get-file-name-from-uri">https://stackoverflow.com/questions/4263002/how-to-get-file-name-from-uri</a></p>
<h2 id="Toolbar问题"><a href="#Toolbar问题" class="headerlink" title="Toolbar问题"></a>Toolbar问题</h2><p>使用toolbar时经常会遇到问题。例如<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/26486730/in-android-app-toolbar-settitle-method-has-no-effect-application-name-is-shown">设置title的问题</a>。</p>
<p>这里自己创建一个统一的标题栏TitleBar。想要什么控件自己添加。</p>
<h2 id="Google-MobileAds"><a href="#Google-MobileAds" class="headerlink" title="Google MobileAds"></a>Google MobileAds</h2><p><code>MobileAds.initialize(getApplicationContext(), AdsMgr.GOOGLE_ADS_APP_ID);</code>的执行会占用很多时间。测试过程中发现小米手机甚至使用了3秒钟来执行这个方法。</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/37418663/what-is-the-proper-way-to-call-mobileads-initialize">https://stackoverflow.com/questions/37418663/what-is-the-proper-way-to-call-mobileads-initialize</a></p>
<p>给启动页Activity一个纯色的启动背景。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;AppTheme.NoActionBar&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;windowActionBar&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;windowNoTitle&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowBackground&quot;</span>&gt;</span>@color/colorPrimary<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>启动页中初始化Ads时实在是耗时太长，干脆放到子线程中去操作。<br>虽然<a target="_blank" rel="noopener" href="https://developers.google.com/admob/android/quick-start">官方文档</a>建议的是越早初始化越好。但也不希望太影响用户体验。</p>
<h2 id="递归查看某个路径下的文件"><a href="#递归查看某个路径下的文件" class="headerlink" title="递归查看某个路径下的文件"></a>递归查看某个路径下的文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">treeDir</span><span class="params">(File dir, <span class="type">int</span> level)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">            sb.append(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (dir.isDirectory()) &#123;</span><br><span class="line"><span class="comment">//            LL.d(TAG, sb.toString() + dir.getName());</span></span><br><span class="line">            level++;</span><br><span class="line">            <span class="keyword">for</span> (File f : dir.listFiles()) &#123;</span><br><span class="line">                treeDir(f, level);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//            LL.d(TAG, sb.toString() + dir.getName());</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="提供草稿功能"><a href="#提供草稿功能" class="headerlink" title="提供草稿功能"></a>提供草稿功能</h2><p>为方便用户使用，提供草稿功能。这就涉及到增删查改的操作。</p>
<p>[2019-7-31] 本来想直接用sqlite，但为了开发方便，选用了<a target="_blank" rel="noopener" href="http://greenrobot.org/greendao/">greenDAO</a>。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/greenrobot/greenDAO">https://github.com/greenrobot/greenDAO</a></p>
<p>使用2个表，分别为Draft（存档）和DraftContent（图层）。DraftContent中存放着关联的存档ID。</p>
<p>能保存的东西都保存下来。</p>
<h3 id="greendao插入元素"><a href="#greendao插入元素" class="headerlink" title="greendao插入元素"></a>greendao插入元素</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Draft</span> <span class="variable">draft1</span> <span class="operator">=</span> genDraft(<span class="string">&quot;示例1&quot;</span>, p1Path);</span><br><span class="line"><span class="type">Draft</span> <span class="variable">draft2</span> <span class="operator">=</span> genDraft(<span class="string">&quot;示例2&quot;</span>, p2Path);</span><br><span class="line"><span class="type">Draft</span> <span class="variable">draft3</span> <span class="operator">=</span> genDraft(<span class="string">&quot;示例3&quot;</span>, p3Path);</span><br><span class="line">Log.d(TAG, <span class="string">&quot;addDemoDraft: id: &quot;</span> + draft1.getDraftId() + <span class="string">&quot;,&quot;</span> + draft3.getDraftId());</span><br><span class="line">daoSession.insert(draft1);</span><br><span class="line">daoSession.insert(draft2);</span><br><span class="line">daoSession.insert(draft3);</span><br></pre></td></tr></table></figure>
<p>插入元素后就有id了。</p>
<h3 id="greendao删除元素"><a href="#greendao删除元素" class="headerlink" title="greendao删除元素"></a>greendao删除元素</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DraftDao</span> <span class="variable">draftDao</span> <span class="operator">=</span> daoSession.getDraftDao();</span><br><span class="line"><span class="type">DraftContentDao</span> <span class="variable">draftContentDao</span> <span class="operator">=</span> daoSession.getDraftContentDao();</span><br><span class="line"><span class="keyword">for</span> (Draft d : drafts) &#123;</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;删除 &quot;</span> + d.getName());</span><br><span class="line">    draftDao.queryBuilder()</span><br><span class="line">            .where(DraftDao.Properties.DraftId.eq(d.getDraftId())).buildDelete()</span><br><span class="line">            .executeDeleteWithoutDetachingEntities();</span><br><span class="line">    draftContentDao.queryBuilder()</span><br><span class="line">            .where(DraftContentDao.Properties.RelativeDraftId.eq(d.getDraftId())).buildDelete()</span><br><span class="line">            .executeDeleteWithoutDetachingEntities();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用DrawerLayout"><a href="#使用DrawerLayout" class="headerlink" title="使用DrawerLayout"></a>使用DrawerLayout</h2><p>报错： <code>IllegalArgumentException: No drawer view found with gravity LEFT</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: No drawer view found with gravity LEFT</span><br><span class="line">    at androidx.drawerlayout.widget.DrawerLayout.openDrawer(DrawerLayout.java:1736)</span><br><span class="line">    at androidx.drawerlayout.widget.DrawerLayout.openDrawer(DrawerLayout.java:1722)</span><br></pre></td></tr></table></figure>
<p>忘记中xml中加上开抽屉方向了 tools:openDrawer=”start”<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">androidx.drawerlayout.widget.DrawerLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/main_page_root&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.act.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:openDrawer</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>抽屉加上方向 android:layout_gravity=”start”<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 抽屉 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_gravity</span>=<span class="string">&quot;start&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_marginEnd</span>=<span class="string">&quot;100dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="美术设计，App交互设计"><a href="#美术设计，App交互设计" class="headerlink" title="美术设计，App交互设计"></a>美术设计，App交互设计</h2><p>设计是一个比较令我头疼的问题。在这个看脸的时代，App一定要好看！对我而言，直接采用material design的风格会比较省事。<br>经过调整和对比，我选择使用暗色的风格。因为现在主流的图形编辑软件，颜色风格以暗色居多。</p>
<p>参考：</p>
<ul>
<li>看颜色示例 <a target="_blank" rel="noopener" href="https://material.io/design/color/applying-color-to-ui.html#sheets-surfaces">https://material.io/design/color/applying-color-to-ui.html#sheets-surfaces</a></li>
<li>查颜色 <a target="_blank" rel="noopener" href="https://material-ui.com/customization/color/">https://material-ui.com/customization/color/</a></li>
</ul>
<h2 id="文字编辑"><a href="#文字编辑" class="headerlink" title="文字编辑"></a>文字编辑</h2><p>文字内容，大小，旋转方向，颜色都可以调整。</p>
<p>需要一个调色盘来调整颜色。找个第三方的，好看能用即可。</p>
<h2 id="删除存档报错"><a href="#删除存档报错" class="headerlink" title="删除存档报错"></a>删除存档报错</h2><p>list类的经典异常 ConcurrentModificationException。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.util.ConcurrentModificationException</span><br><span class="line">    at java.util.ArrayList$Itr.next(ArrayList.java:860)</span><br></pre></td></tr></table></figure>
<p>list删除元素时报错。这样写是不行的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Data d : dataList) &#123;</span><br><span class="line">    <span class="keyword">if</span> (d.selected) &#123;</span><br><span class="line">        dataList.remove(d);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>用迭代器来删除元素。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Iterator&lt;Data&gt; iterator = dataList.iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    <span class="type">Data</span> <span class="variable">data</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">    <span class="keyword">if</span> (data.selected) &#123;</span><br><span class="line">        iterator.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="输出图片"><a href="#输出图片" class="headerlink" title="输出图片"></a>输出图片</h2><h3 id="保存View的显示内容"><a href="#保存View的显示内容" class="headerlink" title="保存View的显示内容"></a>保存View的显示内容</h3><p>获取一个view的bitmap，然后保存到文件去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取一个 View 的缓存视图</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Bitmap <span class="title function_">getCacheBitmapFromView</span><span class="params">(View view)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">drawingCacheEnabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    view.setDrawingCacheEnabled(drawingCacheEnabled);</span><br><span class="line">    view.buildDrawingCache(drawingCacheEnabled);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Bitmap</span> <span class="variable">drawingCache</span> <span class="operator">=</span> view.getDrawingCache();</span><br><span class="line">    Bitmap bitmap;</span><br><span class="line">    <span class="keyword">if</span> (drawingCache != <span class="literal">null</span>) &#123;</span><br><span class="line">        bitmap = Bitmap.createBitmap(drawingCache);</span><br><span class="line">        view.setDrawingCacheEnabled(<span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        bitmap = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bitmap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">saveBitmapFile</span><span class="params">(Bitmap bitmap, String fileAbsPath)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(fileAbsPath); <span class="comment">// 将要保存图片的路径</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            file.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file));</span><br><span class="line">        bitmap.compress(Bitmap.CompressFormat.JPEG, <span class="number">100</span>, bos);</span><br><span class="line">        bos.flush();</span><br><span class="line">        bos.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="保存图片文件后的处理"><a href="#保存图片文件后的处理" class="headerlink" title="保存图片文件后的处理"></a>保存图片文件后的处理</h3><p>用户输出图片文件后，打开微信想发送这张图片。但是用户发现微信的快捷发送功能找不到这张图片。<br>怎么才能让微信知道这里新增了一张图片呢？</p>
<p>如果要发送广播<code>ACTION_MEDIA_MOUNTED</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sendBroadcast(<span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_MEDIA_MOUNTED, Uri.fromFile(outputFile)));</span><br></pre></td></tr></table></figure>
<p>报错，没有足够的权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.SecurityException: Permission Denial: not allowed to send broadcast android.intent.action.MEDIA_MOUNTED</span><br></pre></td></tr></table></figure>
<p>Android KK开始，这个广播开始只能由系统发出。KK及之后的版本需使用<code>Intent.ACTION_MEDIA_SCANNER_SCAN_FILE</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">outputFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line">sendBroadcast(<span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_MEDIA_SCANNER_SCAN_FILE, Uri.fromFile(outputFile)));</span><br></pre></td></tr></table></figure>
<p>参考</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/24072489/java-lang-securityexception-permission-denial-not-allowed-to-send-broadcast-an">https://stackoverflow.com/questions/24072489/java-lang-securityexception-permission-denial-not-allowed-to-send-broadcast-an</a></p>
<h2 id="移动TextView"><a href="#移动TextView" class="headerlink" title="移动TextView"></a>移动TextView</h2><p>编辑页中有一个需求是手指拖动文字。</p>
<h3 id="1-1-x版本"><a href="#1-1-x版本" class="headerlink" title="1.1.x版本"></a>1.1.x版本</h3><p>1.1.0版本的做法是，在Activity的onTouch方法里来改变TextView的坐标。从而实现TextView的拖动效果。<br>父View和子View设同一个OnTouchListener。但是只有父view来处理触摸事件。<br>如果是子view接收到了触摸事件，则做一个bool标记firstOnTv = true，返回false，把触摸事件交给父view来处理。<br>父view处理触摸事件时，判断如果刚才点中的是子view（即mContentTv），则在MotionEvent.ACTION_MOVE时更改子view的坐标。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> View.<span class="type">OnTouchListener</span> <span class="variable">mWsOnTouchListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">View</span>.OnTouchListener() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">firstOnTv</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// 最开始点中的是tv</span></span><br><span class="line">        <span class="type">float</span> originTvX;           <span class="comment">// tv最开始的坐标</span></span><br><span class="line">        <span class="type">float</span> originTvY;</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> downX;</span><br><span class="line">        <span class="type">float</span> downY;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouch</span><span class="params">(View v, MotionEvent event)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> v.getId();</span><br><span class="line"><span class="comment">//            Log.d(TAG, &quot;onTouch: touch tv: &quot; + (id == mContentTv.getId()) + &quot;, touch ws: &quot; + (id == mWorkspaceField.getId()));</span></span><br><span class="line">            <span class="type">float</span> <span class="variable">x</span> <span class="operator">=</span> event.getX();</span><br><span class="line">            <span class="type">float</span> <span class="variable">y</span> <span class="operator">=</span> event.getY();</span><br><span class="line"><span class="comment">//            Log.d(TAG, &quot;onTouch: [&quot; + x + &quot;, &quot; + y + &quot;] , &quot; + event);</span></span><br><span class="line">            <span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">                mSaveIv.setEnabled(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (id == mContentTv.getId()) &#123;</span><br><span class="line">                    firstOnTv = <span class="literal">true</span>;</span><br><span class="line">                    originTvX = mContentTv.getX();</span><br><span class="line">                    originTvY = mContentTv.getY();</span><br><span class="line"><span class="comment">//                    Log.d(TAG, &quot;onTouch: 保存tv坐标 (&quot; + originTvX + &quot;, &quot; + originTvY + &quot;)&quot;);</span></span><br><span class="line">                &#125;</span><br><span class="line">                downX = event.getX();</span><br><span class="line">                downY = event.getY();</span><br><span class="line"><span class="comment">//                Log.d(TAG, &quot;onTouch: down: x,y [&quot; + x + &quot;, &quot; + y + &quot;]&quot;);</span></span><br><span class="line">                <span class="keyword">return</span> id != mContentTv.getId();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_MOVE) &#123;</span><br><span class="line"><span class="comment">//                Log.d(TAG, &quot;onTouch: move: x,y [&quot; + x + &quot;, &quot; + y + &quot;]&quot;);</span></span><br><span class="line">                <span class="keyword">if</span> (!firstOnTv) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 不移动tv，直接消耗掉这个操作</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">float</span> <span class="variable">dx</span> <span class="operator">=</span> x - downX;</span><br><span class="line">                <span class="type">float</span> <span class="variable">dy</span> <span class="operator">=</span> y - downY;</span><br><span class="line">                <span class="keyword">if</span> (Math.abs(dx) &gt; <span class="number">2</span> &amp;&amp; Math.abs(dy) &gt; <span class="number">2</span>) &#123;</span><br><span class="line">                    mContentTv.setX(originTvX + dx);</span><br><span class="line">                    mContentTv.setY(originTvY + dy);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_UP) &#123;</span><br><span class="line">                firstOnTv = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (mCanvasWid &gt; <span class="number">0</span> &amp;&amp; mCanvasHeight &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    mDraftContent.setTvLocationXRatio(mContentTv.getX() / mCanvasWid);</span><br><span class="line">                    mDraftContent.setTvLocationYRatio(mContentTv.getY() / mCanvasHeight);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="版本更新"><a href="#版本更新" class="headerlink" title="版本更新"></a>版本更新</h2><ul>
<li>2019-8-8 v1.1.1 版本更新<ul>
<li>解决了一些bug</li>
<li>UI调整，增加了抽屉的头图和欢迎文字</li>
</ul>
</li>
<li>2019-8-4 v1.1.0 版本更新</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-06-26T11:29:00.000Z" title="2019/6/26 19:29:00">2019-06-26</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:40.061Z" title="2021/6/18 17:38:40">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">6 分钟读完 (大约844个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/06/26/Android/Android-OkHttp_Retrofit_cancel_request/">Android OkHttp + Retrofit 取消请求的方法</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/06/26/Android/Android-OkHttp_Retrofit_cancel_request/">本文链接</a></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在某一个界面，用户发起了一个网络请求，因为某种原因用户在网络请求完成前离开了当前界面，比较好的做法是取消这个网络请求。对于OkHttp来说，具体是调用<code>Call</code>的<code>cancel</code>方法。</p>
<p>如何找到这一个网络请求并取消掉它呢？</p>
<p>操作大致分为3步。第一步，在建立请求时，给请求（request）添加标记；第二步，根据标记，找到请求；最后，取消这个请求。</p>
<h1 id="OkHttp中的tag"><a href="#OkHttp中的tag" class="headerlink" title="OkHttp中的tag"></a>OkHttp中的tag</h1><p>要取消一个请求，OkHttp中可以使用cancel方法，<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b74466039b84">参考</a>。</p>
<p>OkHttp的request对象有tag。可以根据tag来标示请求。<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46477195/how-to-cancel-the-request-using-okhttp">参考Stack Overflow</a>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Set tags for your requests when you build them:</span></span><br><span class="line"><span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder().</span><br><span class="line">url(url).tag(<span class="string">&quot;requestKey&quot;</span>).build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//When you want to cancel:</span></span><br><span class="line"><span class="comment">//A) go through the queued calls and cancel if the tag matches:</span></span><br><span class="line"><span class="keyword">for</span> (Call call : mHttpClient.dispatcher().queuedCalls()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (call.request().tag().equals(<span class="string">&quot;requestKey&quot;</span>))</span><br><span class="line">        call.cancel();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//B) go through the running calls and cancel if the tag matches:</span></span><br><span class="line"><span class="keyword">for</span> (Call call : mHttpClient.dispatcher().runningCalls()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (call.request().tag().equals(<span class="string">&quot;requestKey&quot;</span>))</span><br><span class="line">        call.cancel();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Retrofit中并没有显示地提供取消请求的接口。<a target="_blank" rel="noopener" href="https://github.com/square/retrofit/issues/2608">2018年时Retrofit仍未提供直接访问call对象的方法</a><br>那么如何找到目标网络请求呢？</p>
<h1 id="Retrofit加入自定义header"><a href="#Retrofit加入自定义header" class="headerlink" title="Retrofit加入自定义header"></a>Retrofit加入自定义header</h1><p>给每个与页面（Activity，Fragment）相关的request加入自定义header，<a target="_blank" rel="noopener" href="https://publicobject.com/2016/01/17/sneaking-data-into-an-okhttp-interceptor/">参考</a>。<br>给OkHttpClient添加拦截器。标记出页面的生存状态。如果页面销毁了，则取消对应的request。</p>
<p>以GithubOnAndroid项目为例，<a target="_blank" rel="noopener" href="https://github.com/RustFisher/GithubOnAndroid">https://github.com/RustFisher/GithubOnAndroid</a></p>
<h2 id="添加标记"><a href="#添加标记" class="headerlink" title="添加标记"></a>添加标记</h2><p>持有一个ConcurrentHashMap&lt;String, Boolean&gt;来标记页面存活状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, Boolean&gt; actLiveMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;(); <span class="comment">// 标记Activity是否存活</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">markPageAlive</span><span class="params">(String actName)</span> &#123;</span><br><span class="line">    actLiveMap.put(actName, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">markPageDestroy</span><span class="params">(String actName)</span> &#123;</span><br><span class="line">    actLiveMap.put(actName, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Activity中登记界面状态"><a href="#Activity中登记界面状态" class="headerlink" title="Activity中登记界面状态"></a>Activity中登记界面状态</h2><p>给当前Activity起名字。每个Activity的标记名必须唯一。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MY_ACT_NAME</span> <span class="operator">=</span> <span class="string">&quot;xxx1Activity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        NetworkCenter.markPageAlive(MY_ACT_NAME);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        NetworkCenter.markPageDestroy(MY_ACT_NAME);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="OkHttpClient添加拦截器"><a href="#OkHttpClient添加拦截器" class="headerlink" title="OkHttpClient添加拦截器"></a>OkHttpClient添加拦截器</h2><p>给OkHttpClient添加拦截器，在拦截器中检查页面的存活情况。<br>检查后，把这个自定义header移除掉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HEADER_ACT_NAME</span> <span class="operator">=</span> <span class="string">&quot;Activity-Name&quot;</span>; <span class="comment">// 标记Activity界面名字</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Interceptor</span> <span class="variable">lifeInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Interceptor</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> chain.request();</span><br><span class="line">            <span class="type">String</span> <span class="variable">actName</span> <span class="operator">=</span> request.header(HEADER_ACT_NAME);</span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(actName)) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;lifeInterceptor: actName: &quot;</span> + actName);</span><br><span class="line">                <span class="type">Boolean</span> <span class="variable">actLive</span> <span class="operator">=</span> actLiveMap.get(actName);</span><br><span class="line">                <span class="keyword">if</span> (actLive == <span class="literal">null</span> || !actLive) &#123;</span><br><span class="line">                    chain.call().cancel();</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;lifeInterceptor: 取消请求, actName: &quot;</span> + actName);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;lifeInterceptor: 发起请求, actName: &quot;</span> + actName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Request</span> <span class="variable">newRequest</span> <span class="operator">=</span> request.newBuilder().removeHeader(HEADER_ACT_NAME).build();</span><br><span class="line">            <span class="keyword">return</span> chain.proceed(newRequest);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">OkHttpClient = <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">        .readTimeout(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">        .connectTimeout(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">        .addInterceptor(lifeInterceptor) <span class="comment">// 添加拦截器</span></span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>
<p>call.cancel()后，不会再走Retrofit的subscribe方法。</p>
<h2 id="添加header"><a href="#添加header" class="headerlink" title="添加header"></a>添加header</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GET(&quot;users/&#123;owner&#125;/repos&quot;)</span></span><br><span class="line">Observable&lt;List&lt;UserRepo&gt;&gt; <span class="title function_">userRepo</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@Header(NetworkCenter.HEADER_ACT_NAME)</span> <span class="meta">@Nullable</span> String actName,</span></span><br><span class="line"><span class="params">        <span class="meta">@Path(&quot;owner&quot;)</span> String owner,</span></span><br><span class="line"><span class="params">        <span class="meta">@Query(&quot;sort&quot;)</span> String sortType)</span>;</span><br></pre></td></tr></table></figure>
<p>更多请参考：</p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2018/08/22/Android/Android-OkHttp_Retrofit_use_intro/">Android OkHttp + Retrofit 使用示例</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/06/26/Android/Android-OkHttp_Retrofit_cancel_request/">Android OkHttp + Retrofit 取消请求的方法</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file/">Android OkHttp + Retrofit 下载文件与进度监听</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file_partial/">Android OkHttp + Retrofit 断点续传</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-04-21T14:13:16.000Z" title="2019/4/21 22:13:16">2019-04-21</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:50.458Z" title="2021/6/18 17:38:50">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">10 分钟读完 (大约1431个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/04/21/Android/Android-SparseArray_src_code_note/">Android SparseArray 原理解析</a></p><div class="content"><h1 id="Android-SparseArray-原理解析"><a href="#Android-SparseArray-原理解析" class="headerlink" title="Android SparseArray 原理解析"></a>Android SparseArray 原理解析</h1><h2 id="什么是SparseArray？"><a href="#什么是SparseArray？" class="headerlink" title="什么是SparseArray？"></a>什么是SparseArray？</h2><p>SparseArray存储的是键值对，以int作为key，Object作为value。Sparse有稀疏、缺少的意思。SparseArray应用场景是相对稀少的数据，一般是几百以内。</p>
<h2 id="SparseArray采用的数据结构？"><a href="#SparseArray采用的数据结构？" class="headerlink" title="SparseArray采用的数据结构？"></a>SparseArray采用的数据结构？</h2><p>SparseArray并不像HashMap采用一维数组+单链表和二叉树结构，而是采用两个一维数组，一个是存储key(int类型),一个是存value object。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span>[] mKeys; <span class="comment">// 存储key</span></span><br><span class="line"><span class="keyword">private</span> Object[] mValues; <span class="comment">// 存储value对象</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> mSize; <span class="comment">// 记录存储键值对的数量</span></span><br></pre></td></tr></table></figure>
<p>mKeys和mValues读写时采用的下标是一一对应的。<br><img src="http://rustblogres.rustfisher.com/Android-SparseArray-mKeys-mValues.pngg" alt=""></p>
<h2 id="SparseArray默认容量多大？"><a href="#SparseArray默认容量多大？" class="headerlink" title="SparseArray默认容量多大？"></a>SparseArray默认容量多大？</h2><p>SparseArray在默认构造函数中指定其默认容量大小。默认为10</p>
<p>初始化后<code>mSize = 0</code>，实例化mKeys和mValues。</p>
<h2 id="SparseArray-get方法的流程分析"><a href="#SparseArray-get方法的流程分析" class="headerlink" title="SparseArray get方法的流程分析"></a>SparseArray get方法的流程分析</h2><p>输入一个int型的key，通过二分法查找匹配的下标。若没找到对应的下标，则返回null或用户指定的默认对象。</p>
<p>key是递增存放的。二分法查找下标时，可能会返回一个负值，此时表示在mKeys中没找到对应的键。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> get(key, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets the Object mapped from the specified key, or the specified Object</span></span><br><span class="line"><span class="comment"> * if no such mapping has been made.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> key, E valueIfKeyNotFound)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> ContainerHelpers.binarySearch(mKeys, mSize, key); <span class="comment">// 二分法查找下标</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i &lt; <span class="number">0</span> || mValues[i] == DELETED) &#123; </span><br><span class="line">    <span class="comment">// 找到的下标为负或当前位置元素以被删除，表明没找到</span></span><br><span class="line">        <span class="keyword">return</span> valueIfKeyNotFound;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (E) mValues[i]; <span class="comment">// 找到指定元素</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SparseArray-put方法的流程分析"><a href="#SparseArray-put方法的流程分析" class="headerlink" title="SparseArray put方法的流程分析"></a>SparseArray put方法的流程分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, E value)</span> &#123;</span><br><span class="line">       <span class="comment">// 二分法找到key的下标</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 代表当前已经存在key及其对应的值，直接替换value</span></span><br><span class="line">            mValues[i] = value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 表示当前并不存在key，则应添加新的键值对</span></span><br><span class="line">            <span class="comment">// i取反，得到要添加的数组位置下标。二叉查找返回的是key的“应当”存放的位置下标。</span></span><br><span class="line">            i = ~i;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (i &lt; mSize &amp;&amp; mValues[i] == DELETED) &#123;</span><br><span class="line">                <span class="comment">// 原来位置上的元素已经被删掉了，直接赋值替换</span></span><br><span class="line">                mKeys[i] = key;</span><br><span class="line">                mValues[i] = value;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (mGarbage &amp;&amp; mSize &gt;= mKeys.length) &#123;</span><br><span class="line">                <span class="comment">// 容量不足，进行回收操作</span></span><br><span class="line">                gc();</span><br><span class="line">                <span class="comment">// 重新查找目标下标</span></span><br><span class="line">                i = ~ContainerHelpers.binarySearch(mKeys, mSize, key);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 目标下标为i，将key添加进mKeys数组中</span></span><br><span class="line">            mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key);</span><br><span class="line">            <span class="comment">// 目标下标为i，将value插入mValues数组中</span></span><br><span class="line">            mValues = GrowingArrayUtils.insert(mValues, mSize, i, value);</span><br><span class="line">            <span class="comment">// 已存储的数据个数加1</span></span><br><span class="line">            mSize++;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GrowingArrayUtils.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T[] insert(T[] array, <span class="type">int</span> currentSize, <span class="type">int</span> index, T element) &#123;</span><br><span class="line">        <span class="keyword">assert</span> currentSize &lt;= array.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentSize + <span class="number">1</span> &lt;= array.length) &#123;</span><br><span class="line">            <span class="comment">// 当前数组容量充足，index开始的元素后移1位</span></span><br><span class="line">            System.arraycopy(array, index, array, index + <span class="number">1</span>, currentSize - index);</span><br><span class="line">            array[index] = element;</span><br><span class="line">            <span class="keyword">return</span> array;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 容量不足，先扩容生成新的数组newArray</span></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        T[] newArray = ArrayUtils.newUnpaddedArray((Class&lt;T&gt;)array.getClass().getComponentType(),</span><br><span class="line">                growSize(currentSize));</span><br><span class="line">        <span class="comment">// 将原来数组index之前的部分复制到新数组对象中</span></span><br><span class="line">        System.arraycopy(array, <span class="number">0</span>, newArray, <span class="number">0</span>, index);</span><br><span class="line">        newArray[index] = element; <span class="comment">// 插入元素</span></span><br><span class="line">        <span class="comment">// 将原数组index+1之后的元素拷贝到新数组中</span></span><br><span class="line">        System.arraycopy(array, index, newArray, index + <span class="number">1</span>, array.length - index);</span><br><span class="line">        <span class="keyword">return</span> newArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扩容计算规则，当前容量小于等于4则返回8；否则返回2倍的容量</span></span><br><span class="line"><span class="comment">// 扩容后最小容量是8</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">growSize</span><span class="params">(<span class="type">int</span> currentSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> currentSize &lt;= <span class="number">4</span> ? <span class="number">8</span> : currentSize * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="key下标的二叉查找方法分析"><a href="#key下标的二叉查找方法分析" class="headerlink" title="key下标的二叉查找方法分析"></a>key下标的二叉查找方法分析</h2><p>二叉查找方法<code>ContainerHelpers.binarySearch(int[] array, int size, int value)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">binarySearch</span><span class="params">(<span class="type">int</span>[] array, <span class="type">int</span> size, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">lo</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">hi</span> <span class="operator">=</span> size - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (lo &lt;= hi) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">midVal</span> <span class="operator">=</span> array[mid];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (midVal &lt; value) &#123;</span><br><span class="line">            lo = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (midVal &gt; value) &#123;</span><br><span class="line">            hi = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;  <span class="comment">// value found</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ~lo;  <span class="comment">// value not present</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果没有找到输入value对应的下标，则会返回一个按位取反后的值（一般是个负值）。</p>
<p>例如输入array是 [1,2,4,5]，size是4，value是3；那么会得到2的取反值。而<code>2</code>就是value的目标位置下标。</p>
<h2 id="SparseArray最大容量？每次扩容多少？"><a href="#SparseArray最大容量？每次扩容多少？" class="headerlink" title="SparseArray最大容量？每次扩容多少？"></a>SparseArray最大容量？每次扩容多少？</h2><p>SparseArray并不像HashMap一样定义有最大容量是多少，最大可以达到Integer.MAX_VALUE，可能会报oom。每次扩容时如果当前容量小于5则扩容是8，否则扩容为原容量的2倍。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">growSize</span><span class="params">(<span class="type">int</span> currentSize)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> currentSize &lt;= <span class="number">4</span> ? <span class="number">8</span> : currentSize * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SparseArray与HashMap的比较，应用场景是？"><a href="#SparseArray与HashMap的比较，应用场景是？" class="headerlink" title="SparseArray与HashMap的比较，应用场景是？"></a>SparseArray与HashMap的比较，应用场景是？</h2><ul>
<li>SparseArray采用的不是哈希算法，HashMap采用的是哈希算法。</li>
<li>SparseArray采用的是两个一维数组分别用于存储键和值，HashMap采用的是一维数组+单向链表或二叉树。</li>
<li>SparseArray key只能是int类型，而HashMap的key是Object。</li>
<li>SparseArray  key是有序存储（升序），而HashMap不是。</li>
<li>SparseArray 默认容量是10，而HashMap默认容量是16。</li>
<li>SparseArray 默认每次扩容是2倍于原来的容量，而HashMap默认每次扩容时是原容量*0.75倍</li>
<li>SparseArray value的存储被不像HashMap一样需要额外的需要一个实体类（Node）进行包装</li>
<li>SparseArray查找元素总体而言比HashMap要逊色，因为SparseArray查找是需要经过二分法的过程，而HashMap不存在冲突的情况其技术处的hash对应的下标直接就可以取到值。</li>
</ul>
<p>针对上面与HashMap的比较，采用SparseArray还是HashMap，建议根据如下需求选取：</p>
<ul>
<li>如果对内存要求比较高，而对查询效率没什么大的要求，可以是使用SparseArray</li>
<li>数量在百级别的SparseArray比HashMap有更好的优势</li>
<li>要求key是int类型的，因为HashMap会对int自定装箱变成Integer类型</li>
<li>要求key是有序的且是升序</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/30a2bfb202b4">https://www.jianshu.com/p/30a2bfb202b4</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-09-01T14:58:43.000Z" title="2018/9/1 22:58:43">2018-09-01</time>发表</span><span class="level-item"><time dateTime="2020-02-20T01:40:44.063Z" title="2020/2/20 09:40:44">2020-02-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">23 分钟读完 (大约3376个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/09/01/Dev-note/dev-note-app-learn/">「Learn」开发记录</a></p><div class="content"><p>开发App过程中遇到的一些问题和解决办法。临时记录一些解决方案。</p>
<h2 id="音频"><a href="#音频" class="headerlink" title="音频"></a>音频</h2><p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/19/Android/Android-MediaPlayer_intro/">Android MediaPlayer基础。</a><br><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/22/Android/Android-MediaPlayer_use_play_audio/">在线音频播放，使用MediaPlayer。</a><br><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/09/23/Android/Android-Media_download_stream_file/">下载在线音频到本地，使用URLConnection。</a></p>
<h2 id="自定义ViewGroup"><a href="#自定义ViewGroup" class="headerlink" title="自定义ViewGroup"></a>自定义ViewGroup</h2><p>继承自LinearLayout，自定义子View的排布方式。</p>
<h3 id="crash-ViewGroup-resetResolvedLayoutDirection"><a href="#crash-ViewGroup-resetResolvedLayoutDirection" class="headerlink" title="crash ViewGroup.resetResolvedLayoutDirection"></a>crash ViewGroup.resetResolvedLayoutDirection</h3><p>给LinearLayout addView的时候报错<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">E/AndroidRuntime:     at android.view.ViewGroup.resetResolvedLayoutDirection(ViewGroup.java:7291)</span><br><span class="line">    at android.view.ViewGroup.resetResolvedLayoutDirection(ViewGroup.java:7291)</span><br></pre></td></tr></table></figure></p>
<p>检查代码，发现addView的时候把LinearLayout自己添加进去了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">LinearLayout</span> <span class="variable">wordCube</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayout</span>(<span class="built_in">this</span>);</span><br><span class="line">wordCube.addView(wordCube, chTvParams);</span><br></pre></td></tr></table></figure></p>
<p>改成<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">LinearLayout</span> <span class="variable">wordCube</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayout</span>(<span class="built_in">this</span>);</span><br><span class="line">wordCube.addView(tv, chTvParams); <span class="comment">// 要加的是tv</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Bugly热更新"><a href="#Bugly热更新" class="headerlink" title="Bugly热更新"></a>Bugly热更新</h2><p>Bugly热更新方案集成了腾讯的tinker，自带了补丁包发布平台。</p>
<p>文档</p>
<p><a target="_blank" rel="noopener" href="https://bugly.qq.com/docs/user-guide/instruction-manual-android-hotfix/?v=20181014122344#_3">https://bugly.qq.com/docs/user-guide/instruction-manual-android-hotfix/?v=20181014122344#_3</a></p>
<p>tinker不支持热更新新增四大组件，不能修改Manifest文件。但是可以修改四大组件里面的逻辑。<br>可以修改layout文件和资源文件。</p>
<h2 id="Assets遍历文件"><a href="#Assets遍历文件" class="headerlink" title="Assets遍历文件"></a>Assets遍历文件</h2><p>assets里存放着四千多个文件，红米6A遍历一次要2秒多。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] list = context.getAssets().list(<span class="string">&quot;folder&quot;</span>); <span class="comment">// 执行这一句要两千多毫秒</span></span><br></pre></td></tr></table></figure>
<h2 id="语音识别方案"><a href="#语音识别方案" class="headerlink" title="语音识别方案"></a>语音识别方案</h2><p>主力方案为百度语音识别。</p>
<p>综合价格考虑，将科大讯飞的<a target="_blank" rel="noopener" href="https://www.xfyun.cn/services/voicedictation">语音听写</a>作为备用方案。</p>
<p>将百度语音识别与讯飞听写的SDK一起引入到App中。由后台控制用户使用哪一个语音引擎。</p>
<h2 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h2><p>项目采用的是mvvm架构。有2个页面要用到同一个数据源。把这个数据源单独抽出来，设计监听器。</p>
<p>原框架的下载文件功能有一个bug。如果下载时抛出了异常，也会调用success回调。<br>这里是在下载时记录目标文件的长度，在success回调中检查本地文件大小与这个长度是否一致。</p>
<h2 id="限速下载"><a href="#限速下载" class="headerlink" title="限速下载"></a>限速下载</h2><p>在io流那里进行延时操作。用Thread.sleep方法。<br>阻塞的是socket的操作。</p>
<h2 id="下载安装apk"><a href="#下载安装apk" class="headerlink" title="下载安装apk"></a>下载安装apk</h2><p>下载了新版本apk后，调用代码进行安装。根据手机系统版本的不同选择不同的安装方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title function_">installApk</span><span class="params">(Context context,String downloadApk)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW);</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(downloadApk);</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">apkUri</span> <span class="operator">=</span> FileProvider.getUriForFile(context, <span class="string">&quot;com.iNTGO.nndc.fileprovider&quot;</span>, file);</span><br><span class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION|</span><br><span class="line">                        Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br><span class="line">        intent.setDataAndType(apkUri, <span class="string">&quot;application/vnd.android.package-archive&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.fromFile(file);</span><br><span class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        intent.setDataAndType(uri, <span class="string">&quot;application/vnd.android.package-archive&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    context.startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于小米4c android 5.1.1（API 22），如果把apk放在app内部存储，packageInstaller是无法安装的。要把apk放在公共存储中才能安装。</p>
<h2 id="修改Android系统镜像（img）"><a href="#修改Android系统镜像（img）" class="headerlink" title="修改Android系统镜像（img）"></a>修改Android系统镜像（img）</h2><p>装一个VMware Workstation Pro，下载一个Ubuntu 16的镜像（iso）。用的是阿里云的资源，比较快。<br>一系列的mount，打包后，刷机一直不成功。找到个ROM助手，尝试一下。修改了system.img后，线刷进去，卡米（卡在开机的MI logo界面）。<br>查一下发现，是selinux处于enforcing状态，没法装。小米4c用的是MIUI8，商家说没法root。MiUI7可以root。<br>还没找到非root情况下关闭selinux的方法。</p>
<h2 id="动画效果"><a href="#动画效果" class="headerlink" title="动画效果"></a>动画效果</h2><p>加一些动效会让界面更加生动有活力。</p>
<h3 id="属性动画-星星飞行"><a href="#属性动画-星星飞行" class="headerlink" title="属性动画 - 星星飞行"></a>属性动画 - 星星飞行</h3><p>控制星星飞入，定位，飞出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">flyInTime</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">stayTime</span> <span class="operator">=</span> <span class="number">520</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">flyOutTime</span> <span class="operator">=</span> <span class="number">250</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">totalTime</span> <span class="operator">=</span> flyInTime + stayTime + flyOutTime;</span><br><span class="line">        binding.starIv.setX(inX);</span><br><span class="line">        binding.starIv.setY(yStay);</span><br><span class="line">        binding.starIv.setVisibility(View.VISIBLE);</span><br><span class="line">        setStarIvSize(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ValueAnimator</span> <span class="variable">animator</span> <span class="operator">=</span> ValueAnimator.ofInt(<span class="number">1</span>, totalTime);</span><br><span class="line">        animator.setDuration(totalTime);</span><br><span class="line">        animator.setInterpolator(<span class="keyword">new</span> <span class="title class_">AccelerateInterpolator</span>());</span><br><span class="line">        animator.addUpdateListener(<span class="keyword">new</span> <span class="title class_">ValueAnimator</span>.AnimatorUpdateListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationUpdate</span><span class="params">(ValueAnimator valueAnimator)</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> (<span class="type">int</span>) valueAnimator.getAnimatedValue();</span><br><span class="line">                <span class="type">ImageView</span> <span class="variable">starIv</span> <span class="operator">=</span> binding.starIv;</span><br><span class="line">                <span class="keyword">if</span> (value &lt; flyInTime) &#123;</span><br><span class="line">                    <span class="type">float</span> <span class="variable">inProgress</span> <span class="operator">=</span> value / (<span class="number">1.0f</span> * flyInTime);</span><br><span class="line">                    <span class="type">float</span> <span class="variable">x</span> <span class="operator">=</span> inProgress * (xStay - inX) + inX;</span><br><span class="line">                    <span class="type">float</span> y;</span><br><span class="line">                    <span class="keyword">if</span> (value &lt; flyInTime / <span class="number">2</span>) &#123;</span><br><span class="line">                        y = yStay + <span class="number">20</span> - inProgress * <span class="number">60</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        y = yStay - <span class="number">20</span> + inProgress * <span class="number">60</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    starIv.setX(x);</span><br><span class="line">                    starIv.setY(y);</span><br><span class="line">                    setStarIvSize((<span class="type">int</span>) (mStarIvOriginWid * (inProgress)), (<span class="type">int</span>) (mStarIvOriginHeight * (inProgress)));</span><br><span class="line"><span class="comment">//                    Log.d(TAG, &quot;onAnimationUpdate: value: &quot; + value + &quot;, progress: &quot; + inProgress + &quot;, x: &quot; + x);</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &lt; flyInTime + stayTime) &#123;</span><br><span class="line">                    starIv.setX(xStay);</span><br><span class="line">                    starIv.setY(yStay);</span><br><span class="line">                    setStarIvSize(mStarIvOriginWid, mStarIvOriginHeight);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (valueAnimator.isRunning()) &#123;</span><br><span class="line">                        <span class="type">float</span> <span class="variable">progress</span> <span class="operator">=</span> (value - flyInTime - stayTime) / (<span class="number">1.0f</span> * flyOutTime);</span><br><span class="line">                        starIv.setX(xStay + (progress * Math.abs(endX - xStay)));</span><br><span class="line">                        starIv.setY(yStay - (progress * Math.abs(endY - yStay)));</span><br><span class="line">                        setStarIvSize((<span class="type">int</span>) (mStarIvOriginWid * (<span class="number">1</span> - progress)), (<span class="type">int</span>) (mStarIvOriginHeight * (<span class="number">1</span> - progress)));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (value &gt;= totalTime - <span class="number">10</span>) &#123;</span><br><span class="line">                    binding.starIv.setVisibility(View.GONE);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        animator.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 改变星星ImageView的大小，LayoutParams不能弄错了</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setStarIvSize</span><span class="params">(<span class="type">int</span> wid, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        RelativeLayout.<span class="type">LayoutParams</span> <span class="variable">lp</span> <span class="operator">=</span> (RelativeLayout.LayoutParams) binding.starIv.getLayoutParams();</span><br><span class="line">        lp.width = wid;</span><br><span class="line">        lp.height = height;</span><br><span class="line">        binding.starIv.setLayoutParams(lp);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如果一个View在LinearLayout里，它的坐标没有那么容易获取。</p>
<p>下面的代码获取到的坐标是[0,0]。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">imageView.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] location = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">2</span>];</span><br><span class="line">        imageView.getLocationOnScreen(location);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/transitions/custom-transitions">创建自定义过渡动画 - Google</a><br><a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/animation/layout.html">自动为布局更新添加动画 - Google</a></p>
<h2 id="退出App"><a href="#退出App" class="headerlink" title="退出App"></a>退出App</h2><p>在登录界面，点击返回键即退出整个App。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">mExitApp</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBackPressed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onBackPressed();</span><br><span class="line">        mExitApp = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        <span class="keyword">if</span> (mExitApp) &#123;</span><br><span class="line">            System.exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="crash"><a href="#crash" class="headerlink" title="crash"></a>crash</h2><p>为了提高程序的健壮性，很多时候并不能过于相信服务器返回的结果。该加判空就判空。<br>如果服务器返回空的数据或者字段，要有对应的措施。</p>
<h3 id="gc超时"><a href="#gc超时" class="headerlink" title="gc超时"></a>gc超时</h3><p>该异常表示调用超时。</p>
<p>解决方案：一般是系统在gc时，调用对象的finalize超时导致</p>
<p>解决办法：<br>1.检查分析finalize的实现为什么耗时较高，修复它；<br>2.检查日志查看GC是否过于频繁，导致超时，减少内容开销，防止内存泄露。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">android.content.res.XmlBlock$Parser.finalize() timed out after 10 seconds</span><br><span class="line"></span><br><span class="line">android.content.res.AssetManager.xmlBlockGone(AssetManager.java:500)</span><br><span class="line"></span><br><span class="line">android.content.res.AssetManager.xmlBlockGone(AssetManager.java:500)</span><br><span class="line">android.content.res.XmlBlock.decOpenCountLocked(XmlBlock.java:63)</span><br><span class="line">android.content.res.XmlBlock.access$1600(XmlBlock.java:34)</span><br><span class="line">android.content.res.XmlBlock$Parser.close(XmlBlock.java:448)</span><br><span class="line">android.content.res.XmlBlock$Parser.finalize(XmlBlock.java:454)</span><br><span class="line">java.lang.Daemons$FinalizerDaemon.doFinalize(Daemons.java:191)</span><br><span class="line">java.lang.Daemons$FinalizerDaemon.run(Daemons.java:174)</span><br><span class="line">java.lang.Thread.run(Thread.java:818)</span><br></pre></td></tr></table></figure>
<h3 id="RuntimeException-Cannot-create-an-instance-of-class"><a href="#RuntimeException-Cannot-create-an-instance-of-class" class="headerlink" title="RuntimeException: Cannot create an instance of class"></a>RuntimeException: Cannot create an instance of class</h3><p>使用了MVVM的框架，创建viewModel时报错。检查发现忘记复写方法<code>initViewModel</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> MyViewModel <span class="title function_">initViewModel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MyAppViewModelFactory</span> <span class="variable">factory</span> <span class="operator">=</span> MyAppViewModelFactory.getInstance(getApplication());</span><br><span class="line">    <span class="keyword">return</span> ViewModelProviders.of(<span class="built_in">this</span>, factory).get(MyViewModel.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="ANR"><a href="#ANR" class="headerlink" title="ANR"></a>ANR</h2><h3 id="死循环导致的ANR"><a href="#死循环导致的ANR" class="headerlink" title="死循环导致的ANR"></a>死循环导致的ANR</h3><p>之前业务逻辑中，有一个随机添加不重复字符串的功能。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (needCheckList.size() &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="type">Random</span> <span class="variable">rd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">word</span> <span class="operator">=</span> wordList.get(rd.nextInt(wordList.size()));</span><br><span class="line">    <span class="keyword">if</span>(!needCheckList.contains(word)) &#123;</span><br><span class="line">        needCheckList.add(word);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// .....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这段代码的效率不高。伪随机数不能保证高效地不重复地取到新的下标。<br>在某些性能较差的手机上，陷入多次循环后有可能导致anr。 anr message 表明此时CPU占用率超过100%。<br>我们使用<code>Collections.shuffle(wordList);</code>来代替伪随机数，也能实现随机取出字符串的效果。提高健壮性。</p>
<h2 id="gradle"><a href="#gradle" class="headerlink" title="gradle"></a>gradle</h2><p>想在Terminal里使用gradlew命令，还得先在电脑上安装jdk。<br>现在（2019-11-18）想在官网下载个jdk，还得登录oracle账号。网速很慢，去别的地方下载jdk-8u181-windows-x64。</p>
<h3 id="多渠道自动打包"><a href="#多渠道自动打包" class="headerlink" title="多渠道自动打包"></a>多渠道自动打包</h3><p>假设我们有很多种渠道，每个渠道的<code>manifestPlaceholders</code>的内容都不同。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">productFlavors &#123;</span><br><span class="line">    xxx &#123;</span><br><span class="line">        manifestPlaceholders = [XX_ID  : <span class="string">&quot;123&quot;</span>,</span><br><span class="line">                                XX_KEY : <span class="string">&quot;key_key&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之前渠道少的时候，可以点击gradle task一个个来打包。<br>现在渠道种类多了（比如二十多个），再一个个点击就很累。想要一键打包或者一行命令打包，有什么成熟好用的多渠道打包方式呢？<br>我们尝试了<a target="_blank" rel="noopener" href="https://github.com/Meituan-Dianping/walle">美团点评的walle</a>，号称是<code>Android Signature V2 Scheme签名下的新一代渠道包打包神器</code>。<br>试着接入walle的姿势可能不对，打包不成功。此时看到有人说<a target="_blank" rel="noopener" href="https://github.com/Meituan-Dianping/walle/issues/312">不支持多渠道不同的包名和配置manifestPlaceholders</a>，暂时先不使用walle。</p>
<p>已经使用了Bugly，有很多形如<code>assembleXxxRelease</code>的任务。<br>我们可以在终端命令行里执行gradlew命令来打包。<br>Windows环境下就是<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradlew assembleXxxRelease</span><br></pre></td></tr></table></figure></p>
<p>那么写一个bat脚本，把这几十个渠道包按顺序一个个打包出来。<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradlew assembleXxxRelease &amp;&amp; gradlew assembleYyyRelease &amp;&amp; gradlew assembleZzzRelease</span><br></pre></td></tr></table></figure><br>这个方法非常“暴力”，仅仅是替代了手动执行的过程。</p>
<h2 id="框架"><a href="#框架" class="headerlink" title="框架"></a>框架</h2><h3 id="BindingCommand-问题"><a href="#BindingCommand-问题" class="headerlink" title="BindingCommand 问题"></a>BindingCommand 问题</h3><p>由于历史原因，App使用了一个MVVM框架。layout中可以绑定BindingCommand。<br>不知道是不是开发姿势不对，快速点击某个按钮时，对应的<code>BindingCommand</code>并不能立即响应。连续点击会错过点击事件。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">BindingCommand</span> <span class="variable">myCommand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BindingCommand</span>(<span class="keyword">new</span> <span class="title class_">BindingAction</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// my logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>而换用<code>setOnClickListener</code>可以立刻监听到每一个点击事件。<br>为了追求响应速度，在某些地方采用设置监听器的方式了。</p>
<h2 id="界面UI"><a href="#界面UI" class="headerlink" title="界面UI"></a>界面UI</h2><h3 id="android-跑马灯重复抖动的解决方法"><a href="#android-跑马灯重复抖动的解决方法" class="headerlink" title="android 跑马灯重复抖动的解决方法"></a>android 跑马灯重复抖动的解决方法</h3><p>解决的方法，在跑马灯控件外层，再嵌套一个布局控件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_weight</span>=<span class="string">&quot;55&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;horizontal&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.rustfisher.view.MarqueeTextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/tv_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:ellipsize</span>=<span class="string">&quot;marquee&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:focusable</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:focusableInTouchMode</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:maxWidth</span>=<span class="string">&quot;150dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:singleLine</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">&quot;10sp&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="EditText划词选词弹出菜单"><a href="#EditText划词选词弹出菜单" class="headerlink" title="EditText划词选词弹出菜单"></a>EditText划词选词弹出菜单</h3><p>et可选，弹出了系统的菜单。</p>
<p>et不可选，弹出了自定义的菜单。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">registerForContextMenu(mEt);</span><br><span class="line">mEt.setOnCreateContextMenuListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnCreateContextMenuListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreateContextMenu</span><span class="params">(<span class="keyword">final</span> ContextMenu menu, View v, ContextMenu.ContextMenuInfo menuInfo)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onCreateContextMenu: selected: &quot;</span> + mEt.getSelectionStart() + <span class="string">&quot;, &quot;</span> + mEt.getSelectionEnd()); <span class="comment">// 都是0</span></span><br><span class="line">        getMenuInflater().inflate(R.menu.et_menu, menu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>et可选，弹出了自定义菜单。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">mEt.setCustomSelectionActionModeCallback(genActionModeCallback1());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ActionMode.Callback <span class="title function_">genActionModeCallback1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ActionMode</span>.Callback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onCreateActionMode</span><span class="params">(ActionMode mode, Menu menu)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onCreateActionMode:&quot;</span></span><br><span class="line">                    + <span class="string">&quot; selected: &quot;</span> + mEt.getSelectionStart() + <span class="string">&quot;, &quot;</span> + mEt.getSelectionEnd());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onPrepareActionMode</span><span class="params">(ActionMode mode, Menu menu)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onPrepareActionMode: &quot;</span> + <span class="string">&quot; selected: &quot;</span> + mEt.getSelectionStart() + <span class="string">&quot;, &quot;</span> + mEt.getSelectionEnd());</span><br><span class="line">            menu.clear();</span><br><span class="line">            mode.getMenuInflater().inflate(R.menu.et_menu, menu);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onActionItemClicked</span><span class="params">(ActionMode mode, MenuItem item)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onActionItemClicked: &quot;</span> + <span class="string">&quot; selected: &quot;</span> + mEt.getSelectionStart() + <span class="string">&quot;, &quot;</span> + mEt.getSelectionEnd());</span><br><span class="line">            mode.finish();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroyActionMode</span><span class="params">(ActionMode mode)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onDestroyActionMode: &quot;</span> + <span class="string">&quot; selected: &quot;</span> + mEt.getSelectionStart() + <span class="string">&quot;, &quot;</span> + mEt.getSelectionEnd());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>1+手机可以用，但小米手机无法弹出自定义菜单。此法不能通用。</p>
<h3 id="竖直的进度条"><a href="#竖直的进度条" class="headerlink" title="竖直的进度条"></a>竖直的进度条</h3><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3926395/android-set-a-progressbar-to-be-a-vertical-bar-instead-of-horizontal">https://stackoverflow.com/questions/3926395/android-set-a-progressbar-to-be-a-vertical-bar-instead-of-horizontal</a></p>
<h3 id="获取statusbar高度"><a href="#获取statusbar高度" class="headerlink" title="获取statusbar高度"></a>获取statusbar高度</h3><p>在Activity中获取DecorView。通过DecorView的位置来判断statusBar的高度。Activity别设置成全屏的就好。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getStatusBarHeight</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Rect</span> <span class="variable">rectangle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Rect</span>();</span><br><span class="line">    <span class="type">Window</span> <span class="variable">window</span> <span class="operator">=</span> getWindow();</span><br><span class="line">    window.getDecorView().getWindowVisibleDisplayFrame(rectangle);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;getStatusBarHeight: &quot;</span> + rectangle.top);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让statusbar不占位置，并设置成透明背景。<br>底下的虚拟系统按键（Home，back，menu）不能受影响。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;AppTheme&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;Theme.AppCompat.DayNight.NoActionBar&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowTranslucentStatus&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowTranslucentNavigation&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:statusBarColor&quot;</span>&gt;</span>@android:color/transparent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="drawable-vector-assets"><a href="#drawable-vector-assets" class="headerlink" title="drawable - vector assets"></a>drawable - vector assets</h3><p>通过引入svg文件得到的drawable，layout中直接设置src使用drawable。小米4c和红米6A手机屏幕上图像错乱。<br>改变ImageView的大小不起作用。清楚as缓存也不起作用。</p>
<p>如果不在layout中设置，而是在代码中<code>setImageResource</code>则显示正常。</p>
<h3 id="设计界面"><a href="#设计界面" class="headerlink" title="设计界面"></a>设计界面</h3><p>去花瓣网上找灵感。<br>比如设计列表界面，可以给每个项目增加一个小背景。可以是颜色，可以是背景图。</p>
<h2 id="网络请求"><a href="#网络请求" class="headerlink" title="网络请求"></a>网络请求</h2><h3 id="设计接口获取数据"><a href="#设计接口获取数据" class="headerlink" title="设计接口获取数据"></a>设计接口获取数据</h3><p>项目里用OKHttp框架来进行网络请求。返回结果被转化成对象<code>Entity</code>。<br>同一个服务器返回里装有相同结构的A,B,C对象。它们的名字不一样，GsonFormat的时候是分开成3个类的。<br>为了让代码更简洁，把这3个对象进行抽象。<br>一开始是做了一个抽象类，让这3个类继承。但是OKHttp那边会报错。</p>
<p>然后改用了接口的方式。设计的接口里有一些通用方法。在<code>Entity</code>里让那3个类都实现这个接口，然后在方法中返回我们要的数据。</p>
<h2 id="AsyncTask"><a href="#AsyncTask" class="headerlink" title="AsyncTask"></a>AsyncTask</h2><h3 id="资源分配"><a href="#资源分配" class="headerlink" title="资源分配"></a>资源分配</h3><p>AsyncTask背后有一个线程池。调用了<code>execute()</code>并不能保证任务立刻被执行。<br>换用Thread。</p>
<h2 id="App设置"><a href="#App设置" class="headerlink" title="App设置"></a>App设置</h2><h3 id="分屏设置"><a href="#分屏设置" class="headerlink" title="分屏设置"></a>分屏设置</h3><p>如果不进行设置，默认是允许分屏的。这里我们把分屏给禁止。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:networkSecurityConfig=&quot;@xml/network_security_config&quot;</span><br><span class="line">android:resizeableActivity=&quot;false&quot;</span><br></pre></td></tr></table></figure></p>
<p>添加在application标签里。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.app.MyApplication&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:networkSecurityConfig</span>=<span class="string">&quot;@xml/network_security_config&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="adb"><a href="#adb" class="headerlink" title="adb"></a>adb</h2><h3 id="系统App"><a href="#系统App" class="headerlink" title="系统App"></a>系统App</h3><p>把apk放进root后的手机里，当做是系统app。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">F:\<span class="title">IE</span>\<span class="title">MyApp0826</span>\<span class="title">app</span>\<span class="title">libs</span>&gt;<span class="title">adb</span> <span class="title">root</span></span></span><br><span class="line"><span class="function"><span class="title">F</span>:\<span class="title">IE</span>\<span class="title">MyApp0826</span>\<span class="title">app</span>\<span class="title">libs</span>&gt;<span class="title">adb</span> <span class="title">remount</span></span></span><br><span class="line"><span class="function"><span class="title">remount</span> <span class="title">succeeded</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">F</span>:\<span class="title">IE</span>\<span class="title">MyApp0826</span>\<span class="title">app</span>\<span class="title">libs</span>&gt;<span class="title">adb</span> <span class="title">shell</span> <span class="title">mkdir</span> /<span class="title">system</span>/<span class="title">priv</span>-<span class="title">app</span>/<span class="title">MyApp</span></span></span><br><span class="line"><span class="function"><span class="title">F</span>:\<span class="title">IE</span>\<span class="title">MyApp0826</span>\<span class="title">app</span>\<span class="title">libs</span>&gt;<span class="title">adb</span> <span class="title">shell</span> <span class="title">chmod</span> 755 /<span class="title">system</span>/<span class="title">priv</span>-<span class="title">app</span>/<span class="title">MyApp</span></span></span><br><span class="line"><span class="function"><span class="title">F</span>:\<span class="title">IE</span>\<span class="title">MyApp0826</span>\<span class="title">app</span>\<span class="title">libs</span>&gt;<span class="title">adb</span> <span class="title">shell</span> <span class="title">chmod</span> 644 /<span class="title">system</span>/<span class="title">priv</span>-<span class="title">app</span>/<span class="title">MyApp</span>/<span class="title">MyApp.apk</span></span></span><br><span class="line"><span class="function"><span class="title">F</span>:\<span class="title">IE</span>\<span class="title">MyApp0826</span>\<span class="title">app</span>\<span class="title">libs</span>&gt;<span class="title">adb</span> <span class="title">shell</span> <span class="title">chmod</span> 755 /<span class="title">system</span>/<span class="title">priv</span>-<span class="title">app</span>/<span class="title">MyApp</span>/<span class="title">lib</span></span></span><br><span class="line"><span class="function"><span class="title">F</span>:\<span class="title">IE</span>\<span class="title">MyApp0826</span>\<span class="title">app</span>\<span class="title">libs</span>&gt;<span class="title">adb</span> <span class="title">shell</span> <span class="title">chmod</span> 755 /<span class="title">system</span>/<span class="title">priv</span>-<span class="title">app</span>/<span class="title">MyApp</span>/<span class="title">lib</span>/<span class="title">arm</span></span></span><br><span class="line"><span class="function"><span class="title">F</span>:\<span class="title">IE</span>\<span class="title">MyApp0826</span>\<span class="title">app</span>\<span class="title">libs</span>&gt;<span class="title">adb</span> <span class="title">shell</span> <span class="title">sync</span></span></span><br><span class="line"><span class="function"><span class="title">F</span>:\<span class="title">IE</span>\<span class="title">MyApp0826</span>\<span class="title">app</span>\<span class="title">libs</span>&gt;<span class="title">adb</span> <span class="title">shell</span> <span class="title">reboot</span></span></span><br></pre></td></tr></table></figure>
<h3 id="范围内随机数"><a href="#范围内随机数" class="headerlink" title="范围内随机数"></a>范围内随机数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(seed);</span><br><span class="line"><span class="type">int</span> <span class="variable">random_integer</span> <span class="operator">=</span> rand.nextInt(upperbound-lowerbound) + lowerbound;</span><br></pre></td></tr></table></figure>
<h2 id="内存泄漏"><a href="#内存泄漏" class="headerlink" title="内存泄漏"></a>内存泄漏</h2><h3 id="Handler与单例"><a href="#Handler与单例" class="headerlink" title="Handler与单例"></a>Handler与单例</h3><p>单例模式加上Handler。有人把handler直接交给单例。长生命周期的一直持有短生命周期的对象，没法回收造成内存泄漏。</p>
<p>viewModel中有一个handler，而handler被单例持有。handler是直接实例化的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(<span class="meta">@NonNull</span> Message msg)</span> &#123;</span><br><span class="line">        handleResult(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>handleResult方法中使用了viewModel的数据列表。</p>
<p>这样在新建一个viewModel的时候，单例持有旧的handler，handler持有的还是旧的那个数据列表。<br>内存中就有2份不一样的数据列表。</p>
<p>修复方案：<br>首先不能让单例持有这个handler。<br>其次退出viewModel的时候，把handler中的消息清空。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-08-21T17:10:01.000Z" title="2018/8/22 01:10:01">2018-08-22</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:47.745Z" title="2021/6/18 17:38:47">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">8 分钟读完 (大约1163个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/08/22/Android/Android-OkHttp_Retrofit_use_intro/">Android OkHttp + Retrofit 使用示例</a></p><div class="content"><p><a target="_blank" rel="noopener" href="https://rustfisher.com/2018/08/22/Android/Android-OkHttp_Retrofit_use_intro/">本文链接</a></p>
<p>OkHttp + Retrofit使用示例。从引入依赖，编写接口，到发起网络请求。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/square/okhttp">https://github.com/square/okhttp</a></p>
<h1 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h1><h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><p>引入依赖，使用Retrofit2。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">implementation &#x27;com.squareup.retrofit2:retrofit:2.1.0&#x27;</span><br><span class="line">implementation &#x27;com.squareup.retrofit2:converter-gson:2.1.0&#x27;</span><br><span class="line">implementation &#x27;com.squareup.retrofit2:adapter-rxjava:2.1.0&#x27;</span><br></pre></td></tr></table></figure></p>
<h2 id="查询-Query"><a href="#查询-Query" class="headerlink" title="查询 @Query"></a>查询 <code>@Query</code></h2><p>例如URL <code>https://base_url/backend-service/config?env=dev</code>，问号后面属于查询内容。<br>不论是GET或POST，都要用<code>@Query</code>这个注解。否则会报异常。</p>
<h2 id="URL填充与拼接"><a href="#URL填充与拼接" class="headerlink" title="URL填充与拼接"></a>URL填充与拼接</h2><p>单纯URL填充可以用<code>@Path</code>注解。<br>例如下面这个post请求。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@POST(&quot;user-service/user/&#123;uid&#125;/token/refresh&quot;)</span></span><br><span class="line">Call&lt;RefreshTokenResp&gt; <span class="title function_">refreshToken</span><span class="params">(<span class="meta">@Path(&quot;uid&quot;)</span> String uid, <span class="meta">@Query(&quot;token&quot;)</span> String token)</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="GET带有查询的参数"><a href="#GET带有查询的参数" class="headerlink" title="GET带有查询的参数"></a>GET带有查询的参数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CfgService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GET(&quot;backend-service/config&quot;)</span></span><br><span class="line">    Call&lt;ServerCfgResp&gt; <span class="title function_">getServerCfg</span><span class="params">(<span class="meta">@Query(&quot;env&quot;)</span> String env)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="POST，带有查询的参数和body"><a href="#POST，带有查询的参数和body" class="headerlink" title="POST，带有查询的参数和body"></a>POST，带有查询的参数和body</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@POST(&quot;user-service/login&quot;)</span></span><br><span class="line">    Call&lt;LoginResp&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@Query(&quot;lenovoST&quot;)</span> String token, <span class="meta">@Query(&quot;realm&quot;)</span> String realm,</span></span><br><span class="line"><span class="params">                            <span class="meta">@Body</span> RequestBody body)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@POST(&quot;user-service/logout&quot;)</span></span><br><span class="line">    Call&lt;CommonEntity&gt; <span class="title function_">logout</span><span class="params">(<span class="meta">@Query(&quot;token&quot;)</span> String token, <span class="meta">@Body</span> RequestBody body)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的时候要创建<code>RequestBody</code>；先调查好后台接受的body类型。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;system&quot;</span>, <span class="string">&quot;Android&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;phoneBrand&quot;</span>, Build.BRAND);</span><br><span class="line">map.put(<span class="string">&quot;modelNum&quot;</span>, Build.MODEL);</span><br><span class="line"><span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">bodyJson</span> <span class="operator">=</span> gson.toJson(map);</span><br><span class="line"><span class="type">RequestBody</span> <span class="variable">requestBody</span> <span class="operator">=</span> RequestBody.create(MediaType.parse(<span class="string">&quot;application/json&quot;</span>), bodyJson);</span><br></pre></td></tr></table></figure></p>
<p>初始化<code>OkHttpClient</code>；这里信任所有的SSL证书（正式环境不建议这么做）。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CfgService cfgService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SSLSocketFactory</span> <span class="variable">sslSocketFactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sslSocketFactory = SSLUtils.getSSLSocketFactory();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        OkHttpClient.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder();</span><br><span class="line">        <span class="keyword">if</span> (sslSocketFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;sslSocketFactory != null&quot;</span>);</span><br><span class="line">            builder.sslSocketFactory(sslSocketFactory);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;sslSocketFactory == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        builder.hostnameVerifier(<span class="keyword">new</span> <span class="title class_">HostnameVerifier</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String hostname, SSLSession session)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 强制返回true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">OkHttpClient</span> <span class="variable">lenClient</span> <span class="operator">=</span> builder.build();</span><br><span class="line">        <span class="type">Retrofit</span> <span class="variable">retrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">                .baseUrl(ServerCfg.HOST_URL)</span><br><span class="line">                .client(lenClient)</span><br><span class="line">                .addCallAdapterFactory(RxJavaCallAdapterFactory.create())</span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                .build();</span><br><span class="line">        cfgService = retrofit.create(CfgService.class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="调用网络请求"><a href="#调用网络请求" class="headerlink" title="调用网络请求"></a>调用网络请求</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mNetworkManager.getUserApi().login(mLenovoToken, ServerCfg.RID, requestBody).enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>&lt;LoginResp&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call&lt;LoginResp&gt; call, <span class="keyword">final</span> Response&lt;LoginResp&gt; response)</span> &#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call&lt;LoginResp&gt; call, <span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="信任所有服务器的ssl"><a href="#信任所有服务器的ssl" class="headerlink" title="信任所有服务器的ssl"></a>信任所有服务器的ssl</h2><p><strong>并不推荐这么做</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSLUtils</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 信任所有服务器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SSLSocketFactory <span class="title function_">getSSLSocketFactory</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SSLSocketFactory</span> <span class="variable">sslSocketFactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> SSLContext.getInstance(<span class="string">&quot;TLS&quot;</span>);</span><br><span class="line">        sslContext.init(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">TrustManager</span>[]&#123;createTrustAllManager()&#125;, <span class="keyword">new</span> <span class="title class_">SecureRandom</span>());</span><br><span class="line">        sslSocketFactory = sslContext.getSocketFactory();</span><br><span class="line">        <span class="keyword">return</span> sslSocketFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> X509TrustManager <span class="title function_">createTrustAllManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">X509TrustManager</span> <span class="variable">tm</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tm = <span class="keyword">new</span> <span class="title class_">X509TrustManager</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkClientTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span></span><br><span class="line">                        <span class="keyword">throws</span> CertificateException &#123;</span><br><span class="line">                    <span class="comment">//do nothing，接受任意客户端证书</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkServerTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span></span><br><span class="line">                        <span class="keyword">throws</span> CertificateException &#123;</span><br><span class="line">                    <span class="comment">//do nothing，接受任意服务端证书</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">X509Certificate</span>[<span class="number">0</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="service使用io-reactivex-Observable"><a href="#service使用io-reactivex-Observable" class="headerlink" title="service使用io.reactivex.Observable"></a>service使用io.reactivex.Observable</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.reactivex.Observable; <span class="comment">// 这个是rx2的包</span></span><br><span class="line"><span class="comment">// ---</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户反馈接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 用户输入的反馈内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@POST(&quot;feedbackAction&quot;)</span></span><br><span class="line">    Observable&lt;UserFeedback&gt; <span class="title function_">userFeedback</span><span class="params">(<span class="meta">@Query(&quot;appVersion&quot;)</span> String appVersion,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Query(&quot;phoneModel&quot;)</span> String phoneModel,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Query(&quot;phoneOsVersion&quot;)</span> String osVersion,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Query(&quot;submitContent&quot;)</span> String content)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="示例1-Retrofit2，RxJava2"><a href="#示例1-Retrofit2，RxJava2" class="headerlink" title="示例1 - Retrofit2，RxJava2"></a>示例1 - Retrofit2，RxJava2</h1><h2 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">implementation &#x27;com.squareup.retrofit2:retrofit:2.5.0&#x27;</span><br><span class="line">implementation &#x27;com.squareup.retrofit2:converter-gson:2.5.0&#x27;</span><br><span class="line">implementation &#x27;com.squareup.retrofit2:adapter-rxjava2:2.3.0&#x27;</span><br><span class="line">implementation &#x27;io.reactivex.rxjava2:rxandroid:2.1.1&#x27;</span><br><span class="line">implementation &#x27;io.reactivex.rxjava2:rxjava:2.2.8&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="定义interface"><a href="#定义interface" class="headerlink" title="定义interface"></a>定义interface</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.reactivex.Observable;</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.Field;</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.FieldMap;</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.FormUrlEncoded;</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.GET;</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.POST;</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.Query;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RustDrone后台接口</span></span><br><span class="line"><span class="comment"> * Created on 2019-5-17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RustDroneCommonService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户反馈接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 用户输入的反馈内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@FormUrlEncoded</span></span><br><span class="line">    <span class="meta">@POST(&quot;feedbackAction&quot;)</span></span><br><span class="line">    Observable&lt;FeedbackResp&gt; <span class="title function_">userFeedback</span><span class="params">(<span class="meta">@Field(&quot;appVersion&quot;)</span> String appVersion,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Field(&quot;phoneModel&quot;)</span> String phoneModel,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Field(&quot;phoneOsVersion&quot;)</span> String osVersion,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@Field(&quot;submitContent&quot;)</span> String content,</span></span><br><span class="line"><span class="params">                                          <span class="meta">@FieldMap</span> Map&lt;String, String&gt; map)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取手机验证码</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mobile 手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GET(&quot;verifyCode&quot;)</span></span><br><span class="line">    Observable&lt;PhoneCodeResp&gt; <span class="title function_">getPhoneCode</span><span class="params">(<span class="meta">@Query(&quot;mobile&quot;)</span> String mobile, <span class="meta">@Query(&quot;oprType&quot;)</span> <span class="type">int</span> type)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="调用接口"><a href="#调用接口" class="headerlink" title="调用接口"></a>调用接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.reactivex.Observer;</span><br><span class="line"><span class="keyword">import</span> io.reactivex.android.schedulers.AndroidSchedulers;</span><br><span class="line"><span class="keyword">import</span> io.reactivex.disposables.Disposable;</span><br><span class="line"><span class="keyword">import</span> io.reactivex.schedulers.Schedulers;</span><br><span class="line"></span><br><span class="line">RustDroneDataCenter.getCenter().getCommonService().userFeedback(BuildConfig.VERSION_NAME,</span><br><span class="line">                    Build.MODEL.replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;-&quot;</span>), Build.VERSION.RELEASE, fd, ext)</span><br><span class="line">                    .subscribeOn(Schedulers.newThread())</span><br><span class="line">                    .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                    .subscribe(<span class="keyword">new</span> <span class="title class_">Observer</span>&lt;FeedbackResp&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Disposable d)</span> &#123;</span><br><span class="line"><span class="comment">//                            LL.dn(TAG, &quot;onSubscribe: &quot; + d);</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(FeedbackResp feedbackResp)</span> &#123;</span><br><span class="line">                            LL.dn(TAG, <span class="string">&quot;onNext: &quot;</span> + feedbackResp);</span><br><span class="line">                            <span class="keyword">if</span> (feedbackResp.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                                popSubmitSuccessDialog();</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                LL.e(<span class="string">&quot;上传用户反馈失败&quot;</span>);</span><br><span class="line">                                mPbLayout.setVisibility(View.GONE);</span><br><span class="line">                                popRetryDialog();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">                            LL.e(<span class="string">&quot;上传用户反馈失败 code: &quot;</span> + e);</span><br><span class="line">                            mPbLayout.setVisibility(View.GONE);</span><br><span class="line">                            popRetryDialog();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">                            mPbLayout.setVisibility(View.GONE);</span><br><span class="line">                            LL.dn(TAG, <span class="string">&quot;onComplete: 上传结束&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br></pre></td></tr></table></figure>
<h1 id="GithubOnAndroid示例"><a href="#GithubOnAndroid示例" class="headerlink" title="GithubOnAndroid示例"></a>GithubOnAndroid示例</h1><p>代码地址： <a target="_blank" rel="noopener" href="https://github.com/RustFisher/GithubOnAndroid">https://github.com/RustFisher/GithubOnAndroid</a></p>
<h2 id="添加拦截器"><a href="#添加拦截器" class="headerlink" title="添加拦截器"></a>添加拦截器</h2><h3 id="定义拦截器"><a href="#定义拦截器" class="headerlink" title="定义拦截器"></a>定义拦截器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 仅仅是示例，不做任何处理</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Interceptor</span> <span class="variable">doNothingInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Interceptor</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Interceptor1: intercept&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> chain.proceed(chain.request());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="添加拦截器-1"><a href="#添加拦截器-1" class="headerlink" title="添加拦截器"></a>添加拦截器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">                .readTimeout(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">                .connectTimeout(<span class="number">10</span>, TimeUnit.SECONDS)</span><br><span class="line">                .addInterceptor(doNothingInterceptor) <span class="comment">// 添加拦截器</span></span><br><span class="line">                .addInterceptor(<span class="keyword">new</span> <span class="title class_">Interceptor</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;Interceptor2: intercept&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> chain.proceed(chain.request());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .addNetworkInterceptor(<span class="keyword">new</span> <span class="title class_">Interceptor</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;NetworkInterceptor1: intercept&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> chain.proceed(chain.request());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .build();</span><br></pre></td></tr></table></figure>
<h4 id="拦截器中增加header"><a href="#拦截器中增加header" class="headerlink" title="拦截器中增加header"></a>拦截器中增加header</h4><p>操作chain中的request。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 添加一些公共参数</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Interceptor</span> <span class="variable">RustDroneInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Interceptor</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Response <span class="title function_">intercept</span><span class="params">(Chain chain)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> chain.request().newBuilder()</span><br><span class="line">                .addHeader(<span class="string">&quot;token&quot;</span>, UserCenter.getToken())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> chain.proceed(request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>更多请参考：</p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2018/08/22/Android/Android-OkHttp_Retrofit_use_intro/">Android OkHttp + Retrofit 使用示例</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/06/26/Android/Android-OkHttp_Retrofit_cancel_request/">Android OkHttp + Retrofit 取消请求的方法</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file/">Android OkHttp + Retrofit 下载文件与进度监听</a></p>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/10/18/Android/Android-OkHttp_Retrofit_download_file_partial/">Android OkHttp + Retrofit 断点续传</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-07-29T01:11:15.000Z" title="2018/7/29 09:11:15">2018-07-29</time>发表</span><span class="level-item"><time dateTime="2021-06-24T09:04:56.782Z" title="2021/6/24 17:04:56">2021-06-24</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">18 分钟读完 (大约2707个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/07/29/Dev-note/dev-note-app-drone/">「drone」开发记录</a></p><div class="content"><h2 id="斜体文字被切掉了一块"><a href="#斜体文字被切掉了一块" class="headerlink" title="斜体文字被切掉了一块"></a>斜体文字被切掉了一块</h2><p>TextView.setText的时候在右边加上一个空格。</p>
<p>或者<code>string.xml</code>中添加<code>&amp;#x200A;</code>来占位。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;dp_page_ready&quot;</span>&gt;</span>READY<span class="symbol">&amp;#x200A;</span><span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>或者在TextView.setText的时候加上一个空格。</p>
<h2 id="动态给LinearLayout添加子View"><a href="#动态给LinearLayout添加子View" class="headerlink" title="动态给LinearLayout添加子View"></a>动态给LinearLayout添加子View</h2><p>一列27个自定义view，如果要写到xml里就太麻烦了。<br>在Java代码中新建子View，设置LayoutParams，然后添加到LinearLayout里。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initGrids</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">bigGridHeightPx</span> <span class="operator">=</span> (<span class="type">int</span>) dpToPx(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">bigGrid2MarginVerticalPx</span> <span class="operator">=</span> (<span class="type">int</span>) dpToPx(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">smallGridHeightPx</span> <span class="operator">=</span> (<span class="type">int</span>) dpToPx(<span class="number">6</span>); <span class="comment">// 这里有27个格点</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">smallGridMarginBotPx</span> <span class="operator">=</span> (<span class="type">int</span>) dpToPx(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">LinearLayout</span> <span class="variable">linearLayoutLeft1</span> <span class="operator">=</span> findViewById(R.id.dp_page_g_field_left1);</span><br><span class="line">    <span class="type">LinearLayout</span> <span class="variable">linearLayoutLeft2</span> <span class="operator">=</span> findViewById(R.id.dp_page_g_field_left2);</span><br><span class="line">    mLeftGridList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">GridsHorView</span> <span class="variable">g1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GridsHorView</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="type">GridsHorView</span> <span class="variable">g2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GridsHorView</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="type">GridsHorView</span> <span class="variable">g3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GridsHorView</span>(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    LinearLayout.<span class="type">LayoutParams</span> <span class="variable">p1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayout</span>.LayoutParams(LinearLayout.LayoutParams.MATCH_PARENT, bigGridHeightPx);</span><br><span class="line">    LinearLayout.<span class="type">LayoutParams</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayout</span>.LayoutParams(LinearLayout.LayoutParams.MATCH_PARENT, bigGridHeightPx);</span><br><span class="line">    p2.setMargins(<span class="number">0</span>, bigGrid2MarginVerticalPx, <span class="number">0</span>, bigGrid2MarginVerticalPx);</span><br><span class="line">    linearLayoutLeft1.addView(g1, p1);</span><br><span class="line">    linearLayoutLeft1.addView(g2, p2);</span><br><span class="line">    linearLayoutLeft1.addView(g3, p1);</span><br><span class="line">    mLeftGridList.addAll(Arrays.asList(g1, g2, g3));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">27</span>; i++) &#123;</span><br><span class="line">        <span class="type">GridsHorView</span> <span class="variable">smallGrid</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GridsHorView</span>(<span class="built_in">this</span>);</span><br><span class="line">        smallGrid.setAlphaValue((<span class="type">int</span>) (<span class="number">255</span> * (<span class="number">1</span> - <span class="number">0.02</span> * i)));</span><br><span class="line">        LinearLayout.<span class="type">LayoutParams</span> <span class="variable">sp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayout</span>.LayoutParams(LinearLayout.LayoutParams.MATCH_PARENT, smallGridHeightPx);</span><br><span class="line">        sp.setMargins(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, smallGridMarginBotPx);</span><br><span class="line">        mLeftGridList.add(smallGrid);</span><br><span class="line">        linearLayoutLeft2.addView(smallGrid, sp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (GridsHorView g : mLeftGridList) &#123;</span><br><span class="line">        g.setOri(GridsHorView.Ori.RIGHT_TO_LEFT);</span><br><span class="line">        g.disableMode();</span><br><span class="line">        g.setCubeCount(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化右边（P2）的格子...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">float</span> <span class="title function_">dpToPx</span><span class="params">(<span class="type">float</span> dp)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> dp * getResources().getDisplayMetrics().density;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取当前WiFi的名字"><a href="#获取当前WiFi的名字" class="headerlink" title="获取当前WiFi的名字"></a>获取当前WiFi的名字</h2><p>需要定位权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getWiFiName</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">wifiId</span> <span class="operator">=</span> <span class="string">&quot;WIFI_NAME_NOT_FOUND&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">WifiManager</span> <span class="variable">wifiMgr</span> <span class="operator">=</span> (WifiManager) context.getSystemService(Context.WIFI_SERVICE);</span><br><span class="line">        <span class="type">WifiInfo</span> <span class="variable">info</span> <span class="operator">=</span> wifiMgr.getConnectionInfo();</span><br><span class="line">        wifiId = info != <span class="literal">null</span> ? info.getSSID() : <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(wifiId) &amp;&amp; wifiId.startsWith(<span class="string">&quot;\&quot;&quot;</span>)) &#123;</span><br><span class="line">        wifiId = wifiId.substring(<span class="number">1</span>); <span class="comment">// 删去前面那个引号</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> wifiId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法适用于判断WiFi名称的前缀。</p>
<h2 id="检查权限的方法"><a href="#检查权限的方法" class="headerlink" title="检查权限的方法"></a>检查权限的方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">checkPermission</span><span class="params">(String[] permissions, <span class="keyword">final</span> <span class="type">int</span> reqCode)</span> &#123;</span><br><span class="line">    List&lt;String&gt; perList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String p : permissions) &#123;</span><br><span class="line">        <span class="keyword">if</span> (PackageManager.PERMISSION_GRANTED != ContextCompat.checkSelfPermission(<span class="built_in">this</span>, p)) &#123;</span><br><span class="line">            LL.e(<span class="string">&quot;没有权限: &quot;</span> + p);</span><br><span class="line">            perList.add(p);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!perList.isEmpty()) &#123;</span><br><span class="line">        String[] per = <span class="keyword">new</span> <span class="title class_">String</span>[perList.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; per.length; i++) &#123;</span><br><span class="line">            per[i] = perList.get(i);</span><br><span class="line">        &#125;</span><br><span class="line">        ActivityCompat.requestPermissions(<span class="built_in">this</span>, per, reqCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="设置Click监听器"><a href="#设置Click监听器" class="headerlink" title="设置Click监听器"></a>设置Click监听器</h2><p>应用在Activity中，给一堆view设置同一个监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置点击监听器</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setOnClickListeners</span><span class="params">(View.OnClickListener l, View... views)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (View v : views) &#123;</span><br><span class="line">        v.setOnClickListener(l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setOnClickListeners</span><span class="params">(View.OnClickListener l, <span class="type">int</span>... resIds)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> r : resIds) &#123;</span><br><span class="line">        findViewById(r).setOnClickListener(l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="设置字体"><a href="#设置字体" class="headerlink" title="设置字体"></a>设置字体</h2><p>先把字体加载好。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setTvPangMenAndItalic</span><span class="params">(<span class="type">int</span>... tvResIds)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i : tvResIds) &#123;</span><br><span class="line">        ((TextView) findViewById(i)).setTypeface(AppControl.getPangMenTf(), Typeface.ITALIC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setTvPangMenAndItalic</span><span class="params">(TextView... tvs)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (TextView t : tvs) &#123;</span><br><span class="line">        t.setTypeface(AppControl.getPangMenTf(), Typeface.ITALIC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="收起软键盘"><a href="#收起软键盘" class="headerlink" title="收起软键盘"></a>收起软键盘</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">hideSoftKeyboard</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InputMethodManager</span> <span class="variable">inputMgr</span> <span class="operator">=</span> (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);</span><br><span class="line">        inputMgr.hideSoftInputFromWindow(getCurrentFocus().getWindowToken(), InputMethodManager.HIDE_NOT_ALWAYS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LL.e(<span class="string">&quot;rustApp&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="判断网络是否有连接"><a href="#判断网络是否有连接" class="headerlink" title="判断网络是否有连接"></a>判断网络是否有连接</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isNetworkAvailable</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">ConnectivityManager</span> <span class="variable">connectivity</span> <span class="operator">=</span> (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connectivity == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        NetworkInfo[] info = connectivity.getAllNetworkInfo();</span><br><span class="line">        <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (NetworkInfo anInfo : info) &#123;</span><br><span class="line">                <span class="keyword">if</span> (anInfo.getState() == NetworkInfo.State.CONNECTED) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="判断某个App是否安装"><a href="#判断某个App是否安装" class="headerlink" title="判断某个App是否安装"></a>判断某个App是否安装</h2><p>获取PackageManager通过包名来判断某个App是否安装。<br>但是有的手机在获取PackageManager的时候就能抛出异常。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">appInstalledOrNot</span><span class="params">(String uri)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> getPackageManager();</span><br><span class="line">        pm.getPackageInfo(uri, PackageManager.GET_ACTIVITIES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LL.e(<span class="string">&quot;appInstalledOrNot: &quot;</span> + uri, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总而言之这并不是个很好的办法。</p>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p>一些性能优化的处理措施和思考。</p>
<h3 id="给UI线程更多的CPU资源"><a href="#给UI线程更多的CPU资源" class="headerlink" title="给UI线程更多的CPU资源"></a>给UI线程更多的CPU资源</h3><p>数据库的操作放在子线程中进行。数据库线程也可能会和UI线程争抢CPU的时间片。<br>假设数据库要删除大量数据（比如1万条）。<br>那么我们可以尝试在数据库处理了某个数量（例如1千）的操作后，sleep一下，给UI线程让出CPU时间。<br>但现在一般都是多核手机，具体效果有待考量。</p>
<h2 id="log记录工具"><a href="#log记录工具" class="headerlink" title="log记录工具"></a>log记录工具</h2><p>把log写到文件里。用RandomAccessFile与MappedByteBuffer写日志到文件中。任务处理放在子线程中，由HandlerThread来管理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LL</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Level</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">D</span> <span class="operator">=</span> <span class="string">&quot;D&quot;</span>; <span class="comment">// 普通debug</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">W</span> <span class="operator">=</span> <span class="string">&quot;W&quot;</span>; <span class="comment">// 警告</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">E</span> <span class="operator">=</span> <span class="string">&quot;E&quot;</span>; <span class="comment">// 错误</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">defTag</span> <span class="operator">=</span> <span class="string">&quot;App&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">showLogcat</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">writeFile</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意申请SD卡读写权限</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">logFileDir</span> <span class="operator">=</span> Environment.getExternalStorageDirectory().getAbsolutePath() +</span><br><span class="line">            File.separator + <span class="string">&quot;rust&quot;</span> + File.separator + <span class="string">&quot;logs&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;LogListener&gt; listenerList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HandlerThread handlerThread;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Handler writerHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LOG_FILE_GROW_SIZE</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">10</span>; <span class="comment">// log文件每次增长的大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="variable">gCurrentLogPos</span> <span class="operator">=</span> <span class="number">0</span>;                  <span class="comment">// log文件当前写到的位置 - 注意要单线程处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用前必须调用此方法进行准备</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 建议传入applicationContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileDir 存放log文件的目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(Context context, <span class="meta">@NonNull</span> String fileDir, String logFilePrefix)</span> &#123;</span><br><span class="line">        gCurrentLogPos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(fileDir)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Environment.getExternalStorageState().equals(</span><br><span class="line">                    Environment.MEDIA_MOUNTED)) &#123;</span><br><span class="line">                logFileDir = Environment.getExternalStorageDirectory().getAbsolutePath() +</span><br><span class="line">                        File.separator + <span class="string">&quot;rust&quot;</span> + File.separator + <span class="string">&quot;logs&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logFileDir = context.getFilesDir().getAbsolutePath() +</span><br><span class="line">                        File.separator + <span class="string">&quot;rust&quot;</span> + File.separator + <span class="string">&quot;logs&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logFileDir = fileDir;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == handlerThread) &#123;</span><br><span class="line">            handlerThread = <span class="keyword">new</span> <span class="title class_">HandlerThread</span>(<span class="string">&quot;LL&quot;</span>);</span><br><span class="line">            handlerThread.start();</span><br><span class="line">        &#125;</span><br><span class="line">        writerHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>(handlerThread.getLooper());</span><br><span class="line">        fileName = logFilePrefix + <span class="string">&quot;_&quot;</span> + System.currentTimeMillis() + <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">        Log.d(defTag, <span class="string">&quot;[prepare] file: &quot;</span> + fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLogFileDir</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> logFileDir;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getFileName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 退出</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">quit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (writerHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">            writerHandler.removeCallbacksAndMessages(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (handlerThread != <span class="literal">null</span>) &#123;</span><br><span class="line">            handlerThread.quit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setDefTag</span><span class="params">(String t)</span> &#123;</span><br><span class="line">        LL.defTag = t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setWriteFile</span><span class="params">(<span class="type">boolean</span> w)</span> &#123;</span><br><span class="line">        LL.writeFile = w;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">d</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        d(defTag, content, writeFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">d</span><span class="params">(String tag, String content)</span> &#123;</span><br><span class="line">        d(tag, content, writeFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dn</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        d(defTag, content, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不写到文件中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dn</span><span class="params">(String tag, String content)</span> &#123;</span><br><span class="line">        d(tag, content, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">d</span><span class="params">(String tag, String content, <span class="type">boolean</span> write)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (showLogcat) &#123;</span><br><span class="line">            Log.d(tag, content);</span><br><span class="line">        &#125;</span><br><span class="line">        tellLog(Level.D, tag, content);</span><br><span class="line">        <span class="keyword">if</span> (write) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writerHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">                writerHandler.post(<span class="keyword">new</span> <span class="title class_">WriteRunnable</span>(tag, content));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// log级别 WARN - w</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">w</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        w(defTag, content, writeFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">w</span><span class="params">(String tag, String content)</span> &#123;</span><br><span class="line">        w(tag, content, writeFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不写到文件中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">wn</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        w(defTag, content, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不写到文件中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">wn</span><span class="params">(String tag, String content)</span> &#123;</span><br><span class="line">        w(tag, content, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">w</span><span class="params">(String tag, String content, <span class="type">boolean</span> write)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (showLogcat) &#123;</span><br><span class="line">            Log.w(tag, content);</span><br><span class="line">        &#125;</span><br><span class="line">        tellLog(Level.W, tag, content);</span><br><span class="line">        <span class="keyword">if</span> (write) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writerHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">                writerHandler.post(<span class="keyword">new</span> <span class="title class_">WriteRunnable</span>(tag, content));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">e</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        e(defTag, content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">e</span><span class="params">(String tag, String content)</span> &#123;</span><br><span class="line">        e(tag, content, writeFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">e</span><span class="params">(String tag, Exception e)</span> &#123;</span><br><span class="line">        e(tag, e.getMessage(), writeFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只打log  不写文件</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">en</span><span class="params">(String tag, String content)</span> &#123;</span><br><span class="line">        e(tag, content, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">e</span><span class="params">(String tag, String content, <span class="type">boolean</span> write)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (showLogcat) &#123;</span><br><span class="line">            Log.e(tag, content);</span><br><span class="line">        &#125;</span><br><span class="line">        tellLog(Level.E, tag, content);</span><br><span class="line">        <span class="keyword">if</span> (write) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writerHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">                writerHandler.post(<span class="keyword">new</span> <span class="title class_">WriteRunnable</span>(tag, content));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">tellLog</span><span class="params">(String level, String tag, String content)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != listenerList) &#123;</span><br><span class="line">            <span class="keyword">for</span> (LogListener l : listenerList) &#123;</span><br><span class="line">                l.onLog(level, tag, content);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(LogListener l)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == listenerList) &#123;</span><br><span class="line">            listenerList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        listenerList.add(l);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeListener</span><span class="params">(LogListener l)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != listenerList) &#123;</span><br><span class="line">            listenerList.remove(l);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WriteRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        String mmTag;</span><br><span class="line">        String mmContent;</span><br><span class="line"></span><br><span class="line">        WriteRunnable(String tag, String content) &#123;</span><br><span class="line">            <span class="built_in">this</span>.mmTag = tag;</span><br><span class="line">            <span class="built_in">this</span>.mmContent = content;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">SimpleDateFormat</span> <span class="variable">logTimeFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;HH:mm:ss.SSS&quot;</span>, Locale.CHINA);</span><br><span class="line">            <span class="type">String</span> <span class="variable">logContent</span> <span class="operator">=</span> logTimeFormat.format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">&quot; [&quot;</span> + mmTag + <span class="string">&quot;] &quot;</span> + mmContent + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(logFileDir);</span><br><span class="line">                <span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">mk</span> <span class="operator">=</span> dir.mkdirs();</span><br><span class="line">                    Log.d(defTag, <span class="string">&quot;make dir &quot;</span> + mk);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">File</span> <span class="variable">eFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(logFileDir + File.separator + fileName);</span><br><span class="line">                <span class="type">byte</span>[] strBytes = logContent.getBytes();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">RandomAccessFile</span> <span class="variable">randomAccessFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(eFile, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">                    MappedByteBuffer mappedByteBuffer;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">inputLen</span> <span class="operator">=</span> strBytes.length;</span><br><span class="line">                    <span class="keyword">if</span> (!eFile.exists()) &#123;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">nf</span> <span class="operator">=</span> eFile.createNewFile();</span><br><span class="line">                        Log.d(defTag, <span class="string">&quot;new log file &quot;</span> + nf);</span><br><span class="line">                        mappedByteBuffer = randomAccessFile.getChannel().map(FileChannel.MapMode.READ_WRITE, gCurrentLogPos, LOG_FILE_GROW_SIZE);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mappedByteBuffer = randomAccessFile.getChannel().map(FileChannel.MapMode.READ_WRITE, gCurrentLogPos, inputLen);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mappedByteBuffer.remaining() &lt; inputLen) &#123;</span><br><span class="line">                        mappedByteBuffer = randomAccessFile.getChannel().map(FileChannel.MapMode.READ_WRITE, gCurrentLogPos, LOG_FILE_GROW_SIZE + inputLen);</span><br><span class="line"><span class="comment">//                        Log.d(defTag, &quot;run: grow size &quot;);</span></span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">//                    Log.d(defTag, &quot;run: gCurrentLogPos: &quot; + gCurrentLogPos + &quot;, pos: &quot; + mappedByteBuffer.position() + &quot;, remaining: &quot; + mappedByteBuffer.remaining());</span></span><br><span class="line">                    mappedByteBuffer.put(strBytes);</span><br><span class="line">                    gCurrentLogPos += inputLen;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.e(defTag, <span class="string">&quot;WriteRunnable run: &quot;</span>, e);</span><br><span class="line">                    <span class="keyword">if</span> (!eFile.exists()) &#123;</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">nf</span> <span class="operator">=</span> eFile.createNewFile();</span><br><span class="line">                        Log.d(defTag, <span class="string">&quot;new log file &quot;</span> + nf);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="type">FileOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(eFile, <span class="literal">true</span>);</span><br><span class="line">                    os.write(logContent.getBytes());</span><br><span class="line">                    os.flush();</span><br><span class="line">                    os.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                Log.e(defTag, <span class="string">&quot;写log文件出错: &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">LogListener</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">onLog</span><span class="params">(String level, String tag, String content)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义View"><a href="#自定义View" class="headerlink" title="自定义View"></a>自定义View</h2><p>一些自定义的view，比如一些折线图，条形图。</p>
<h3 id="折线图-ColorAutoLineChart"><a href="#折线图-ColorAutoLineChart" class="headerlink" title="折线图 ColorAutoLineChart"></a>折线图 ColorAutoLineChart</h3><p>单独一条折线，可自动缩放Y轴高度。使用FloatBuffer来存储数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ColorAutoLineChart</span> <span class="keyword">extends</span> <span class="title class_">View</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;AppColorAutoLineChart&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="variable">yMax</span> <span class="operator">=</span> <span class="number">1856f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="variable">yMin</span> <span class="operator">=</span> -<span class="number">1024f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 图表线条在view顶部留出的间距</span></span><br><span class="line">    <span class="type">float</span> <span class="variable">viewYStart</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="type">float</span> <span class="variable">axisTextSize</span> <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">onShowPointsCount</span> <span class="operator">=</span> <span class="number">256</span>;  <span class="comment">// 当前显示的数据个数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">cacheMaxPoint</span> <span class="operator">=</span> <span class="number">9000</span>;     <span class="comment">// 数据存储最大个数</span></span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> <span class="variable">axisLineWid</span> <span class="operator">=</span> <span class="number">1f</span>; <span class="comment">// 坐标轴线条宽度</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dataLineWid</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据线颜色</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">dataColor</span> <span class="operator">=</span> Color.WHITE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="variable">xStep</span> <span class="operator">=</span> <span class="number">1.0f</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> viewWidth;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> viewHeight;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="variable">botLeftXOnView</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 图表左下点在view中的x坐标</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="variable">botLeftYOnView</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="variable">originYToBottom</span> <span class="operator">=</span> <span class="number">20</span>; <span class="comment">// 图表原点距离view底部的距离</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FloatBuffer dataBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Paint bgPaint;</span><br><span class="line">    <span class="keyword">private</span> Paint linePaint;</span><br><span class="line">    <span class="keyword">private</span> Paint wavePaint;</span><br><span class="line">    <span class="type">Path</span> <span class="variable">wavePath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(); <span class="comment">// 用来画渐变色</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">waveTopColor</span> <span class="operator">=</span> Color.parseColor(<span class="string">&quot;#f65212&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ColorAutoLineChart</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ColorAutoLineChart</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ColorAutoLineChart</span><span class="params">(Context context, AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        init(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addData</span><span class="params">(<span class="type">int</span>[] data)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i : data) &#123;</span><br><span class="line">            addData(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addData</span><span class="params">(<span class="type">float</span> data)</span> &#123;</span><br><span class="line">        dataBuffer.put(data);</span><br><span class="line">        <span class="keyword">if</span> (dataBuffer.position() &gt; (dataBuffer.capacity() * <span class="number">2</span> / <span class="number">3</span>)) &#123;</span><br><span class="line">            <span class="type">float</span>[] bufferArr = dataBuffer.array();</span><br><span class="line">            System.arraycopy(bufferArr, dataBuffer.position() - cacheMaxPoint, bufferArr, <span class="number">0</span>, cacheMaxPoint);</span><br><span class="line">            dataBuffer.position(cacheMaxPoint);</span><br><span class="line"><span class="comment">//            Log.d(TAG, &quot;把当前数据移动到buffer起始位置 &quot; + dataBuffer);</span></span><br><span class="line">        &#125;</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        dataBuffer = FloatBuffer.allocate(<span class="number">3</span> * cacheMaxPoint); <span class="comment">// 分配3倍的空间</span></span><br><span class="line">        bgPaint = <span class="keyword">new</span> <span class="title class_">Paint</span>(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        linePaint = <span class="keyword">new</span> <span class="title class_">Paint</span>(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        wavePaint = <span class="keyword">new</span> <span class="title class_">Paint</span>(Paint.ANTI_ALIAS_FLAG);</span><br><span class="line">        bgPaint.setStrokeWidth(axisLineWid);</span><br><span class="line">        bgPaint.setStyle(Paint.Style.STROKE);</span><br><span class="line">        linePaint.setStrokeWidth(dataLineWid);</span><br><span class="line">        linePaint.setStyle(Paint.Style.STROKE);</span><br><span class="line">        linePaint.setColor(dataColor);</span><br><span class="line"></span><br><span class="line">        botLeftXOnView = TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, <span class="number">0</span>, context.getResources().getDisplayMetrics());</span><br><span class="line">        originYToBottom = TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, <span class="number">20</span>, context.getResources().getDisplayMetrics());</span><br><span class="line">        viewYStart = TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, <span class="number">20</span>, context.getResources().getDisplayMetrics());</span><br><span class="line">        axisLineWid = TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, <span class="number">1</span>, context.getResources().getDisplayMetrics());</span><br><span class="line">        axisTextSize = TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_SP, <span class="number">8</span>, context.getResources().getDisplayMetrics());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onSizeChanged</span><span class="params">(<span class="type">int</span> w, <span class="type">int</span> h, <span class="type">int</span> oldw, <span class="type">int</span> oldh)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onSizeChanged(w, h, oldw, oldh);</span><br><span class="line">        viewWidth = getWidth();</span><br><span class="line">        viewHeight = getHeight();</span><br><span class="line">        botLeftYOnView = viewHeight - originYToBottom;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDraw(canvas);</span><br><span class="line">        canvas.drawColor(Color.TRANSPARENT);</span><br><span class="line">        xStep = (viewWidth - botLeftXOnView) / (onShowPointsCount - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">dataStartIndexInBuffer</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 数据在buffer中的起始下标</span></span><br><span class="line">        <span class="keyword">if</span> (dataBuffer.position() &gt; onShowPointsCount) &#123;</span><br><span class="line">            dataStartIndexInBuffer = dataBuffer.position() - onShowPointsCount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">float</span>[] bufferArr = dataBuffer.array();</span><br><span class="line">        <span class="type">float</span> <span class="variable">maxData</span> <span class="operator">=</span> bufferArr[<span class="number">0</span>];</span><br><span class="line">        <span class="type">float</span> <span class="variable">minData</span> <span class="operator">=</span> bufferArr[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> dataStartIndexInBuffer; i &lt; dataBuffer.position(); i++) &#123;</span><br><span class="line">            <span class="type">float</span> <span class="variable">cur</span> <span class="operator">=</span> bufferArr[i];</span><br><span class="line">            <span class="keyword">if</span> (cur &lt; minData) &#123;</span><br><span class="line">                minData = cur;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur &gt; maxData) &#123;</span><br><span class="line">                maxData = cur;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        drawWave(canvas, dataStartIndexInBuffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">drawWave</span><span class="params">(Canvas canvas, <span class="type">int</span> dataStartIndexInBuffer)</span> &#123;</span><br><span class="line">        wavePath.reset();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">float</span> <span class="variable">yDataRange</span> <span class="operator">=</span> yMax - yMin;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">float</span> <span class="variable">yAxisRangeOnView</span> <span class="operator">=</span> botLeftYOnView - viewYStart;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">float</span> <span class="variable">yDataStep</span> <span class="operator">=</span> yAxisRangeOnView / yDataRange;</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span>[] dataArr = dataBuffer.array();</span><br><span class="line">        <span class="type">float</span> <span class="variable">maxData</span> <span class="operator">=</span> dataArr[dataStartIndexInBuffer];</span><br><span class="line"></span><br><span class="line">        <span class="type">float</span> <span class="variable">waveStartX</span> <span class="operator">=</span> botLeftXOnView;</span><br><span class="line">        <span class="type">float</span> <span class="variable">waveStartY</span> <span class="operator">=</span> getYL(dataArr[dataStartIndexInBuffer], yDataStep);</span><br><span class="line">        wavePath.moveTo(waveStartX, waveStartY);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> dataStartIndexInBuffer; i &lt; dataBuffer.position() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">            <span class="type">float</span> <span class="variable">curData</span> <span class="operator">=</span> dataArr[i];</span><br><span class="line">            <span class="type">float</span> <span class="variable">nextData</span> <span class="operator">=</span> dataArr[i + <span class="number">1</span>];</span><br><span class="line">            wavePath.lineTo(botLeftXOnView + (i - dataStartIndexInBuffer + <span class="number">1</span>) * xStep, getYL(nextData, yDataStep));</span><br><span class="line">            canvas.drawLine(botLeftXOnView + (i - dataStartIndexInBuffer) * xStep, getYL(curData, yDataStep),</span><br><span class="line">                    botLeftXOnView + (i - dataStartIndexInBuffer + <span class="number">1</span>) * xStep, getYL(nextData, yDataStep),</span><br><span class="line">                    linePaint);</span><br><span class="line">            maxData = Math.max(maxData, nextData);</span><br><span class="line">        &#125;</span><br><span class="line">        wavePath.lineTo(viewWidth, viewHeight);</span><br><span class="line">        wavePath.lineTo(botLeftXOnView, viewHeight);</span><br><span class="line">        wavePath.lineTo(waveStartX, waveStartY);</span><br><span class="line">        wavePath.close();</span><br><span class="line">        wavePaint.setShader(<span class="keyword">new</span> <span class="title class_">LinearGradient</span>(<span class="number">0</span>, getYL(maxData, yDataStep), <span class="number">0</span>, viewHeight, waveTopColor, Color.TRANSPARENT, Shader.TileMode.CLAMP));</span><br><span class="line">        canvas.drawPath(wavePath, wavePaint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="title function_">getYL</span><span class="params">(<span class="keyword">final</span> <span class="type">float</span> yData, <span class="type">float</span> yDataStep)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> botLeftYOnView - (yData - yMin) * yDataStep;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="后台用户行为记录"><a href="#后台用户行为记录" class="headerlink" title="后台用户行为记录"></a>后台用户行为记录</h2><p>最开始设计后台服务的时候，并没有考虑到太多的记录功能。仅仅记录了用户登录行为。<br>今后应该记录更详细的。例如获取用户信息，时间，客户端类型，userID等等。获取用户信息是否成功，可作为缓存登录的依据。</p>
<p>后台可以记录的用户行为，例如获取用户信息，用户查看飞行记录列表，用户查看飞行记录详情，用户点赞。</p>
<h2 id="WebView设置"><a href="#WebView设置" class="headerlink" title="WebView设置"></a>WebView设置</h2><p>webview不显示图片的问题。LL后加载https的网页，默认会不加载http的资源。需要设置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">webSettings.setBlockNetworkImage(<span class="literal">false</span>);</span><br><span class="line">webSettings.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);</span><br></pre></td></tr></table></figure>
<h2 id="方法调用记录调用原因"><a href="#方法调用记录调用原因" class="headerlink" title="方法调用记录调用原因"></a>方法调用记录调用原因</h2><p>调用某个方法的时候，比如中止某项功能。可以在log上记录一些原因，方便debug。</p>
<h2 id="Glide"><a href="#Glide" class="headerlink" title="Glide"></a>Glide</h2><h3 id="设定播放gif的次数"><a href="#设定播放gif的次数" class="headerlink" title="设定播放gif的次数"></a>设定播放gif的次数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Glide.get(getApplicationContext()).setMemoryCategory(MemoryCategory.NORMAL);</span><br><span class="line">Glide.with(<span class="built_in">this</span>).asGif().listener(<span class="keyword">new</span> <span class="title class_">RequestListener</span>&lt;GifDrawable&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onLoadFailed</span><span class="params">(<span class="meta">@Nullable</span> GlideException e, Object model, Target&lt;GifDrawable&gt; target, <span class="type">boolean</span> isFirstResource)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onResourceReady</span><span class="params">(GifDrawable resource, Object model, Target&lt;GifDrawable&gt; target, DataSource dataSource, <span class="type">boolean</span> isFirstResource)</span> &#123;</span><br><span class="line">        resource.setLoopCount(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).load(R.drawable.app_start_up).into(imageView);</span><br><span class="line">imageView.setOnApplyWindowInsetsListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnApplyWindowInsetsListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> WindowInsets <span class="title function_">onApplyWindowInsets</span><span class="params">(View v, WindowInsets insets)</span> &#123;</span><br><span class="line">        MyAppControl.setPhoneStatusBarHeight(insets.getSystemWindowInsetTop());</span><br><span class="line">        <span class="keyword">return</span> insets;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-06-01T14:10:03.000Z" title="2018/6/1 22:10:03">2018-06-01</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:12.351Z" title="2021/6/18 17:38:12">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">5 分钟读完 (大约813个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/06/01/Android/Android-Intent_extra_size_limit/">Android Intent 传递数据大小限制</a></p><div class="content"><p>在<code>sendBroadcast</code>，<code>startActivity</code>时，我们会用到Intent。<br>Intent可以携带一些数据，比如基本类型数据int、Boolean，或是String，或是序列化对象，Parcelable与Serializable。</p>
<p>Intent传递数据时，如果数据太大，可能会出现异常。比如App闪退，或是Intent发送不成功，logcat报错等等。</p>
<p>这就牵涉到一个问题：Intent 传递数据大小限制。</p>
<p>Intent到底能够携带多少数据呢？</p>
<h2 id="使用Intent传送数据时，可能会出现异常"><a href="#使用Intent传送数据时，可能会出现异常" class="headerlink" title="使用Intent传送数据时，可能会出现异常"></a>使用Intent传送数据时，可能会出现异常</h2><p>在Intent中传入一个Parcelable对象；例如传入一个bitmap对象。</p>
<p>代码参考： <a target="_blank" rel="noopener" href="https://github.com/AnRFDev/android-Basic4">https://github.com/AnRFDev/android-Basic4</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Bitmap</span> <span class="variable">b1</span> <span class="operator">=</span> Bitmap.createScaledBitmap(srcBmp, dstWid, dstHeight, <span class="literal">false</span>);</span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MSG_INTENT);</span><br><span class="line">intent.putExtra(K_PIC, b1);</span><br></pre></td></tr></table></figure><br>选择bitmap的原因是，Bitmap实现了<code>Parcelable</code>接口，并且可以通过<code>getByteCount()</code>得知所占内存大小。</p>
<p><code>sendBroadcast</code>时，报出如下信息<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">V/ActivityManager: Broadcast: Intent &#123; act=intent_bi flg=0x10 (has extras) &#125; ordered=false userid=0 callerApp=ProcessRecord&#123;27aeaaf5 31217:com.rustfisher.basic4/u0a113&#125;</span><br><span class="line">E/JavaBinder: !!! FAILED BINDER TRANSACTION !!!</span><br><span class="line">W/BroadcastQueue: Failure sending broadcast Intent &#123; act=intent_bi flg=0x10 (has extras) &#125;</span><br><span class="line">       android.os.TransactionTooLargeException</span><br><span class="line">           at android.os.BinderProxy.transactNative(Native Method)</span><br><span class="line">           at android.os.BinderProxy.transact(Binder.java:504)</span><br><span class="line">           at android.app.ApplicationThreadProxy.scheduleRegisteredReceiver(ApplicationThreadNative.java:1170)</span><br><span class="line">           at com.android.server.am.BroadcastQueue.performReceiveLocked(BroadcastQueue.java:576)</span><br><span class="line">           at com.android.server.am.BroadcastQueue.deliverToRegisteredReceiverLocked(BroadcastQueue.java:848)</span><br><span class="line">           at com.android.server.am.BroadcastQueue.processNextBroadcast(BroadcastQueue.java:917)</span><br><span class="line">           at com.android.server.am.BroadcastQueue$BroadcastHandler.handleMessage(BroadcastQueue.java:254)</span><br><span class="line">           at android.os.Handler.dispatchMessage(Handler.java:111)</span><br><span class="line">           at android.os.Looper.loop(Looper.java:194)</span><br><span class="line">           at android.os.HandlerThread.run(HandlerThread.java:61)</span><br><span class="line">           at com.android.server.ServiceThread.run(ServiceThread.java:46)</span><br></pre></td></tr></table></figure></p>
<p>查看异常类<code>TransactionTooLargeException</code>，它继承了<code>RemoteException</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> android.os;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransactionTooLargeException</span> <span class="keyword">extends</span> <span class="title class_">RemoteException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TransactionTooLargeException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TransactionTooLargeException</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从报错信息<code>FAILED BINDER TRANSACTION</code>可以看出，binder传送数据失败了。<br>追踪到<code>Binder</code>，它的<code>transactNative</code>方法报出<code>RemoteException</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">transactNative</span><span class="params">(<span class="type">int</span> code, Parcel data, Parcel reply,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> flags)</span> <span class="keyword">throws</span> RemoteException;</span><br></pre></td></tr></table></figure><br>抛出的异常与Binder有关。</p>
<h2 id="Intent携带信息的大小受Binder限制"><a href="#Intent携带信息的大小受Binder限制" class="headerlink" title="Intent携带信息的大小受Binder限制"></a>Intent携带信息的大小受Binder限制</h2><p>Intent携带信息的大小其实是受Binder限制。本文标题也可以改为“Binder传递数据大小限制”。</p>
<p>数据以<code>Parcel</code>对象的形式存放在Binder传递缓存中。<br>如果数据或返回值比传递buffer大，则此次传递调用失败并抛出<code>TransactionTooLargeException</code>异常。</p>
<p>Binder传递缓存有一个限定大小，通常是1Mb。但同一个进程中所有的传输共享缓存空间。</p>
<p>多个地方在进行传输时，即时它们各自传输的数据不超出大小限制，<code>TransactionTooLargeException</code>异常也可能会被抛出。</p>
<p>在使用Intent传递数据时，1Mb并不是安全上限。因为Binder中可能正在处理其它的传输工作。<br>不同的机型和系统版本，这个上限值也可能会不同。</p>
<p>在其它地方，例如<code>onSaveInstanceState(@NonNull Bundle outState)</code>，也可能会遇到与Binder有关的<a target="_blank" rel="noopener" href="https://medium.com/@mdmasudparvez/android-os-transactiontoolargeexception-on-nougat-solved-3b6e30597345">类似问题</a>。</p>
<h2 id="为什么Binder要限制传输数据的大小"><a href="#为什么Binder要限制传输数据的大小" class="headerlink" title="为什么Binder要限制传输数据的大小"></a>为什么Binder要限制传输数据的大小</h2><p>个人推测，作为一种IPC的方式，Binder并不是为传输大量数据而设计。</p>
<p>传输大量数据，可以考虑URL之类的方法。</p>
<p>参考</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8434423/android-remote-method-data-limit">https://stackoverflow.com/questions/8434423/android-remote-method-data-limit</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/os/TransactionTooLargeException">https://developer.android.com/reference/android/os/TransactionTooLargeException</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-05-21T12:16:01.000Z" title="2018/5/21 20:16:01">2018-05-21</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:39:07.625Z" title="2021/6/18 17:39:07">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">3 分钟读完 (大约503个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/05/21/Android/NDK-Makefile_example/">Android NDK Makefile相关与示例</a></p><div class="content"><h2 id="Android-mk与Application-mk"><a href="#Android-mk与Application-mk" class="headerlink" title="Android.mk与Application.mk"></a><code>Android.mk</code>与<code>Application.mk</code></h2><p>Android Studio 3之前，需要编写<code>Android.mk</code>和<code>Application.mk</code>文件。</p>
<p>使用jdk8或jdk7中提供的<code>javah</code>来生成头文件。</p>
<h3 id="build-gradle设定jni"><a href="#build-gradle设定jni" class="headerlink" title="build.gradle设定jni"></a><code>build.gradle</code>设定jni</h3><p>以下是某模块的<code>build.gradle</code>文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    // ....</span><br><span class="line">    sourceSets.main &#123;</span><br><span class="line">        jni.srcDirs = [] // 禁止自动执行ndk-build</span><br><span class="line">        jniLibs.srcDirs = [&#x27;src/main/libs&#x27;] // 设定成so文件生成的目录</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="指定模块的名字"><a href="#指定模块的名字" class="headerlink" title="指定模块的名字"></a>指定模块的名字</h3><p>在<code>Android.mk</code>文件中指定模块的名字<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE := modname</span><br></pre></td></tr></table></figure><br>编译得到<code>libmodname.so</code>文件</p>
<p>加载库文件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    System.loadLibrary(<span class="string">&quot;modname&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="利用-TARGET-ARCH-ABI-判断目标架构类别"><a href="#利用-TARGET-ARCH-ABI-判断目标架构类别" class="headerlink" title="利用$(TARGET_ARCH_ABI)判断目标架构类别"></a>利用<code>$(TARGET_ARCH_ABI)</code>判断目标架构类别</h3><p>Android Studio 3之前，需要编写<code>Android.mk</code>和<code>Application.mk</code>文件。使用jdk8或jdk7。</p>
<p>一个典型<code>Application.mk</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APP_ABI := arm64-v8a armeabi-v7a</span><br><span class="line">APP_PLATFORM := android-19</span><br><span class="line">APP_STL := gnustl_static</span><br><span class="line">APP_CPPFLAGS += -std=c++11</span><br></pre></td></tr></table></figure><br>指定了2种架构</p>
<p>在<code>Android.mk</code>中，可以用<code>$(TARGET_ARCH_ABI)</code>判断目标架构类别；<br>例如jni目录中有如下的文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">jni</span><br><span class="line">|-- Android.mk</span><br><span class="line">|-- Application.mk</span><br><span class="line">|-- something.cpp</span><br><span class="line">|-- include</span><br><span class="line">|   |-- something.h</span><br><span class="line">|-- lib</span><br><span class="line">|   |-- arm64-v8a</span><br><span class="line">|   |   `-- libcustom.a</span><br><span class="line">|   `-- armeabi-v7a</span><br><span class="line">|       `-- libcustom.a</span><br></pre></td></tr></table></figure></p>
<p><code>Android.mk</code>中判断当前编译的目标架构而加载库文件<code>libcustom.a</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_LDFLAGS := $(LOCAL_PATH)/lib/$(TARGET_ARCH_ABI)/libcustom.a</span><br></pre></td></tr></table></figure></p>
<h3 id="引用OpenCV模块"><a href="#引用OpenCV模块" class="headerlink" title="引用OpenCV模块"></a>引用OpenCV模块</h3><p>假设已经下载好<code>opencv-3.2.0</code>SDK，<code>Android.mk</code>中引用<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OPENCVROOT:=$(LOCAL_PATH)/../../../../../opencv-3.2.0-android-sdk/OpenCV-android-sdk</span><br><span class="line">OPENCV_CAMERA_MODULES:=off</span><br><span class="line">OPENCV_INSTALL_MODULES:=on</span><br><span class="line">OPENCV_LIB_TYPE:=STATIC</span><br><span class="line"></span><br><span class="line">include $&#123;OPENCVROOT&#125;/sdk/native/jni/OpenCV.mk</span><br></pre></td></tr></table></figure><br>使用相对路径找到sdk，引入OpenCV的mk文件</p>
<h2 id="Android-NDK-通用-makefile-与相关配置"><a href="#Android-NDK-通用-makefile-与相关配置" class="headerlink" title="Android NDK 通用 makefile 与相关配置"></a>Android NDK 通用 makefile 与相关配置</h2><p><code>Android.mk</code><br><figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line">LOCAL_MODULE := waveExtract</span><br><span class="line">TARGET_ARCH_ABI := all</span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES := src/wave_display.c src/FFT.c</span><br><span class="line"></span><br><span class="line">LOCAL_LDLIBS+= -L<span class="variable">$(SYSROOT)</span>/usr/lib -llog</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_SHARED_LIBRARY)</span></span><br></pre></td></tr></table></figure></p>
<hr>
<p><code>Application.mk</code><br><figure class="highlight mk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">APP_PLATFORM := android-19</span><br><span class="line">APP_MODULES := waveExtract</span><br><span class="line">APP_ABI := armeabi-v7a arm64-v8a</span><br><span class="line">APP_STL := stlport_static</span><br><span class="line">APP_CPPFLAGS += -fexceptions</span><br><span class="line"><span class="comment"># for using c++ features,you need to enable these in your Makefile</span></span><br><span class="line">APP_CPP_FEATURES += exceptions rtti</span><br></pre></td></tr></table></figure></p>
<hr>
<p><code>build.gradle</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#x27;com.android.library&#x27;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion 28</span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion 19</span><br><span class="line">        targetSdkVersion 28</span><br><span class="line">        versionCode 1</span><br><span class="line">        versionName &quot;1.0&quot;</span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled false</span><br><span class="line">            proguardFiles getDefaultProguardFile(&#x27;proguard-android.txt&#x27;), &#x27;proguard-rules.pro&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        main &#123;</span><br><span class="line">            jni.srcDirs = []</span><br><span class="line">            jniLibs.srcDirs = [&#x27;src/main/libs&#x27;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation fileTree(dir: &#x27;libs&#x27;, include: [&#x27;*.jar&#x27;])</span><br><span class="line"></span><br><span class="line">    implementation &#x27;com.android.support:appcompat-v7:28.+&#x27;</span><br><span class="line">    testImplementation &#x27;junit:junit:4.12&#x27;</span><br><span class="line">    androidTestImplementation &#x27;com.android.support.test:runner:1.0.2&#x27;</span><br><span class="line">    androidTestImplementation &#x27;com.android.support.test.espresso:espresso-core:3.0.2&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-04-19T13:52:11.000Z" title="2018/4/19 21:52:11">2018-04-19</time>发表</span><span class="level-item"><time dateTime="2019-08-01T06:45:36.000Z" title="2019/8/1 14:45:36">2019-08-01</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">3 分钟读完 (大约416个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/04/19/Android/Android-Activity_View_get_size/">Activity中获取View的宽高</a></p><div class="content"><p>有些时候我们需要获取到View的宽高信息。在onCreate和onResume中尝试view.getWidth()或是view.getHeiht()时，我们会发现获取到的是0。<br>Activity视图在创建完成后，各个子view并不一定被加载完成。<br>获取宽高正确的方法有哪些呢？</p>
<h2 id="方法1-在Activity的onWindowFocusChanged获取宽高"><a href="#方法1-在Activity的onWindowFocusChanged获取宽高" class="headerlink" title="方法1 - 在Activity的onWindowFocusChanged获取宽高"></a>方法1 - 在Activity的<code>onWindowFocusChanged</code>获取宽高</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onWindowFocusChanged</span><span class="params">(<span class="type">boolean</span> hasFocus)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onWindowFocusChanged(hasFocus);</span><br><span class="line">    <span class="comment">// 在这里我们可以获取到View的真实宽高</span></span><br><span class="line">    Log.d(TAG, <span class="string">&quot;onWindowFocusChanged: mBtn1.getWidth == &quot;</span> + mBtn1.getWidth());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="方法2-使用ViewTreeObserver的OnGlobalLayoutListener回调"><a href="#方法2-使用ViewTreeObserver的OnGlobalLayoutListener回调" class="headerlink" title="方法2 - 使用ViewTreeObserver的OnGlobalLayoutListener回调"></a>方法2 - 使用ViewTreeObserver的<code>OnGlobalLayoutListener</code>回调</h2><p>获取View的ViewTreeObserver，添加回调<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ViewTreeObserver</span> <span class="variable">vto</span> <span class="operator">=</span> mBtn1.getViewTreeObserver();</span><br><span class="line">vto.addOnGlobalLayoutListener(<span class="keyword">new</span> <span class="title class_">ViewTreeObserver</span>.OnGlobalLayoutListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGlobalLayout</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> mBtn1.getHeight();</span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> mBtn1.getWidth();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onGlobalLayout: mBtn1 &quot;</span> + width + <span class="string">&quot;, &quot;</span> + height);</span><br><span class="line">        mBtn1.getViewTreeObserver().removeOnGlobalLayoutListener(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="方法3-使用View-post-Runnable-action-方法"><a href="#方法3-使用View-post-Runnable-action-方法" class="headerlink" title="方法3 - 使用View.post(Runnable action)方法"></a>方法3 - 使用<code>View.post(Runnable action)</code>方法</h2><p>例如我们在onCreate中post一个Runnable<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        mBtn1 = findViewById(R.id.btn1);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;mBtn1 post runnable&quot;</span>);</span><br><span class="line">        mBtn1.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;mBtn1: &quot;</span> + mBtn1.getWidth() + <span class="string">&quot;, &quot;</span> + mBtn1.getHeight());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* log</span></span><br><span class="line"><span class="comment">06-19 11:54:17.865 28009-28009/com.rustfisher.basic4 D/rustApp: mBtn1 post runnable</span></span><br><span class="line"><span class="comment">06-19 11:54:17.867 28009-28009/com.rustfisher.basic4 D/rustApp: [act2] onResume</span></span><br><span class="line"><span class="comment">06-19 11:54:17.899 28009-28009/com.rustfisher.basic4 D/rustApp: mBtn1: 355, 144</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><br>可以获取到view的宽高。从log的时间上可以看出，在view加载完毕后，执行的Runnable。</p>
<h2 id="应用-动态调整ImageView的宽高"><a href="#应用-动态调整ImageView的宽高" class="headerlink" title="应用 - 动态调整ImageView的宽高"></a>应用 - 动态调整ImageView的宽高</h2><p>获取到view的宽高后，我们可以动态地调整ImageView的高度。<br>假设图片宽高为704 * 440。xml中设置scaleType为fitXY。已知ImageView的宽度是固定的，我们可以调整高度。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:scaleType</span>=<span class="string">&quot;fitXY&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>根据图片真实大小来重设ImageView的高度。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onWindowFocusChanged</span><span class="params">(<span class="type">boolean</span> hasFocus)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onWindowFocusChanged(hasFocus);</span><br><span class="line">    resetIntroIvParams();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resetIntroIvParams</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> mIntroIv.getHeight(); <span class="comment">// 704 * 440</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">wid</span> <span class="operator">=</span> mIntroIv.getWidth();</span><br><span class="line">    <span class="keyword">if</span> (height &gt; <span class="number">0</span> &amp;&amp; wid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ViewGroup.<span class="type">LayoutParams</span> <span class="variable">layoutParams</span> <span class="operator">=</span> mIntroIv.getLayoutParams();</span><br><span class="line">        layoutParams.height = (<span class="type">int</span>) (wid * <span class="number">440.0</span> / <span class="number">704.0</span>);</span><br><span class="line">        mIntroIv.setLayoutParams(layoutParams);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-03-01T13:21:16.000Z" title="2018/3/1 21:21:16">2018-03-01</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:24.530Z" title="2021/6/18 17:38:24">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">11 分钟读完 (大约1608个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/03/01/Android/Android-MediaMuxer_MediaExtractor_mp4/">Android 使用 MediaExtractor 和 MediaMuxer 解析和封装 mp4 文件</a></p><div class="content"><p>本文目的：使用 MediaExtractor 和 MediaMuxer 解析和封装 mp4 文件</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>MP4或称MPEG-4第14部分（英语：MPEG-4 Part 14）是一种标准的数字多媒体容器格式。</p>
<p>MP4中的音频格式通常为AAC(audio/mp4a-latm)</p>
<h4 id="MediaExtractor"><a href="#MediaExtractor" class="headerlink" title="MediaExtractor"></a>MediaExtractor</h4><p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaExtractor.html">MediaExtractor</a> 可用于分离多媒体容器中视频track和音频track</p>
<p><code>setDataSource()</code> 设置数据源，数据源可以是本地文件地址，也可以是网络地址</p>
<p><code>getTrackFormat(int index)</code> 来获取各个track的<code>MediaFormat</code>，通过<code>MediaFormat</code>来获取track的详细信息，如：MimeType、分辨率、采样频率、帧率等等</p>
<p><code>selectTrack(int index)</code> 通过下标选择指定的通道</p>
<p><code>readSampleData(ByteBuffer buffer, int offset)</code> 获取当前编码好的数据并存在指定好偏移量的buffer中</p>
<h4 id="MediaMuxer"><a href="#MediaMuxer" class="headerlink" title="MediaMuxer"></a>MediaMuxer</h4><p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaMuxer.html">MediaMuxer</a> 可用于混合基本码流。将所有的信道的信息合成一个视频。<br>目前输出格式支持MP4，Webm，3GP。从Android Nougat开始支持向MP4中混入B-frames。</p>
<h3 id="提取并输出MP4文件中的视频部分"><a href="#提取并输出MP4文件中的视频部分" class="headerlink" title="提取并输出MP4文件中的视频部分"></a>提取并输出MP4文件中的视频部分</h3><p>从一个MP4文件中提取出视频，得到不含音频的MP4文件。</p>
<p>实现流程，首先是使用<code>MediaExtractor</code>提取，然后使用<code>MediaMuxer</code>输出MP4文件。</p>
<ul>
<li><code>MediaExtractor</code>设置数据源，找到并选择视频轨道的格式和下标</li>
<li><code>MediaMuxer</code>设置输出格式为<code>MUXER_OUTPUT_MPEG_4</code>，添加前面选定的格式，调用<code>start()</code>启动</li>
<li><code>MediaExtractor</code>读取帧数据，不停地将帧数据和相关信息传入<code>MediaMuxer</code></li>
<li>最后停止并释放<code>MediaMuxer</code>和<code>MediaExtractor</code><br>最好放在子线程中操作。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提取视频</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sourceVideoPath 原始视频文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception 出错</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">extractVideo</span><span class="params">(String sourceVideoPath, String outVideoPath)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">MediaExtractor</span> <span class="variable">sourceMediaExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">    sourceMediaExtractor.setDataSource(sourceVideoPath);</span><br><span class="line">    <span class="type">int</span> <span class="variable">numTracks</span> <span class="operator">=</span> sourceMediaExtractor.getTrackCount();</span><br><span class="line">    <span class="type">int</span> <span class="variable">sourceVideoTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// 原始视频文件视频轨道参数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numTracks; ++i) &#123;</span><br><span class="line">        <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> sourceMediaExtractor.getTrackFormat(i);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mime</span> <span class="operator">=</span> format.getString(MediaFormat.KEY_MIME);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;MediaFormat: &quot;</span> + mime);</span><br><span class="line">        <span class="keyword">if</span> (mime.startsWith(<span class="string">&quot;video/&quot;</span>)) &#123;</span><br><span class="line">            sourceMediaExtractor.selectTrack(i);</span><br><span class="line">            sourceVideoTrackIndex = i;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;selectTrack index=&quot;</span> + i + <span class="string">&quot;; format: &quot;</span> + mime);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">MediaMuxer</span> <span class="variable">outputMediaMuxer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaMuxer</span>(outVideoPath,</span><br><span class="line">            MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line">    outputMediaMuxer.addTrack(sourceMediaExtractor.getTrackFormat(sourceVideoTrackIndex));</span><br><span class="line">    outputMediaMuxer.start();</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">inputBuffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">2</span>); <span class="comment">// 分配的内存要尽量大一些</span></span><br><span class="line">    MediaCodec.<span class="type">BufferInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">    <span class="type">int</span> sampleSize;</span><br><span class="line">    <span class="keyword">while</span> ((sampleSize = sourceMediaExtractor.readSampleData(inputBuffer, <span class="number">0</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">presentationTimeUs</span> <span class="operator">=</span> sourceMediaExtractor.getSampleTime();</span><br><span class="line">        info.offset = <span class="number">0</span>;</span><br><span class="line">        info.size = sampleSize;</span><br><span class="line">        info.flags = MediaCodec.BUFFER_FLAG_SYNC_FRAME;</span><br><span class="line">        info.presentationTimeUs = presentationTimeUs;</span><br><span class="line">        outputMediaMuxer.writeSampleData(sourceVideoTrackIndex, inputBuffer, info);</span><br><span class="line">        sourceMediaExtractor.advance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    outputMediaMuxer.stop();</span><br><span class="line">    outputMediaMuxer.release();    <span class="comment">// 停止并释放 MediaMuxer</span></span><br><span class="line">    sourceMediaExtractor.release();</span><br><span class="line">    sourceMediaExtractor = <span class="literal">null</span>;   <span class="comment">// 释放 MediaExtractor</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
如果上面的<code>ByteBuffer</code>分配的空间太小，<code>readSampleData(inputBuffer, 0)</code>可能会出现<code>IllegalArgumentException</code>异常。</li>
</ul>
<h3 id="提取MP4文件中的音频部分，获取音频文件"><a href="#提取MP4文件中的音频部分，获取音频文件" class="headerlink" title="提取MP4文件中的音频部分，获取音频文件"></a>提取MP4文件中的音频部分，获取音频文件</h3><h4 id="基于Java-MP4-Parser提取出AAC文件的方法"><a href="#基于Java-MP4-Parser提取出AAC文件的方法" class="headerlink" title="基于Java MP4 Parser提取出AAC文件的方法"></a>基于<code>Java MP4 Parser</code>提取出AAC文件的方法</h4><p><code>Java MP4 Parser</code> - <a target="_blank" rel="noopener" href="https://github.com/sannies/mp4parser">https://github.com/sannies/mp4parser</a><br>Java实现读、写和创建MP4容器。但是和编解码音视频有区别。这里主要是提取与再合成。</p>
<p>下载<code>isoparser-1.1.22.jar</code>并添加进工程中；尝试过gradle直接导入，但不成功</p>
<p>找到视频文件中所有的音轨，将它们提取出来写入新的文件中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">extractAudioFromMP4</span><span class="params">(String outAudioPath, String sourceMP4Path)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Movie</span> <span class="variable">movie</span> <span class="operator">=</span> MovieCreator.build(sourceMP4Path);</span><br><span class="line">    List&lt;Track&gt; audioTracks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Track t : movie.getTracks()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t.getHandler().equals(<span class="string">&quot;soun&quot;</span>)) &#123;</span><br><span class="line">            audioTracks.add(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Movie</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Movie</span>();</span><br><span class="line">    <span class="keyword">if</span> (audioTracks.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        result.addTrack(<span class="keyword">new</span> <span class="title class_">AppendTrack</span>(audioTracks.toArray(<span class="keyword">new</span> <span class="title class_">Track</span>[audioTracks.size()])));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Container</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMp4Builder</span>().build(result);</span><br><span class="line">    <span class="type">FileChannel</span> <span class="variable">fc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(outAudioPath, <span class="string">&quot;rw&quot;</span>).getChannel();</span><br><span class="line">    out.writeContainer(fc);</span><br><span class="line">    fc.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>在红米手机上测试成功。从MP4文件（时长约2分20秒）中提取出的AAC文件可在手机上直接播放。</p>
<h3 id="将AAC音轨换到另一个MP4文件"><a href="#将AAC音轨换到另一个MP4文件" class="headerlink" title="将AAC音轨换到另一个MP4文件"></a>将AAC音轨换到另一个MP4文件</h3><p>MediaExtractor可以直接从提取AAC文件或MP4文件中提取ACC音轨，MediaMuxer来写入新的MP4文件。</p>
<p>提供音频的文件可以是MP4文件，也可以是AAC文件；另一个提供视频，混合输出新的MP4文件。</p>
<p>生成的视频的长度由提供视频的文件决定。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> outputVideoFilePath 输出视频文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> videoProviderPath   提供视频的MP4文件 时长以此为准</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> audioProviderPath   提供音频的文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception 运行异常  例如读写文件异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">replaceAudioForMP4File</span><span class="params">(String outputVideoFilePath, String videoProviderPath,</span></span><br><span class="line"><span class="params">                                          String audioProviderPath)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">MediaMuxer</span> <span class="variable">mediaMuxer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaMuxer</span>(outputVideoFilePath,</span><br><span class="line">            MediaMuxer.OutputFormat.MUXER_OUTPUT_MPEG_4);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 视频 MediaExtractor</span></span><br><span class="line">    <span class="type">MediaExtractor</span> <span class="variable">mVideoExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">    mVideoExtractor.setDataSource(videoProviderPath);</span><br><span class="line">    <span class="type">int</span> <span class="variable">videoTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mVideoExtractor.getTrackCount(); i++) &#123;</span><br><span class="line">        <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> mVideoExtractor.getTrackFormat(i);</span><br><span class="line">        <span class="keyword">if</span> (format.getString(MediaFormat.KEY_MIME).startsWith(<span class="string">&quot;video/&quot;</span>)) &#123;</span><br><span class="line">            mVideoExtractor.selectTrack(i);</span><br><span class="line">            videoTrackIndex = mediaMuxer.addTrack(format);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Video: format:&quot;</span> + format);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 音频 MediaExtractor</span></span><br><span class="line">    <span class="type">MediaExtractor</span> <span class="variable">audioExtractor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaExtractor</span>();</span><br><span class="line">    audioExtractor.setDataSource(audioProviderPath);</span><br><span class="line">    <span class="type">int</span> <span class="variable">audioTrackIndex</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; audioExtractor.getTrackCount(); i++) &#123;</span><br><span class="line">        <span class="type">MediaFormat</span> <span class="variable">format</span> <span class="operator">=</span> audioExtractor.getTrackFormat(i);</span><br><span class="line">        <span class="keyword">if</span> (format.getString(MediaFormat.KEY_MIME).startsWith(<span class="string">&quot;audio/&quot;</span>)) &#123;</span><br><span class="line">            audioExtractor.selectTrack(i);</span><br><span class="line">            audioTrackIndex = mediaMuxer.addTrack(format);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Audio: format:&quot;</span> + format);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mediaMuxer.start(); <span class="comment">// 添加完所有轨道后start</span></span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">videoEndPreTimeUs</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 封装视频track</span></span><br><span class="line">    <span class="keyword">if</span> (-<span class="number">1</span> != videoTrackIndex) &#123;</span><br><span class="line">        MediaCodec.<span class="type">BufferInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">        info.presentationTimeUs = <span class="number">0</span>;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">        <span class="type">int</span> sampleSize;</span><br><span class="line">        <span class="keyword">while</span> ((sampleSize = mVideoExtractor.readSampleData(buffer, <span class="number">0</span>)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            info.offset = <span class="number">0</span>;</span><br><span class="line">            info.size = sampleSize;</span><br><span class="line">            info.flags = MediaCodec.BUFFER_FLAG_SYNC_FRAME;</span><br><span class="line">            info.presentationTimeUs = mVideoExtractor.getSampleTime();</span><br><span class="line">            videoEndPreTimeUs = info.presentationTimeUs;</span><br><span class="line">            mediaMuxer.writeSampleData(videoTrackIndex, buffer, info);</span><br><span class="line">            mVideoExtractor.advance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;视频 videoEndPreTimeUs &quot;</span> + videoEndPreTimeUs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装音频track</span></span><br><span class="line">    <span class="keyword">if</span> (-<span class="number">1</span> != audioTrackIndex) &#123;</span><br><span class="line">        MediaCodec.<span class="type">BufferInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">        info.presentationTimeUs = <span class="number">0</span>;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">        <span class="type">int</span> sampleSize;</span><br><span class="line">        <span class="keyword">while</span> ((sampleSize = audioExtractor.readSampleData(buffer, <span class="number">0</span>)) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">                audioExtractor.getSampleTime() &lt;= videoEndPreTimeUs) &#123;</span><br><span class="line">            info.offset = <span class="number">0</span>;</span><br><span class="line">            info.size = sampleSize;</span><br><span class="line">            info.flags = MediaCodec.BUFFER_FLAG_SYNC_FRAME;</span><br><span class="line">            info.presentationTimeUs = audioExtractor.getSampleTime();</span><br><span class="line">            mediaMuxer.writeSampleData(audioTrackIndex, buffer, info);</span><br><span class="line">            audioExtractor.advance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mVideoExtractor.release(); <span class="comment">// 释放MediaExtractor</span></span><br><span class="line">    audioExtractor.release();</span><br><span class="line">    mediaMuxer.stop();</span><br><span class="line">    mediaMuxer.release();     <span class="comment">// 释放MediaMuxer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Video: format:&#123;csd-1=java.nio.ByteArrayBuffer[position=0,limit=9,capacity=9], mime=video/avc, frame-rate=30, height=1080, width=1920, max-input-size=1572864, isDMCMMExtractor=1, durationUs=12425577, csd-0=java.nio.ByteArrayBuffer[position=0,limit=20,capacity=20]&#125;</span><br><span class="line">Audio: format:&#123;max-input-size=5532, aac-profile=2, mime=audio/mp4a-latm, durationUs=340101875, csd-0=java.nio.ByteArrayBuffer[position=0,limit=2,capacity=2], channel-count=2, sample-rate=44100&#125;</span><br></pre></td></tr></table></figure>
<h3 id="MP3转换为AAC"><a href="#MP3转换为AAC" class="headerlink" title="MP3转换为AAC"></a>MP3转换为AAC</h3><h4 id="使用-AndroidAudioConverter"><a href="#使用-AndroidAudioConverter" class="headerlink" title="使用 AndroidAudioConverter"></a>使用 AndroidAudioConverter</h4><p>AndroidAudioConverter - <a target="_blank" rel="noopener" href="https://github.com/adrielcafe/AndroidAudioConverter">https://github.com/adrielcafe/AndroidAudioConverter</a></p>
<p>基于FFmpeg的第三方库。支持格式有AAC, MP3, M4A, WMA, WAV 和 FLAC</p>
<p>使用方法：</p>
<p><code>app/build.gradle</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">  maven &#123;</span><br><span class="line">    url &quot;https://jitpack.io&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">  compile &#x27;com.github.adrielcafe:AndroidAudioConverter:0.0.8&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>申请读写外部存储权限<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><br>在<code>Application</code>类中加载库<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MuxerApp</span> <span class="keyword">extends</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate();</span><br><span class="line">        AndroidAudioConverter.load(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">ILoadCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">// Great!</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">                <span class="comment">// FFmpeg is not supported by device</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>使用转换功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">sourceMP3Path</span> <span class="operator">=</span> SOURCE_PATH + File.separator + <span class="string">&quot;music1.mp3&quot;</span>;</span><br><span class="line">Log.d(TAG, <span class="string">&quot;转换开始 &quot;</span> + sourceMP3Path);</span><br><span class="line"><span class="type">File</span> <span class="variable">srcFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(sourceMP3Path);</span><br><span class="line"><span class="type">IConvertCallback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IConvertCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(File convertedFile)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onSuccess: &quot;</span> + convertedFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Exception error)</span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;onFailure: &quot;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">AndroidAudioConverter.with(getApplicationContext())</span><br><span class="line">        <span class="comment">// Your current audio file</span></span><br><span class="line">        .setFile(srcFile)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Your desired audio format</span></span><br><span class="line">        .setFormat(AudioFormat.AAC)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// An callback to know when conversion is finished</span></span><br><span class="line">        .setCallback(callback)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start conversion</span></span><br><span class="line">        .convert();</span><br></pre></td></tr></table></figure></p>
<p>在三星Note4上测试，转换13MB的MP3文件用了大约3分18秒。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaExtractor.html">MediaExtractor - Android Developer</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaMuxer.html">MediaMuxer - Android Developer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sannies/mp4parser">Java MP4 Parser</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://rustfisher.com/tags/Android-Media/">Android音视频相关文章</a><br><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/12/08/Android_tutorial_2020/Android-tutorial_2020_a_menu/">Android tutorial 2020</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2018-02-05T12:56:57.000Z" title="2018/2/5 20:56:57">2018-02-05</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:37:37.907Z" title="2021/6/18 17:37:37">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">6 分钟读完 (大约952个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/02/05/Android/adb_mock_touch_and_monkeyrunner/">Android 模拟用户点击</a></p><div class="content"><p>Android模拟用户点击。在自动化测试中可使用的工具。<br>可以利用adb命令，也可以使用Android SDK中的<code>monkeyrunner</code>工具。</p>
<ul>
<li>win7-64</li>
<li>gitbash</li>
</ul>
<h1 id="使用adb命令"><a href="#使用adb命令" class="headerlink" title="使用adb命令"></a>使用adb命令</h1><p>主要使用input命令<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">usage: input ...</span><br><span class="line"></span><br><span class="line">       input text &lt;string&gt;</span><br><span class="line">       input keyevent &lt;key code number or name&gt;</span><br><span class="line">       input tap &lt;x&gt; &lt;y&gt;</span><br><span class="line">       input swipe &lt;x1&gt; &lt;y1&gt; &lt;x2&gt; &lt;y2&gt;</span><br></pre></td></tr></table></figure><br>keyevent指的是android对应的keycode，比如home键的keycode=3，back键的keycode=4</p>
<p>tap是touch屏幕的事件，只需给出x、y坐标即可</p>
<p>swipe模拟滑动的事件，给出起点和终点的坐标即可</p>
<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 模拟点击位置 (<span class="number">100</span>,<span class="number">100</span>)</span><br><span class="line">adb shell input tap <span class="number">100</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line"># 模拟滑动 从(<span class="number">650</span>, <span class="number">250</span>)到(<span class="number">200</span>,<span class="number">300</span>)</span><br><span class="line">adb shell input swipe <span class="number">650</span> <span class="number">250</span> <span class="number">200</span> <span class="number">300</span></span><br></pre></td></tr></table></figure>
<p>编写一个bat脚本，模拟用户滑动<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">echo</span> --------- Mock <span class="built_in">start</span> ----------</span><br><span class="line"></span><br><span class="line">:tag_start</span><br><span class="line"><span class="built_in">echo</span> running...</span><br><span class="line">adb shell input swipe <span class="number">650</span> <span class="number">250</span> <span class="number">200</span> <span class="number">666</span></span><br><span class="line">@<span class="built_in">ping</span> <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -n <span class="number">8</span> &gt;<span class="built_in">nul</span></span><br><span class="line"><span class="keyword">goto</span> tag_start</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> --------- Mock finish ---------</span><br><span class="line"><span class="built_in">pause</span></span><br></pre></td></tr></table></figure></p>
<p>死循环发送滑动命令，延时语句<br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">ping</span> <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -n <span class="number">8</span> &gt;<span class="built_in">nul</span></span><br></pre></td></tr></table></figure></p>
<h1 id="monkeyrunner"><a href="#monkeyrunner" class="headerlink" title="monkeyrunner"></a>monkeyrunner</h1><p>环境配置，配置好Java与Android SDK的环境变量。手机连接到电脑。<br>系统变量中加入<code>ANDROID_SWT</code>，此例中路径为<code>G:\SDK\tools\lib\x86_64</code></p>
<p>修改后的脚本<code>rustmonkeyrunner.bat</code>，Windows环境下需要在gitbash或CMD里运行</p>
<p>来自<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/44666939/unable-to-access-jarfile-framework-monkeyrunner-25-3-2-jar">unable-to-access-jarfile-framework-monkeyrunner-25-3-2-jar</a><br><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="comment">rem Copyright (C) 2010 The Android Open Source Project</span></span><br><span class="line"><span class="comment">rem</span></span><br><span class="line"><span class="comment">rem Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">rem you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">rem You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">rem</span></span><br><span class="line"><span class="comment">rem      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">rem</span></span><br><span class="line"><span class="comment">rem Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">rem distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">rem WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">rem See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">rem limitations under the License.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem don&#x27;t modify the caller&#x27;s environment</span></span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Set up prog to be the path of this script, including following symlinks,</span></span><br><span class="line"><span class="comment">rem and set up progdir to be the fully-qualified pathname of its directory.</span></span><br><span class="line"><span class="built_in">set</span> prog=%~f0</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Change current directory and drive to where the script is, to avoid</span></span><br><span class="line"><span class="comment">rem issues with directories containing whitespaces.</span></span><br><span class="line"><span class="built_in">cd</span> /d %~dp0</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">rem Check we have a valid Java.exe in the path.</span></span><br><span class="line"><span class="built_in">set</span> java_exe=</span><br><span class="line"><span class="keyword">call</span> ..\lib\find_java.bat</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> java_exe <span class="keyword">goto</span> :EOF</span><br><span class="line"><span class="keyword">for</span> /f <span class="variable">%%a</span> <span class="keyword">in</span> (&quot;<span class="variable">%APP_HOME%</span>\lib\monkeyrunner-<span class="number">25</span>.<span class="number">3</span>.<span class="number">2</span>.jar&quot;) <span class="keyword">do</span> <span class="built_in">set</span> jarfile=<span class="variable">%%~</span>nxa</span><br><span class="line"><span class="built_in">set</span> frameworkdir=.</span><br><span class="line"><span class="built_in">set</span> libdir=</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">exist</span> <span class="variable">%frameworkdir%</span>\<span class="variable">%jarfile%</span> <span class="keyword">goto</span> JarFileOk</span><br><span class="line">    <span class="built_in">set</span> frameworkdir=..\lib</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">exist</span> <span class="variable">%frameworkdir%</span>\<span class="variable">%jarfile%</span> <span class="keyword">goto</span> JarFileOk</span><br><span class="line">    <span class="built_in">set</span> frameworkdir=..\framework</span><br><span class="line"></span><br><span class="line">:JarFileOk</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> jarpath=<span class="variable">%frameworkdir%</span>\<span class="variable">%jarfile%</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">defined</span> ANDROID_SWT <span class="keyword">goto</span> QueryArch</span><br><span class="line">    <span class="built_in">set</span> swt_path=<span class="variable">%ANDROID_SWT%</span></span><br><span class="line">    <span class="keyword">goto</span> SwtDone</span><br><span class="line"></span><br><span class="line">:QueryArch</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> /f &quot;delims=&quot; <span class="variable">%%a</span> <span class="keyword">in</span> (&#x27;<span class="variable">%frameworkdir%</span>\..\bin\archquery&#x27;) <span class="keyword">do</span> <span class="built_in">set</span> swt_path=<span class="variable">%frameworkdir%</span>\<span class="variable">%%a</span></span><br><span class="line"></span><br><span class="line">:SwtDone</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">exist</span> &quot;<span class="variable">%swt_path%</span>&quot; <span class="keyword">goto</span> SetPath</span><br><span class="line">    <span class="built_in">echo</span> SWT folder &#x27;<span class="variable">%swt_path%</span>&#x27; does <span class="keyword">not</span> <span class="keyword">exist</span>.</span><br><span class="line">    <span class="built_in">echo</span> Please <span class="built_in">set</span> ANDROID_SWT to point to the folder containing swt.jar <span class="keyword">for</span> your platform.</span><br><span class="line">    <span class="keyword">exit</span> /B</span><br><span class="line"></span><br><span class="line">:SetPath</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> &quot;<span class="variable">%java_exe%</span>&quot; -Xmx512m &quot;-Djava.ext.dirs=<span class="variable">%frameworkdir%</span>;<span class="variable">%swt_path%</span>&quot; -Dcom.android.monkeyrunner.bindir=..\..\platform-tools -jar <span class="variable">%jarpath%</span> %*</span><br></pre></td></tr></table></figure></p>
<p>运行脚本<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC ~</span><br><span class="line">$ /cygdrive/g/SDK/tools/bin/rustmonkeyrunner.bat</span><br><span class="line">Jython 2.5.3 (2.5:c56500f08d34+, Aug 13 2012, 14:54:35)</span><br><span class="line">[Java HotSpot(TM) 64-Bit Server VM (Oracle Corporation)] on java1.8.0_77</span><br></pre></td></tr></table></figure></p>
<p>首次运行时import模块迟迟没有反应<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from com.android.monkeyrunner import MonkeyRunner, MonkeyDevice, MonkeyImage</span><br></pre></td></tr></table></figure></p>
<p>尝试运行脚本<code>an_test2.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;importing module...&quot;</span>)</span><br><span class="line"><span class="keyword">from</span> com.android.monkeyrunner <span class="keyword">import</span> MonkeyRunner, MonkeyDevice, MonkeyImage</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;waiting for connection...&quot;</span>)</span><br><span class="line">device = MonkeyRunner.waitForConnection()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;device found!&quot;</span>)</span><br><span class="line"></span><br><span class="line">s_wid = <span class="built_in">int</span>(device.getProperty(<span class="string">&quot;display.width&quot;</span>))     <span class="comment"># 获取屏幕宽度像素</span></span><br><span class="line">s_height = <span class="built_in">int</span>(device.getProperty(<span class="string">&quot;display.height&quot;</span>)) <span class="comment"># 获取屏幕高度像素</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;build.version.sdk &quot;</span> + <span class="built_in">str</span>(device.getProperty(<span class="string">&quot;build.version.sdk&quot;</span>)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;display.width     &quot;</span> + <span class="built_in">str</span>(s_wid))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;display.height    &quot;</span> + <span class="built_in">str</span>(s_height))</span><br><span class="line"></span><br><span class="line">drag_point_left_x = <span class="number">20</span></span><br><span class="line">drag_point_right_x = s_wid - <span class="number">20</span></span><br><span class="line">drag_point_y = s_height / <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;current loop is &quot;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">    device.drag((drag_point_right_x, drag_point_y), (drag_point_left_x, drag_point_y), <span class="number">1.0</span>, <span class="number">50</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;waiting...&quot;</span>)</span><br><span class="line">    MonkeyRunner.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;continue&quot;</span>)</span><br><span class="line">    device.drag((drag_point_left_x, drag_point_y), (drag_point_right_x, drag_point_y), <span class="number">0.5</span>, <span class="number">3</span>)</span><br><span class="line">    MonkeyRunner.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-------- finish --------&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>命令行直接执行，可以看到执行结果和相应的报错信息<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator&gt;G:\SDK\tools\bin\rustmonkeyrunner.bat H:\fisher_p\py_ws\an_test2.py</span><br><span class="line">importing module...</span><br><span class="line">waiting for connection...</span><br><span class="line">device found!</span><br><span class="line">build.version.sdk 23</span><br><span class="line">display.width     1440</span><br><span class="line">display.height    2560</span><br><span class="line">current loop is 0</span><br><span class="line">waiting...</span><br><span class="line">continue</span><br><span class="line">current loop is 1</span><br><span class="line"># .....</span><br><span class="line">-------- finish --------</span><br></pre></td></tr></table></figure><br>测试中发现，脚本可以运行在系统app。若当前打开的是第三方app，会直接报错，获取不到相应信息</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15935622/getproperty-getsystemproperty-in-monkeyrunner-return-none">monkeyrunner 获取系统信息</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/studio/test/monkeyrunner/MonkeyDevice.html">Android MonkeyDevice - Google</a></li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-12-20T12:59:14.000Z" title="2017/12/20 20:59:14">2017-12-20</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:21.799Z" title="2021/6/18 17:38:21">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">16 分钟读完 (大约2460个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/12/20/Android/Android-MediaCodec_use_demo/">Android MediaCodec 编解码</a></p><div class="content"><h2 id="Android-MediaCodec-使用方式"><a href="#Android-MediaCodec-使用方式" class="headerlink" title="Android MediaCodec 使用方式"></a>Android MediaCodec 使用方式</h2><p>使用MediaCodec进行编解码。输入H.264格式的数据，输出帧数据并发送给监听器。  </p>
<h4 id="H-264的配置"><a href="#H-264的配置" class="headerlink" title="H.264的配置"></a>H.264的配置</h4><p>创建并配置codec。配置codec时，若手动创建MediaFormat对象的话，一定要记得<strong>设置”csd-0”和”csd-1”这两个参数</strong>。<br>“csd-0”和”csd-1”这两个参数一定要和接收到的帧对应上。  </p>
<h4 id="输入数据"><a href="#输入数据" class="headerlink" title="输入数据"></a>输入数据</h4><p>给codec输入数据时，如果对输入数据进行排队，需要检查排队队列的情况。<br>例如一帧数据暂用1M内存，1秒30帧，排队队列有可能会暂用30M的内存。当内存暂用过高，我们需要采取一定的措施来减小内存占用。<br>codec硬解码时会受到手机硬件的影响。若手机性能不佳，编解码的速度有可能慢于原始数据输入。不得已的情况我们可以将排队中的旧数据抛弃，输入新数据。  </p>
<h4 id="解码器性能"><a href="#解码器性能" class="headerlink" title="解码器性能"></a>解码器性能</h4><p>对视频实时性要求高的场景，codec没有可用的输入缓冲区，<code>mCodec.dequeueInputBuffer</code>返回-1。<br>为了实时性，这里会强制释放掉输入输出缓冲区<code>mCodec.flush()</code>。  </p>
<h4 id="问题1-MediaCodec输入数据和输出数据数量之间有没有特定的关系"><a href="#问题1-MediaCodec输入数据和输出数据数量之间有没有特定的关系" class="headerlink" title="问题1 - MediaCodec输入数据和输出数据数量之间有没有特定的关系"></a>问题1 - MediaCodec输入数据和输出数据数量之间有没有特定的关系</h4><p>对于MediaCodec，输入数据和输出数据数量之间有没有特定的关系？假设输入10帧的数据，可以得到多少次输出？</p>
<p>实测发现，不能百分百保证输入输出次数是相等的。例如vivo x6 plus，输入30帧，能得到28帧结果。或者300次输入，得到298次输出。</p>
<h4 id="异常1-dequeueInputBuffer-0-一直返回-1"><a href="#异常1-dequeueInputBuffer-0-一直返回-1" class="headerlink" title="异常1 - dequeueInputBuffer(0)一直返回-1"></a>异常1 - dequeueInputBuffer(0)一直返回-1</h4><p>某些手机长时间编解码后，可能会出现尝试获取codec输入缓冲区时下标一直返回-1。<br>例如vivo x6 plus，运行约20分钟后，<code>mCodec.dequeueInputBuffer(0)</code>一直返回-1。</p>
<p>处理方法：如果一直返回-1，同步方式下尝试调用<code>codec.flush()</code>方法，异步方式下尝试<code>codec.flush()</code>后再调用<code>codec.start()</code>方法。</p>
<p>有一些手机解码速度太慢，有可能会经常返回-1。不要频繁调用<code>codec.flush()</code>，以免显示不正常。</p>
<h3 id="代码示例-同步方式进行编解码"><a href="#代码示例-同步方式进行编解码" class="headerlink" title="代码示例 - 同步方式进行编解码"></a>代码示例 - 同步方式进行编解码</h3><p>这一个例子使用同步方式进行编解码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解码器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodecDecoder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;CodecDecoder&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MIME_TYPE</span> <span class="operator">=</span> <span class="string">&quot;video/avc&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CSD0</span> <span class="operator">=</span> <span class="string">&quot;csd-0&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CSD1</span> <span class="operator">=</span> <span class="string">&quot;csd-1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIME_INTERNAL</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DECODER_TIME_INTERNAL</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MediaCodec mCodec;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">mCount</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 媒体解码器MediaCodec用的</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 送入编解码器前的缓冲队列</span></span><br><span class="line">    <span class="comment">// 需要实时监控这个队列所暂用的内存情况  在这里堵塞的话很容易引起OOM</span></span><br><span class="line">    <span class="keyword">private</span> Queue&lt;<span class="type">byte</span>[]&gt; data = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DecoderThread decoderThread;</span><br><span class="line">    <span class="keyword">private</span> CodecListener listener; <span class="comment">// 自定义的监听器  当解码得到帧数据时通过它发送出去</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CodecDecoder</span><span class="params">()</span> &#123;</span><br><span class="line">        data = <span class="keyword">new</span> <span class="title class_">ConcurrentLinkedQueue</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCodecCreated</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mCodec!=<span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">createCodec</span><span class="params">(CodecListener listener, <span class="type">byte</span>[] spsBuffer, <span class="type">byte</span>[] ppsBuffer, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.listener = listener;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mCodec = MediaCodec.createDecoderByType(Constants.MIME_TYPE);</span><br><span class="line">            <span class="type">MediaFormat</span> <span class="variable">mediaFormat</span> <span class="operator">=</span> createVideoFormat(spsBuffer, ppsBuffer, width, height);</span><br><span class="line">            mCodec.configure(mediaFormat, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">            mCodec.start();</span><br><span class="line"></span><br><span class="line">            Log.d(TAG, <span class="string">&quot;decoderThread mediaFormat in:&quot;</span> + mediaFormat);</span><br><span class="line"></span><br><span class="line">            decoderThread = <span class="keyword">new</span> <span class="title class_">DecoderThread</span>();</span><br><span class="line">            decoderThread.start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;MediaCodec create error:&quot;</span> + e.getMessage());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MediaFormat <span class="title function_">createVideoFormat</span><span class="params">(<span class="type">byte</span>[] spsBuffer, <span class="type">byte</span>[] ppsBuffer, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        MediaFormat mediaFormat;</span><br><span class="line">        mediaFormat = MediaFormat.createVideoFormat(MIME_TYPE, width, height);</span><br><span class="line">        mediaFormat.setByteBuffer(CSD0, ByteBuffer.wrap(spsBuffer));</span><br><span class="line">        mediaFormat.setByteBuffer(CSD1, ByteBuffer.wrap(ppsBuffer));</span><br><span class="line">        mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT,</span><br><span class="line">                MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Flexible);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mediaFormat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastInQueueTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输入H.264帧数据  这里会监控排队情况</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addData</span><span class="params">(<span class="type">byte</span>[] dataBuffer)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timeDiff</span> <span class="operator">=</span> System.currentTimeMillis() - lastInQueueTime;</span><br><span class="line">        <span class="keyword">if</span> (timeDiff &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            lastInQueueTime = System.currentTimeMillis();</span><br><span class="line">            <span class="type">int</span> <span class="variable">queueSize</span> <span class="operator">=</span> data.size(); <span class="comment">// ConcurrentLinkedQueue查询长度时会遍历一次 在数据量巨大的情况下尽量少用这个方法</span></span><br><span class="line">            <span class="keyword">if</span> (queueSize &gt; <span class="number">30</span>) &#123;</span><br><span class="line">                data.clear();</span><br><span class="line">                LogInFile.getLogger().e(<span class="string">&quot;frame queue 帧数据队列超出上限，自动清除数据 &quot;</span> + queueSize);</span><br><span class="line">            &#125;</span><br><span class="line">            data.add(dataBuffer.clone());</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;frame queue 添加一帧数据&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LogInFile.getLogger().e(<span class="string">&quot;frame queue 添加速度太快,跳过此帧. timeDiff=&quot;</span> + timeDiff);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroyCodec</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCodec != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(data!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    data.clear();</span><br><span class="line">                    data = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(decoderThread!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    decoderThread.stopThread();</span><br><span class="line">                    decoderThread = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mCodec.release();</span><br><span class="line">                mCodec = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;destroyCodec exception:&quot;</span> + e.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">DecoderThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INPUT_BUFFER_FULL_COUNT_MAX</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> isRunning;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">inputBufferFullCount</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 输入缓冲区满了多少次</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopThread</span><span class="params">()</span> &#123;</span><br><span class="line">            isRunning = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            setName(<span class="string">&quot;CodecDecoder_DecoderThread-&quot;</span> + getId());</span><br><span class="line">            isRunning = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (isRunning) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (data != <span class="literal">null</span> &amp;&amp; !data.isEmpty()) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">inputBufferIndex</span> <span class="operator">=</span> mCodec.dequeueInputBuffer(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span> (inputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="type">byte</span>[] buf = data.poll();</span><br><span class="line">                            <span class="type">ByteBuffer</span> <span class="variable">inputBuffer</span> <span class="operator">=</span> mCodec.getInputBuffer(inputBufferIndex);</span><br><span class="line">                            <span class="keyword">if</span> (<span class="literal">null</span> != inputBuffer) &#123;</span><br><span class="line">                                inputBuffer.clear();</span><br><span class="line">                                inputBuffer.put(buf, <span class="number">0</span>, buf.length);</span><br><span class="line">                                mCodec.queueInputBuffer(inputBufferIndex, <span class="number">0</span>,</span><br><span class="line">                                        buf.length, mCount * TIME_INTERNAL, <span class="number">0</span>);</span><br><span class="line">                                mCount++;</span><br><span class="line">                            &#125;</span><br><span class="line">                            inputBufferFullCount = <span class="number">0</span>; <span class="comment">// 还有缓冲区可以用的时候重置计数</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            inputBufferFullCount++;</span><br><span class="line">                            LogInFile.getLogger().e(TAG, <span class="string">&quot;decoderThread inputBuffer full.  inputBufferFullCount=&quot;</span> + inputBufferFullCount);</span><br><span class="line">                            <span class="keyword">if</span> (inputBufferFullCount &gt; INPUT_BUFFER_FULL_COUNT_MAX) &#123;</span><br><span class="line">                                mCount = <span class="number">0</span>;</span><br><span class="line">                                mCodec.flush(); <span class="comment">// 在这里清除所有缓冲区</span></span><br><span class="line">                                LogInFile.getLogger().e(TAG, <span class="string">&quot;mCodec.flush()...&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Get output buffer index</span></span><br><span class="line">                    MediaCodec.<span class="type">BufferInfo</span> <span class="variable">bufferInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaCodec</span>.BufferInfo();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">outputBufferIndex</span> <span class="operator">=</span> mCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">while</span> (outputBufferIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> outputBufferIndex;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;releaseOutputBuffer &quot;</span> + Thread.currentThread().toString());</span><br><span class="line">                        <span class="keyword">final</span> <span class="type">ByteBuffer</span> <span class="variable">outputBuffer</span> <span class="operator">=</span> byteBufferClone(mCodec.getOutputBuffer(index));</span><br><span class="line">                        <span class="type">Image</span> <span class="variable">image</span> <span class="operator">=</span> mCodec.getOutputImage(index);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="literal">null</span> != image) &#123;</span><br><span class="line">                            <span class="comment">// 获取NV21格式的数据</span></span><br><span class="line">                            <span class="keyword">final</span> <span class="type">byte</span>[] nv21 = ImageUtil.getDataFromImage(image, FaceDetectUtil.COLOR_FormatNV21);</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">imageWid</span> <span class="operator">=</span> image.getWidth();</span><br><span class="line">                            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">imageHei</span> <span class="operator">=</span> image.getHeight();</span><br><span class="line">                            <span class="comment">// 这里选择创建新的线程去发送数据 - 这是可优化的地方</span></span><br><span class="line">                            <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                                    listener.onDataDecoded(outputBuffer,</span><br><span class="line">                                            mCodec.getOutputFormat().getInteger(MediaFormat.KEY_COLOR_FORMAT),</span><br><span class="line">                                            nv21, imageWid, imageHei);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;).start();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            listener.onDataDecoded(outputBuffer,</span><br><span class="line">                                    mCodec.getOutputFormat().getInteger(MediaFormat.KEY_COLOR_FORMAT),</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0</span>&#125;, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mCodec.releaseOutputBuffer(index, <span class="literal">false</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">                            android.util.Log.e(TAG, <span class="string">&quot;releaseOutputBuffer ERROR&quot;</span>, ex);</span><br><span class="line">                        &#125;</span><br><span class="line">                        outputBufferIndex = mCodec.dequeueOutputBuffer(bufferInfo, <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;decoderThread exception:&quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(DECODER_TIME_INTERNAL);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deep clone byteBuffer</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ByteBuffer <span class="title function_">byteBufferClone</span><span class="params">(ByteBuffer buffer)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (buffer.remaining() == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ByteBuffer.wrap(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">clone</span> <span class="operator">=</span> ByteBuffer.allocate(buffer.remaining());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (buffer.hasArray()) &#123;</span><br><span class="line">            System.arraycopy(buffer.array(), buffer.arrayOffset() + buffer.position(), clone.array(), <span class="number">0</span>, buffer.remaining());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            clone.put(buffer.duplicate());</span><br><span class="line">            clone.flip();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> clone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h3 id="代码示例-工具函数"><a href="#代码示例-工具函数" class="headerlink" title="代码示例 - 工具函数"></a>代码示例 - 工具函数</h3><p>一些工具函数。比如从image中取出NV21格式的数据。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] getDataFromImage(Image image) &#123;</span><br><span class="line">    <span class="keyword">return</span> getDataFromImage(image, COLOR_FormatNV21);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将Image根据colorFormat类型的byte数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] getDataFromImage(Image image, <span class="type">int</span> colorFormat) &#123;</span><br><span class="line">    <span class="keyword">if</span> (colorFormat != COLOR_FormatI420 &amp;&amp; colorFormat != COLOR_FormatNV21) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;only support COLOR_FormatI420 &quot;</span> + <span class="string">&quot;and COLOR_FormatNV21&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isImageFormatSupported(image)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;can&#x27;t convert Image to byte array, format &quot;</span> + image.getFormat());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Rect</span> <span class="variable">crop</span> <span class="operator">=</span> image.getCropRect();</span><br><span class="line">    <span class="type">int</span> <span class="variable">format</span> <span class="operator">=</span> image.getFormat();</span><br><span class="line">    <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> crop.width();</span><br><span class="line">    <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> crop.height();</span><br><span class="line">    Image.Plane[] planes = image.getPlanes();</span><br><span class="line">    <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[width * height * ImageFormat.getBitsPerPixel(format) / <span class="number">8</span>];</span><br><span class="line">    <span class="type">byte</span>[] rowData = <span class="keyword">new</span> <span class="title class_">byte</span>[planes[<span class="number">0</span>].getRowStride()];</span><br><span class="line">    <span class="type">int</span> <span class="variable">channelOffset</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">outputStride</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; planes.length; i++) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                channelOffset = <span class="number">0</span>;</span><br><span class="line">                outputStride = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> (colorFormat == COLOR_FormatI420) &#123;</span><br><span class="line">                    channelOffset = width * height;</span><br><span class="line">                    outputStride = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorFormat == COLOR_FormatNV21) &#123;</span><br><span class="line">                    channelOffset = width * height + <span class="number">1</span>;</span><br><span class="line">                    outputStride = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">if</span> (colorFormat == COLOR_FormatI420) &#123;</span><br><span class="line">                    channelOffset = (<span class="type">int</span>) (width * height * <span class="number">1.25</span>);</span><br><span class="line">                    outputStride = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorFormat == COLOR_FormatNV21) &#123;</span><br><span class="line">                    channelOffset = width * height;</span><br><span class="line">                    outputStride = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> planes[i].getBuffer();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rowStride</span> <span class="operator">=</span> planes[i].getRowStride();</span><br><span class="line">        <span class="type">int</span> <span class="variable">pixelStride</span> <span class="operator">=</span> planes[i].getPixelStride();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">shift</span> <span class="operator">=</span> (i == <span class="number">0</span>) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> width &gt;&gt; shift;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> height &gt;&gt; shift;</span><br><span class="line">        buffer.position(rowStride * (crop.top &gt;&gt; shift) + pixelStride * (crop.left &gt;&gt; shift));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> <span class="number">0</span>; row &lt; h; row++) &#123;</span><br><span class="line">            <span class="type">int</span> length;</span><br><span class="line">            <span class="keyword">if</span> (pixelStride == <span class="number">1</span> &amp;&amp; outputStride == <span class="number">1</span>) &#123;</span><br><span class="line">                length = w;</span><br><span class="line">                buffer.get(data, channelOffset, length);</span><br><span class="line">                channelOffset += length;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                length = (w - <span class="number">1</span>) * pixelStride + <span class="number">1</span>;</span><br><span class="line">                buffer.get(rowData, <span class="number">0</span>, length);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">col</span> <span class="operator">=</span> <span class="number">0</span>; col &lt; w; col++) &#123;</span><br><span class="line">                    data[channelOffset] = rowData[col * pixelStride];</span><br><span class="line">                    channelOffset += outputStride;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (row &lt; h - <span class="number">1</span>) &#123;</span><br><span class="line">                buffer.position(buffer.position() + rowStride - length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否是支持的数据类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isImageFormatSupported</span><span class="params">(Image image)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">format</span> <span class="operator">=</span> image.getFormat();</span><br><span class="line">    <span class="keyword">switch</span> (format) &#123;</span><br><span class="line">        <span class="keyword">case</span> ImageFormat.YUV_420_888:</span><br><span class="line">        <span class="keyword">case</span> ImageFormat.NV21:</span><br><span class="line">        <span class="keyword">case</span> ImageFormat.YV12:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>“csd-0”和”csd-1”是什么，对于H264视频的话，它对应的是sps和pps，对于AAC音频的话，对应的是ADTS，做音视频开发的人应该都知道，它一般存在于编码器生成的IDR帧之中。</p>
<p>得到的mediaFormat<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaFormat in:&#123;height=720, width=1280, csd-1=java.nio.ByteArrayBuffer[position=0,limit=7,capacity=7], mime=video/avc, csd-0=java.nio.ByteArrayBuffer[position=0,limit=13,capacity=13], color-format=2135033992&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="存储图片的方法"><a href="#存储图片的方法" class="headerlink" title="存储图片的方法"></a>存储图片的方法</h3><p>Image类在Android API21及以后功能十分强大。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dumpFile</span><span class="params">(String fileName, <span class="type">byte</span>[] data)</span> &#123;</span><br><span class="line">    FileOutputStream outStream;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(fileName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unable to create output file &quot;</span> + fileName, ioe);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outStream.write(data);</span><br><span class="line">        outStream.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;failed writing data to file &quot;</span> + fileName, ioe);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">compressToJpeg</span><span class="params">(String fileName, Image image)</span> &#123;</span><br><span class="line">    FileOutputStream outStream;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(fileName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Unable to create output file &quot;</span> + fileName, ioe);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Rect</span> <span class="variable">rect</span> <span class="operator">=</span> image.getCropRect();</span><br><span class="line">    <span class="type">YuvImage</span> <span class="variable">yuvImage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YuvImage</span>(getDataFromImage(image, COLOR_FormatNV21), ImageFormat.NV21, rect.width(), rect.height(), <span class="literal">null</span>);</span><br><span class="line">    yuvImage.compressToJpeg(rect, <span class="number">100</span>, outStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NV21转bitmap的方法"><a href="#NV21转bitmap的方法" class="headerlink" title="NV21转bitmap的方法"></a>NV21转bitmap的方法</h3><p>直接存入文件<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in try catch</span></span><br><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(Environment.getExternalStorageDirectory() + <span class="string">&quot;/imagename.jpg&quot;</span>);</span><br><span class="line"><span class="type">YuvImage</span> <span class="variable">yuvImage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YuvImage</span>(nv21bytearray, ImageFormat.NV21, width, height, <span class="literal">null</span>);</span><br><span class="line">yuvImage.compressToJpeg(<span class="keyword">new</span> <span class="title class_">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, width, height), <span class="number">100</span>, fos);</span><br><span class="line">fos.close();</span><br></pre></td></tr></table></figure></p>
<p>获得Bitmap对象的方法，这个方法耗时耗内存<br>NV21 -&gt; yuvImage -&gt; jpeg -&gt; bitmap<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in try catch</span></span><br><span class="line"><span class="type">YuvImage</span> <span class="variable">yuvImage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YuvImage</span>(nv21bytearray, ImageFormat.NV21, width, height, <span class="literal">null</span>);</span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">yuvImage.compressToJpeg(<span class="keyword">new</span> <span class="title class_">Rect</span>(<span class="number">0</span>, <span class="number">0</span>, width, height), <span class="number">100</span>, os);</span><br><span class="line"><span class="type">byte</span>[] jpegByteArray = os.toByteArray();</span><br><span class="line"><span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> BitmapFactory.decodeByteArray(jpegByteArray, <span class="number">0</span>, jpegByteArray.length);</span><br><span class="line">os.close();</span><br></pre></td></tr></table></figure></p>
<p>参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/32276522/convert-nv21-byte-array-into-bitmap-readable-format">https://stackoverflow.com/questions/32276522/convert-nv21-byte-array-into-bitmap-readable-format</a></p>
<h3 id="codec选择YUV420格式输出OutputBuffer的问题"><a href="#codec选择YUV420格式输出OutputBuffer的问题" class="headerlink" title="codec选择YUV420格式输出OutputBuffer的问题"></a>codec选择YUV420格式输出OutputBuffer的问题</h3><p>假设codec选择的格式是<code>COLOR_FormatYUV420Flexible</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Flexible);</span><br></pre></td></tr></table></figure><br>解码后，得到的格式是<code>COLOR_QCOM_FormatYUV420SemiPlanar32m // 0x7FA30C04</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mCodec.getOutputFormat().getInteger(MediaFormat.KEY_COLOR_FORMAT)</span><br></pre></td></tr></table></figure><br>解码出来的<code>ByteBuffer oBuffer = mCodec.getOutputBuffer(index);</code>包含元素个数为1413120；记为<code>nv21Codec</code><br>而通过<code>mCodec.getOutputImage(index)</code>得到的image对象获取到的nv21数组元素个数为1382400；记为<code>nv21</code>，这些是我们想要的数据</p>
<p>对比这2个数组我们发现，前面的y部分是相同的。<code>nv21</code>前921600个元素是y数据，后460800个元素是uv数据。<br><code>nv21Codec</code>前921600个元素是y数据，之后的20480个字节都是0，再接下来的460800个元素是uv数据。最后的10240个字节是0</p>
<p><code>nv21</code>和<code>nv21Codec</code>的uv部分存储顺序是相反的。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.polarxiong.com/archives/Android-MediaCodec%E8%A7%86%E9%A2%91%E6%96%87%E4%BB%B6%E7%A1%AC%E4%BB%B6%E8%A7%A3%E7%A0%81-%E9%AB%98%E6%95%88%E7%8E%87%E5%BE%97%E5%88%B0YUV%E6%A0%BC%E5%BC%8F%E5%B8%A7-%E5%BF%AB%E9%80%9F%E4%BF%9D%E5%AD%98JPEG%E5%9B%BE%E7%89%87-%E4%B8%8D%E4%BD%BF%E7%94%A8OpenGL.html">Android: MediaCodec视频文件硬件解码,高效率得到YUV格式帧,快速保存JPEG图片(不使用OpenGL)(附Demo)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.polarxiong.com/archives/Android-Image%E7%B1%BB%E6%B5%85%E6%9E%90-%E7%BB%93%E5%90%88YUV_420_888.html">Android: Image类浅析(结合YUV_420_888)</a></li>
<li><a target="_blank" rel="noopener" href="http://bigflake.com/mediacodec/">Android MediaCodec stuff</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/leixiaohua1020/">雷霄骅(leixiaohua1020)的专栏</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/leixiaohua1020/article/details/15811977">[总结]FFMPEG视音频编解码零基础学习方法 - 雷霄骅</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Bilibili/ijkplayer">Bilibili/ijkplayer - Github</a></li>
</ul>
<p>Android音视频相关文章请参考 <a target="_blank" rel="noopener" href="https://rustfisher.com/tags/Android-Media/">https://rustfisher.com/tags/Android-Media/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-06-22T14:13:16.000Z" title="2017/6/22 22:13:16">2017-06-22</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:37:13.068Z" title="2021/6/18 17:37:13">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">10 分钟读完 (大约1555个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/06/22/Android/Android-AsyncTask_use_and_RTFSC/">Android AsyncTask 使用与分析</a></p><div class="content"><p>本文简单介绍Android中的AsyncTask，并从源码角度分析它的流程和特点。  </p>
<p>AsyncTask有助于使用UI线程。<br>这个类能让你不主动使用多线程或Handler，在UI线程进行后台操作并发布结果。<br>是一个在不用多线程和Handler的情况下的帮助类。AsyncTask适用于短时间的操作（最多几秒）。<br>如需长时间的线程操作，建议使用多线程包<code>java.util.concurrent</code>中的API，比如<code>Executor</code>，<code>ThreadPoolExecutor</code> 和 <code>FutureTask</code></p>
<p>AsyncTask任务的构成：</p>
<ul>
<li>3种泛型：<code>Params</code>， <code>Progress</code> 和 <code>Result</code></li>
<li>4个步骤：<code>onPreExecute</code>, <code>doInBackground</code>, <code>onProgressUpdate</code> 和 <code>onPostExecute</code></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/os/AsyncTask.html">Google文档</a></p>
<h3 id="用法简介"><a href="#用法简介" class="headerlink" title="用法简介"></a>用法简介</h3><p>虚构一个计算任务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 虚拟的计算任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">CalculationTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Float, Integer, Float&gt; &#123;</span><br><span class="line">        <span class="keyword">protected</span> Float <span class="title function_">doInBackground</span><span class="params">(Float... inputs)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;doInBackground thread ID = &quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            <span class="type">long</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="type">float</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">float</span> f : inputs) &#123;</span><br><span class="line">                <span class="comment">// 假设这里有一些耗时的操作</span></span><br><span class="line">                result += f;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (step &lt; <span class="number">5</span>) &#123;</span><br><span class="line">                result += step;</span><br><span class="line">                step++;</span><br><span class="line">                publishProgress((<span class="type">int</span>) step);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onProgressUpdate</span><span class="params">(Integer... progress)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onProgressUpdate thread ID = &quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onProgressUpdate: &quot;</span> + progress[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPostExecute</span><span class="params">(Float result)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onPostExecute thread ID = &quot;</span> + Thread.currentThread().getId());</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;任务执行完毕&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行任务</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CalculationTask</span>().execute(<span class="number">1.2f</span>, <span class="number">2.3f</span>, <span class="number">6.3f</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">logcat</span></span><br><span class="line"><span class="comment">Main thread ID = 1</span></span><br><span class="line"><span class="comment">doInBackground thread ID = 8089</span></span><br><span class="line"><span class="comment">onProgressUpdate thread ID = 1</span></span><br><span class="line"><span class="comment">onProgressUpdate: 1</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">onProgressUpdate thread ID = 1</span></span><br><span class="line"><span class="comment">onProgressUpdate: 5</span></span><br><span class="line"><span class="comment">onPostExecute thread ID = 1</span></span><br><span class="line"><span class="comment">任务执行完毕</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<h3 id="AsyncTask-使用的的泛型"><a href="#AsyncTask-使用的的泛型" class="headerlink" title="AsyncTask 使用的的泛型"></a>AsyncTask 使用的的泛型</h3><p>AsyncTask使用的3种泛型</p>
<ul>
<li>Params 送去执行的类型</li>
<li>Progress 后台计算的进度类型</li>
<li>Result 后台计算的结果</li>
</ul>
<p>不用的泛型可以用<code>Void</code>表示。例如<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">MyTask</span> <span class="keyword">extends</span> <span class="title class_">AsyncTask</span>&lt;Void, Void, Void&gt; &#123; ... &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="异步任务的4个步骤"><a href="#异步任务的4个步骤" class="headerlink" title="异步任务的4个步骤"></a>异步任务的4个步骤</h3><p>异步任务执行时经过4个步骤</p>
<ul>
<li><code>onPreExecute()</code> UI线程在任务开始前调用这个方法。此方法常用来设置任务，比如在屏幕上显示一个进度条。</li>
<li><code>doInBackground(Params...)</code> <code>onPreExecute()</code>执行完毕后立即在后台线程中执行。这一步用来执行耗时的后台计算。<br>这个方法接受异步任务的参数，返回最后的任务结果。这一步可以调用<code>publishProgress(Progress...)</code>通知出去一个或多个进度。这些进度值会被<code>onProgressUpdate(Progress...)</code>在UI线程收到。</li>
<li><code>onProgressUpdate(Progress...)</code>  调用<code>publishProgress(Progress...)</code>后会在UI线程中执行。用来显示执行中任务的UI。</li>
<li><code>onPostExecute(Result)</code> 后台任务执行完毕时被调用。最终结果会被传入这个方法。</li>
</ul>
<h3 id="取消任务"><a href="#取消任务" class="headerlink" title="取消任务"></a>取消任务</h3><p>调用<code>cancel(boolean)</code>可随时取消任务。取消任务后<code>isCancelled()</code>会返回true。<br>调用这个方法后，后台任务<code>doInBackground(Object[])</code>执行完毕后会调用<code>onCancelled(Object)</code>而不再是<code>onPostExecute(Object)</code>。<br>为保证任务能被及时地取消，在<code>doInBackground(Object[])</code>中应该经常检查<code>isCancelled()</code>返回值</p>
<h3 id="线程规则-Threading-rules"><a href="#线程规则-Threading-rules" class="headerlink" title="线程规则 Threading rules"></a>线程规则 Threading rules</h3><p>一些线程规则</p>
<ul>
<li>异步任务必须从UI线程启动</li>
<li>必须在UI线程实例化AsyncTask类</li>
<li>必须在UI线程调用<code>execute(Params...)</code></li>
<li>不要手动调用<code>onPreExecute(), onPostExecute(Result), doInBackground(Params...), onProgressUpdate(Progress...)</code></li>
<li>同一个异步任务实例只能被执行一次。重复执行同一个异步任务实例会抛出异常（<code>IllegalStateException</code>）。</li>
</ul>
<h2 id="源码简析"><a href="#源码简析" class="headerlink" title="源码简析"></a>源码简析</h2><p>需要解决的问题：<br>AsyncTask是如何调用后台线程完成任务的？线程是如何调度的？</p>
<p>AsyncTask使用<code>Executor</code>，利用<code>WorkerRunnable</code>和<code>FutureTask</code>来执行后台任务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WorkerRunnable&lt;Params, Result&gt; mWorker; <span class="comment">// 实现了 Callable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> FutureTask&lt;Result&gt; mFuture;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">WorkerRunnable</span>&lt;Params, Result&gt; <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;Result&gt; &#123;</span><br><span class="line">    Params[] mParams;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用<code>Handler</code>来进行线程调度。内部定义了一个类<code>InternalHandler</code>。</p>
<h3 id="从execute-Params-params-方法切入"><a href="#从execute-Params-params-方法切入" class="headerlink" title="从execute(Params... params)方法切入"></a>从<code>execute(Params... params)</code>方法切入</h3><p>先看方法<code>execute(Params... params)</code>，使用默认执行器，并传入参数<br>调用<code>xecuteOnExecutor(Executor exec, Params... params)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span> <span class="comment">// 指定在主线程执行</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title function_">execute</span><span class="params">(Params... params)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> executeOnExecutor(sDefaultExecutor, params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先判断当前状态，如果状态不是<code>Status.PENDING</code>，则抛出异常。<br>否则进入<code>Status.RUNNING</code>状态，执行<code>onPreExecute()</code>，再由执行器启动任务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> AsyncTask&lt;Params, Progress, Result&gt; <span class="title function_">executeOnExecutor</span><span class="params">(Executor exec,</span></span><br><span class="line"><span class="params">        Params... params)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mStatus != Status.PENDING) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (mStatus) &#123;</span><br><span class="line">            <span class="keyword">case</span> RUNNING:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot execute task:&quot;</span></span><br><span class="line">                        + <span class="string">&quot; the task is already running.&quot;</span>);</span><br><span class="line">            <span class="keyword">case</span> FINISHED: <span class="comment">// 同一个任务实例只能够执行一次</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot execute task:&quot;</span></span><br><span class="line">                        + <span class="string">&quot; the task has already been executed &quot;</span></span><br><span class="line">                        + <span class="string">&quot;(a task can be executed only once)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mStatus = Status.RUNNING;</span><br><span class="line">    onPreExecute();</span><br><span class="line">    mWorker.mParams = params;</span><br><span class="line">    exec.execute(mFuture); <span class="comment">// 开始进入后台线程执行任务</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>mWorker</code>带着传进来的参数，<code>mFuture</code>实例化时已经将<code>mWorker</code>注入。参看构造函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AsyncTask</span><span class="params">()</span> &#123;</span><br><span class="line">    mWorker = <span class="keyword">new</span> <span class="title class_">WorkerRunnable</span>&lt;Params, Result&gt;() &#123;</span><br><span class="line">        <span class="keyword">public</span> Result <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            mTaskInvoked.set(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</span><br><span class="line">            <span class="comment">// 在后台线程进行自定义的操作  这里面可以调用publishProgress方法</span></span><br><span class="line">            <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> doInBackground(mParams); </span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">            <span class="keyword">return</span> postResult(result); <span class="comment">// 发送最终结果</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    mFuture = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;Result&gt;(mWorker) &#123; <span class="comment">// 依赖 mWorker</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">done</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                postResultIfNotInvoked(get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                android.util.Log.w(LOG_TAG, e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;An error occurred while executing doInBackground()&quot;</span>,</span><br><span class="line">                        e.getCause());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (CancellationException e) &#123;</span><br><span class="line">                postResultIfNotInvoked(<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>publishProgress</code>方法通过主线程的Handler向外通知进度<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">publishProgress</span><span class="params">(Progress... values)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isCancelled()) &#123;</span><br><span class="line">        getHandler().obtainMessage(MESSAGE_POST_PROGRESS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AsyncTaskResult</span>&lt;Progress&gt;(<span class="built_in">this</span>, values)).sendToTarget();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>后台任务执行完毕，<code>postResult</code>发送最终结果<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Result <span class="title function_">postResult</span><span class="params">(Result result)</span> &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> getHandler().obtainMessage(MESSAGE_POST_RESULT,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">AsyncTaskResult</span>&lt;Result&gt;(<span class="built_in">this</span>, result));</span><br><span class="line">    message.sendToTarget(); <span class="comment">// 会走到finish方法</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">finish</span><span class="params">(Result result)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">        onCancelled(result); <span class="comment">// 如果任务已经被取消了</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onPostExecute(result); <span class="comment">// 通知任务执行完毕</span></span><br><span class="line">    &#125;</span><br><span class="line">    mStatus = Status.FINISHED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="关于默认执行器-sDefaultExecutor-和线程池"><a href="#关于默认执行器-sDefaultExecutor-和线程池" class="headerlink" title="关于默认执行器 sDefaultExecutor 和线程池"></a>关于默认执行器 <code>sDefaultExecutor</code> 和线程池</h3><p>源码中构建了一个线程池和一个自定义的执行器<code>SerialExecutor</code>。靠它们来执行后台任务。</p>
<p>参考源代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AsyncTask</span>&lt;Params, Progress, Result&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CPU_COUNT</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">    <span class="comment">// 核心线程至少2个，最多4个</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CORE_POOL_SIZE</span> <span class="operator">=</span> Math.max(<span class="number">2</span>, Math.min(CPU_COUNT - <span class="number">1</span>, <span class="number">4</span>));</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAXIMUM_POOL_SIZE</span> <span class="operator">=</span> CPU_COUNT * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">KEEP_ALIVE_SECONDS</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Executor</span> <span class="variable">SERIAL_EXECUTOR</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerialExecutor</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">Executor</span> <span class="variable">sDefaultExecutor</span> <span class="operator">=</span> SERIAL_EXECUTOR;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ThreadFactory</span> <span class="variable">sThreadFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadFactory</span>() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">mCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;AsyncTask #&quot;</span> + mCount.getAndIncrement());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor THREAD_POOL_EXECUTOR; <span class="comment">// 实际执行者</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">                CORE_POOL_SIZE, MAXIMUM_POOL_SIZE, KEEP_ALIVE_SECONDS, TimeUnit.SECONDS,</span><br><span class="line">                sPoolWorkQueue, sThreadFactory);</span><br><span class="line">        threadPoolExecutor.allowCoreThreadTimeOut(<span class="literal">true</span>);</span><br><span class="line">        THREAD_POOL_EXECUTOR = threadPoolExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认执行器的类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SerialExecutor</span> <span class="keyword">implements</span> <span class="title class_">Executor</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> ArrayDeque&lt;Runnable&gt; mTasks = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;Runnable&gt;();</span><br><span class="line">        Runnable mActive;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> &#123;</span><br><span class="line">            mTasks.offer(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        r.run();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        scheduleNext();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">if</span> (mActive == <span class="literal">null</span>) &#123;</span><br><span class="line">                scheduleNext();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">scheduleNext</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((mActive = mTasks.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                THREAD_POOL_EXECUTOR.execute(mActive);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-06-09T15:49:50.000Z" title="2017/6/9 23:49:50">2017-06-09</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:15.089Z" title="2021/6/18 17:38:15">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">5 分钟读完 (大约742个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/06/09/Android/Android-IntentService-intro1/">Android IntentService 分析和用法</a></p><div class="content"><p>IntentService的分析和用法，实用性介绍。</p>
<h2 id="IntentService-简介"><a href="#IntentService-简介" class="headerlink" title="IntentService 简介"></a>IntentService 简介</h2><ul>
<li>IntentService继承自Service，可用<code>startService</code>启动，也需要在<code>AndroidManifest.xml</code>中注册</li>
<li>IntentService在一个单独的worker线程中处理任务</li>
<li>任务完成后，会自动停止</li>
<li>可多次启动同一个IntentService，它们会自一个接一个地排队处理</li>
</ul>
<h2 id="IntentService-与-Service"><a href="#IntentService-与-Service" class="headerlink" title="IntentService 与 Service"></a>IntentService 与 Service</h2><p>耗时任务可以不用在Service中手动开启线程。<br>当操作完成时，我们不用手动停止IntentService，它会自动判定停止。  </p>
<h3 id="IntentService-自动停止"><a href="#IntentService-自动停止" class="headerlink" title="IntentService 自动停止"></a>IntentService 自动停止</h3><p>参考IntentService源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ServiceHandler mServiceHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ServiceHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceHandler</span><span class="params">(Looper looper)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        onHandleIntent((Intent)msg.obj);</span><br><span class="line">        stopSelf(msg.arg1); <span class="comment">// 传入startID</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate();</span><br><span class="line">    <span class="type">HandlerThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HandlerThread</span>(<span class="string">&quot;IntentService[&quot;</span> + mName + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    thread.start();</span><br><span class="line"></span><br><span class="line">    mServiceLooper = thread.getLooper();</span><br><span class="line">    mServiceHandler = <span class="keyword">new</span> <span class="title class_">ServiceHandler</span>(mServiceLooper);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(<span class="meta">@Nullable</span> Intent intent, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mServiceHandler.obtainMessage();</span><br><span class="line">    msg.arg1 = startId; <span class="comment">// 这个是停止服务的依据</span></span><br><span class="line">    msg.obj = intent;</span><br><span class="line">    mServiceHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>利用<code>ServiceHandler</code>来控制生命周期。onCreate方法中开启了一个<code>HandlerThread</code>来处理请求。<br>在<code>onStart</code>中获取到<code>startId</code>。在<code>ServiceHandler</code>中每次处理完一个命令都会调用<code>stopSelf(int startId)</code>方法来停止服务。<br>IntentService直到命令队列中的所有命令被执行完后才会停止服务。</p>
<h2 id="用法示例"><a href="#用法示例" class="headerlink" title="用法示例"></a>用法示例</h2><p>新建一个模拟计算的后台服务<code>CalIntentService</code>继承<code>IntentService</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 模拟计算的后台服务</span></span><br><span class="line"><span class="comment"> * Created by Rust on 2017/6/9.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CalIntentService</span> <span class="keyword">extends</span> <span class="title class_">IntentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;rustApp&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mStartId</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一定要一个无参构造器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CalIntentService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="string">&quot;cal_intent_service_name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates an IntentService.  Invoked by your subclass&#x27;s constructor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name Used to name the worker thread, important only for debugging.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CalIntentService</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(<span class="meta">@Nullable</span> Intent intent, <span class="type">int</span> startId)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onStart(intent, startId);</span><br><span class="line">        mStartId = startId;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[CalIntentService] onStart, startId=&quot;</span> + mStartId); <span class="comment">// 复写这个方法来看startId</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy(); <span class="comment">// 观察生命周期</span></span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[CalIntentService] onDestroy. StartId=&quot;</span> + mStartId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onHandleIntent</span><span class="params">(<span class="meta">@Nullable</span> Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != intent) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;msg&quot;</span>);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;[CalIntentService] 收到 name:&quot;</span> + name + <span class="string">&quot;, msg:&quot;</span> + msg + <span class="string">&quot;, at &quot;</span></span><br><span class="line">                    + Thread.currentThread().toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>); <span class="comment">// 模拟耗时操作</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[CalIntentService] 计算结束.  mStartId=&quot;</span> + mStartId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>AndroidManifest中注册这个服务。目前只允许本App使用<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.rustfisher.service.CalIntentService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Activity中启动这个服务<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">btn2.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">calIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(getApplicationContext(), CalIntentService.class);</span><br><span class="line">        calIntent.putExtra(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Rust&quot;</span>);</span><br><span class="line">        calIntent.putExtra(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;Click event: &quot;</span> + mClickCount++);</span><br><span class="line">        startService(calIntent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在手机上运行，快速点击几次按钮，启动IntentService，logcat输出<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[CalIntentService] onStart, startId=1</span><br><span class="line">[CalIntentService] 收到 name:Rust, msg:Click event: 0, at Thread[IntentService[cal_intent_service_name],5,main]</span><br><span class="line">[CalIntentService] onStart, startId=2</span><br><span class="line">[CalIntentService] onStart, startId=3</span><br><span class="line">[CalIntentService] onStart, startId=4</span><br><span class="line">[CalIntentService] 计算结束.  最新StartId=4</span><br><span class="line">[CalIntentService] 收到 name:Rust, msg:Click event: 1, at Thread[IntentService[cal_intent_service_name],5,main]</span><br><span class="line">[CalIntentService] 计算结束.  最新StartId=4</span><br><span class="line">[CalIntentService] 收到 name:Rust, msg:Click event: 2, at Thread[IntentService[cal_intent_service_name],5,main]</span><br><span class="line">[CalIntentService] 计算结束.  最新StartId=4</span><br><span class="line">[CalIntentService] 收到 name:Rust, msg:Click event: 3, at Thread[IntentService[cal_intent_service_name],5,main]</span><br><span class="line">[CalIntentService] 计算结束.  最新StartId=4</span><br><span class="line">[CalIntentService] onDestroy. StartId=4</span><br></pre></td></tr></table></figure></p>
<p>可以看出，先执行<code>onStart</code>，然后排队执行<code>onHandleIntent</code>。任务全部结束后自行停止。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-06-07T15:23:11.000Z" title="2017/6/7 23:23:11">2017-06-07</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:09.823Z" title="2021/6/18 17:38:09">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">18 分钟读完 (大约2771个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/06/07/Android/Android-Handler_src_note/">Android Handler，Looper 与 MessageQueue 使用与分析</a></p><div class="content"><h2 id="Handler-简介"><a href="#Handler-简介" class="headerlink" title="Handler 简介"></a>Handler 简介</h2><p>一个Handler允许发送和处理Message，通过关联线程的 MessageQueue 执行 Runnable 对象。<br>每个Handler实例都和一个单独的线程及其消息队列绑定。<br>可以将一个任务切换到Handler所在的线程中去执行。一个用法就是子线程通过Handler更新UI。</p>
<p>Handler主要有2种用法：</p>
<ul>
<li>做出计划，在未来某个时间点执行消息和Runnable</li>
<li>线程调度，在其他线程规划并执行任务</li>
</ul>
<p>要使用好Handler，需要了解与其相关的 <code>MessageQueue</code>， <code>Message</code>和<code>Looper</code>；不能孤立的看Handler。<br>Handler就像一个操作者（或者像一个对开发者开放的窗口），利用<code>MessageQueue</code>和<code>Looper</code>来实现任务调度和处理。  </p>
<p><strong>Handler持有 Looper 的实例，直接持有looper的消息队列。</strong></p>
<h3 id="属性与构造器"><a href="#属性与构造器" class="headerlink" title="属性与构造器"></a>属性与构造器</h3><p>Handler类中持有的实例，持有looper，messageQueue等等。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Looper mLooper; <span class="comment">// Handler持有Looper实例</span></span><br><span class="line"><span class="keyword">final</span> MessageQueue mQueue; <span class="comment">// Handler持有消息队列</span></span><br><span class="line"><span class="keyword">final</span> Callback mCallback;</span><br></pre></td></tr></table></figure></p>
<p>在Handler的构造器中，我们可以看到Handler获取了Looper的消息队列。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(Callback callback, <span class="type">boolean</span> async)</span> &#123;</span><br><span class="line">    <span class="comment">// 处理异常</span></span><br><span class="line">    mLooper = Looper.myLooper();</span><br><span class="line">    <span class="comment">// 处理特殊情况...</span></span><br><span class="line">    mQueue = mLooper.mQueue; <span class="comment">// 获取的是Looper的消息队列</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(Looper looper, Callback callback, <span class="type">boolean</span> async)</span> &#123;</span><br><span class="line">    mLooper = looper;</span><br><span class="line">    mQueue = looper.mQueue; <span class="comment">// 获取的是Looper的消息队列</span></span><br><span class="line">    mCallback = callback;</span><br><span class="line">    mAsynchronous = async;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Handler的使用方法"><a href="#Handler的使用方法" class="headerlink" title="Handler的使用方法"></a>Handler的使用方法</h3><p>Handler发送和处理消息的几个方法</p>
<ul>
<li>void handleMessage( Message  msg):处理消息的方法，该方法通常被重写。</li>
<li>final boolean hasMessage(int  what):检查消息队列中是否包含有what属性为指定值的消息</li>
<li>final boolean hasMessage(int what ,Object object) :检查消息队列中是否包含有what好object属性指定值的消息</li>
<li>sendEmptyMessage(int what):发送空消息</li>
<li>final Boolean send EmptyMessageDelayed(int what ,long delayMillis):指定多少毫秒发送空消息</li>
<li>final  boolean sendMessage(Message msg):立即发送消息</li>
<li>final boolean sendMessageDelayed(Message msg,long delayMillis):多少秒之后发送消息</li>
</ul>
<h4 id="Handler-sendEmptyMessage-int-what-流程解析"><a href="#Handler-sendEmptyMessage-int-what-流程解析" class="headerlink" title="Handler.sendEmptyMessage(int what) 流程解析"></a>Handler.sendEmptyMessage(int what) 流程解析</h4><p>获取一个Message实例，并立即将Message实例添加到消息队列中去。<br>简要流程如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 立刻发送一个empty消息</span></span><br><span class="line">sendEmptyMessage(<span class="type">int</span> what) </span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送延迟为0的empty消息  这个方法里通过Message.obtain()获取一个Message实例</span></span><br><span class="line">sendEmptyMessageDelayed(what, <span class="number">0</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算消息的计划执行时间，进入下一阶段</span></span><br><span class="line">sendMessageDelayed(Message msg, <span class="type">long</span> delayMillis)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这里判断队列是否为null  若为null则直接返回false</span></span><br><span class="line">sendMessageAtTime(Message msg, <span class="type">long</span> uptimeMillis)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将消息添加到队列中</span></span><br><span class="line">enqueueMessage(MessageQueue queue, Message msg, <span class="type">long</span> uptimeMillis)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接下来是MessageQueue添加消息</span></span><br><span class="line"><span class="comment">// MessageQueue.java</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">enqueueMessage</span><span class="params">(Message msg, <span class="type">long</span> when)</span></span><br></pre></td></tr></table></figure><br>可以看到，最后是把message添加到了messageQueue中。</p>
<h4 id="Handler-取消任务"><a href="#Handler-取消任务" class="headerlink" title="Handler 取消任务"></a>Handler 取消任务</h4><p>要取消任务时，调用下面这个方法<code>removeCallbacksAndMessages(Object token)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">removeCallbacksAndMessages</span><span class="params">(Object token)</span> &#123;</span><br><span class="line">    mQueue.removeCallbacksAndMessages(<span class="built_in">this</span>, token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>通过调用<code>Message.recycleUnchecked()</code>方法，取消掉与此Handler相关联的Message。</p>
<p>相关的消息队列会执行取消指令<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">removeCallbacksAndMessages</span><span class="params">(Handler h, Object object)</span></span><br></pre></td></tr></table></figure></p>
<h3 id="消息驱动与Handler"><a href="#消息驱动与Handler" class="headerlink" title="消息驱动与Handler"></a>消息驱动与Handler</h3><p>Android是消息驱动的，实现消息驱动有几个要素</p>
<ul>
<li>消息的表示：Message</li>
<li>消息队列：MessageQueue</li>
<li>消息循环，用于循环取出消息进行处理：Looper</li>
<li>消息处理，消息循环从消息队列中取出消息后要对消息进行处理：Handler</li>
</ul>
<h4 id="初始化消息队列"><a href="#初始化消息队列" class="headerlink" title="初始化消息队列"></a>初始化消息队列</h4><p>在Looper构造器中即创建了一个MessageQueue，<strong>Looper持有消息队列的实例</strong>。</p>
<h4 id="发送消息"><a href="#发送消息" class="headerlink" title="发送消息"></a>发送消息</h4><p>通过Looper.prepare初始化好消息队列后就可以调用Looper.loop进入消息循环了，然后我们就可以向消息队列发送消息，<br>消息循环就会取出消息进行处理，在看消息处理之前，先看一下消息是怎么被添加到消息队列的。</p>
<h4 id="消息循环"><a href="#消息循环" class="headerlink" title="消息循环"></a>消息循环</h4><p>Java层的消息都保存在了Java层MessageQueue的成员mMessages中，Native层的消息都保存在了Native Looper的<br>mMessageEnvelopes中，这就可以说有两个消息队列，而且都是按时间排列的。</p>
<h2 id="Message-和-MessageQueue-简介"><a href="#Message-和-MessageQueue-简介" class="headerlink" title="Message 和 MessageQueue 简介"></a>Message 和 MessageQueue 简介</h2><p>与Handler工作的几个组件Looper、MessageQueue各自的作用：</p>
<ul>
<li>1.Handler：它把消息发送给Looper管理的MessageQueue,并负责处理Looper分给它的消息</li>
<li>2.MessageQueue：管理Message，由Looper管理</li>
<li>3.Looper：每个线程只有一个Looper，比如UI线程中，系统会默认的初始化一个Looper对象，它负责管理MessageQueue，不断的从MessageQueue中取消息，并将相对应的消息分给Handler处理。</li>
</ul>
<h3 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h3><p>Message 属于被传递，被使用的角色。Message 是包含描述和任意数据对象的“消息”，能被发送给<code>Handler</code>。Message包含2个int属性和一个额外的对象。<br>虽然构造器是公开的，但获取实例最好的办法是调用<code>Message.obtain()</code>或<code>Handler.obtainMessage()</code>。这样可以从他们的可回收对象池中获取到消息实例。一般来说，每个Message实例持有一个Handler。</p>
<p>Message部分属性值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*package*/</span> Handler target; <span class="comment">// 指定的Handler</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*package*/</span> Runnable callback;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以组成链表</span></span><br><span class="line"><span class="comment">// sometimes we store linked lists of these things</span></span><br><span class="line"><span class="comment">/*package*/</span> Message next;</span><br></pre></td></tr></table></figure><br>从这里也不难看出，每个Message都持有Handler实例。如果Handler持有Activity的引用，Activity onDestroy后Message却仍然在队列中，因为Handler与Activity的强关联，会造成Activity无法被GC回收，导致内存泄露。<br>因此在Activity onDestroy 时，与Activity关联的Handler应清除它的队列由Activity产生的任务，避免内存泄露。</p>
<p>重置自身的方法，将属性全部重置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recycle</span><span class="params">()</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">recycleUnchecked</span><span class="params">()</span></span><br></pre></td></tr></table></figure></p>
<p>获取Message实例的常用方法，得到的实例与传入的Handler绑定<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Same as &#123;<span class="doctag">@link</span> #obtain()&#125;, but sets the value for the &lt;em&gt;target&lt;/em&gt; member on the Message returned.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> h  Handler to assign to the returned Message object&#x27;s &lt;em&gt;target&lt;/em&gt; member.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> A Message object from the global pool.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Message <span class="title function_">obtain</span><span class="params">(Handler h)</span> &#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">m</span> <span class="operator">=</span> obtain();</span><br><span class="line">    m.target = h;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将消息发送给Handler<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sends this Message to the Handler specified by &#123;<span class="doctag">@link</span> #getTarget&#125;.</span></span><br><span class="line"><span class="comment"> * Throws a null pointer exception if this field has not been set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToTarget</span><span class="params">()</span> &#123;</span><br><span class="line">    target.sendMessage(<span class="built_in">this</span>); <span class="comment">// target 就是与消息绑定的Handler</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>调用这个方法后，Handler会将消息添加进它的消息队列<code>MessageQueue</code>中。</p>
<h3 id="MessageQueue"><a href="#MessageQueue" class="headerlink" title="MessageQueue"></a>MessageQueue</h3><p>持有一列可以被Looper分发的Message。一般来说由Handler将Message添加到MessageQueue中。<br>获取当前线程的MessageQueue方法是<code>Looper.myQueue()</code>。通过<code>Looper.getMainLooper()</code>获取到主线程的looper。</p>
<h2 id="Looper-简介"><a href="#Looper-简介" class="headerlink" title="Looper 简介"></a>Looper 简介</h2><p>Looper与MessageQueue紧密关联。在一个线程中运行的消息循环。线程默认情况下是没有与之管理的消息循环的。<br>要创建一个消息循环，在线程中调用prepare，然后调用loop。即开始处理消息，直到循环停止。大多数情况下通过Handler来与消息循环互动。</p>
<p>Handler与Looper在线程中交互的典型例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LooperThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Handler mHandler;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        Looper.prepare(); <span class="comment">// 为当前线程准备一个Looper</span></span><br><span class="line">        <span class="comment">// 创建Handler实例，Handler会获取当前线程的Looper</span></span><br><span class="line">        <span class="comment">// 如果实例化Handler时当前线程没有Looper，会报异常 RuntimeException</span></span><br><span class="line">        mHandler = <span class="keyword">new</span> <span class="title class_">Handler</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">                <span class="comment">// process incoming messages here</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Looper.loop(); <span class="comment">// Looper开始运行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了<code>Looper.loop()</code>之后，looper开始运行。当looper的messageQueue中没有消息时，相关的线程处于什么状态呢？<br>查看looper的源码，看到loop方法里面有一个死循环。queue.next()方法是可能会阻塞线程的。如果从queue中获取到null，则表明此消息队列正在退出。此时looper的死循环也会被返回。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> queue.next(); <span class="comment">// might block</span></span><br><span class="line">    <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br>调用looper的quit方法，实际上调用了<code>mQueue.quit(false)</code>。消息队列退出后，looper的loop死循环也被退出了。</p>
<p>进入MessageQueue的next方法去看，发现里面也有一个死循环。没有消息时，这个死循环会阻塞在<code>nativePollOnce</code>这个方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Message <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line">        <span class="comment">// 处理message对象</span></span><br></pre></td></tr></table></figure></p>
<p>我们知道Thread有New（新建，未运行），RUNNABLE（正常运行），BLOCKED，WAITING（线程拥有了某个锁之后, 调用了他的wait方法, 等待其他线程/锁拥有者调用 notify / notifyAll），TIMED_WAITING，TERMINATED（已经执行完毕）这几种状态。消息队列中没有消息，在nativePollOnce方法中“等待”。相关线程则处于RUNNABLE状态。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/38818642/android-what-is-message-queue-native-poll-once-in-android">https://stackoverflow.com/questions/38818642/android-what-is-message-queue-native-poll-once-in-android</a></p>
<h3 id="Looper中的属性"><a href="#Looper中的属性" class="headerlink" title="Looper中的属性"></a>Looper中的属性</h3><p>Looper持有MessageQueue；唯一的主线程Looper <code>sMainLooper</code>；Looper当前线程 <code>mThread</code>；<br>存储Looper的<code>sThreadLocal</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sThreadLocal.get() will return null unless you&#x27;ve called prepare().</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;Looper&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Looper sMainLooper;  <span class="comment">// guarded by Looper.class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> MessageQueue mQueue; <span class="comment">// Handler会获取这个消息队列实例（参考Handler构造器）</span></span><br><span class="line"><span class="keyword">final</span> Thread mThread; <span class="comment">// Looper当前线程</span></span><br></pre></td></tr></table></figure></p>
<p>ThreadLocal并不是线程，它的作用是可以在每个线程中存储数据。</p>
<h3 id="Looper-方法"><a href="#Looper-方法" class="headerlink" title="Looper 方法"></a>Looper 方法</h3><p>准备方法，将当前线程初始化为Looper。退出时要调用quit<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">()</span> &#123;</span><br><span class="line">    prepare(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepare</span><span class="params">(<span class="type">boolean</span> quitAllowed)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Only one Looper may be created per thread&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sThreadLocal.set(<span class="keyword">new</span> <span class="title class_">Looper</span>(quitAllowed)); <span class="comment">// Looper实例存入了sThreadLocal</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>prepare</code>方法新建 Looper 并存入 sThreadLocal <code>sThreadLocal.set(new Looper(quitAllowed))</code><br><code>ThreadLocal&lt;T&gt;</code>类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> (T)e.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当要获取Looper对象时，从<code>sThreadLocal</code>获取<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取与当前线程关联的Looper，返回可以为null</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> Looper <span class="title function_">myLooper</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sThreadLocal.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在当前线程运行一个消息队列。结束后要调用退出方法<code>quit()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loop</span><span class="params">()</span></span><br></pre></td></tr></table></figure></p>
<p>准备主线程Looper。Android环境会创建主线程Looper，开发者不应该自己调用这个方法。<br>UI线程，它就是ActivityThread，ActivityThread被创建时就会初始化Looper，这也是在主线程中默认可以使用Handler的原因。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">prepareMainLooper</span><span class="params">()</span> &#123;</span><br><span class="line">    prepare(<span class="literal">false</span>); <span class="comment">// 这里表示了主线程Looper不能由开发者来退出</span></span><br><span class="line">    <span class="keyword">synchronized</span> (Looper.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sMainLooper != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;The main Looper has already been prepared.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sMainLooper = myLooper();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>获取主线程的Looper。我们开发者想操作主线程时，可调用此方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Looper <span class="title function_">getMainLooper</span><span class="params">()</span></span><br></pre></td></tr></table></figure></p>
<h3 id="同一个Thread的不同Handler"><a href="#同一个Thread的不同Handler" class="headerlink" title="同一个Thread的不同Handler"></a>同一个Thread的不同Handler</h3><p>与UI线程对应的MainLooper，可以关联多个Handler。<br>多个Handler之间的计划任务不会互相影响。比如有2个关联了UI线程的handler。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Handler mMainHandler1;</span><br><span class="line">Handler mMainHandler2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initUtils</span><span class="params">()</span> &#123;</span><br><span class="line">    mMainHandler1 = <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper());</span><br><span class="line">    mMainHandler2 = <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper());</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;mMainHandler1 post 任务&quot;</span>);</span><br><span class="line">    mMainHandler1.postDelayed(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;mMainHandler1的演示任务已执行&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1500</span>);</span><br><span class="line">    mMainHandler2.removeCallbacksAndMessages(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>mMainHandler2取消它的任务并不会影响mMainHandler1。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-03-16T13:01:11.000Z" title="2017/3/16 21:01:11">2017-03-16</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:39:10.007Z" title="2021/6/18 17:39:10">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">7 分钟读完 (大约1033个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/03/16/Android/NDK-read_write_file/">Android NDK 读写文件</a></p><div class="content"><p>开发环境与工具： win7_x64，Android Studio 2.2.3, Cygwin</p>
<p>使用NDK，就进入了Linux的世界。理解了这一点，很多事情就好办了。需要熟悉C语言操作文件的方式。</p>
<h2 id="准备事项"><a href="#准备事项" class="headerlink" title="准备事项"></a>准备事项</h2><h3 id="申请权限"><a href="#申请权限" class="headerlink" title="申请权限"></a>申请权限</h3><p>申请SD卡的读写权限<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot; /&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.READ_EXTERNAL_STORAGE&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<p>6.0开始需要动态申请权限。</p>
<h3 id="使用Linux中的文件绝对路径"><a href="#使用Linux中的文件绝对路径" class="headerlink" title="使用Linux中的文件绝对路径"></a>使用Linux中的文件绝对路径</h3><p>手机sd卡中存放着文件。目录为 <code>/sdcard/hello.txt</code>和<code>/sdcard/egdir/csv/eg_data.csv</code>。</p>
<h2 id="读写示例"><a href="#读写示例" class="headerlink" title="读写示例"></a>读写示例</h2><h3 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jni/</span><br><span class="line">|-- Android.mk</span><br><span class="line">|-- com_rustfisher_ndkalgo_RWFile.h</span><br><span class="line">`-- RWFile.c</span><br></pre></td></tr></table></figure>
<h3 id="Java文件"><a href="#Java文件" class="headerlink" title="Java文件"></a>Java文件</h3><p><code>RWFile.java</code> 里面写了多个native方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RWFile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;NDKMan&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">readIn</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nativeRead();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">writeToFile</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nativeWrite(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">readSDFile</span><span class="params">(String fileName)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nativeReadSDFile(fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> String <span class="title function_">nativeRead</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName e.g. FolderName/textFile.txt</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> String <span class="title function_">nativeReadSDFile</span><span class="params">(String fileName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> String <span class="title function_">nativeWrite</span><span class="params">(String msg)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>RWFile.c</code>编译出<code>.h</code>文件后，里面的方法名。可以看出编译后的方法名和原来的native方法是一一对应的。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">join</span><span class="params">(<span class="type">char</span> *s1, <span class="type">char</span> *s2,<span class="type">char</span> *result)</span>          <span class="comment">// 拼接char的函数</span></span><br><span class="line">Java_com_rustfisher_ndkalgo_RWFile_nativeRead       <span class="comment">// 读取固定文件的内容</span></span><br><span class="line">Java_com_rustfisher_ndkalgo_RWFile_nativeReadSDFile <span class="comment">// 根据文件名读取文件内容</span></span><br><span class="line">Java_com_rustfisher_ndkalgo_RWFile_nativeWrite      <span class="comment">// 将内容写入文件</span></span><br></pre></td></tr></table></figure></p>
<h3 id="C文件"><a href="#C文件" class="headerlink" title="C文件"></a>C文件</h3><p>C文件是我们具体实现功能的地方。<code>RWFile.c</code>代码如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;com_rustfisher_ndkalgo_RWFile.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *sdcardDir = <span class="string">&quot;/sdcard/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">join</span><span class="params">(<span class="type">char</span> *s1, <span class="type">char</span> *s2,<span class="type">char</span> *result)</span> &#123;</span><br><span class="line">    result = (<span class="type">char</span> *) <span class="built_in">malloc</span>(<span class="built_in">strlen</span>(s1)+<span class="built_in">strlen</span>(s2)+<span class="number">1</span>);<span class="comment">// +1 for the zero-terminator</span></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(result, s1);</span><br><span class="line">    <span class="built_in">strcat</span>(result, s2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_RWFile_nativeRead</span></span><br><span class="line"><span class="params">(JNIEnv *env, jobject jObj)</span> &#123;</span><br><span class="line">    FILE* file = fopen(<span class="string">&quot;/sdcard/hello.txt&quot;</span>,<span class="string">&quot;r+&quot;</span>);</span><br><span class="line">    <span class="type">char</span> myStr[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">char</span>* readInPtr = fgets(myStr, <span class="number">128</span>, file);</span><br><span class="line">        fclose(file);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != readInPtr) &#123;</span><br><span class="line">            <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, myStr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">&quot;JNI read file fail!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">&quot;JNI read file fail!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_RWFile_nativeReadSDFile</span></span><br><span class="line"><span class="params">(JNIEnv *env, jobject jObj, jstring fileName)</span> &#123;</span><br><span class="line">    <span class="type">char</span> *fileNamePtr = (*env)-&gt;GetStringUTFChars(env, fileName, <span class="number">0</span>);</span><br><span class="line">    <span class="type">char</span> * result;</span><br><span class="line">    join(sdcardDir,fileNamePtr,result);</span><br><span class="line"></span><br><span class="line">    FILE* file = fopen(result,<span class="string">&quot;r+&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">char</span> myStr[<span class="number">128</span>];</span><br><span class="line">        <span class="type">char</span>* readInPtr = fgets(myStr, <span class="number">128</span>, file);</span><br><span class="line">        fclose(file);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> != readInPtr) &#123;</span><br><span class="line">            <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, myStr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">&quot;JNI read fail - NULL == readInPtr&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">&quot;JNI read file fail! - file is NULL &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_RWFile_nativeWrite</span></span><br><span class="line"><span class="params">(JNIEnv *env, jobject jObj, jstring msg)</span> &#123;</span><br><span class="line"></span><br><span class="line">    FILE* file = fopen(<span class="string">&quot;/sdcard/hello.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *nativeMsg = (*env)-&gt;GetStringUTFChars(env, msg, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(nativeMsg, file);</span><br><span class="line">        fflush(file);</span><br><span class="line">        fclose(file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">&quot;Write finished.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="需关注的函数"><a href="#需关注的函数" class="headerlink" title="需关注的函数"></a>需关注的函数</h2><p>要特别关心函数的返回值，返回值往往代表着调用的结果。</p>
<h3 id="打开文件-fopen"><a href="#打开文件-fopen" class="headerlink" title="打开文件 fopen"></a>打开文件 <code>fopen</code></h3><p><code>FILE * fopen(const char * path,const char * mode);</code><br>mode模式选择，例如<code>&quot;r&quot;</code>  </p>
<ul>
<li>r(read): 读</li>
<li>w(write): 写</li>
<li>a(append): 追加</li>
<li>t(text): 文本文件，可省略不写</li>
<li>b(banary): 二进制文件</li>
<li>+: 读和写</li>
</ul>
<p>凡用“r”打开一个文件时，该文件必须已经存在，且只能从该文件读出。</p>
<p>用“w”打开的文件只能向该文件写入。若打开的文件不存在，则以指定的文件名建立该文件，若打开的文件已<br>经存在，则将该文件删去，重建一个新文件。这个方法保证目标文件里写入的只有我们要的数据。</p>
<p>若要向一个已存在的文件追加新的信息，只能用“a”方式打开文件。但此时该文件必须是存在的，否则将会出错。</p>
<p>在打开一个文件时，如果出错，fopen将返回一个空指针值NULL。在程序中可以用这一信息来判别是否完成<br>打开文件的工作，并作相应的处理。</p>
<p>如果成功的打开一个文件, fopen()函数返回文件指针, 否则返回空指针</p>
<h3 id="从文件中读取数据-fgets"><a href="#从文件中读取数据-fgets" class="headerlink" title="从文件中读取数据 fgets"></a>从文件中读取数据 <code>fgets</code></h3><p><code>char *fgets(char *s, int n, FILE *stream);</code><br>从文件指针stream中读取n-1个字符，存到以s为起始地址的空间里，直到读完一行，如果成功则返回s的指<br>针，否则返回NULL。</p>
<h3 id="NDK中生成jstring的函数-env-gt-NewStringUTF-env-char"><a href="#NDK中生成jstring的函数-env-gt-NewStringUTF-env-char" class="headerlink" title="NDK中生成jstring的函数  (*env)-&gt;NewStringUTF(env, char *);"></a>NDK中生成jstring的函数  <code>(*env)-&gt;NewStringUTF(env, char *);</code></h3><p><code>(*env)-&gt;NewStringUTF(env, char *);</code><br>如果传入的char*是一个空值，在一些平台上会报错。<br>比如红米手机会直接崩溃，而魅族手机能得到一个空的String。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-01-19T12:31:11.000Z" title="2017/1/19 20:31:11">2017-01-19</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:57.733Z" title="2021/6/18 17:38:57">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">8 分钟读完 (大约1143个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/01/19/Android/Gradle_for_android_Creating_Build_Variants/">Gradle 构建多种版本</a></p><div class="content"><p>本章目的</p>
<ul>
<li>Build types 构建类型</li>
<li>Product flavors</li>
<li>Build variants 构建不同种类</li>
<li>Signing configurations</li>
</ul>
<p>开发APP时，会有生成不同版本的需求。比如测试版本和发布版本。不同版本之间通常有不同的设置。</p>
<h2 id="Build-types"><a href="#Build-types" class="headerlink" title="Build types"></a>Build types</h2><p>定义APP或者模块该被如何构建。</p>
<p>可以用<code>buildTypes</code>来定义构建类型。例如：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled <span class="literal">false</span></span><br><span class="line">        proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>默认的<code>build.gradle</code>文件会包含一个<code>release</code>构建类型</p>
<h3 id="创建构建类型"><a href="#创建构建类型" class="headerlink" title="创建构建类型"></a>创建构建类型</h3><p>比如创建一个<code>staging</code>构建类型<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">    <span class="comment">// staging 是一个自定义名字</span></span><br><span class="line">    <span class="comment">// 生成signed App时可以选择这个类型</span></span><br><span class="line">    staging.initWith(buildTypes.debug)</span><br><span class="line">    staging &#123;</span><br><span class="line">        applicationIdSuffix <span class="string">&quot;.staging&quot;</span></span><br><span class="line">        versionNameSuffix <span class="string">&quot;-staging&quot;</span></span><br><span class="line">        buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;BASE_URL&quot;</span>, <span class="string">&quot;\&quot;http://www.staging.com\&quot;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>这里定义了<code>applicationIdSuffix</code>，让staging版本的applicationId和release版本的不同。</p>
<p><code>initWith()</code>创建一个新的构建类型并复制现有的构建类型。用这个方法可以复写已有的构建类型。</p>
<h3 id="资源目录"><a href="#资源目录" class="headerlink" title="资源目录"></a>资源目录</h3><p>创建了新的构建类型后，可以建立新的资源文件。例如我们已经有了staging构建类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├── androidTest</span><br><span class="line">├── debug</span><br><span class="line">├── greenRelease</span><br><span class="line">├── main</span><br><span class="line">├── redDebug</span><br><span class="line">├── staging// 可以新建资源目录</span><br><span class="line">└── test</span><br></pre></td></tr></table></figure>
<p>不同资源目录里的文件可以用相同的文件名。</p>
<p>main目录里的strings.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;app_name&quot;</span>&gt;</span>GDemo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- staging strings.xml --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;app_name&quot;</span>&gt;</span>GStaging<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>生成不同版本的app时，会自动去找相应的资源文件</p>
<h3 id="依赖包管理"><a href="#依赖包管理" class="headerlink" title="依赖包管理"></a>依赖包管理</h3><p>每一种构建类型可以有自己的依赖。Gradle自动为每个类型创建依赖配置。<br>下面就是单独为debug版本添加logging模块的依赖</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(<span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>, <span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">    androidTestCompile(<span class="string">&#x27;com.android.support.test.espresso:espresso-core:2.2.2&#x27;</span>, &#123;</span><br><span class="line">        exclude <span class="attr">group:</span> <span class="string">&#x27;com.android.support&#x27;</span>, <span class="attr">module:</span> <span class="string">&#x27;support-annotations&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    compile <span class="string">&#x27;com.android.support:appcompat-v7:25.1.1&#x27;</span></span><br><span class="line">    testCompile <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line"></span><br><span class="line">    debugCompile <span class="string">&#x27;de.mindpipe.android:android-logging-log4j:1.0.3&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Product-flavors-产品特征"><a href="#Product-flavors-产品特征" class="headerlink" title="Product flavors 产品特征"></a>Product flavors 产品特征</h2><p>product flavors用于创建同一个APP的不同版本。最直接的例子就是免费和付费版APP。</p>
<p>当我们要发布APP时，可以选择release或者staging（上面的例子）版。但是对同一个构建类型，比如对<br>于release版，我们可以用Product flavors打包出有各自特征的APP。比如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多渠道打包可以用在这里配置</span></span><br><span class="line"><span class="comment">// 一旦配置了productFlavors，生成apk时会默认选其中一个选项</span></span><br><span class="line">productFlavors &#123;</span><br><span class="line">    red &#123;</span><br><span class="line">        versionName <span class="string">&quot;1.0-red&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    green &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.rustfisher.gradletest.green&quot;</span> <span class="comment">// 使用另一个签名</span></span><br><span class="line">        versionNameSuffix <span class="string">&quot;-green&quot;</span><span class="comment">// 版本名添加后缀</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="资源文件"><a href="#资源文件" class="headerlink" title="资源文件"></a>资源文件</h3><p>新建了productFlavors类型后，我们可以新建相应的资源目录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├── androidTest</span><br><span class="line">├── debug</span><br><span class="line">├── greenRelease // release版本  采用green</span><br><span class="line">├── main</span><br><span class="line">├── redDebug // debug版本   采用red</span><br><span class="line">├── staging</span><br><span class="line">└── test</span><br></pre></td></tr></table></figure>
<h3 id="多种特种的变量-Multiflavor-variants"><a href="#多种特种的变量-Multiflavor-variants" class="headerlink" title="多种特种的变量 Multiflavor variants"></a>多种特种的变量 Multiflavor variants</h3><p>在Product flavors中可以进行组合，例如</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line"></span><br><span class="line">    flavorDimensions(<span class="string">&quot;color&quot;</span>, <span class="string">&quot;price&quot;</span>) <span class="comment">// 新建了2种类型</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 多渠道打包可以用在这里配置</span></span><br><span class="line">    <span class="comment">// 一旦配置了productFlavors，debug时会默认选一个选项</span></span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        red &#123;</span><br><span class="line">            versionName <span class="string">&quot;1.0-red&quot;</span></span><br><span class="line">            dimension <span class="string">&quot;color&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        green &#123;</span><br><span class="line">            applicationId <span class="string">&quot;com.rustfisher.gradletest.green&quot;</span> <span class="comment">// 使用另一个签名</span></span><br><span class="line">            versionNameSuffix <span class="string">&quot;-green&quot;</span></span><br><span class="line">            dimension <span class="string">&quot;color&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        freeApp &#123;</span><br><span class="line">            dimension <span class="string">&quot;price&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        paidApp &#123;</span><br><span class="line">            dimension <span class="string">&quot;price&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么在打包apk时，可以有如下4种版本  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">green-freeApp </span><br><span class="line">green-paidApp </span><br><span class="line">red-freeApp </span><br><span class="line">red-paidApp</span><br></pre></td></tr></table></figure>
<p>一旦添加flavorDimensions，就必须为每一个flavor制定dimension。<br>就像上面的<code>color</code>和<code>price</code>必须出现在下面4种productFlavors之中。否则会报错。</p>
<h2 id="Build-Variants"><a href="#Build-Variants" class="headerlink" title="Build Variants"></a>Build Variants</h2><p>Android Studio左下角可以打开Build Variants窗口。选择模块和<code>Build Variants</code>。<br>前面配置的构建类型都会在这个列表中出现。</p>
<h3 id="Tasks-任务"><a href="#Tasks-任务" class="headerlink" title="Tasks 任务"></a>Tasks 任务</h3><p>Android plugin for Gradle 会自动为每个配置的构建类型创建任务。<br>新建项目时，会有默认的assembleDebug 和 assembleRelease。<br>经过上面的配置以后，会有产生相对应的任务<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">assemble</span><br><span class="line">assembleAndroidTest</span><br><span class="line">assembleDebug</span><br><span class="line">assembleFreeApp</span><br><span class="line">assembleGreen</span><br><span class="line">assembleGreenFreeApp</span><br><span class="line">assembleGreenPaidApp</span><br><span class="line">assemblePaidApp</span><br><span class="line">assembleRed</span><br><span class="line">assembleRedFreeApp</span><br><span class="line">assembleRedPaidApp</span><br><span class="line">assembleRelease</span><br><span class="line">assembleStaging</span><br></pre></td></tr></table></figure></p>
<h3 id="Resource-and-manifest-merging"><a href="#Resource-and-manifest-merging" class="headerlink" title="Resource and manifest merging"></a>Resource and manifest merging</h3><p>Android的Gradle插件会在打包app前将主要资源和构建类型资源合在一起。另外，lib工程也可以提供<br>额外可被合并的资源文件。manifest文件也可被合并。比如在debug版本中申请正式版中不需要的权限。</p>
<h3 id="定义构建变量"><a href="#定义构建变量" class="headerlink" title="定义构建变量"></a>定义构建变量</h3><p>给productFlavors中的类型添加资源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">productFlavors &#123;</span><br><span class="line">    red &#123;</span><br><span class="line">        versionName &quot;1.0-red&quot;</span><br><span class="line">        dimension &quot;color&quot;</span><br><span class="line">        resValue(&quot;color&quot;, &quot;flavor_color&quot;, &quot;#ff0000&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    green &#123;</span><br><span class="line">        applicationId &quot;com.rustfisher.gradletest.green&quot; // 使用另一个签名</span><br><span class="line">        versionNameSuffix &quot;-green&quot;</span><br><span class="line">        resValue(&quot;color&quot;, &quot;flavor_color&quot;, &quot;#00ff00&quot;)</span><br><span class="line">        dimension &quot;color&quot;</span><br><span class="line">    &#125;</span><br><span class="line">// ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的flavor_color可以在代码中通过R文件找到<code>R.color.flavor_color</code></p>
<p>参考：<em>Gradle for Android</em>  Kevin Pelgrims</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-01-19T12:11:11.000Z" title="2017/1/19 20:11:11">2017-01-19</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:52.929Z" title="2021/6/18 17:38:52">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">10 分钟读完 (大约1472个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/01/19/Android/Gradle_for_android_Basic_Build_Customization/">Gradle 基础自定义构建</a></p><div class="content"><p>win7  Android Studio 2.1.3</p>
<p>基础自定义构建 Basic Build Customization</p>
<p>本章目的</p>
<ul>
<li>理解Gradle文件</li>
<li>build tasks入门</li>
<li>自定义构建</li>
</ul>
<h2 id="理解Gradle文件"><a href="#理解Gradle文件" class="headerlink" title="理解Gradle文件"></a>理解Gradle文件</h2><p>在Android Studio中新建一个项目后，会自动创建3个Gradle文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MyApp</span><br><span class="line">├── build.gradle</span><br><span class="line">├── settings.gradle</span><br><span class="line">└── app</span><br><span class="line">    └── build.gradle</span><br></pre></td></tr></table></figure>
<p>每个文件都有自己的作用</p>
<h3 id="settings-gradle文件"><a href="#settings-gradle文件" class="headerlink" title="settings.gradle文件"></a>settings.gradle文件</h3><p>新建工程的settings文件类似下面这样</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&#x27;:app&#x27;</span></span><br></pre></td></tr></table></figure>
<p>Gradle为每个settings文件创建<code>Settings</code>对象，并调用其中的方法。</p>
<h3 id="The-top-level-build-file-最外层的构建文件"><a href="#The-top-level-build-file-最外层的构建文件" class="headerlink" title="The top-level build file 最外层的构建文件"></a>The top-level build file 最外层的构建文件</h3><p>能对工程中所有模块进行配置。如下</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:2.1.3&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">        maven &#123; url <span class="string">&quot;https://jitpack.io&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task clean(<span class="attr">type:</span> Delete) &#123;</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>buildscript</code>代码块是具体配置的地方，引用JCenter仓库。<br>本例中，一个仓库代表着依赖库，换句话说是app可以从中下载使用库文件。<br>JCenter是一个有名的 Maven 仓库。</p>
<p><code>dependencies</code>代码块用来配置依赖。上面注释说明了，不要在此添加依赖，而应该到独立的模块<br>中去配置依赖。</p>
<p><code>allprojects</code>能对所有模块进行配置。</p>
<h3 id="模块中的build文件"><a href="#模块中的build文件" class="headerlink" title="模块中的build文件"></a>模块中的build文件</h3><p>模块中的独立配置文件，会覆盖掉top-level的<code>build.gradle</code>文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">25</span></span><br><span class="line">    buildToolsVersion <span class="string">&quot;25.0.2&quot;</span></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.xxx.rust.newproj&quot;</span></span><br><span class="line">        minSdkVersion <span class="number">18</span></span><br><span class="line">        targetSdkVersion <span class="number">25</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(<span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>, <span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">    testCompile <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">    compile <span class="string">&#x27;com.android.support:appcompat-v7:25.1.0&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面来看3个主要的代码块。</p>
<h4 id="plugin"><a href="#plugin" class="headerlink" title="plugin"></a>plugin</h4><p>第一行应用了Android 应用插件。Android插件由Google团队开发维护。该插件提供构建，测试，打包应用和模块需要的所有的task。</p>
<h4 id="android"><a href="#android" class="headerlink" title="android"></a>android</h4><p>最大的一个区域。defaultConfig区域对app核心进行配置，会配置覆盖AndroidManifest.xml中的配置。</p>
<p>applicationId复写掉manifest文件中的包名。但applicationId和包名有区别。<br>manifest中的包名，在源代码和R文件中使用。所以package name在android studio中理解为一个查询类的路径比较合理。<br>applicationId在Android系统中是作为应用的唯一标识，即在一个Android设备中所有的应用程序的applicationId都是唯一的。</p>
<h4 id="dependencies"><a href="#dependencies" class="headerlink" title="dependencies"></a>dependencies</h4><p>是Gradle标准配置的一部分。<br>Android中用来配置使用到的库。</p>
<h2 id="定制化构建-Customizing-the-build"><a href="#定制化构建-Customizing-the-build" class="headerlink" title="定制化构建 Customizing the build"></a>定制化构建 Customizing the build</h2><h3 id="BuildConfig-and-resources"><a href="#BuildConfig-and-resources" class="headerlink" title="BuildConfig and resources"></a>BuildConfig and resources</h3><p>自从SDK17以来，构建工具会生成一个BuildConfig类，包含着静态变量DEBUG和一些信息。<br>如果你想在区分debug和正式版，比如打log，这个BuildConfig类很有用。<br>可以通过Gradle来扩展这个类，让它拥有更多的静态变量。</p>
<p>以NewProj工程为例，<code>app\build.gradle</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">25</span></span><br><span class="line">    buildToolsVersion <span class="string">&quot;25.0.2&quot;</span></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.xxx.rust.newproj&quot;</span></span><br><span class="line">        minSdkVersion <span class="number">18</span></span><br><span class="line">        targetSdkVersion <span class="number">25</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;BASE_URL&quot;</span>, <span class="string">&quot;\&quot;http://www.baidu.com\&quot;&quot;</span>)</span><br><span class="line">            buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;A_CONTENT&quot;</span>, <span class="string">&quot;\&quot;debug content\&quot;&quot;</span>)</span><br><span class="line">            resValue(<span class="string">&quot;string&quot;</span>, <span class="string">&quot;str_version&quot;</span>, <span class="string">&quot;debug_ver&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;BASE_URL&quot;</span>, <span class="string">&quot;\&quot;http://www.qq.com\&quot;&quot;</span>)</span><br><span class="line">            buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;A_CONTENT&quot;</span>, <span class="string">&quot;\&quot;release content\&quot;&quot;</span>)</span><br><span class="line">            resValue(<span class="string">&quot;string&quot;</span>, <span class="string">&quot;str_version&quot;</span>, <span class="string">&quot;release_ver&quot;</span>)</span><br><span class="line"></span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的<code>buildConfigField</code>和<code>resValue</code>在编译后，能在源代码中使用<br>注意上面那个转义的分号不可少；注意里面的大小写，这里传入的参数就像是直接填入的代码一样</p>
<p>下面是编译后生成的BuildConfig文件，可以看到buildConfigField的东西已经在里面了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BuildConfig</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">DEBUG</span> <span class="operator">=</span> Boolean.parseBoolean(<span class="string">&quot;true&quot;</span>);</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">APPLICATION_ID</span> <span class="operator">=</span> <span class="string">&quot;com.xxx.rust.newproj&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUILD_TYPE</span> <span class="operator">=</span> <span class="string">&quot;debug&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FLAVOR</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERSION_CODE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">VERSION_NAME</span> <span class="operator">=</span> <span class="string">&quot;1.0&quot;</span>;</span><br><span class="line">  <span class="comment">// Fields from build type: debug</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">A_CONTENT</span> <span class="operator">=</span> <span class="string">&quot;debug content&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BASE_URL</span> <span class="operator">=</span> <span class="string">&quot;http://www.baidu.com&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>resValue会被添加到资源文件中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mTv2.setText(R.string.str_version);</span><br></pre></td></tr></table></figure>
<h3 id="通过-build-gradle-增加获取-applicationId-的方式"><a href="#通过-build-gradle-增加获取-applicationId-的方式" class="headerlink" title="通过 build.gradle 增加获取 applicationId 的方式"></a>通过 build.gradle 增加获取 applicationId 的方式</h3><p>模块<code>build.gradle</code>中添加属性<code>applicationId</code>，会被编译到BuildConfig中<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">project.afterEvaluate &#123;</span><br><span class="line">    project.android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">        <span class="keyword">def</span> applicationId = [variant.mergedFlavor.applicationId, variant.buildType.applicationIdSuffix].findAll().join()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在代码中可以直接使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">appID</span> <span class="operator">=</span> BuildConfig.APPLICATION_ID;</span><br></pre></td></tr></table></figure></p>
<h3 id="获取时间的方法"><a href="#获取时间的方法" class="headerlink" title="获取时间的方法"></a>获取时间的方法</h3><p>模块<code>build.gradle</code>中添加方法<code>getTime()</code>，并在<code>buildTypes</code>中添加域。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前时间</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">def</span> getTime() &#123;</span><br><span class="line">    String timeNow = <span class="keyword">new</span> Date().format(<span class="string">&#x27;YYYYMMdd-HHmmss&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> timeNow</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            buildConfigField <span class="string">&quot;String&quot;</span>, <span class="string">&quot;BUILD_TIME&quot;</span>, <span class="string">&quot;\&quot;&quot;</span> + getTime() + <span class="string">&quot;\&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            buildConfigField <span class="string">&quot;String&quot;</span>, <span class="string">&quot;BUILD_TIME&quot;</span>, <span class="string">&quot;\&quot;&quot;</span> + getTime() + <span class="string">&quot;\&quot;&quot;</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>BuildConfig.java</code>中得到这个域。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fields from build type: debug</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUILD_TIME</span> <span class="operator">=</span> <span class="string">&quot;20180912-100335&quot;</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="修改release-apk文件名的方法"><a href="#修改release-apk文件名的方法" class="headerlink" title="修改release apk文件名的方法"></a>修改release apk文件名的方法</h3><p>gradle版本3.1.4。使用了上面的方法<code>getTime()</code>。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 修改release的apk名字</span></span><br><span class="line">    applicationVariants.all &#123; variant -&gt;</span><br><span class="line">        variant.outputs.all &#123;</span><br><span class="line">            <span class="keyword">if</span> (variant.buildType.name == <span class="string">&#x27;release&#x27;</span>) &#123;</span><br><span class="line">                outputFileName = <span class="string">&quot;xxx_release_$&#123;defaultConfig.versionName&#125;_$&#123;getTime()&#125;.apk&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以前的方法可能会遇到问题：<code>Cannot set the value of read-only property &#39;outputFile&#39; for ApkVariantOutputImpl_Decorated</code>。<br>参考：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/44239235/android-gradle-3-0-0-alpha2-plugin-cannot-set-the-value-of-read-only-property">https://stackoverflow.com/questions/44239235/android-gradle-3-0-0-alpha2-plugin-cannot-set-the-value-of-read-only-property</a></p>
<h3 id="工程范围的设置"><a href="#工程范围的设置" class="headerlink" title="工程范围的设置"></a>工程范围的设置</h3><p>如果一个工程中有多个模块，可以对整个工程应用设置，而不用去修改每一个模块。</p>
<p><code>NewProj\build.gradle</code><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ext &#123;</span><br><span class="line">    compileSDKVersion = <span class="number">25</span></span><br><span class="line">    local = <span class="string">&#x27;Hello from the top-level build&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每一个<code>build.gradle</code>文件都能定义额外的属性，在ext代码块中。</p>
<p>在一个模块的<code>libmodule\build.gradle</code>文件中，可以引用rootProject的ext属性</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion rootProject.ext.compileSDKVersion</span><br><span class="line">    buildToolsVersion <span class="string">&quot;25.0.2&quot;</span></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="工程属性-Project-properties"><a href="#工程属性-Project-properties" class="headerlink" title="工程属性 Project properties"></a>工程属性 Project properties</h3><p>定义properties的地方</p>
<ul>
<li>ext代码块</li>
<li>gradle.properties文件</li>
<li>命令行 -P 参数</li>
</ul>
<p>工程<code>build.gradle</code>文件<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">    compileSDKVersion = <span class="number">25</span></span><br><span class="line">    local = <span class="string">&#x27;Hello from the top-level build&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Print properties info</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">task aPrintSomeInfo &#123;</span><br><span class="line">    println(local)</span><br><span class="line">    println(<span class="string">&#x27;project dir: &#x27;</span> + projectDir)</span><br><span class="line">    println(projectPropertiesFileText)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task aPrintAllProperites() &#123;</span><br><span class="line">    println(<span class="string">&#x27;\nthis is aPrintAllProperites task\n&#x27;</span>)</span><br><span class="line">    Iterator pIt = properties.iterator()</span><br><span class="line">    <span class="keyword">while</span> (pIt.hasNext()) &#123;</span><br><span class="line">        println(pIt.next())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>gradle.properties文件中增加<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">projectPropertiesFileText = Hello there from gradle.properties</span><br></pre></td></tr></table></figure></p>
<p>在as的Gradle栏上双击执行aPrintSomeInfo，会连带下一个task也执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">13:08:10: Executing external task &#x27;aPrintSomeInfo&#x27;...</span><br><span class="line">Hello from the top-level build</span><br><span class="line">project dir: G:\openSourceProject\NewProj</span><br><span class="line">Hello there from gradle.properties</span><br><span class="line"></span><br><span class="line">this is aPrintAllProperites task</span><br><span class="line">......</span><br><span class="line">BUILD SUCCESSFUL</span><br><span class="line"></span><br><span class="line">Total time: 1.025 secs</span><br><span class="line">13:08:11: External task execution finished &#x27;aPrintSomeInfo&#x27;.</span><br></pre></td></tr></table></figure>
<p>参考：<em>Gradle for Android</em>  Kevin Pelgrims</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2017-01-19T11:01:15.000Z" title="2017/1/19 19:01:15">2017-01-19</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:39:00.302Z" title="2021/6/18 17:39:00">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">9 分钟读完 (大约1415个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/01/19/Android/Gradle_for_android_Start/">Gradle for Android 开始</a></p><div class="content"><h1 id="Gradle-for-Android开始"><a href="#Gradle-for-Android开始" class="headerlink" title="Gradle for Android开始"></a>Gradle for Android开始</h1><p>Google在Gradle中的目标：能复用代码，创建构建变量，能配置和定制构建过程。</p>
<h2 id="Gradle基础"><a href="#Gradle基础" class="headerlink" title="Gradle基础"></a>Gradle基础</h2><p>Gradle构建脚本并不是用XML来写的，而是基于Groovy的一种（domain-specifc language）<br>DSL语言。这是一种运行在JVM上的动态语言。</p>
<p>如果要构建新的任务和插件，我们需要了解这门语言。</p>
<h2 id="Projects-and-tasks"><a href="#Projects-and-tasks" class="headerlink" title="Projects and tasks"></a>Projects and tasks</h2><p>这是Gradle种最重要的两个概念。每个构建（build）至少包含一个project，每一个project包含<br>一个或多个task。每个<code>build.gradle</code>代表一个project。task被定义在这个构建脚本中。<br>一个task对象包含一列需要被执行的Action对象。一个Action对象就是一块被执行的代码，就像<br>Java中的方法。</p>
<p>当初始化构建进程时，Gradle收集build文件中的project和task对象。</p>
<h2 id="构建的生命周期（The-build-lifecycle）"><a href="#构建的生命周期（The-build-lifecycle）" class="headerlink" title="构建的生命周期（The build lifecycle）"></a>构建的生命周期（The build lifecycle）</h2><p>为简化构建过程，构建工具创造了一种工作流的动态模型DAG（Directed Acyclic Graph）。<br>这意味着所有的任务会一个接一个地执行，不会出现循环的情况。<br>一个任务一旦被执行就不会再被调用。没有依赖的任务永远是最优先执行的。<br>在配置过程中生成依赖关系。</p>
<p>一个Gradle构建过程有3个步骤：</p>
<ul>
<li>初始化：工程实例被创建时初始化。如果有多个模块，每个模块有自己的<code>build.gradle</code>文件，<br>多个project被创建。</li>
<li>配置：这一步执行build脚本，创建并配置每个project的task。</li>
<li>执行：Gradle决定执行那些任务。根据当前目录和传入参数执行task。</li>
</ul>
<h2 id="build配置文件"><a href="#build配置文件" class="headerlink" title="build配置文件"></a>build配置文件</h2><p><code>build.gradle</code>文件。配置build的地方。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:2.2.2&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>repositories块中，指定JCenter作为依赖仓库。<br>这个脚本获取了Android构建工具。这个Android插件提供了构建和测试应用所需的功能。</p>
<p>插件被用来扩展Gradle构建脚本的功能。在project中使用插件，就可以定义属性和任务。</p>
<h2 id="Gradle-Wrapper初步"><a href="#Gradle-Wrapper初步" class="headerlink" title="Gradle Wrapper初步"></a>Gradle Wrapper初步</h2><p>Gradle是一个开发中的工具。使用Gradle Wrapper可以避免一些问题，确保能构建顺利。<br>Gradle在Windows系统上提供了batch文件，在其他系统上提供了shell脚本。试图运行脚本时，会<br>自动检查并下载Gradle。但在我们的网络比较令人着急。可以尝试在网络上找资源。</p>
<p>比如我下载了一个<code>gradle-2.14.1-all.zip</code>，将其放到Android工程的gradle/wrapper下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gradle</span><br><span class="line">`-- wrapper</span><br><span class="line">    |-- gradle-2.14.1-all.zip</span><br><span class="line">    |-- gradle-wrapper.jar</span><br><span class="line">    `-- gradle-wrapper.properties</span><br></pre></td></tr></table></figure>
<p>然后修改<code>gradle-wrapper.properties</code>文件，把Url修改成<br><code>distributionUrl=gradle-2.14.1-all.zip</code></p>
<p>在Android Studio提供的Terminal中运行<code>grawdlew</code>，先unzipping，然后开始下载依赖文件。<br>这些文件在windows中默认存放到<br><code>C:\Users\UserName\.gradle\wrapper\dists\gradle-2.14.1-all</code>，还是很占空间的。<br>此时你可以在项目下的命令行中使用grawdlew命令。比如查看版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">G:\rust_proj\NDKProj&gt;gradlew -v</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Gradle 2.14.1</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Build time:   2016-07-18 06:38:37 UTC</span><br><span class="line">Revision:     d9e2113d9fb05a5caabba61798bdb8dfdca83719</span><br><span class="line"></span><br><span class="line">Groovy:       2.4.4</span><br><span class="line">Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015</span><br><span class="line">JVM:          1.8.0_77 (Oracle Corporation 25.77-b03)</span><br><span class="line">OS:           Windows 7 6.1 amd64</span><br></pre></td></tr></table></figure>
<p>如果在另一个Android项目下同样复制了<code>gradle-2.14.1-all.zip</code>，并且尝试运行gradlew，<br>C盘里相应目录下又会多一个文件夹。</p>
<h2 id="获取Gradle-Wrapper"><a href="#获取Gradle-Wrapper" class="headerlink" title="获取Gradle Wrapper"></a>获取Gradle Wrapper</h2><p>打开Windows CMD，进入前面配置好的Android工程目录，同样可以运行gradlew。</p>
<p>此时我们的C盘里已经有<code>gradle-2.14.1-all.zip</code>了。找到<code>gradle.bat</code>的路径，将其添加到<br>电脑PATH中。这里添加到用户的环境变量中。</p>
<p>在G盘新建一个目录<code>gradleTest</code>，然后创建一个<code>build.gradle</code>文件；其中填写如下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">task wrapper(type: Wrapper) &#123;</span><br><span class="line">    gradleVersion = &#x27;2.4&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入刚才的目录，在CMD中直接运行gradle</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">G:\gradleTest&gt;gradle</span><br><span class="line">:help</span><br><span class="line">Welcome to Gradle 2.14.1.</span><br><span class="line">To run a build, run gradle &lt;task&gt; ...</span><br><span class="line">To see a list of available tasks, run gradle tasks</span><br><span class="line">To see a list of command-line options, run gradle --help</span><br><span class="line">To see more detail about a task, run gradle help --task &lt;task&gt;</span><br><span class="line">BUILD SUCCESSFUL</span><br><span class="line">Total time: 1.714 secs</span><br></pre></td></tr></table></figure>
<p>此时目录下生成了一个<code>.gradle</code>目录</p>
<p>如果当前目录下没有<code>build.gradle</code>文件，gradle也会执行并生成<code>.gradle</code>目录。</p>
<p>我们来观察Android项目里Gradle Wrapper的情况<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NDKProj/</span><br><span class="line">├── gradlew</span><br><span class="line">├── gradlew.bat</span><br><span class="line">└── gradle/wrapper/</span><br><span class="line">    ├── gradle-wrapper.jar</span><br><span class="line">    └── gradle-wrapper.properties</span><br></pre></td></tr></table></figure><br>Gradle Wrapper包含3个部分：</p>
<ul>
<li>MS可执行的gradlew.bat和Linux， Mac OS X可执行的gradlew</li>
<li>脚本需要的Jar文件</li>
<li>一个properties文件</li>
</ul>
<p>在前面我们已经把properties文件修改成了这样：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#Mon Aug 29 19:26:36 CST 2016</span><br><span class="line">distributionBase=GRADLE_USER_HOME</span><br><span class="line">distributionPath=wrapper/dists</span><br><span class="line">zipStoreBase=GRADLE_USER_HOME</span><br><span class="line">zipStorePath=wrapper/dists</span><br><span class="line">distributionUrl=gradle-2.14.1-all.zip</span><br></pre></td></tr></table></figure></p>
<p>原distributionUrl如下：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">distributionUrl=https\://services.gradle.org/distributions/gradle-2.14.1-all.zip</span><br></pre></td></tr></table></figure></p>
<p>这意味着我们可以使用不同的URL和Gradle。我们前面已经这么做了。</p>
<h2 id="运行基本的构建任务（task）"><a href="#运行基本的构建任务（task）" class="headerlink" title="运行基本的构建任务（task）"></a>运行基本的构建任务（task）</h2><p>进入Android工程目录下，用命令行执行gradlew<br><code>gradlew tasks</code>会打印出任务列表；<code>gradlew tasks --all</code>打印出所有的任务</p>
<p><code>gradlew assembleDebug</code>编译当前项目，创建一个debug版本的apk</p>
<p><code>gradlew clean</code>清理当前项目的output</p>
<p><code>gradlew check</code>运行所有的检查，通常是在真机或者模拟器上运行测试</p>
<p><code>gradlew build</code>触发assemble 和 check</p>
<p>这些功能在Android Studio上都有相应按键</p>
<p>参考：<em>Gradle for Android</em>  Kevin Pelgrims</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-08-02T00:08:16.000Z" title="2016/8/2 08:08:16">2016-08-02</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:39:12.416Z" title="2021/6/18 17:39:12">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">17 分钟读完 (大约2552个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/08/02/Android/NDK-use_sample_1/">Android NDK 示例-返回字符串，数组，Java对象；兼容性问题</a></p><div class="content"><p>Android Studio 2.2.3 创建工程 NDKProj</p>
<h3 id="工程准备"><a href="#工程准备" class="headerlink" title="工程准备"></a>工程准备</h3><p>在<code>SmartAlgorithm.java</code>中加载了库文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java</span><br><span class="line">`-- com</span><br><span class="line">    `-- rustfisher</span><br><span class="line">        `-- ndkproj</span><br><span class="line">            |-- MainActivity.java</span><br><span class="line">            `-- SmartAlgorithm.java</span><br></pre></td></tr></table></figure><br>JNI目录，需要mk文件，头文件和源文件。这里头文件和源文件故意不统一文件名，也可实现效果。<br>但还是建议用同样的文件名，方便定位。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jni/</span><br><span class="line">|-- Android.mk</span><br><span class="line">|-- Application.mk</span><br><span class="line">|-- com_rustfisher_ndkproj_SmartAlgorithm.h</span><br><span class="line">`-- com_rustfisher_ndkproj_SmartAlgorithm_if_not_the_same.cpp</span><br></pre></td></tr></table></figure></p>
<h3 id="NDK返回值"><a href="#NDK返回值" class="headerlink" title="NDK返回值"></a>NDK返回值</h3><p>加载<code>SmartAlgorithm</code>；这个是统一标示。LOCAL_MODULE 与 APP_MODULES 均为此标示。<br>NDK中的方法要声明为native。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rustfisher.ndkproj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmartAlgorithm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;SmartAlgorithm&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">getMsg</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><strong>注意</strong>，Java文件生成头文件后，Java文件的路径不能轻易改动。</p>
<p>编写Android.mk文件；ABI 选择all，编译出支持多个平台的so文件。<br>填入源文件的文件名。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line">LOCAL_MODULE := SmartAlgorithm</span><br><span class="line">TARGET_ARCH_ABI := all</span><br><span class="line">LOCAL_SRC_FILES := com_rustfisher_ndkproj_SmartAlgorithm_if_not_the_same.cpp</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_SHARED_LIBRARY)</span></span><br></pre></td></tr></table></figure></p>
<p>编写Application.mk文件（网上copy来的）。同样ABI 选择all。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">APP_PLATFORM := android-16</span><br><span class="line">APP_MODULES := SmartAlgorithm</span><br><span class="line">APP_ABI := all</span><br><span class="line">APP_STL := stlport_static</span><br><span class="line">APP_CPPFLAGS += -fexceptions</span><br><span class="line"><span class="comment"># for using c++ features,you need to enable these in your Makefile</span></span><br><span class="line">APP_CPP_FEATURES += exceptions rtti</span><br></pre></td></tr></table></figure></p>
<p>修改工程build.gradle文件，添加jni的配置。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sourceSets</span> &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">        jni.srcDirs = []</span><br><span class="line">        jniLibs.srcDirs = [<span class="string">&#x27;src/main/libs&#x27;</span>]<span class="comment">// 指定so库的位置</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译出头文件，得到 <code>com_rustfisher_ndkproj_SmartAlgorithm.h</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKProj/app/src/main/java</span><br><span class="line">javah com.rustfisher.ndkproj.SmartAlgorithm</span><br></pre></td></tr></table></figure>
<p>将头文件放到jni目录下，与源文件一起。</p>
<p>生成的头文件不要手动去修改，直接使用即可。<br><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class com_rustfisher_ndkproj_SmartAlgorithm */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _Included_com_rustfisher_ndkproj_SmartAlgorithm</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _Included_com_rustfisher_ndkproj_SmartAlgorithm</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_rustfisher_ndkproj_SmartAlgorithm</span></span><br><span class="line"><span class="comment"> * Method:    getMsg</span></span><br><span class="line"><span class="comment">* Signature: ()Ljava/lang/String;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_com_rustfisher_ndkproj_SmartAlgorithm_getMsg</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_rustfisher_ndkproj_SmartAlgorithm</span></span><br><span class="line"><span class="comment"> * Method:    add</span></span><br><span class="line"><span class="comment">* Signature: (II)I</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_rustfisher_ndkproj_SmartAlgorithm_add</span></span><br><span class="line">  <span class="params">(JNIEnv *, jobject, jint, jint)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>编写源文件，实现头文件中的方法。一个是返回字符串，一个是加法。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;com_rustfisher_ndkproj_SmartAlgorithm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Already define in com_rustfisher_ndkproj_SmartAlgorithm.h, no need to extern C here.</span></span><br><span class="line"><span class="comment">extern &quot;C&quot; &#123;</span></span><br><span class="line"><span class="comment">    JNIEXPORT jstring JNICALL Java_com_rustfisher_ndkproj_SmartAlgorithm_getMsg(JNIEnv *env, jobject obj);</span></span><br><span class="line"><span class="comment">    JNIEXPORT jint JNICALL Java_com_rustfisher_ndkproj_SmartAlgorithm_add(JNIEnv *env, jobject obj, jint a, jint b);</span></span><br><span class="line"><span class="comment">&#125;;*/</span></span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring JNICALL <span class="title function_">Java_com_rustfisher_ndkproj_SmartAlgorithm_getMsg</span><span class="params">(JNIEnv *env, jobject obj)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">&quot;Hello from the JNI.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jint JNICALL <span class="title function_">Java_com_rustfisher_ndkproj_SmartAlgorithm_add</span><span class="params">(JNIEnv *env, jobject obj, jint a, jint b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;<span class="comment">//*</span></span><br></pre></td></tr></table></figure></p>
<p>然后在命令行 ndk-build。这里是win7下的Cygwin。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKProj/app/src/main/jni</span><br><span class="line">$ ndk-build.cmd</span><br><span class="line">[all] Compile++      : SmartAlgorithm &lt;= com_rustfisher_ndkproj_SmartAlgorithm_if_not_the_same.cpp</span><br><span class="line">[all] SharedLibrary  : libSmartAlgorithm.so</span><br><span class="line">[all] Install        : libSmartAlgorithm.so =&gt; libs/arm64-v8a/libSmartAlgorithm.so</span><br><span class="line"><span class="comment"># ...... 后面还有很多</span></span><br></pre></td></tr></table></figure></p>
<p>在libs目录下出现了对应的so库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKProj/app/src/main/libs</span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">|-- arm64-v8a</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- armeabi</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- armeabi-v7a</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- mips</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- mips64</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">|-- x86</span><br><span class="line">|   `-- libSmartAlgorithm.so</span><br><span class="line">`-- x86_64</span><br><span class="line">    `-- libSmartAlgorithm.so</span><br><span class="line"></span><br><span class="line">7 directories, 7 files</span><br></pre></td></tr></table></figure></p>
<p>在MainActivity中调用这两个方法。<br>运行apk到机器上，查看log。发现调用成功。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.rustfisher.ndkproj D/MainActivity: onCreate: Hello from the JNI.</span><br><span class="line">com.rustfisher.ndkproj D/MainActivity: onCreate: 3</span><br></pre></td></tr></table></figure>
<h3 id="处理数组的方法"><a href="#处理数组的方法" class="headerlink" title="处理数组的方法"></a>处理数组的方法</h3><p>1.不要直接操作输入的数组；<br>2.注意释放本地引用，防止溢出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">short</span>[] getConvertedArray(<span class="type">short</span>[] data, <span class="type">int</span> dataLen);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jshortArray JNICALL <span class="title">Java_com_rustfisher_ndkproj_SmartAlgorithm_getConvertedArray</span><span class="params">(JNIEnv *env, jobject obj, jshortArray input, jint len)</span> </span>&#123;</span><br><span class="line">    jshort* inputPtr;</span><br><span class="line">    inputPtr = env-&gt;<span class="built_in">GetShortArrayElements</span>(input,<span class="number">0</span>);<span class="comment">// 直接操作指针会改变Android Dalvik中的值</span></span><br><span class="line">    jshort* resPtr;</span><br><span class="line">    jshortArray result;</span><br><span class="line">    result = env-&gt;<span class="built_in">NewShortArray</span>(len);<span class="comment">// 创建新的数组</span></span><br><span class="line">    resPtr = env-&gt;<span class="built_in">GetShortArrayElements</span>(result,<span class="number">0</span>);<span class="comment">// 指针</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(jint i = <span class="number">0</span>;i &lt; len;i++) &#123;</span><br><span class="line">        resPtr[i] = inputPtr[i] * <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseShortArrayElements</span>(input, inputPtr, <span class="number">0</span>);<span class="comment">// 释放本地引用</span></span><br><span class="line">    env-&gt;<span class="built_in">SetShortArrayRegion</span>(result,<span class="number">0</span>,len,resPtr);     <span class="comment">// 存入数据</span></span><br><span class="line">    env-&gt;<span class="built_in">ReleaseShortArrayElements</span>(result, resPtr, <span class="number">0</span>); <span class="comment">// 释放本地引用</span></span><br><span class="line">    <span class="keyword">return</span> result;<span class="comment">// 返回结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JNI层-unsigned-char-与-jbyte-数组转换"><a href="#JNI层-unsigned-char-与-jbyte-数组转换" class="headerlink" title="JNI层 unsigned char 与 jbyte 数组转换"></a>JNI层 unsigned char 与 jbyte 数组转换</h3><p>本例说明的是unsigned char 与 jbyte之间互相转换<br>注意方法：<code>(*env)-&gt;SetByteArrayRegion(env, jbyte_arr, 0, len, uc_ptr);</code><br>java代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] getByteArrayFromJNI() &#123;</span><br><span class="line">    <span class="keyword">return</span> nativeGetByteArray();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] byteArrayTravelJNI(<span class="type">byte</span>[] input) &#123;</span><br><span class="line">    <span class="keyword">return</span> nativeSendByteArray(input, input.length);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">byte</span>[] nativeGetByteArray(); <span class="comment">// 从JNI中获取byte数组</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输入byte数组，在JNI中转换后再获取回来</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">native</span> <span class="type">byte</span>[] nativeSendByteArray(<span class="type">byte</span>[] input, <span class="type">int</span> len);</span><br></pre></td></tr></table></figure></p>
<p>JNI C代码<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// return byte array from unsigned char array.  jbytes:  1 2 0 7f 80 81 ff 0 1</span></span><br><span class="line">JNIEXPORT jbyteArray JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_NDKUtils_nativeGetByteArray</span><span class="params">(JNIEnv *env, jobject jObj)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> uc_arr[] = &#123;<span class="number">1</span>, <span class="number">-2</span>, <span class="number">0</span>, <span class="number">127</span>, <span class="number">128</span>, <span class="number">129</span>, <span class="number">255</span>, <span class="number">256</span>, <span class="number">257</span>&#125;;</span><br><span class="line">    <span class="type">int</span> uc_arr_len = <span class="keyword">sizeof</span>(uc_arr) / <span class="keyword">sizeof</span>(uc_arr[<span class="number">0</span>]);</span><br><span class="line">    jbyte byte_array[uc_arr_len];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;i &lt; uc_arr_len; i++) &#123;</span><br><span class="line">        byte_array[i] = uc_arr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    jbyteArray jbyte_arr = (*env)-&gt;NewByteArray(env, uc_arr_len);</span><br><span class="line">    (*env)-&gt;SetByteArrayRegion(env, jbyte_arr, <span class="number">0</span>, uc_arr_len, byte_array);</span><br><span class="line">    <span class="keyword">return</span> jbyte_arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// jbyte -&gt; unsigned char -&gt; jbyte</span></span><br><span class="line">JNIEXPORT jbyteArray JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_NDKUtils_nativeSendByteArray</span></span><br><span class="line">    <span class="params">(JNIEnv *env, jobject jObj, jbyteArray input_byte_arr, jint input_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> len = (<span class="type">int</span>)input_len;</span><br><span class="line">    jbyte *jbyte_ptr = (*env)-&gt;GetByteArrayElements(env, input_byte_arr, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *uc_ptr = (<span class="type">unsigned</span> <span class="type">char</span> *)jbyte_ptr;</span><br><span class="line"></span><br><span class="line">    jbyteArray jbyte_arr = (*env)-&gt;NewByteArray(env, len);</span><br><span class="line">    jbyte byte_array[input_len];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(;i &lt; input_len; i++) &#123;</span><br><span class="line">        byte_array[i] = uc_ptr[i];</span><br><span class="line">    &#125;</span><br><span class="line">    (*env)-&gt;SetByteArrayRegion(env, jbyte_arr, <span class="number">0</span>, len, byte_array);</span><br><span class="line">    (*env)-&gt;ReleaseByteArrayElements(env, input_byte_arr, jbyte_ptr, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> jbyte_arr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于<code>SetByteArrayRegion</code>这个方法<br>方法说明：<code>void SetXxxArrayRegion(JNIEnv *env, jarray array, jint start, jint length, Xxx elems[])</code><br>将C数组的元素复制到Java数组中。注意最后一个参数要和前面的对应上。</p>
<p><code>void ReleaseXxxArrayElements(JNIEnv *env, jarray array, Xxx elems[], jint mode)</code><br>通知虚拟机通过GetXxxArrayElements获得的一个指针已经不再需要了。Mode是0，更新数组<br>元素后释放elems缓存。</p>
<p>在这里遇到过一个bug，同样的代码在armeabi上正常运行，但是到了v7a或v8a平台上就闪退。<br>使用<code>SetXxxArrayRegion</code>这个方法时，传入的参数一定要和方法名中的<code>Xxx</code>对应上<br>详细可以参考<em>Core Java</em>中的Java Native和Android Develop上关于abi的解释</p>
<p>测试调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NDKUtils</span> <span class="variable">ndkUtils</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NDKUtils</span>();</span><br><span class="line"><span class="type">byte</span>[] res = ndkUtils.getByteArrayFromJNI(); <span class="comment">// 从JNI中获取byte数组</span></span><br><span class="line">logBytes(res);</span><br><span class="line">Log.d(TAG, <span class="string">&quot;-------------------------------------------------------------&quot;</span>);</span><br><span class="line"><span class="type">byte</span>[] inputBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">127</span>, (<span class="type">byte</span>) <span class="number">128</span>, (<span class="type">byte</span>) <span class="number">255</span>, -<span class="number">120</span>&#125;;</span><br><span class="line"><span class="type">byte</span>[] tRes = ndkUtils.byteArrayTravelJNI(inputBytes); <span class="comment">// 让byte数组在JNI中旅游一圈</span></span><br><span class="line">logBytes(inputBytes);</span><br><span class="line">logBytes(tRes);</span><br></pre></td></tr></table></figure></p>
<p>输出<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bytes:  1 2 0 7f 80 81 ff 0 1 </span><br><span class="line">-------------------------------------------------------------</span><br><span class="line">bytes:  1 2 7f 80 ff 88 </span><br><span class="line">bytes:  1 2 7f 80 ff 88 </span><br></pre></td></tr></table></figure></p>
<h3 id="直接操作输入的数组"><a href="#直接操作输入的数组" class="headerlink" title="直接操作输入的数组"></a>直接操作输入的数组</h3><p>以int数组为例<br>输入一个数组后，获取数组然后直接改变数组中的元素，最后释放掉本地引用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT <span class="type">void</span> JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_NDKUtils_nativeModifyArray</span></span><br><span class="line">  <span class="params">(JNIEnv *env, jobject jObj, jintArray input_arr, jint input_len)</span> &#123;</span><br><span class="line">    <span class="type">int</span> * input_ptr = (*env)-&gt;GetIntArrayElements(env, input_arr, <span class="number">0</span>);</span><br><span class="line">    input_ptr[input_len - <span class="number">1</span>] =  input_ptr[input_len - <span class="number">1</span>] - <span class="number">1</span>;</span><br><span class="line">    (*env)-&gt;ReleaseIntArrayElements(env, input_arr, input_ptr, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">NDKUtils</span> <span class="variable">moUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NDKUtils</span>();</span><br><span class="line"><span class="type">int</span>[] origin = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;;</span><br><span class="line">Log.d(TAG, <span class="string">&quot;origin before: &quot;</span> + Arrays.toString(origin));</span><br><span class="line">moUtil.modifyArray(origin);</span><br><span class="line">Log.d(TAG, <span class="string">&quot;origin after:  &quot;</span> + Arrays.toString(origin));</span><br></pre></td></tr></table></figure>
<p>观察输出可以看出，输入的数组直接被改变了<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">origin before: [1, 2, 3, 4, 5, 6, 7]</span><br><span class="line">origin after:  [1, 2, 3, 4, 5, 6, 6]</span><br></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT <span class="type">void</span> JNICALL <span class="title">Java_com_rustfisher_face_1detect_1lib_CalHelper_cvtNV21</span></span></span><br><span class="line"><span class="function">  <span class="params">(JNIEnv *env, jclass jcls, jbyteArray input_arr,jint in_arr_len,</span></span></span><br><span class="line"><span class="params"><span class="function">   jbyteArray target_arr, jint nv21_size, jint y_size, jint yuv_gap)</span> </span>&#123;</span><br><span class="line">    jbyte *in_ptr = env-&gt;<span class="built_in">GetByteArrayElements</span>(input_arr, <span class="literal">false</span>);</span><br><span class="line">    jbyte *target_ptr = env-&gt;<span class="built_in">GetByteArrayElements</span>(target_arr, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = y_size; i &lt; nv21_size; i+=<span class="number">2</span>)&#123;</span><br><span class="line">        target_ptr[i] = in_ptr[i + yuv_gap + <span class="number">1</span>];</span><br><span class="line">        target_ptr[i + <span class="number">1</span>] = in_ptr[i + yuv_gap];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="返回Java对象"><a href="#返回Java对象" class="headerlink" title="返回Java对象"></a>返回Java对象</h3><p>NDK中可以创建Java对象并返回。<br>例如我们新建一个<code>JavaUser</code>类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaUser</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JavaUser</span><span class="params">(<span class="type">int</span> age, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name + <span class="string">&quot;, &quot;</span> + age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>native方法返回一个JavaUser对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NDKUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;NDKMan&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JavaUser <span class="title function_">createUser</span><span class="params">(<span class="type">int</span> age, String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nativeGetUser(age, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">native</span> JavaUser <span class="title function_">nativeGetUser</span><span class="params">(<span class="type">int</span> age, String name)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>c文件实现代码。注意参数签名的写法，要参照标准。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JNIEXPORT jobject JNICALL <span class="title function_">Java_com_rustfisher_ndkalgo_NDKUtils_nativeGetUser</span></span><br><span class="line">    <span class="params">(JNIEnv *env, jobject jObj, jint age, jstring name)</span></span><br><span class="line">&#123;</span><br><span class="line">    jclass userClass = (*env)-&gt;FindClass(env, <span class="string">&quot;com/rustfisher/ndkalgo/JavaUser&quot;</span>);</span><br><span class="line">    jmethodID userConstruct = (*env)-&gt;GetMethodID(env, userClass, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(ILjava/lang/String;)V&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (*env)-&gt;NewObject(env, userClass, userConstruct, age, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用native方法生成对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testJavaUserNDK</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">NDKUtils</span> <span class="variable">ndkUtils</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NDKUtils</span>();</span><br><span class="line">    <span class="type">JavaUser</span> <span class="variable">tom</span> <span class="operator">=</span> ndkUtils.createUser(<span class="number">20</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">    Log.d(TAG, tom.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="NDK兼容性问题"><a href="#NDK兼容性问题" class="headerlink" title="NDK兼容性问题"></a>NDK兼容性问题</h3><p>Vivo x6plus 兼容性问题。Vivo x6plus 打开Parrot界面即崩溃。但是Parrot官方APP能够正常使用。<br>我自己的so库与Parrot的so库不兼容，出现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java.lang.UnsatisfiedLinkError:</span><br><span class="line">dalvik.system.PathClassLoader[DexPathList[[zip file &quot;/data/app/com.xx.xx.xxx-1/base.apk&quot;],nativeLibraryDirectories=[/data/app/com.xx.xx.xxx-1/lib/arm64, /vendor/lib64, /system/lib64]]] couldn&#x27;t find &quot;libjson.so&quot;</span><br><span class="line">    at java.lang.Runtime.loadLibrary(Runtime.java:366)</span><br><span class="line">    at java.lang.System.loadLibrary(System.java:988)</span><br><span class="line">    at com.parrot.arsdk.ARSDK.loadSDKLibs(ARSDK.java:20)</span><br><span class="line">    at com.parrot.sdk.activity.DronesListActivity.&lt;clinit&gt;(DronesListActivity.java:44)</span><br><span class="line">    at java.lang.reflect.Constructor.newInstance(Native Method)</span><br></pre></td></tr></table></figure>
<h4 id="分析处理兼容性问题"><a href="#分析处理兼容性问题" class="headerlink" title="分析处理兼容性问题"></a>分析处理兼容性问题</h4><p>将Parrot官方apk解包后，找到so库文件。发现只有x86、mips、armeabi_v7a、armeabi 这4个。<br>而我加载了有更多的库。</p>
<p>将我自己的so文件删除至只剩下Parrot那4个即可。</p>
<p>Android.mk<br><code>TARGET_ARCH_ABI := x86 mips armeabi armeabi-v7a</code></p>
<h3 id="同名so文件引起UnsatisfiedLinkError"><a href="#同名so文件引起UnsatisfiedLinkError" class="headerlink" title="同名so文件引起UnsatisfiedLinkError"></a>同名so文件引起UnsatisfiedLinkError</h3><p>主工程<code>app</code>中带有C工程与so文件。现需要将所有的C工程移到新的模块<code>mylib</code>中。</p>
<p>新建模块<code>mylib</code>，将C工程复制进来。gradle中配置jni，因为修改了文件路径，重新生成头文件并修改cpp文件。<br>在模块中进行ndk-build，获得so库。</p>
<p>安装运行app，出现UnsatisfiedLinkError：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.UnsatisfiedLinkError: No implementation found for void com.xx.jni.MyJNI.init(java.lang.String) </span><br><span class="line">(tried Java_com_xx_jni_MyJNI_init and Java_com_xx_jni_MyJNI_init__Ljava_lang_String_2)</span><br></pre></td></tr></table></figure><br>分析原因，app能够正常加载库文件，但未找到实现方法。app使用的so库，究竟是不是我们指定的那个。</p>
<p>尝试进行修复，原app工程的<code>Android.mk</code>中<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE := main</span><br></pre></td></tr></table></figure><br>移动到模块后，新的<code>Android.mk</code>修改为<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_MODULE := mynewmain</span><br></pre></td></tr></table></figure><br>库改了名字后，修改Java代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    System.loadLibrary(<span class="string">&quot;mynewmain&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>重装app即可正常使用。</p>
<p>经过分析与尝试，删除原app工程中所有的so文件，再次重装app即可正常运行。不需要修改so库的名字。</p>
<p>错误原因猜想：app主工程与模块<code>mylib</code>中有同名的so文件，安装app时会优先使用app主工程中的so库。</p>
<h3 id="jstring转为char的方法-jstring-gt-char"><a href="#jstring转为char的方法-jstring-gt-char" class="headerlink" title="jstring转为char的方法 jstring -&gt; char"></a>jstring转为char的方法 jstring -&gt; char</h3><p>jstring转为char的方法<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span> *<span class="title">jstringToChar</span><span class="params">(JNIEnv *env, jstring jstr)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> *rtn = <span class="literal">NULL</span>;</span><br><span class="line">    jclass clsstring = env-&gt;<span class="built_in">FindClass</span>(<span class="string">&quot;java/lang/String&quot;</span>);</span><br><span class="line">    jstring strencode = env-&gt;<span class="built_in">NewStringUTF</span>(<span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">    jmethodID mid = env-&gt;<span class="built_in">GetMethodID</span>(clsstring, <span class="string">&quot;getBytes&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)[B&quot;</span>);</span><br><span class="line">    jbyteArray barr = (jbyteArray) env-&gt;<span class="built_in">CallObjectMethod</span>(jstr, mid, strencode);</span><br><span class="line">    jsize alen = env-&gt;<span class="built_in">GetArrayLength</span>(barr);</span><br><span class="line">    jbyte *ba = env-&gt;<span class="built_in">GetByteArrayElements</span>(barr, JNI_FALSE);</span><br><span class="line">    <span class="keyword">if</span> (alen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        rtn = (<span class="type">char</span> *) <span class="built_in">malloc</span>(alen + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(rtn, ba, alen);</span><br><span class="line">        rtn[alen] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseByteArrayElements</span>(barr, ba, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> rtn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考 <a target="_blank" rel="noopener" href="https://blog.csdn.net/xlxxcc/article/details/51106721">JNI中string 、 char* 和 jstring 两种转换 - CSDN xlxxcc</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2016-06-14T07:08:16.000Z" title="2016/6/14 15:08:16">2016-06-14</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:39:14.845Z" title="2021/6/18 17:39:14">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">11 分钟读完 (大约1719个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2016/06/14/Android/NDK-use_sample_2/">Android NDK 初步</a></p><div class="content"><ul>
<li>开发环境： win7 64，Android Studio 2.1</li>
</ul>
<p>需要工具：NDK，Cygwin</p>
<h3 id="使用adb查看手机CPU架构信息"><a href="#使用adb查看手机CPU架构信息" class="headerlink" title="使用adb查看手机CPU架构信息"></a>使用adb查看手机CPU架构信息</h3><p>将手机通过USB连接到电脑，adb shell进入手机根目录，执行<code>cat /proc/cpuinfo</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">shell@hnCHE-H:/ $ cat /proc/cpuinfo</span><br><span class="line">cat /proc/cpuinfo</span><br><span class="line">Processor       : AArch64 Processor rev 3 (aarch64)</span><br><span class="line">processor       : 0</span><br><span class="line">processor       : 1</span><br><span class="line">processor       : 2</span><br><span class="line">processor       : 3</span><br><span class="line">processor       : 4</span><br><span class="line">processor       : 5</span><br><span class="line">processor       : 6</span><br><span class="line">processor       : 7</span><br><span class="line">Features        : fp asimd evtstrm aes pmull sha1 sha2 crc32</span><br><span class="line">CPU implementer : 0x41</span><br><span class="line">CPU architecture: AArch64</span><br><span class="line">CPU variant     : 0x0</span><br><span class="line">CPU part        : 0xd03</span><br><span class="line">CPU revision    : 3</span><br><span class="line"></span><br><span class="line">Hardware        : hi6210sft</span><br></pre></td></tr></table></figure><br>可以看到手机处理器的信息</p>
<h3 id="使用-SDK-Manager-配置安装-NDK"><a href="#使用-SDK-Manager-配置安装-NDK" class="headerlink" title="使用 SDK Manager 配置安装 NDK"></a>使用 SDK Manager 配置安装 NDK</h3><p>添加系统环境变量 <code>G:\SDK\ndk-bundle;G:\SDK\platform-tools</code></p>
<p>下载并安装Cygwin：<a target="_blank" rel="noopener" href="https://cygwin.com/install.html">https://cygwin.com/install.html</a></p>
<p>Cygwin 安装NDK需要的工具包（如果第一次安装时没有选择工具包，可以再次启动安装）：<br>make, gcc, gdb, mingw64-x86_64-gcc, binutils<br><img src="https://raw.githubusercontent.com/RustFisher/RustNotes/master/Android_note/pics/Cygwin_tools.png" alt="tools"></p>
<p>配置<code>G:\soft\Cygwin\home\Administrator\.bashrc</code>，添加下面的指令，使用英文界面。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LANG=&#x27;en_US&#x27;</span><br><span class="line">export LC_ALL=&#x27;en_US.GBK&#x27;</span><br></pre></td></tr></table></figure><br>配置text选项，在option里的text可设置。<br>可以在<code>G:\soft\Cygwin\home\Administrator\.minttyrc</code>中看到。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Locale=zh_CN</span><br><span class="line">Charset=GBK</span><br></pre></td></tr></table></figure>
<p>设置完字体后可以避免中文乱码。</p>
<p>配置 <code>G:\soft\Cygwin\home\Administrator\.bash_profile</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NDK=/cygdrive/G/SDK/ndk-bundle/ndk-build.cmd</span><br><span class="line">export NDK</span><br></pre></td></tr></table></figure>
<p>在Cygwin中查找NDK位置，可以看到在SDK目录里面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/soft/Cygwin/home/Administrator</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$NDK</span></span><br><span class="line">/cygdrive/G/SDK/ndk-bundle/ndk-build.cmd</span><br></pre></td></tr></table></figure>
<h3 id="操作示例NDK工程"><a href="#操作示例NDK工程" class="headerlink" title="操作示例NDK工程"></a>操作示例NDK工程</h3><p><em>JDK10已经不提供<code>javah</code>这个工具了，我们可以使用as支持c++的功能；详情见下文</em></p>
<p>生成一次试试。从github上获取android-ndk-android-mk，进入hello-jni工程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/android-ndk-android-mk/hello-jni</span><br><span class="line">$ ndk-build.cmd</span><br><span class="line"><span class="comment"># 输出很多信息</span></span><br></pre></td></tr></table></figure>
<p>编译成功后，自动生成一个libs目录，编译生成的.so文件放在里面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKTest/app/src/main</span><br><span class="line">$ ndk-build.cmd</span><br><span class="line">[armeabi] Install        : librust_ndk.so =&gt; libs/armeabi/librust_ndk.so</span><br><span class="line"># 进入java目录，编译.h文件</span><br><span class="line">Administrator@rust-PC /cygdrive/g/rust_proj/NDKTest/app/src/main/java</span><br><span class="line">$ javah com.rustfisher.ndktest.HelloJNI</span><br><span class="line"># 会生成一个.h文件</span><br></pre></td></tr></table></figure>
<p>将它复制到jni文件夹下；这个就是JNI层的代码。</p>
<p>Ubuntu下javah报错。需要添加参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javah -cp /home/rust/Android/Sdk/platforms/android-25/android.jar:. com.example.LibUtil</span><br></pre></td></tr></table></figure>
<h3 id="使用C-C-实现JNI"><a href="#使用C-C-实现JNI" class="headerlink" title="使用C/C++实现JNI"></a>使用C/C++实现JNI</h3><p>遇到错误： Error:Execution failed for task ‘:app:compileDebugNdk’.</p>
<blockquote>
<p>Error: NDK integration is deprecated in the current plugin.  Consider trying the new experimental plugin.  For details, see <a target="_blank" rel="noopener" href="http://tools.android.com/tech-docs/new-build-system/gradle-experimental">http://tools.android.com/tech-docs/new-build-system/gradle-experimental</a>.  Set “android.useDeprecatedNdk=true” in gradle.properties to continue using the current NDK integration.</p>
</blockquote>
<p>解决办法：在<code>app\build.gradle</code>文件中添加<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sourceSets.main &#123;</span><br><span class="line">    jniLibs.srcDir &#x27;src/main/libs&#x27;</span><br><span class="line">    jni.srcDirs = [] //disable automatic ndk-build call</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>文件有3种：接口文件<code>.h</code>； 实现文件<code>.c</code>，注意与前面的<code>.h</code>文件同名； <code>.h</code>与<code>.c</code>生成的库文件<code>.so</code></p>
<h3 id="操作步骤小结"><a href="#操作步骤小结" class="headerlink" title="操作步骤小结"></a>操作步骤小结</h3><p>From Java to C/C++<br>Step 1 定义Java接口文件，里面定义好native方法。<br>Step 2 javah生成.h接口文件 。<br>Step 3 复制.h文件的文件名，编写C/C++文件。注意要实现.h中的接口。  </p>
<h3 id="NDK遇到的问题与注意事项"><a href="#NDK遇到的问题与注意事项" class="headerlink" title="NDK遇到的问题与注意事项"></a>NDK遇到的问题与注意事项</h3><h4 id="文件关联问题"><a href="#文件关联问题" class="headerlink" title="文件关联问题"></a>文件关联问题</h4><p>写cpp源文件的时候，忘记include头文件。产生<code>java.lang.UnsatisfiedLinkError: No implementation found for</code> 之类的错误<br>stackoverflow上有关于<code>Android NDK C++ JNI (no implementation found for native…)</code>的问题。</p>
<h4 id="NDK本地对象数量溢出问题-Local-ref-table-overflow"><a href="#NDK本地对象数量溢出问题-Local-ref-table-overflow" class="headerlink" title="NDK本地对象数量溢出问题 Local ref table overflow"></a>NDK本地对象数量溢出问题 <code>Local ref table overflow</code></h4><p>NDK本地只允许持有512个本地对象，return后会销毁这些对象。必须注意，在循环中创建的本地对象要在使用后销毁掉。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;<span class="built_in">DeleteLocalRef</span>(local_ref);<span class="comment">// local_ref 是本地创建的对象</span></span><br></pre></td></tr></table></figure>
<h4 id="调用Java方法时，注意指定返回值"><a href="#调用Java方法时，注意指定返回值" class="headerlink" title="调用Java方法时，注意指定返回值"></a>调用Java方法时，注意指定返回值</h4><p><code>env-&gt;CallBooleanMethod(resArrayList,arrayList_add, javaObject);</code> ArrayList的add方法返回Boolean</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html">https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html</a></p>
<h4 id="C-调用C方法"><a href="#C-调用C方法" class="headerlink" title="C++调用C方法"></a>C++调用C方法</h4><p>C++文件中，需要调用C里面的方法。如果未经任何处理，会出现无引用错误<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: undefined reference to &#x27;......</span><br></pre></td></tr></table></figure></p>
<p>因此在C++文件中涉及到C方法，需要声明。<br>例如<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;c_file_header.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// ___ 结束声明</span></span><br></pre></td></tr></table></figure></p>
<p>javah生成的JNI头文件中也有extern，可作为参考</p>
<h3 id="NDK中使用logcat"><a href="#NDK中使用logcat" class="headerlink" title="NDK中使用logcat"></a>NDK中使用logcat</h3><p>配置：Cygwin， NDK 14.1…<br>可以在NDK中使用logcat，方便调试<br>需要在mk文件中添加<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_LDLIBS := -L$(SYSROOT)/usr/lib -llog</span><br></pre></td></tr></table></figure></p>
<p>代码中添加头文件，即可调用logcat的方法<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;android/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG    <span class="string">&quot;rustApp&quot;</span></span></span><br><span class="line"></span><br><span class="line">__android_log_write(ANDROID_LOG_VERBOSE, LOG_TAG, <span class="string">&quot;My Log&quot;</span>);</span><br></pre></td></tr></table></figure></p>
<p>此时编译出现了错误：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">G:/SDK/ndk-bundle/build//../toolchains/x86_64-4.9/prebuilt/windows-x86_64/lib/gcc/x86_64-linux-android/4.9.x/../../../../x86_64-linux-android/bin\ld: warning: skipping incompatible G:/SDK/ndk-bundle/build//../platforms/android-21/arch-x86_64/usr/lib/libc.a while searching for c</span><br><span class="line">G:/SDK/ndk-bundle/build//../toolchains/x86_64-4.9/prebuilt/windows-x86_64/lib/gcc/x86_64-linux-android/4.9.x/../../../../x86_64-linux-android/bin\ld: error: treating warnings as errors</span><br><span class="line">clang++.exe: error: linker command failed with exit code 1 (use -v to see invocation)</span><br><span class="line">make: *** [G:/openSourceProject/NDKAlgo/app/src/main/obj/local/x86_64/libNDKMan.so] Error 1</span><br></pre></td></tr></table></figure></p>
<p>出现了<code>error: treating warnings as errors</code><br>处理方法，在mk文件中添加<code>LOCAL_DISABLE_FATAL_LINKER_WARNINGS=true</code><br>再次编译即可</p>
<p>我们可以使用宏定义简化打log的写法<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_TAG    <span class="string">&quot;rustApp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGV(...) __android_log_write(ANDROID_LOG_VERBOSE, LOG_TAG, __VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG , LOG_TAG, __VA_ARGS__)  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO , LOG_TAG, __VA_ARGS__)  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGW(...) __android_log_print(ANDROID_LOG_WARN , LOG_TAG, __VA_ARGS__)  </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR , LOG_TAG, __VA_ARGS__)  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">LOGV(<span class="string">&quot;This is my log&quot;</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="Android-Studio-3-为library-module添加C-支持"><a href="#Android-Studio-3-为library-module添加C-支持" class="headerlink" title="Android Studio 3 为library module添加C++支持"></a>Android Studio 3 为library module添加C++支持</h3><p>as在新建project的时候可以选择支持C++，可以新建一个支持C++的项目来参考。<br>可以不用自己javah来生成头文件。</p>
<p>在工程中新建android library，将<code>CMakeLists.txt</code>添加到模块中。这里模块名是<code>native-lib</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.4.1)</span><br><span class="line"></span><br><span class="line">add_library( # Sets the name of the library.</span><br><span class="line">             native-lib</span><br><span class="line"></span><br><span class="line">             # Sets the library as a shared library.</span><br><span class="line">             SHARED</span><br><span class="line"></span><br><span class="line">             # Provides a relative path to your source file(s).</span><br><span class="line">             src/main/cpp/native-lib.cpp</span><br><span class="line">             src/main/cpp/imagetool.cpp)</span><br><span class="line"></span><br><span class="line">find_library( # Sets the name of the path variable.</span><br><span class="line">              log-lib</span><br><span class="line"></span><br><span class="line">              # Specifies the name of the NDK library that</span><br><span class="line">              # you want CMake to locate.</span><br><span class="line">              log )</span><br><span class="line"></span><br><span class="line">target_link_libraries( # Specifies the target library.</span><br><span class="line">                       native-lib</span><br><span class="line"></span><br><span class="line">                       # Links the target library to the log library</span><br><span class="line">                       # included in the NDK.</span><br><span class="line">                       $&#123;log-lib&#125; )</span><br></pre></td></tr></table></figure></p>
<p>修改模块的<code>build.gradle</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion 26</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion 19</span><br><span class="line">        targetSdkVersion 26</span><br><span class="line">        versionCode 1</span><br><span class="line">        versionName &quot;1.0&quot;</span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</span><br><span class="line">        // 添加</span><br><span class="line">        externalNativeBuild &#123;</span><br><span class="line">            cmake &#123;</span><br><span class="line">                cppFlags &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled false</span><br><span class="line">            proguardFiles getDefaultProguardFile(&#x27;proguard-android.txt&#x27;), &#x27;proguard-rules.pro&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 添加</span><br><span class="line">    externalNativeBuild &#123;</span><br><span class="line">        cmake &#123;</span><br><span class="line">            path &quot;CMakeLists.txt&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>新建Java文件和C++文件，大致目录如下<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line">|-- AndroidManifest.xml</span><br><span class="line">|-- cpp</span><br><span class="line">|   |-- imagetool.cpp   // cpp文件</span><br><span class="line">|   `-- native-lib.cpp</span><br><span class="line">|-- java</span><br><span class="line">|   `-- com</span><br><span class="line">|       `-- example</span><br><span class="line">|           `-- myclib</span><br><span class="line">|               `-- ImageDetect.java // Java文件</span><br><span class="line">`-- res</span><br></pre></td></tr></table></figure></p>
<p>ImageDetect.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImageDetect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">inputPath</span><span class="params">(String path)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">stringFromJNI</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getOne</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>native-lib.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring</span></span><br><span class="line"><span class="function">JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_myclib_ImageDetect_stringFromJNI</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv *env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>)</span> </span>&#123;</span><br><span class="line">    std::string hello = <span class="string">&quot;In myclib Hello from C++&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(hello.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jint</span></span><br><span class="line"><span class="function">JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_myclib_ImageDetect_getOne</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv *env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">9257</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>imagetool.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT <span class="type">void</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_example_myclib_ImageDetect_inputPath</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv *env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>jobj, jstring inputPath)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// just test</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译运行即可。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-12-25T06:40:43.000Z" title="2015/12/25 14:40:43">2015-12-25</time>发表</span><span class="level-item"><time dateTime="2019-11-10T14:00:50.634Z" title="2019/11/10 22:00:50">2019-11-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">5 分钟读完 (大约747个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/12/25/Dev-note/dev-note-aboutView/">aboutView 开发记录</a></p><div class="content"><p>工程地址 <a target="_blank" rel="noopener" href="https://github.com/RustFisher/aboutView">https://github.com/RustFisher/aboutView</a></p>
<h2 id="虚拟键盘-VKeyboard"><a href="#虚拟键盘-VKeyboard" class="headerlink" title="虚拟键盘 - VKeyboard"></a>虚拟键盘 - VKeyboard</h2><p>VKeyboard - Virtual keyboard</p>
<h3 id="定义按键类"><a href="#定义按键类" class="headerlink" title="定义按键类"></a>定义按键类</h3><p>定义Key类，代表按键。属性有ascii码，是否使用TextView，是否使用ImageView，按键类别（功能键，普通键）等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Key</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> keyType; <span class="comment">// 按键种类 是普通按键或者是功能按键</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">uiType</span> <span class="operator">=</span> UI_TEXT_VIEW; <span class="comment">// UI使用的View类型</span></span><br><span class="line">    <span class="keyword">private</span> String keyText; <span class="comment">// 显示的文字</span></span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UI控制器实现"><a href="#UI控制器实现" class="headerlink" title="UI控制器实现"></a>UI控制器实现</h3><p>实现一个虚拟键盘。采用给LinearLayout添加子view的方式。<br>做一个UI控制器（Widget），需要传入一个LinearLayout作为根view。根据设置的键盘宽度动态调整每个按键的大小。</p>
<p>这种方式不太适合组件化。</p>
<h3 id="创建组件的方式"><a href="#创建组件的方式" class="headerlink" title="创建组件的方式"></a>创建组件的方式</h3><p>将「按键」装配到键盘上。采用适配器模式，将View添加到ViewGroup中。</p>
<p>VKey代表按键，VKeyboardBody代表键盘，VRow代表键盘上的一行，VKeyboardListener是监听器。<br>VKeyboard继承Framelayout，创建适配器VKeyboard.Adapter，将「按键」装配到键盘上。</p>
<p><img src="https://raw.githubusercontent.com/RustFisher/aboutView/master/pics/vk-1.png" alt="vk"></p>
<h4 id="VKey-按键"><a href="#VKey-按键" class="headerlink" title="VKey - 按键"></a>VKey - 按键</h4><p>代表按键。装载着keyCode，背景资源等等属性值。</p>
<h4 id="VKeyboardBody-键盘"><a href="#VKeyboardBody-键盘" class="headerlink" title="VKeyboardBody - 键盘"></a>VKeyboardBody - 键盘</h4><p>代表键盘的显示样式。比如UI的padding值和margin值。</p>
<h4 id="VRow-行"><a href="#VRow-行" class="headerlink" title="VRow - 行"></a>VRow - 行</h4><p>一行按键。实际上是一个LinearLayout的属性值合集。</p>
<h4 id="VKeyboardListener-监听器"><a href="#VKeyboardListener-监听器" class="headerlink" title="VKeyboardListener - 监听器"></a>VKeyboardListener - 监听器</h4><p>事件监听器。例如点击事件等等。</p>
<h4 id="VKeyboard-键盘UI类"><a href="#VKeyboard-键盘UI类" class="headerlink" title="VKeyboard - 键盘UI类"></a>VKeyboard - 键盘UI类</h4><p>实际上继承了FrameLayout。通过VKeyboard.Adapter获取到键盘的按键配置信息。<br>创建对应的子View，并添加到FrameLayout中。</p>
<h5 id="VKeyboard构造函数"><a href="#VKeyboard构造函数" class="headerlink" title="VKeyboard构造函数"></a>VKeyboard构造函数</h5><p>构造函数中有<code>AttributeSet</code>。attrs里面有id，layout_width，layout_height等等信息。</p>
<p>想在View的构造器中获取到定义中xml中的属性，需要从AttributeSet中获取。可能会获取到-1或-2，分别代表MATCH_PARENT和WRAP_CONTENT。<br>因此要判断获取到的数字是否大于0，如果大于0则表明是一个指定的宽度，直接记下这个宽度值。<br>获取到xml中指定的宽度后，再计算子view的宽度。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">VKeyboard</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@Nullable</span> AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">    <span class="type">int</span>[] attrsArray = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;</span><br><span class="line">            android.R.attr.id, <span class="comment">// 0</span></span><br><span class="line">            android.R.attr.background, <span class="comment">// 1</span></span><br><span class="line">            android.R.attr.layout_width, <span class="comment">// 2</span></span><br><span class="line">            android.R.attr.layout_height <span class="comment">// 3</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">TypedArray</span> <span class="variable">a</span> <span class="operator">=</span> context.obtainStyledAttributes(attrs, attrsArray);</span><br><span class="line">    <span class="type">int</span> <span class="variable">layoutWidth</span> <span class="operator">=</span> a.getLayoutDimension(<span class="number">2</span>, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">    <span class="keyword">if</span> (layoutWidth &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        keyboardWidthPx = layoutWidth;</span><br><span class="line">    &#125;</span><br><span class="line">    a.recycle();</span><br><span class="line">    initKeyboardUI(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8037101/how-to-get-attributeset-properties">https://stackoverflow.com/questions/8037101/how-to-get-attributeset-properties</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">MapView</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] attrsArray = <span class="keyword">new</span> <span class="title class_">int</span>[] &#123;</span><br><span class="line">        android.R.attr.id, <span class="comment">// 0</span></span><br><span class="line">        android.R.attr.background, <span class="comment">// 1</span></span><br><span class="line">        android.R.attr.layout_width, <span class="comment">// 2</span></span><br><span class="line">        android.R.attr.layout_height <span class="comment">// 3</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">TypedArray</span> <span class="variable">ta</span> <span class="operator">=</span> context.obtainStyledAttributes(attrs, attrsArray);</span><br><span class="line">    <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> ta.getResourceId(<span class="number">0</span> <span class="comment">/* index of attribute in attrsArray */</span>, View.NO_ID);</span><br><span class="line">    <span class="type">Drawable</span> <span class="variable">background</span> <span class="operator">=</span> ta.getDrawable(<span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">layout_width</span> <span class="operator">=</span> ta. getLayoutDimension(<span class="number">2</span>, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">    <span class="type">int</span> <span class="variable">layout_height</span> <span class="operator">=</span> ta. getLayoutDimension(<span class="number">3</span>, ViewGroup.LayoutParams.MATCH_PARENT);</span><br><span class="line">    ta.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>给Keyboard添加按键（key）。在activity onCreate的时候，Keyboard已经执行了构造函数。<br>之后我们通过setAdapter的方式给它添加key。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-10-29T07:09:35.000Z" title="2015/10/29 15:09:35">2015-10-29</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:38:00.687Z" title="2021/6/18 17:38:00">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">15 分钟读完 (大约2189个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/10/29/Android/Android-Broadcast_intro_use/">Android 广播机制（Broadcast）介绍与使用</a></p><div class="content"><p>Android应用可以通过广播从系统或其他App接收或发送消息。类似于订阅-发布设计模式。当某些事件发生时，可以发出广播。<br>系统在某些状态改变时会发出广播，例如开机、充电。App也可发送自定义广播。广播可用于应用间的通讯，是IPC的一种方式。</p>
<h2 id="广播的种类"><a href="#广播的种类" class="headerlink" title="广播的种类"></a>广播的种类</h2><p>广播的种类也可以看成是广播的属性。</p>
<h3 id="标准广播（Normal-Broadcasts）"><a href="#标准广播（Normal-Broadcasts）" class="headerlink" title="标准广播（Normal Broadcasts）"></a>标准广播（Normal Broadcasts）</h3><p>完全异步的广播。广播发出后，所有的广播接收器几乎同时接收到这条广播。<br>不同的App可以注册并接到标准广播。例如系统广播。</p>
<h3 id="有序广播（Ordered-Broadcasts）"><a href="#有序广播（Ordered-Broadcasts）" class="headerlink" title="有序广播（Ordered Broadcasts）"></a>有序广播（Ordered Broadcasts）</h3><p>同步广播。同一时刻只有一个广播接收器能接收到这条广播。这个接收器处理完后，广播才会继续传递。<br>有序广播是全局的广播。</p>
<h3 id="本地广播（Local-Broaddcasts）"><a href="#本地广播（Local-Broaddcasts）" class="headerlink" title="本地广播（Local Broaddcasts）"></a>本地广播（Local Broaddcasts）</h3><p>只在本App发送和接收的广播。注册为本地广播的接收器无法收到标准广播。</p>
<h3 id="带权限的广播"><a href="#带权限的广播" class="headerlink" title="带权限的广播"></a>带权限的广播</h3><p>发送广播时可以带上相关权限，申请了权限的App或广播接收器才能收到相应的带权限的广播。<br>如果在manifest中申请了相应权限，接收器可以不用再申请一次权限即可接到相应广播。</p>
<h2 id="接收广播"><a href="#接收广播" class="headerlink" title="接收广播"></a>接收广播</h2><p>创建广播接收器，调用<code>onReceive()</code>方法，需要一个继承BroadcastReceiver的类。</p>
<h3 id="注册广播"><a href="#注册广播" class="headerlink" title="注册广播"></a>注册广播</h3><p>代码中注册称为动态注册。在AndroidManifest.xml中注册称为静态注册。动态注册的刚波接收器一定要取消注册。在onDestroy()方法中调用unregisterReceiver()方法来取消注册。</p>
<p>不要在onReceive()方法中添加过多的逻辑操作或耗时的操作。因为在广播接收器中不允许开启线程，当onReceive()方法运行较长时间而没结束时，程序会报错。因此广播接收器一般用来打开其他组件，比如创建一条状态栏通知或启动一个服务。</p>
<p>新建一个MyExampleReceiver继承自BroadcastReceiver。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyExampleReceiver</span> <span class="keyword">extends</span> <span class="title class_">BroadcastReceiver</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Toast.makeText(context,<span class="string">&quot;Got it&quot;</span>,Toast.LENGTH_SHORT).show();</span><br><span class="line">        <span class="comment">//abortBroadcast();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><code>abortBroadcast()</code>可以截断有序广播</p>
<p>在AndroidManifest.xml中注册广播接收器；name里填接收器的名字。<br>可以设置广播接收器优先级：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">receiver</span> <span class="attr">android:name</span>=<span class="string">&quot;.MyExampleReceiver&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.rust.broadcasttest.MY_BROADCAST&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>让接收器接收到一条“com.rust.broadcasttest.MY_BROADCAST”广播。<br>发送自定义广播（标准广播）时，要传送这个值。例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.rust.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">sendBroadcast(intent);</span><br></pre></td></tr></table></figure></p>
<p>发送有序广播，应当调用sendOrderedBroadcast()；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.rust.broadcasttest.MY_BROADCAST&quot;</span>);</span><br><span class="line">sendOrderedBroadcast(intent，<span class="literal">null</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="发送广播"><a href="#发送广播" class="headerlink" title="发送广播"></a>发送广播</h2><p>App有3种发送广播的方式。发送广播需要使用Intent类。</p>
<h3 id="sendOrderedBroadcast-Intent-String"><a href="#sendOrderedBroadcast-Intent-String" class="headerlink" title="sendOrderedBroadcast(Intent, String)"></a>sendOrderedBroadcast(Intent, String)</h3><p>发送有序广播。每次只有1个广播接收器能接到广播。<br>接收器接到有序广播后，可以完全地截断广播，或者传递一些信息给下一个接收器。<br>有序广播的顺序可受<code>android:priority</code>标签影响。同等级的接收器收到广播的顺序是随机的。</p>
<h3 id="sendBroadcast-Intent"><a href="#sendBroadcast-Intent" class="headerlink" title="sendBroadcast(Intent)"></a>sendBroadcast(Intent)</h3><p>以一个未定义的顺序向所有接收器发送广播。也称作普通广播。<br>这种方式更高效，但是接收器不能给下一个接收器传递消息。这类广播也无法截断。</p>
<h3 id="LocalBroadcastManager-sendBroadcast"><a href="#LocalBroadcastManager-sendBroadcast" class="headerlink" title="LocalBroadcastManager.sendBroadcast"></a>LocalBroadcastManager.sendBroadcast</h3><p>广播只能在应用程序内部进行传递，并且广播接收器也只能接收到来自本应用程序发出的广播。<br>这个方法比全局广播更高效（不需要Interprocess communication，IPC），而且不需要担心其它App会收到你的广播以及其他安全问题。</p>
<h2 id="广播与权限"><a href="#广播与权限" class="headerlink" title="广播与权限"></a>广播与权限</h2><h3 id="发送带着权限的广播"><a href="#发送带着权限的广播" class="headerlink" title="发送带着权限的广播"></a>发送带着权限的广播</h3><p>当你调用<code>sendBroadcast(Intent, String)</code>或<code>sendOrderedBroadcast(Intent, String, BroadcastReceiver, Handler, int, String, Bundle)</code>时，你可以指定一个权限。<br>接收器在manifest中申请了相应权限时才能收到这个广播。</p>
<p>例如发送一个带着权限的广播<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sendBroadcast(<span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.example.NOTIFY&quot;</span>),</span><br><span class="line">              Manifest.permission.SEND_SMS);</span><br></pre></td></tr></table></figure></p>
<p>接收广播的app必须注册相应的权限<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.SEND_SMS&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>当然也可以使用自定义<a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/permission-element.html">permission</a>。在manifest中使用permission标签<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">&quot;custom_permission&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><br>添加后编译一下。即可调用<code>Manifest.permission.custom_permission</code></p>
<h3 id="接收带权限的广播"><a href="#接收带权限的广播" class="headerlink" title="接收带权限的广播"></a>接收带权限的广播</h3><p>若注册广播接收器时申明了权限，那么只会接收到带着相应权限的广播。</p>
<p>在配置文件中声明权限，程序才能访问一些关键信息。<br>例如允许查询系统网络状态。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 机器开机广播 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BOOT_COMPLETED&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><br>如果没有申请权限，程序可能会意外关闭。</p>
<h2 id="示例-使用标准广播，本地广播，带权限的广播，有序广播"><a href="#示例-使用标准广播，本地广播，带权限的广播，有序广播" class="headerlink" title="示例 - 使用标准广播，本地广播，带权限的广播，有序广播"></a>示例 - 使用标准广播，本地广播，带权限的广播，有序广播</h2><p>发送和接收广播。分为发送和接收方2个App。</p>
<p>使用带权限的广播。系统权限与自定义权限。<br>使用权限需要在AndroidManifest.xml中声明。如果是自定义权限，需要先添加自定义权限。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 自定义的权限  给广播用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.rust.permission_rust_1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.rust.permission_rust_1&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>发送广播时带上权限声明。接收方（不论是否己方App）需要在<code>AndroidManifest.xml</code>中申请权限。<br>注册接收器时也需要声明权限。</p>
<p>发送不带权限的有序广播<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendStandardOrderBroadcast</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MSG_PHONE);</span><br><span class="line">    sendOrderedBroadcast(intent, <span class="literal">null</span>);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;[App1] 发送不带权限的有序广播, &quot;</span> + intent.getAction());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发送方App1代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;rustApp&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MSG_PHONE</span> <span class="operator">=</span> <span class="string">&quot;msg_phone&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PERMISSION_RUST_1</span> <span class="operator">=</span> <span class="string">&quot;com.rust.permission_rust_1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册广播接收器</span></span><br><span class="line">    registerReceiver(mStandardReceiver1, makeIF());</span><br><span class="line">    registerReceiver(mStandardReceiver2, makeIF());</span><br><span class="line">    registerReceiver(mStandardReceiver3, makeIF());</span><br><span class="line"></span><br><span class="line">    registerReceiver(mStandardReceiverWithPermission, makeIF(),</span><br><span class="line">            Manifest.permission.permission_rust_1, <span class="literal">null</span>);  <span class="comment">// 带上权限</span></span><br><span class="line"></span><br><span class="line">    LocalBroadcastManager.getInstance(getApplicationContext())</span><br><span class="line">            .registerReceiver(mLocalReceiver1, makeIF());</span><br><span class="line">    LocalBroadcastManager.getInstance(getApplicationContext())</span><br><span class="line">            .registerReceiver(mLocalReceiver2, makeIF());</span><br><span class="line">    LocalBroadcastManager.getInstance(getApplicationContext())</span><br><span class="line">            .registerReceiver(mLocalReceiver3, makeIF());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解除接收器</span></span><br><span class="line">    unregisterReceiver(mStandardReceiver1);</span><br><span class="line">    unregisterReceiver(mStandardReceiver2);</span><br><span class="line">    unregisterReceiver(mStandardReceiver3);</span><br><span class="line"></span><br><span class="line">    unregisterReceiver(mStandardReceiverWithPermission);</span><br><span class="line"></span><br><span class="line">    LocalBroadcastManager.getInstance(getApplicationContext())</span><br><span class="line">            .unregisterReceiver(mLocalReceiver1);</span><br><span class="line">    LocalBroadcastManager.getInstance(getApplicationContext())</span><br><span class="line">            .unregisterReceiver(mLocalReceiver2);</span><br><span class="line">    LocalBroadcastManager.getInstance(getApplicationContext())</span><br><span class="line">            .unregisterReceiver(mLocalReceiver3);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送标准广播</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendStandardBroadcast</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MSG_PHONE);</span><br><span class="line">    sendBroadcast(intent);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;[App1] Dispatcher 发送标准广播&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送带权限的标准广播</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendStandardBroadcastWithPermission</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MSG_PHONE);</span><br><span class="line">    sendBroadcast(intent, PERMISSION_RUST_1);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;[App1] Dispatcher 发送带权限的标准广播&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送本地广播</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendAppLocalBroadcast</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MSG_PHONE);</span><br><span class="line">    LocalBroadcastManager.getInstance(getApplicationContext()).sendBroadcast(intent);</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;[App1] Dispatcher 发送本地广播&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> IntentFilter <span class="title function_">makeIF</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">IntentFilter</span> <span class="variable">intentFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(MSG_PHONE);</span><br><span class="line">    intentFilter.addAction(Intent.ACTION_TIME_TICK);</span><br><span class="line">    intentFilter.addAction(Intent.ACTION_TIME_CHANGED);</span><br><span class="line">    <span class="keyword">return</span> intentFilter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标准接收器  用context来注册</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mStandardReceiver1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[App1] 标准接收器1 收到: &quot;</span> + intent.getAction());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标准接收器  用context来注册</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mStandardReceiver2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[App1] 标准接收器2 收到: &quot;</span> + intent.getAction());</span><br><span class="line">        <span class="keyword">if</span> (intent.getAction().endsWith(MSG_PHONE)) &#123;</span><br><span class="line">            abortBroadcast(); <span class="comment">// 截断有序广播</span></span><br><span class="line">            Log.d(TAG, <span class="string">&quot;[App1] 标准接收器2截断有序广播 &quot;</span> + intent.getAction());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标准接收器  用context来注册</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mStandardReceiver3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[App1] 标准接收器3 收到: &quot;</span> + intent.getAction());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册的时候给它带权限  标准接收器</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mStandardReceiverWithPermission</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[App1] 带权限的标准接收器收到: &quot;</span> + intent.getAction());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用LocalBroadcastManager来注册成为本地接收器</span></span><br><span class="line"><span class="comment"> * 收不到标准广播 - 不论是本app发出的还是别的地方发出来的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mLocalReceiver1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[App1] 本地接收器1 收到: &quot;</span> + intent.getAction());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mLocalReceiver2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[App1] 本地接收器2 收到: &quot;</span> + intent.getAction());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mLocalReceiver3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;[App1] 本地接收器3 收到: &quot;</span> + intent.getAction());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>接收方App2代码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 自定义的权限  给广播用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.rust.permission_rust_1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.rust.permission_rust_1&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MSG_PHONE</span> <span class="operator">=</span> <span class="string">&quot;msg_phone&quot;</span>;</span><br><span class="line">        registerReceiver(mDefaultReceiver, makeIF());</span><br><span class="line">        LocalBroadcastManager.getInstance(getApplicationContext())</span><br><span class="line">                .registerReceiver(mLocalReceiver, makeIF());</span><br><span class="line"></span><br><span class="line">        unregisterReceiver(mDefaultReceiver);</span><br><span class="line">        LocalBroadcastManager.getInstance(getApplicationContext())</span><br><span class="line">                .unregisterReceiver(mLocalReceiver);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mDefaultReceiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;[App2] standard receive: &quot;</span> + intent.getAction());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">BroadcastReceiver</span> <span class="variable">mLocalReceiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;[App2] local receive: &quot;</span> + intent.getAction());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IntentFilter <span class="title function_">makeIF</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">IntentFilter</span> <span class="variable">intentFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>(MSG_PHONE);</span><br><span class="line">        intentFilter.addAction(Intent.ACTION_TIME_TICK);</span><br><span class="line">        intentFilter.addAction(Intent.ACTION_TIME_CHANGED);</span><br><span class="line">        <span class="keyword">return</span> intentFilter;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>LocalBroadcastManager</code>发出的本地广播，另一个App是接收不到的。<br>要收到本地广播，同样需要<code>LocalBroadcastManager</code>来注册接收器。</p>
<p>可以把本地广播看成是一个局部的，App内的广播体系。</p>
<p>实验中我们注意到，<code>Intent.ACTION_TIME_TICK</code>广播是可以截断的。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-10-26T07:09:31.000Z" title="2015/10/26 15:09:31">2015-10-26</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:37:07.783Z" title="2021/6/18 17:37:07">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">9 分钟读完 (大约1318个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/10/26/Android/Android-AIDL_intro_and_use/">Android AIDL 了解与使用</a></p><div class="content"><h2 id="AIDL简介"><a href="#AIDL简介" class="headerlink" title="AIDL简介"></a>AIDL简介</h2><p>AIDL（Android Interface Definition Language, Android 接口定义语言）<br>用于定义C/S体系结构中Server端可以提供的服务调用接口，框架层提供的Java系统服务接口大多由AIDL语言定义。<br>Android提供了AIDL工具，可将AIDL文件编译成Java文件。提高服务开发的效率</p>
<p>程序员可以利用AIDL自定义编程接口，在客户端和服务端之间实现进程间通信（IPC）。<br>在Android平台上，一个进程通常不能访问另外一个进程的内存空间，因此，Android平台将这些跨进程访问的对象分解成操作系统能够识别的简单对象。<br>并为跨应用访问而特殊编排和整理这些对象。用于编排和整理这些对象的代码编写起来十分冗长，所以Android的AIDL提供了相关工具来自动生成这些代码。</p>
<p>开发人员只需要在AIDL文件中定义Server端可以提供的服务方法，AIDL工具便可将其转化为Java文件。转化后的Java文件包含C/S体系结构的以下内容：</p>
<ul>
<li>服务接口 （IPowerManager）</li>
<li>服务在Client端的代理（Proxy）</li>
<li>服务存根（Stub）</li>
<li>Binder类型与IIterface类型的转换接口（asInterface 和 asBinder 方法）</li>
<li>服务方法请求码</li>
</ul>
<h2 id="AIDL意义"><a href="#AIDL意义" class="headerlink" title="AIDL意义"></a>AIDL意义</h2><p>AIDL工具建立了基于Binder的C/S体系结构的通用组件；开发者可以专注于开发服务的功能，而不需理会具体的通信结构，提高效率。</p>
<h2 id="应用示例"><a href="#应用示例" class="headerlink" title="应用示例"></a>应用示例</h2><p>根据上文我们可以知道，我们创建两个apk，一个作为服务提供方，一个作为AIDL服务调用方。</p>
<h3 id="AIDL服务提供方代码"><a href="#AIDL服务提供方代码" class="headerlink" title="AIDL服务提供方代码"></a>AIDL服务提供方代码</h3><p>首先是AIDL服务提供方主要文件目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">main/aidl/</span><br><span class="line">`-- com</span><br><span class="line">    `-- rustfisher</span><br><span class="line">        `-- ndkproj</span><br><span class="line">            `-- ITomInterface.aidl // AIDL代码</span><br><span class="line"></span><br><span class="line">main/java</span><br><span class="line">`-- com</span><br><span class="line">    `-- rustfisher</span><br><span class="line">        |-- tom</span><br><span class="line">        |   `-- TomService.java // 对应的Service</span><br><span class="line"></span><br><span class="line">build/generated/source/aidl/</span><br><span class="line">`-- debug</span><br><span class="line">    `-- com</span><br><span class="line">        `-- rustfisher</span><br><span class="line">            `-- ndkproj</span><br><span class="line">                `-- ITomInterface.java // 工程编译后AIDL生成的Java文件 提供给调用方</span><br></pre></td></tr></table></figure></p>
<h4 id="新建AIDL文件并写好接口"><a href="#新建AIDL文件并写好接口" class="headerlink" title="新建AIDL文件并写好接口"></a>新建AIDL文件并写好接口</h4><p>进入服务方的工程，右键新建AIDL文件<code>ITomInterface.aidl</code>。<br>文件会默认生成在<code>main/aidl/com/rustfisher/ndkproj</code>下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ITomInterface.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.rustfisher.ndkproj;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件名应该和接口名相同</span></span><br><span class="line"><span class="comment">// 编写好AIDL文件后可以先编译一次</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ITomInterface</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">basicTypes</span><span class="params">(<span class="type">int</span> anInt, <span class="type">long</span> aLong, <span class="type">boolean</span> aBoolean, <span class="type">float</span> aFloat,</span></span><br><span class="line"><span class="params">            <span class="type">double</span> aDouble, String aString)</span>;</span><br><span class="line">    String <span class="title function_">helloAIDL</span><span class="params">(String name)</span>; <span class="comment">// 此次使用的方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="编写服务方的接口实现代码"><a href="#编写服务方的接口实现代码" class="headerlink" title="编写服务方的接口实现代码"></a>编写服务方的接口实现代码</h4><p>在<code>com.rustfisher.tom</code>包内创建<code>TomService.java</code>文件；建立内部类<code>TomServiceImpl</code>实现接口的功能<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rustfisher.ndkproj.ITomInterface;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomService</span> <span class="keyword">extends</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;rustApp&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ITomInterface</span>.Stub &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">basicTypes</span><span class="params">(<span class="type">int</span> anInt, <span class="type">long</span> aLong, <span class="type">boolean</span> aBoolean, <span class="type">float</span> aFloat, <span class="type">double</span> aDouble, String aString)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">helloAIDL</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            Log.d(TAG, name + <span class="string">&quot; requires helloAIDL()&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name + <span class="string">&quot;, nice to meet you!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomServiceImpl</span>(); <span class="comment">// 绑定服务则返回 TomServiceImpl 实例</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="服务方在AndroidManifest-xml文件中配置"><a href="#服务方在AndroidManifest-xml文件中配置" class="headerlink" title="服务方在AndroidManifest.xml文件中配置"></a>服务方在<code>AndroidManifest.xml</code>文件中配置</h4><p>实现了<code>TomService</code>类后，对此AIDL服务进行配置；在<code>AndroidManifest.xml</code>文件中配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;com.rustfisher.tom.TomService&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.rustfisher.ndkproj.ITomInterface&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure><br>action里面写上AIDL文件</p>
<h4 id="安装运行此apk到手机上"><a href="#安装运行此apk到手机上" class="headerlink" title="安装运行此apk到手机上"></a>安装运行此apk到手机上</h4><p>让服务方运行起来</p>
<h3 id="AIDL调用方代码（客户端）"><a href="#AIDL调用方代码（客户端）" class="headerlink" title="AIDL调用方代码（客户端）"></a>AIDL调用方代码（客户端）</h3><p>建立（或进入）AIDL调用方的工程，这里是aidlcaller工程。</p>
<p>主要文件目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">java/</span><br><span class="line">`-- com</span><br><span class="line">    |-- rust</span><br><span class="line">    |   `-- aidlcaller</span><br><span class="line">    |       `-- MainActivity.java // 演示用的</span><br><span class="line">    `-- rustfisher</span><br><span class="line">        `-- ndkproj // 这个路径尽量保持与服务提供方那里的一致</span><br><span class="line">            `-- ITomInterface.java // 从服务方那里copy来的</span><br></pre></td></tr></table></figure></p>
<p>有如下3个步骤：</p>
<ul>
<li>1.将AIDL服务端生成的Java文件复制到调用方工程里，尽量保持这个Java文件的路径与服务端的一致，便于识别</li>
<li>2.写代码绑定服务，获取AIDL服务对象</li>
<li>3.通过AIDL服务对象完成AIDL接口调用</li>
</ul>
<p>编写调用方<code>MainActivity.java</code>代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.rustfisher.ndkproj.ITomInterface;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;rustApp&quot;</span>;</span><br><span class="line">    ITomInterface mTomService; <span class="comment">// AIDL 服务</span></span><br><span class="line">    TextView mTv1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ServiceConnection</span> <span class="variable">serviceConnection</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceConnection</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> &#123;</span><br><span class="line">            mTomService = ITomInterface.Stub.asInterface(service);<span class="comment">// 获取服务对象</span></span><br><span class="line">            mTv1.setClickable(<span class="literal">true</span>); <span class="comment">// 需要等服务绑定好  再允许点击</span></span><br><span class="line">            Log.d(TAG, <span class="string">&quot;[aidlcaller] onServiceConnected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName name)</span> &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onServiceDisconnected &quot;</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initAIDLService();</span><br><span class="line">        initUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initUI</span><span class="params">()</span> &#123;</span><br><span class="line">        mTv1 = (TextView) findViewById(R.id.tv1);</span><br><span class="line">        mTv1.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> mTomService.helloAIDL(<span class="string">&quot;Jerry&quot;</span>);</span><br><span class="line">                    Log.d(TAG, hello);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;mTomService initAIDLService: Fail &quot;</span>, e);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initAIDLService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 这个是服务提供方的AndroidManifest action</span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="string">&quot;com.rustfisher.ndkproj.ITomInterface&quot;</span>);</span><br><span class="line">        intent.setPackage(<span class="string">&quot;com.rustfisher.ndkproj&quot;</span>); <span class="comment">// 服务提供者的包名</span></span><br><span class="line">        bindService(intent, serviceConnection, Context.BIND_AUTO_CREATE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="测试和效果"><a href="#测试和效果" class="headerlink" title="测试和效果"></a>测试和效果</h4><p>点击调用端的View，打出log <code>Hello Jerry, nice to meet you!</code><br>服务端apk打印log：<code>Jerry requires helloAIDL()</code></p>
<p>如果调用失败则抛出 <code>android.os.DeadObjectException</code></p>
<p>当服务提供方App没有在运行时，调用方去请求服务会失败。</p>
<p>服务端更新后，如果aidl文件没改动，不需要更新生成的Java文件<br>如果服务端apk被卸载，调用端使用此服务时会出错</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://rustfisher.com/2019/08/08/Android/Android-Binder_mechanism_intro/">Android Binder 机制介绍</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2015-10-26T07:09:31.000Z" title="2015/10/26 15:09:31">2015-10-26</time>发表</span><span class="level-item"><time dateTime="2021-06-18T09:39:04.439Z" title="2021/6/18 17:39:04">2021-06-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Android-note/">Android_note</a></span><span class="level-item">3 分钟读完 (大约385个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2015/10/26/Android/NDK-compile_import_a_file/">Android NDK 使用.a</a></p><div class="content"><h2 id="Android-NDK-使用-a"><a href="#Android-NDK-使用-a" class="headerlink" title="Android NDK 使用.a"></a>Android NDK 使用.a</h2><p>一个编译时使用.a文件的例子。流程是准备好库文件以及对应的头文件，编写makefile，编译。</p>
<h3 id="准备库文件与头文件"><a href="#准备库文件与头文件" class="headerlink" title="准备库文件与头文件"></a>准备库文件与头文件</h3><p>先准备头文件和<code>.a</code>文件。这里以ncnn目录为例。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|-- Android.mk</span><br><span class="line">|-- Application.mk</span><br><span class="line">|-- ncnn</span><br><span class="line">|   |-- include</span><br><span class="line">|   |   |-- benchmark.h</span><br><span class="line">|   |   |-- ....h # 对应的头文件</span><br><span class="line">|   |-- lib</span><br><span class="line">|   |   `-- libncnn.a</span><br></pre></td></tr></table></figure>
<h3 id="编写makefile"><a href="#编写makefile" class="headerlink" title="编写makefile"></a>编写makefile</h3><p>在<code>Android.mk</code>中声明库文件。<br>这里是引入opencv的库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := $(call my-dir)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_MODULE    := ncnn</span><br><span class="line">LOCAL_SRC_FILES := ncnn/lib/libncnn.a</span><br><span class="line">include $(PREBUILT_STATIC_LIBRARY)</span><br><span class="line"></span><br><span class="line">LOCAL_STATIC_LIBRARIES := ncnn</span><br><span class="line"></span><br><span class="line">OPENCVROOT:=$(LOCAL_PATH)/../../../../../../OpenCV-android-sdk</span><br><span class="line">OPENCV_CAMERA_MODULES:=off</span><br><span class="line">OPENCV_INSTALL_MODULES:=on</span><br><span class="line">#OPENCV_LIB_TYPE:=SHARED</span><br><span class="line">OPENCV_LIB_TYPE:=STATIC</span><br><span class="line">include $&#123;OPENCVROOT&#125;/sdk/native/jni/OpenCV.mk</span><br><span class="line"></span><br><span class="line"># v20 with sse</span><br><span class="line">LOCAL_SRC_FILES := 	v20/fdssttracker.cpp v20/fhog.cpp v20/runtracker.cpp \</span><br><span class="line">                     jni_eman.cpp \</span><br><span class="line">                     ncnn/ssdmobilenet.cpp jni_encnn.cpp</span><br><span class="line"></span><br><span class="line"># 后面是模块的配置</span><br></pre></td></tr></table></figure>
<p>这里要注意，头文件和.a文件必须是对应的。否则编译时会报错<code>error: undefined reference to</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">E:/projects/myProj/myProject/f1/src/main/jni/ncnn/lib/libncnn.a(net.cpp.o):net.cpp:<span class="keyword">function</span> ncnn::Net::load_model(__STDIO_FILE_STRUCT*): error: undefined reference to <span class="string">&#x27;stderr&#x27;</span></span><br><span class="line">E:/projects/myProj/myProject/f1/src/main/jni/ncnn/lib/libncnn.a(net.cpp.o):net.cpp:<span class="keyword">function</span> ncnn::Net::load_model(char const*): `error: undefined reference to`</span><br><span class="line"><span class="string">&#x27;stderr&#x27;</span></span><br><span class="line">E:/projects/myProj/myProject/f1/src/main/jni/ncnn/lib/libncnn.a(net.cpp.o):net.cpp:<span class="keyword">function</span> ncnn::Net::load_model(unsigned char const*): error: undefined reference to <span class="string">&#x27;stderr&#x27;</span></span><br><span class="line">E:/projects/myProj/myProject/f1/src/main/jni/ncnn/lib/libncnn.a(net.cpp.o):net.cpp:<span class="keyword">function</span> ncnn::Net::find_blob_index_by_name(char const*) const: error: undefined reference to <span class="string">&#x27;stderr&#x27;</span></span><br><span class="line">clang++.exe: error: linker <span class="built_in">command</span> failed with <span class="built_in">exit</span> code 1 (use -v to see invocation)</span><br><span class="line">make: *** [E:/projects/myProj/myProject/f1/src/main/obj/local/armeabi-v7a/libf1.so] Error 1</span><br></pre></td></tr></table></figure></div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/fish.png" alt="RustFisher"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">RustFisher</p><p class="is-size-6 is-block">技术，学习，实践，开发，读书</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">107</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">19</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">55</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/RustFisher" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/RustFisher"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://an.rustfisher.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">技术记录</span></span><span class="level-right"><span class="level-item tag">an.rustfisher.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Android-note/"><span class="level-start"><span class="level-item">Android_note</span></span><span class="level-end"><span class="level-item tag">37</span></span></a></li><li><a class="level is-mobile" href="/categories/Android-tutorial-2020/"><span class="level-start"><span class="level-item">Android_tutorial_2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/CocosCreator/"><span class="level-start"><span class="level-item">CocosCreator</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/Database/"><span class="level-start"><span class="level-item">Database</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Design-pattern/"><span class="level-start"><span class="level-item">Design_pattern</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Flutter-note/"><span class="level-start"><span class="level-item">Flutter_note</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/HTTP/"><span class="level-start"><span class="level-item">HTTP</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux-note/"><span class="level-start"><span class="level-item">Linux_note</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/MongoDB/"><span class="level-start"><span class="level-item">MongoDB</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/NestJS/"><span class="level-start"><span class="level-item">NestJS</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/PyQt/"><span class="level-start"><span class="level-item">PyQt</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/TypeScript/"><span class="level-start"><span class="level-item">TypeScript</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/WebRTC/"><span class="level-start"><span class="level-item">WebRTC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Web-note/"><span class="level-start"><span class="level-item">Web_note</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/miniprogram/"><span class="level-start"><span class="level-item">miniprogram</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/unclassified/"><span class="level-start"><span class="level-item">unclassified</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%80%BB%E7%BB%93/"><span class="level-start"><span class="level-item">总结</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-18T08:32:32.000Z">2023-01-18</time></p><p class="title"><a href="/2023/01/18/unclassified/web-res-move-2023/">网站迁移说明</a></p><p class="categories"><a href="/categories/unclassified/">unclassified</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-30T15:59:59.000Z">2021-11-30</time></p><p class="title"><a href="/2021/11/30/Summary/2021-11/">2021年11月总结</a></p><p class="categories"><a href="/categories/%E6%80%BB%E7%BB%93/">总结</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-09T12:28:11.000Z">2021-11-09</time></p><p class="title"><a href="/2021/11/09/WebRTC/webRTC-concept-intro/">WebRTC概念介绍</a></p><p class="categories"><a href="/categories/WebRTC/">WebRTC</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-13T15:15:14.000Z">2021-10-13</time></p><p class="title"><a href="/2021/10/13/Python/scrapy-hw-blog-record/">Python抓取博客记录，获取标题与url</a></p><p class="categories"><a href="/categories/Python/">Python</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-30T15:59:59.000Z">2021-09-30</time></p><p class="title"><a href="/2021/09/30/Summary/2021-9/">2021年9月总结</a></p><p class="categories"><a href="/categories/%E6%80%BB%E7%BB%93/">总结</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/"><span class="level-start"><span class="level-item">2019</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/"><span class="level-start"><span class="level-item">2018</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/"><span class="level-start"><span class="level-item">2017</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/"><span class="level-start"><span class="level-item">2016</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2015/"><span class="level-start"><span class="level-item">2015</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AIDL/"><span class="tag">AIDL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-2020/"><span class="tag">Android-2020</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-Broadcast/"><span class="tag">Android_Broadcast</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-Media/"><span class="tag">Android_Media</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-View/"><span class="tag">Android_View</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android-service/"><span class="tag">Android_service</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android%E6%BA%90%E7%A0%81/"><span class="tag">Android源码</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Binder/"><span class="tag">Binder</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Cocos-Creator/"><span class="tag">Cocos Creator</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Excel/"><span class="tag">Excel</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Handler/"><span class="tag">Handler</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Matplotlib/"><span class="tag">Matplotlib</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Media/"><span class="tag">Media</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MediaPlayer/"><span class="tag">MediaPlayer</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NDK/"><span class="tag">NDK</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NestJS/"><span class="tag">NestJS</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Network/"><span class="tag">Network</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OkHttp/"><span class="tag">OkHttp</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell/"><span class="tag">Shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Thread/"><span class="tag">Thread</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Tools/"><span class="tag">Tools</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebRTC/"><span class="tag">WebRTC</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebSocket/"><span class="tag">WebSocket</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/css/"><span class="tag">css</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/echarts/"><span class="tag">echarts</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/for/"><span class="tag">for</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gradle/"><span class="tag">gradle</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo%E4%B8%BB%E9%A2%98/"><span class="tag">hexo主题</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/http/"><span class="tag">http</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mac/"><span class="tag">mac</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mmap/"><span class="tag">mmap</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/network/"><span class="tag">network</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openpyxl/"><span class="tag">openpyxl</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/plot/"><span class="tag">plot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/plt/"><span class="tag">plt</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pyecharts/"><span class="tag">pyecharts</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%85%AC%E4%BC%97%E5%8F%B7/"><span class="tag">公众号</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8D%8E%E4%B8%BA%E4%BA%91%E7%A4%BE%E5%8C%BA/"><span class="tag">华为云社区</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%8E%E7%AB%AF/"><span class="tag">后端</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%89%E8%A3%85mysql/"><span class="tag">安装mysql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"><span class="tag">小程序</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"><span class="tag">开发记录</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%80%BB%E7%BB%93/"><span class="tag">总结</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"><span class="tag">数据库</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%88%AC%E8%99%AB/"><span class="tag">爬虫</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BD%91%E7%BB%9C/"><span class="tag">网络</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="tag">设计模式</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%BF%90%E8%90%A5%E7%9A%84Python%E6%8C%87%E5%8D%97/"><span class="tag">运营的Python指南</span><span class="tag">4</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/fish.png" alt="RustFisher的自留地" height="28"></a><p class="is-size-7"><span>&copy; 2023 Rust Fisher</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2023 Rust Fisher</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>